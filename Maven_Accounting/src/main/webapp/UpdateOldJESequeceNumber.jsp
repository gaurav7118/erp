<%@page import="com.krawler.common.util.StringUtil"%>

<!--%@page contentType="text/html" pageEncoding="UTF-8"%>-->
<%@page import="java.sql.*"%>
<%@page import="java.util.*"%>
<%@page import="java.io.*"%>
<%@page import="java.util.logging.Level"%>
<%@page import="java.util.logging.Logger"%>


<%
      Connection conn = null;
          try {              
              String serverip = request.getParameter("serverip");//"192.168.0.208";                            
              String port = request.getParameter("port");//"3306";
              String dbName = request.getParameter("dbname");//"newstaging";
              String userName = request.getParameter("username");//"krawlersqladmin";
              String password = request.getParameter("password"); //"krawler"
              String subdomain = request.getParameter("subdomain");   
              
              if(StringUtil.isNullOrEmpty(serverip)||StringUtil.isNullOrEmpty(port) || StringUtil.isNullOrEmpty(dbName) || StringUtil.isNullOrEmpty(userName) || StringUtil.isNullOrEmpty(password)){
                  throw new Exception(" You have not privided all parameters (parameter are: serverip,port,dbname,username,password) in url. so please provide all these parameter correctly. ");
              }
              String connectString = "jdbc:mysql://" + serverip + ":" + port + "/" + dbName;
              String driver = "com.mysql.jdbc.Driver";
              
              Class.forName(driver).newInstance();
              conn = DriverManager.getConnection(connectString, userName, password);
              String query = "select companyid,companyname FROM company ";
              if(!StringUtil.isNullOrEmpty(subdomain)){
                  query+=" where subdomain= ?";
              }
              PreparedStatement stmt = conn.prepareStatement(query);
              if(!StringUtil.isNullOrEmpty(subdomain)){
                  stmt.setString(1, subdomain);
              }
              ResultSet rs = stmt.executeQuery();
              while (rs.next()) {
                  String companyId = rs.getString("companyid");
                  String companyname=rs.getString("companyname");
                  query="select id from sequenceformat where moduleid=24 and deleted='F' and name='JE000000' and company=? "; //journal entry moduleid is 24
                  PreparedStatement stmt1 = conn.prepareStatement(query);
                  stmt1.setString(1,companyId);
                  ResultSet rs1=stmt1.executeQuery();
                  String sequnceformatid="";                 
                  while(rs1.next()){
                     sequnceformatid=rs1.getString("id");                                       
                  }
                  if(StringUtil.isNullOrEmpty(sequnceformatid)){ //If JE000000 format not exists then create same format
                      String uuid = UUID.randomUUID().toString().replace("-", "");
                      query="insert into sequenceformat (id,name,prefix,suffix,numberofdigit,startfrom,deleted,showleadingzero,modulename,moduleid,company,isdefaultformat) values (?,?,?,?,?,?,?,?,?,?,?,?) ";
                      PreparedStatement stmt2 = conn.prepareStatement(query);
                      stmt2.setString(1, uuid);
                      stmt2.setString(2, "JE000000");
                      stmt2.setString(3, "JE");
                      stmt2.setString(4, "");
                      stmt2.setInt(5, 6);
                      stmt2.setInt(6, 1);
                      stmt2.setString(7, "F");
                      stmt2.setString(8, "T");
                      stmt2.setString(9, "autojournalentry");
                      stmt2.setInt(10, 24);
                      stmt2.setString(11, companyId);
                      stmt2.setString(12, "T");
                      stmt2.execute();
                      sequnceformatid=uuid;
                  } 
                  
                  query="select id,entryno from journalentry where autogen='T' and deleteflag='F' and seqformat is null and seqnumber=0 and company=?";
                  PreparedStatement stmt3=conn.prepareStatement(query);
                  stmt3.setString(1, companyId);
                  ResultSet rs2 =stmt3.executeQuery();
                  while(rs2.next()){
                      int seqnumber = 0;
                      String jeid=rs2.getString("id");
                      String jenumber=rs2.getString("entryno");
                      if (jenumber.length() == 8) {
                              jenumber = jenumber.replaceAll("JE", "00");
                              try {
                                  seqnumber = Integer.parseInt(jenumber); //if exception is occured it means seqnumber not generated by format JE000000   
                              } catch (Exception ex) {
                                  continue;
                              }
                      } else{
                          continue;                         
                      }                                            
                                            
                      query="update journalentry set seqnumber=?, seqformat= ? where id=? and company=?";
                      PreparedStatement stmt4= conn.prepareStatement(query);
                      stmt4.setInt(1,seqnumber);
                      stmt4.setString(2, sequnceformatid);
                      stmt4.setString(3, jeid);
                      stmt4.setString(4, companyId);
                      stmt4.execute(); 
                  } 
              out.println(" Records successfully updated for "+companyname+"  .");                                                                                                                                  
              }
          } catch (Exception e) {
              e.printStackTrace();
              out.print(e.toString());
          } finally{
              if(conn!=null)
              conn.close();
          }
    
%>