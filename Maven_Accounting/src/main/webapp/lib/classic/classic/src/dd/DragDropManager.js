Ext.define("Ext.dd.DragDropManager",{singleton:true,requires:["Ext.util.Region"],uses:["Ext.tip.QuickTipManager"],alternateClassName:["Ext.dd.DragDropMgr","Ext.dd.DDM"],ids:{},handleIds:{},dragCurrent:null,dragOvers:{},deltaX:0,deltaY:0,preventDefault:true,stopPropagation:true,initialized:false,locked:false,init:function(){this.initialized=true},POINT:0,INTERSECT:1,mode:0,notifyOccluded:false,dragCls:Ext.baseCSSPrefix+"dd-drag-current",_execOnAll:function(C,B){var E=this.ids,D,A,G,F;for(D in E){if(E.hasOwnProperty(D)){F=E[D];for(A in F){if(F.hasOwnProperty(A)){G=F[A];if(!this.isTypeOfDD(G)){continue}G[C].apply(G,B)}}}}},addListeners:function(){var A=this;A.init();Ext.getDoc().on({mouseup:A.handleMouseUp,mousemove:{fn:A.handleMouseMove,capture:false},dragstart:A.preventDrag,drag:A.preventDrag,dragend:A.preventDrag,capture:true,scope:A});Ext.getWin().on({unload:A._onUnload,resize:A._onResize,scope:A})},preventDrag:function(A){if(this.isMouseDown){A.stopPropagation()}},_onResize:function(A){this._execOnAll("resetConstraints",[])},lock:function(){this.locked=true},unlock:function(){this.locked=false},isLocked:function(){return this.locked},locationCache:{},useCache:true,clickPixelThresh:8,dragThreshMet:false,clickTimeout:null,startX:0,startY:0,regDragDrop:function(B,A){if(!this.initialized){this.init()}if(!this.ids[A]){this.ids[A]={}}this.ids[A][B.id]=B},removeDDFromGroup:function(C,A){if(!this.ids[A]){this.ids[A]={}}var B=this.ids[A];if(B&&B[C.id]){delete B[C.id]}},_remove:function(F,B){var E=this,C=E.ids,A=F.groups,D;if(E.clearingAll){return }if(E.dragCurrent===F){E.dragCurrent=null}for(D in A){if(A.hasOwnProperty(D)){if(B){delete C[D]}else{if(C[D]){delete C[D][F.id]}}}}delete E.handleIds[F.id];delete E.locationCache[F.id]},regHandle:function(B,A){if(!this.handleIds[B]){this.handleIds[B]={}}this.handleIds[B][A]=A},isDragDrop:function(A){return(this.getDDById(A))?true:false},getRelated:function(F,B){var E=[],D,C,A;for(D in F.groups){for(C in this.ids[D]){A=this.ids[D][C];if(!this.isTypeOfDD(A)){continue}if(!B||A.isTarget){E[E.length]=A}}}return E},isLegalTarget:function(E,D){var B=this.getRelated(E,true),C,A;for(C=0,A=B.length;C<A;++C){if(B[C].id===D.id){return true}}return false},isTypeOfDD:function(A){return(A&&A.__ygDragDrop)},isHandle:function(B,A){return(this.handleIds[B]&&this.handleIds[B][A])},getDDById:function(D,C){var B,A;for(B in this.ids){A=this.ids[B][D];if(A instanceof Ext.dd.DDTarget||C){return A}}return null},handleMouseDown:function(E,D){var B=this,C,A;B.isMouseDown=true;if(Ext.quickTipsActive){Ext.tip.QuickTipManager.ddDisable()}B.currentPoint=E.getPoint();if(B.dragCurrent){B.handleMouseUp(E)}B.mousedownEvent=E;B.currentTarget=E.getTarget();B.dragCurrent=D;A=D.getEl();Ext.fly(A).setCapture();C=E.getXY();B.startX=C[0];B.startY=C[1];B.offsetX=B.offsetY=0;B.deltaX=B.startX-A.offsetLeft;B.deltaY=B.startY-A.offsetTop;B.dragThreshMet=false},startDrag:function(B,E){var C=this,D=C.dragCurrent,A;clearTimeout(C.clickTimeout);if(D){D.b4StartDrag(B,E);D.startDrag(B,E);A=D.getDragEl();if(A){Ext.fly(A).addCls(C.dragCls)}}C.dragThreshMet=true},handleMouseUp:function(B){var A=this;A.isMouseDown=false;if(Ext.quickTipsActive){Ext.tip.QuickTipManager.ddEnable()}if(!A.dragCurrent){return }if(Ext.isIE&&document.releaseCapture){document.releaseCapture()}clearTimeout(A.clickTimeout);if(A.dragThreshMet){A.fireEvents(B,true)}A.stopDrag(B);A.stopEvent(B);A.mousedownEvent=A.currentTarget=null},stopEvent:function(A){if(this.stopPropagation){A.stopPropagation()}if(this.preventDefault){A.preventDefault()}},stopDrag:function(D){var B=this,C=B.dragCurrent,A;if(C){if(B.dragThreshMet){A=C.getDragEl();if(A){Ext.fly(A).removeCls(B.dragCls)}C.b4EndDrag(D);C.endDrag(D)}B.dragCurrent.onMouseUp(D)}B.dragCurrent=null;B.dragOvers={}},handleMouseMove:function(H){var F=this,G=F.dragCurrent,A=F.currentPoint=H.getPoint(),D=A.x,B=A.y,E,C;F.offsetX=D-F.startX;F.offsetY=B-F.startY;if(!G){return true}if(!F.dragThreshMet){E=Math.abs(F.offsetX);C=Math.abs(F.offsetY);if(E>F.clickPixelThresh||C>F.clickPixelThresh){F.startDrag(F.startX,F.startY)}}if(F.dragThreshMet){G.b4Drag(H);G.onDrag(H);if(!G.moveOnly){F.fireEvents(H,false)}}F.stopEvent(H);return true},fireEvents:function(U,K){var W=this,L=Ext.supports.Touch,F=W.dragCurrent,S=W.currentPoint,O=S.x,N=S.y,M=[],G=[],I=[],B=[],V=[],T=[],A=L?document.documentElement.clientWidth/window.innerWidth:1,D,E,J,C,Q,R,P,H;if(!F||F.isLocked()){return }H=!(F.deltaX<0||F.deltaY<0);if(L||(!W.notifyOccluded&&(!Ext.supports.CSSPointerEvents||Ext.isIE10m||Ext.isOpera)&&H)){D=F.getDragEl();if(H){D.style.visibility="hidden"}U.target=document.elementFromPoint(O/A,N/A);if(H){D.style.visibility="visible"}}for(Q in W.dragOvers){E=W.dragOvers[Q];delete W.dragOvers[Q];if(!W.isTypeOfDD(E)||E.destroyed){continue}if(W.notifyOccluded){if(!this.isOverTarget(S,E,W.mode)){I.push(E)}}else{if(!U.within(E.getEl())){I.push(E)}}G[Q]=true}for(P in F.groups){if("string"!==typeof P){continue}for(Q in W.ids[P]){E=W.ids[P][Q];if(W.isTypeOfDD(E)&&(J=E.getEl())&&(E.isTarget)&&(!E.isLocked())&&(Ext.fly(J).isVisible(true))&&((E!==F)||(F.ignoreSelf===false))){if(W.notifyOccluded){if((E.zIndex=W.getZIndex(J))!==-1){C=true}M.push(E)}else{if(U.within(E.getEl())){M.push(E);break}}}}}if(C){Ext.Array.sort(M,W.byZIndex)}for(Q=0,R=M.length;Q<R;Q++){E=M[Q];if(W.isOverTarget(S,E,W.mode)){if(K){V.push(E)}else{if(!G[E.id]){T.push(E)}else{B.push(E)}W.dragOvers[E.id]=E}if(!W.notifyOccluded){break}}}if(W.mode){if(I.length){F.b4DragOut(U,I);F.onDragOut(U,I)}if(T.length){F.onDragEnter(U,T)}if(B.length){F.b4DragOver(U,B);F.onDragOver(U,B)}if(V.length){F.b4DragDrop(U,V);F.onDragDrop(U,V)}}else{for(Q=0,R=I.length;Q<R;++Q){F.b4DragOut(U,I[Q].id);F.onDragOut(U,I[Q].id)}for(Q=0,R=T.length;Q<R;++Q){F.onDragEnter(U,T[Q].id)}for(Q=0,R=B.length;Q<R;++Q){F.b4DragOver(U,B[Q].id);F.onDragOver(U,B[Q].id)}for(Q=0,R=V.length;Q<R;++Q){F.b4DragDrop(U,V[Q].id);F.onDragDrop(U,V[Q].id)}}if(K&&!V.length){F.onInvalidDrop(U)}},getZIndex:function(B){var A=document.body,C,D=-1;B=Ext.getDom(B);while(B!==A){if(!isNaN(C=Number(Ext.fly(B).getStyle("zIndex")))){D=C}B=B.parentNode}return D},byZIndex:function(B,A){return B.zIndex<A.zIndex},getBestMatch:function(C){var E=null,B=C.length,D,A;if(B===1){E=C[0]}else{for(D=0;D<B;++D){A=C[D];if(A.cursorIsOver){E=A;break}else{if(!E||E.overlap.getArea()<A.overlap.getArea()){E=A}}}}return E},refreshCache:function(B){var A,C,D,E;for(A in B){if("string"!==typeof A){continue}for(C in this.ids[A]){D=this.ids[A][C];if(this.isTypeOfDD(D)){E=this.getLocation(D);if(E){this.locationCache[D.id]=E}else{delete this.locationCache[D.id]}}}}},verifyEl:function(A){return Ext.getBody().contains(A)},getLocation:function(F){if(!this.isTypeOfDD(F)){return null}if(F.getRegion){return F.getRegion()}var D=F.getEl(),I,C,B,K,J,L,A,H,E;try{I=Ext.fly(D).getXY()}catch(G){}if(!I){return null}C=I[0];B=C+D.offsetWidth;K=I[1];J=K+D.offsetHeight;L=K-F.padding[0];A=B+F.padding[1];H=J+F.padding[2];E=C-F.padding[3];return new Ext.util.Region(L,A,H,E)},isOverTarget:function(I,A,C){var E=this.locationCache[A.id],H,F,B,D,G;if(!E||!this.useCache){E=this.getLocation(A);this.locationCache[A.id]=E}if(!E){return false}A.cursorIsOver=E.contains(I);H=this.dragCurrent;if(!H||!H.getTargetCoord||(!C&&!H.constrainX&&!H.constrainY)){return A.cursorIsOver}A.overlap=null;F=H.getTargetCoord(I.x,I.y);B=H.getDragEl();D=new Ext.util.Region(F.y,F.x+B.offsetWidth,F.y+B.offsetHeight,F.x);G=D.intersect(E);if(G){A.overlap=G;return(C)?true:A.cursorIsOver}else{return false}},_onUnload:function(B,A){Ext.dd.DragDropManager.unregAll()},unregAll:function(){var C=this,A=C.elementCache,B;if(C.dragCurrent){C.stopDrag();C.dragCurrent=null}C.clearingAll=true;C._execOnAll("unreg",[]);delete C.clearingAll;for(B in A){delete A[B]}C.elementCache={};C.ids={};C.handleIds={}},elementCache:{},getElWrapper:function(B){var A=this.elementCache[B];if(!A||!A.el){A=this.elementCache[B]=new this.ElementWrapper(Ext.getDom(B))}return A},getElement:function(A){return Ext.getDom(A)},getCss:function(B){var A=Ext.getDom(B);return(A)?A.style:null},ElementWrapper:function(A){this.el=A||null;this.id=this.el&&A.id;this.css=this.el&&A.style},getPosX:function(A){return Ext.fly(A).getX()},getPosY:function(A){return Ext.fly(A).getY()},swapNode:function(C,A){if(C.swapNode){C.swapNode(A)}else{var D=A.parentNode,B=A.nextSibling;if(B===C){D.insertBefore(C,A)}else{if(A===C.nextSibling){D.insertBefore(A,C)}else{C.parentNode.replaceChild(A,C);D.insertBefore(C,B)}}}},getScroll:function(){var D=window.document,E=D.documentElement,A=D.body,C=0,B=0;if(E&&(E.scrollTop||E.scrollLeft)){C=E.scrollTop;B=E.scrollLeft}else{if(A){C=A.scrollTop;B=A.scrollLeft}}return{top:C,left:B}},getStyle:function(B,A){return Ext.fly(B).getStyle(A)},getScrollTop:function(){return this.getScroll().top},getScrollLeft:function(){return this.getScroll().left},moveToEl:function(A,C){var B=Ext.fly(C).getXY();Ext.fly(A).setXY(B)},numericSort:function(B,A){return(B-A)},handleWasClicked:function(A,C){if(this.isHandle(C,A.id)){return true}else{var B=A.parentNode;while(B){if(this.isHandle(C,B.id)){return true}else{B=B.parentNode}}}return false}},function(A){Ext.onInternalReady(function(){A.addListeners()})})