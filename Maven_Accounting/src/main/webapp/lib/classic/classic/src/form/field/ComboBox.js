Ext.define("Ext.form.field.ComboBox",{extend:"Ext.form.field.Picker",requires:["Ext.util.DelayedTask","Ext.view.BoundList","Ext.data.StoreManager"],alternateClassName:"Ext.form.ComboBox",alias:["widget.combobox","widget.combo"],mixins:["Ext.util.StoreHolder"],config:{filters:null,selection:null,valueNotFoundText:null,displayTpl:false,delimiter:", ",displayField:"text"},publishes:["selection"],twoWayBindable:["selection"],triggerCls:Ext.baseCSSPrefix+"form-arrow-trigger",hiddenName:"",collapseOnSelect:false,hiddenDataCls:Ext.baseCSSPrefix+"hidden-display "+Ext.baseCSSPrefix+"form-data-hidden",ariaRole:"combobox",childEls:{"hiddenDataEl":true},filtered:false,afterRender:function(){var A=this;A.callParent(arguments);A.setHiddenValue(A.value)},multiSelect:false,triggerAction:"all",allQuery:"",queryParam:"query",queryMode:"remote",queryCaching:true,autoLoadOnValue:false,pageSize:0,anyMatch:false,caseSensitive:false,autoSelect:true,typeAhead:false,typeAheadDelay:250,selectOnTab:true,forceSelection:false,growToLongestValue:true,clearFilterOnBlur:true,defaultListConfig:{loadingHeight:70,minWidth:70,maxHeight:300,shadow:"sides"},transformInPlace:true,clearValueOnEmpty:true,getGrowWidth:function(){var D=this,F=D.inputEl.dom.value,E,G,H,C,B,I,A;if(D.growToLongestValue){E=D.displayField;G=D.store;H=G.data.length;C=0;for(B=0;B<H;B++){I=G.getAt(B).data[E];A=I.length;if(A>C){C=A;F=I}}}return F},initComponent:function(){var E=this,C=Ext.isDefined,B=E.store,D=E.transform,A,F;if(E.typeAhead&&E.multiSelect){Ext.raise("typeAhead and multiSelect are mutually exclusive options -- please remove one of them.")}if(E.typeAhead&&!E.editable){Ext.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}if(E.selectOnFocus&&!E.editable){Ext.raise("If selectOnFocus is enabled the combo must be editable: true -- please change one of those settings.")}if("pinList" in E){E.collapseOnSelect=!E.pinList}if(D){A=Ext.getDom(D);if(A){if(!E.store){B=Ext.Array.map(Ext.Array.from(A.options),function(G){return[G.value,G.text]})}if(!E.name){E.name=A.name}if(!("value" in E)){E.value=A.value}}}E.bindStore(B||"ext-empty-store",true,true);F=E.queryMode==="local";if(!C(E.queryDelay)){E.queryDelay=F?10:500}if(!C(E.minChars)){E.minChars=F?0:4}E.callParent();E.doQueryTask=new Ext.util.DelayedTask(E.doRawQuery,E);if(A){if(E.transformInPlace){E.render(A.parentNode,A);delete E.renderTo}Ext.removeNode(A)}},getSubTplData:function(B){var C,A;C=this.callParent([B]);A=C.inputElAriaAttributes;if(A){A["aria-autocomplete"]="list"}return C},getSubTplMarkup:function(C){var D=this,A="",B=D.callParent(arguments);if(D.hiddenName){A='<div id="'+C.id+'-hiddenDataEl" data-ref="hiddenDataEl" class="'+D.hiddenDataCls+'" role="presentation"></div>'}return A+B},applyDisplayTpl:function(B){var A=this;if(!B){B=new Ext.XTemplate('<tpl for=".">{[typeof values === "string" ? values : values["'+A.getDisplayField()+'"]]}<tpl if="xindex < xcount">'+A.getDelimiter()+"</tpl></tpl>");B.auto=true}else{if(!B.isTemplate){B=new Ext.XTemplate(B)}}return B},applyFilters:function(B,C){var A=this;if(B===null||B.isFilterCollection){return B}if(B){if(!C){C=this.getFilters()}C.beginUpdate();C.splice(0,C.length,B);C.each(function(D){D.ownerId=A.id});C.endUpdate()}return C},applyValueNotFoundText:function(A){var B=this,C=B.valueNotFoundRecord||(B.valueNotFoundRecord=new Ext.data.Model());C.set(B.displayField,A);if(B.valueField&&B.displayField!==B.valueField){C.set(B.valueField,A)}return A},getFilters:function(B){var A=this.filters;if(!A&&B!==false){A=new Ext.util.FilterCollection();this.setFilters(A)}return A},updateFilters:function(A,B){var C=this;if(B){B.un("endupdate","onEndUpdateFilters",C)}if(A){A.on("endupdate","onEndUpdateFilters",C)}C.onEndUpdateFilters(A)},onEndUpdateFilters:function(E){var D=this,F=D.filtered,C=!!E&&(E.length>0),A,B;if(F||C){D.filtered=C;A=[];B=D.store.getFilters();B.each(function(G){if(G.ownerId===D.id&&!E.contains(G)){A.push(G)}});B.splice(0,A,E.items)}},completeEdit:function(C){var B=this,A=B.queryFilter;this.callParent([C]);B.doQueryTask.cancel();B.assertValue();if(A&&B.queryMode==="local"&&B.clearFilterOnBlur){B.getStore().getFilters().remove(A)}},onFocus:function(B){var A=this;A.callParent([B]);if(A.triggerAction!=="all"&&A.queryFilter&&A.queryMode==="local"&&A.clearFilterOnBlur){delete A.lastQuery;A.doRawQuery()}},assertValue:function(){var B=this,C=B.getRawValue(),A=B.getDisplayValue(),D=B.lastSelectedRecords,E;if(B.forceSelection){if(B.multiSelect){if(C!==A){B.setRawValue(A)}}else{E=B.findRecordByDisplay(C);if(E){if(B.getDisplayValue([B.getRecordDisplayData(E)])!==A){B.select(E,true)}}else{if(D&&(!B.allowBlank||B.rawValue)){B.setValue(D)}else{if(D){delete B.lastSelectedRecords}B.setRawValue("")}}}}B.collapse()},onTypeAhead:function(){var E=this,D=E.displayField,B=E.store.findRecord(D,E.getRawValue()),C=E.getPicker(),F,A,G;if(B){F=B.get(D);A=F.length;G=E.getRawValue().length;C.highlightItem(C.getNode(B));if(G!==0&&G!==A){E.setRawValue(F);E.selectText(G,F.length)}}},resetToDefault:Ext.emptyFn,beforeReset:function(){var A=this.queryFilter;this.callParent();if(A){this.getStore().getFilters().remove(A)}},onUnbindStore:function(){var C=this,A=C.picker,B=C.queryFilter;if(B&&!C.store.destroyed){C.changingFilters=true;C.getStore().removeFilter(B,true);C.changingFilters=false}C.pickerSelectionModel.destroy();if(A){A.bindStore(null)}},onBindStore:function(A,C){var E=this,B=E.picker,D,F;if(A){if(A.autoCreated){E.queryMode="local";E.valueField=E.displayField="field1";if(!A.expanded){E.displayField="field2"}if(E.getDisplayTpl().auto){E.setDisplayTpl(null)}}if(!Ext.isDefined(E.valueField)){E.valueField=E.displayField}D={byValue:{rootProperty:"data",unique:false}};D.byValue.property=E.valueField;A.setExtraKeys(D);if(E.displayField===E.valueField){A.byText=A.byValue}else{D.byText={rootProperty:"data",unique:false};D.byText.property=E.displayField;A.setExtraKeys(D)}F={rootProperty:"data",extraKeys:{byInternalId:{property:"internalId"},byValue:{property:E.valueField,rootProperty:"data"}},listeners:{beginupdate:E.onValueCollectionBeginUpdate,endupdate:E.onValueCollectionEndUpdate,scope:E}};E.valueCollection=new Ext.util.Collection(F);E.pickerSelectionModel=new Ext.selection.DataViewModel({mode:E.multiSelect?"SIMPLE":"SINGLE",deselectOnContainerClick:false,enableInitialSelection:false,pruneRemoved:false,selected:E.valueCollection,store:A,listeners:{scope:E,lastselectedchanged:E.updateBindSelection}});if(!C){E.resetToDefault()}if(B){B.setSelectionModel(E.pickerSelectionModel);if(B.getStore()!==A){B.bindStore(A)}}}},bindStore:function(A,E,B){var D=this,C=D.queryFilter;D.mixins.storeholder.bindStore.call(D,A,B);A=D.getStore();if(A&&C&&!E){A.getFilters().add(C)}if(!B&&A&&!A.isEmptyStore){D.setValueOnData()}},getStoreListeners:function(B){if(!B.isEmptyStore){var C=this,A={datachanged:C.onDataChanged,load:C.onLoad,exception:C.onException,update:C.onStoreUpdate,remove:C.checkValueOnChange};if(!B.getRemoteFilter()){A.filterchange=C.checkValueOnChange}return A}},onDataChanged:function(){if(this.grow&&this.growToLongestValue){this.autoSize()}},checkValueOnChange:function(){var A=this;if(!A.destroying&&A.getStore().isLoaded()){if(A.multiSelect){}else{if(A.forceSelection&&!A.changingFilters&&!A.findRecordByValue(A.value)){A.setValue(null)}}}},onStoreUpdate:function(B,A){this.updateValue()},onException:function(){this.collapse()},onLoad:function(C,B,E){var D=this,A=!D.valueCollection.byValue.get(D.value);if(E&&A&&!(C.lastOptions&&"rawQuery" in C.lastOptions)){D.setValueOnData()}D.checkValueOnChange()},setValueOnData:function(){var A=this;A.setValue(A.value);if(A.isExpanded&&A.getStore().getCount()){A.doAutoSelect()}},doRawQuery:function(){var A=this,B=A.inputEl.dom.value;if(A.multiSelect){B=B.split(A.delimiter).pop()}A.doQuery(B,false,true)},doQuery:function(G,C,F){var D=this,A=D.getStore(),E=A.filters&&!A.filters.length&&!!G,B=D.beforeQuery({query:G||"",rawQuery:F,forceAll:C,combo:D,cancel:false});if(B!==false&&!B.cancel){if(D.queryCaching&&!E&&B.query===D.lastQuery){D.getPicker().refresh();D.expand()}else{D.lastQuery=B.query;if(D.queryMode==="local"){D.doLocalQuery(B)}else{D.doRemoteQuery(B)}}}return true},beforeQuery:function(A){var B=this;if(B.fireEvent("beforequery",A)===false){A.cancel=true}else{if(!A.cancel){if(A.query.length<B.minChars&&!A.forceAll){A.cancel=true}}}return A},doLocalQuery:function(B){var D=this,E=B.query,A=D.getStore(),C=D.queryFilter;D.queryFilter=null;D.changingFilters=true;if(C){A.removeFilter(C,true)}if(E){C=D.queryFilter=new Ext.util.Filter({id:D.id+"-filter",anyMatch:D.anyMatch,caseSensitive:D.caseSensitive,root:"data",property:D.displayField,value:D.enableRegEx?new RegExp(E):E});A.addFilter(C,true)}D.changingFilters=false;if(D.store.getCount()||D.getPicker().emptyText){D.getPicker().refresh();D.expand()}else{D.collapse()}D.afterQuery(B)},doRemoteQuery:function(B){var C=this,A=function(){if(!C.destroyed){C.afterQuery(B)}};C.expand();if(C.pageSize){C.loadPage(1,{rawQuery:B.rawQuery,callback:A})}else{C.store.load({params:C.getParams(B.query),rawQuery:B.rawQuery,callback:A})}},afterQuery:function(A){var B=this;if(B.store.getCount()){if(B.typeAhead){B.doTypeAhead()}if(A.rawQuery){if(B.picker&&!B.picker.getSelectionModel().hasSelection()){B.doAutoSelect()}}else{B.doAutoSelect()}}B.startCheckChangeTask()},loadPage:function(B,A){this.store.loadPage(B,Ext.apply({params:this.getParams(this.lastQuery)},A))},onPageChange:function(B,A){this.loadPage(A);return false},getParams:function(C){var B={},A=this.queryParam;if(A){B[A]=C}return B},doAutoSelect:function(){var C=this,B=C.picker,A,D=0;if(B&&C.autoSelect&&C.store.getCount()>0){A=C.picker.getSelectionModel();if(A.lastSelected&&A.selected.length){D=A.lastSelected}B.getNavigationModel().setPosition(D)}},doTypeAhead:function(){var B=this,A=Ext.event.Event;if(!B.typeAheadTask){B.typeAheadTask=new Ext.util.DelayedTask(B.onTypeAhead,B)}if(B.lastKey!==A.BACKSPACE&&B.lastKey!==A.DELETE){B.typeAheadTask.delay(B.typeAheadDelay)}},onTriggerClick:function(){var A=this;if(!A.readOnly&&!A.disabled){if(A.isExpanded){A.collapse()}else{if(A.triggerAction==="all"){A.doQuery(A.allQuery,true)}else{if(A.triggerAction==="last"){A.doQuery(A.lastQuery,true)}else{A.doQuery(A.getRawValue(),false,true)}}}}},onFieldMutation:function(F){var D=this,B=F.getKey(),C=B===F.BACKSPACE||B===F.DELETE,E=D.inputEl.dom.value,A=E.length;if(!D.readOnly&&(E!==D.lastMutatedValue||C)&&B!==F.TAB){D.lastMutatedValue=E;D.lastKey=B;if(A&&(F.type!=="keyup"||(!F.isSpecialKey()||C))){D.doQueryTask.delay(D.queryDelay)}else{if(!A&&(!B||C)){++D.suspendCheckChange;if(!D.multiSelect){D.value=null;D.displayTplData=undefined}if(D.clearValueOnEmpty){D.valueCollection.beginUpdate();D.pickerSelectionModel.deselectAll();D.valueCollection.removeAll();D.valueCollection.endUpdate()}D.collapse();if(D.queryFilter){D.changingFilters=true;D.store.removeFilter(D.queryFilter,true);D.changingFilters=false}--D.suspendCheckChange}D.callParent([F])}}},onDestroy:function(){var A=this;A.doQueryTask.cancel();if(A.typeAheadTask){A.typeAheadTask.cancel();A.typeAheadTask=null}A.bindStore(null);A.valueCollection=Ext.destroy(A.valueCollection);A.callParent()},onAdded:function(){var A=this;A.callParent(arguments);if(A.picker){A.picker.ownerCt=A.up("[floating]");A.picker.registerWithOwnerCt()}},createPicker:function(){var C=this,B,A=Ext.apply({xtype:"boundlist",id:C.pickerId,pickerField:C,selectionModel:C.pickerSelectionModel,floating:true,hidden:true,store:C.getPickerStore(),displayField:C.displayField,preserveScrollOnRefresh:true,pageSize:C.pageSize,tpl:C.tpl},C.listConfig,C.defaultListConfig);B=C.picker=Ext.widget(A);if(C.pageSize){B.pagingToolbar.on("beforechange",C.onPageChange,C)}if(!B.initialConfig.maxHeight){B.on({beforeshow:C.onBeforePickerShow,scope:C})}B.getSelectionModel().on({beforeselect:C.onBeforeSelect,beforedeselect:C.onBeforeDeselect,focuschange:C.onFocusChange,scope:C});B.getNavigationModel().navigateOnSpace=false;return B},getPickerStore:function(){return this.store},onBeforePickerShow:function(A){var B=this,D=B.getPosition()[1]-Ext.getBody().getScroll().top,C=Ext.Element.getViewportHeight()-D-B.getHeight();A.maxHeight=Math.max(D,C)-5},onBeforeSelect:function(C,A,B){return this.fireEvent("beforeselect",this,A,B)},onBeforeDeselect:function(C,A,B){return this.fireEvent("beforedeselect",this,A,B)},onFocusChange:function(C,A,B){var D=this.picker,E;if(B){E=Ext.get(D.getNodeByRecord(B));if(E){this.ariaEl.dom.setAttribute("aria-activedescendant",E.id)}}},getSelection:function(){var A=this.getPicker().getSelectionModel(),B=A.getSelection();return B.length?A.getLastSelected():null},updateSelection:function(A){var B=this,C;if(!B.ignoreNextSelection){B.ignoreNextSelection=true;C=B.getPicker().getSelectionModel();if(A){C.select(A);B.hasHadSelection=true}else{C.deselectAll()}B.ignoreNextSelection=false}},updateBindSelection:function(A,C){var D=this,B=null;if(!D.ignoreNextSelection){D.ignoreNextSelection=true;if(C.length){B=A.getLastSelected();D.hasHadSelection=true}if(D.hasHadSelection){D.setSelection(B)}D.ignoreNextSelection=false}},onValueCollectionBeginUpdate:Ext.emptyFn,onValueCollectionEndUpdate:function(){var D=this,C=D.store,E=D.valueCollection.getRange(),B=E[0],A=E.length;D.updateBindSelection(D.pickerSelectionModel,E);if(D.isSelectionUpdating()){return }Ext.suspendLayouts();D.lastSelection=E;if(A){D.lastSelectedRecords=E}D.updateValue();if(A&&((!D.multiSelect&&C.contains(B))||D.collapseOnSelect||!C.getCount())){D.updatingValue=true;D.collapse();D.updatingValue=false}Ext.resumeLayouts(true);if(A&&!D.suspendCheckChange){if(!D.multiSelect){E=B}D.fireEvent("select",D,E)}},isSelectionUpdating:function(){var A=this.pickerSelectionModel;return A.deselectingDuringSelect||A.refreshing},onExpand:function(){var A=this.getPicker().getNavigationModel();if(A){A.enable()}this.doAutoSelect()},onCollapse:function(){var A=this.getPicker().getNavigationModel();if(A){A.disable()}if(this.updatingValue){this.doQueryTask.cancel()}},select:function(D,A){var C=this,B=C.picker,E;if(D&&D.isModel&&A===true&&B){E=!B.getSelectionModel().isSelected(D)}if(!E){C.suspendEvent("select")}C.setValue(D);C.resumeEvent("select")},findRecord:function(D,C){var B=this.store,A=B.findExact(D,C);return A!==-1?B.getAt(A):false},getSelectedRecord:function(){return this.findRecordByValue(this.value)||null},findRecordByValue:function(C){var A=this.store.byValue.get(C),B=false;if(A){B=A[0]||A}return B},findRecordByDisplay:function(C){var A=this.store.byText.get(C),B=false;if(A){B=A[0]||A}return B},addValue:function(A){if(A!=null){return this.doSetValue(A,true)}},setValue:function(B){var A=this;if(B!=null){return A.doSetValue(B)}else{A.suspendEvent("select");A.valueCollection.beginUpdate();A.pickerSelectionModel.deselectAll();A.valueCollection.endUpdate();A.lastSelectedRecords=null;A.resumeEvent("select")}},setRawValue:function(A){this.callParent([A]);this.lastMutatedValue=A},doSetValue:function(O,K){var U=this,G=U.getStore(),H=G.getModel(),R=[],F=[],Q=U.autoLoadOnValue,E=G.getCount()>0||G.isLoaded(),A=G.hasPendingLoad(),L=Q&&!E&&!A,J=U.forceSelection,N=U.pickerSelectionModel,B=U.displayField===U.valueField,M=G.isEmptyStore,I=U.lastSelection,S,T,C,P,D,V;if(K&&!U.multiSelect){Ext.raise("Cannot add values to non multiSelect ComboBox")}if(A||L||!E||M){if(!O.isModel){if(K){U.value=Ext.Array.from(U.value).concat(O)}else{U.value=O}U.setHiddenValue(U.value);U.setRawValue(B?O:"")}if(L&&!M){G.load()}if(!O.isModel||M){return U}}O=K?Ext.Array.from(U.value).concat(O):Ext.Array.from(O);for(S=0,T=O.length;S<T;S++){C=O[S];if(!C||!C.isModel){C=U.findRecordByValue(V=C);if(!C){C=U.valueCollection.find(U.valueField,V)}}if(!C){if(!J){if(!C&&O[S]){P={};P[U.displayField]=O[S];if(U.valueField&&U.displayField!==U.valueField){P[U.valueField]=O[S]}C=new H(P)}}else{if(U.valueNotFoundRecord){C=U.valueNotFoundRecord}}}if(C){R.push(C);F.push(C.get(U.valueField))}}if(I){T=I.length;if(T===R.length){for(S=0;!D&&S<T;S++){if(Ext.Array.indexOf(U.lastSelection,R[S])===-1){D=true}}}else{D=true}}else{D=R.length}if(D){U.suspendEvent("select");U.valueCollection.beginUpdate();if(R.length){N.select(R,false)}else{N.deselectAll()}U.valueCollection.endUpdate();U.resumeEvent("select")}else{U.updateValue()}if(U.inputEl&&U.emptyText){U.inputEl.removeCls(U.emptyCls);U.valueContainsPlaceholder=false}U.applyEmptyText();return U},updateValue:function(){var E=this,H=E.valueCollection.getRange(),A=H.length,D=[],F=E.displayTplData||(E.displayTplData=[]),G=E.inputEl,C,B;F.length=0;for(C=0;C<A;C++){B=H[C];F.push(E.getRecordDisplayData(B));if(B!==E.valueNotFoundRecord){D.push(B.get(E.valueField))}}E.setHiddenValue(D);E.value=E.multiSelect?D:D[0];if(!Ext.isDefined(E.value)){E.value=undefined}E.displayTplData=F;if(G&&E.emptyText&&!Ext.isEmpty(E.value)){G.removeCls(E.emptyCls)}E.setRawValue(E.getDisplayValue());E.checkChange();E.applyEmptyText()},setHiddenValue:function(H){var E=this,A=E.hiddenName,D,B,I,G,F,C;if(!E.hiddenDataEl||!A){return }H=Ext.Array.from(H);B=E.hiddenDataEl.dom;I=B.childNodes;G=I[0];F=H.length;C=I.length;if(!G&&F>0){E.hiddenDataEl.setHtml(Ext.DomHelper.markup({tag:"input",type:"hidden",name:A}));C=1;G=B.firstChild}while(C>F){B.removeChild(I[0]);--C}while(C<F){B.appendChild(G.cloneNode(true));++C}for(D=0;D<F;D++){I[D].value=H[D]}},getDisplayValue:function(A){A=A||this.displayTplData;return this.getDisplayTpl().apply(A)},getRecordDisplayData:function(A){return A.data},getValue:function(){var C=this,A=C.getStore(),B=C.picker,E=C.getRawValue(),D=C.value;if(!A.isEmptyStore&&C.getDisplayValue()!==E){C.displayTplData=undefined;if(B){C.valueCollection.suspendEvents();B.getSelectionModel().deselectAll();C.valueCollection.resumeEvents();C.lastSelection=null}if(A.isLoaded()&&(C.multiSelect||C.forceSelection)){D=C.value=undefined}else{D=C.value=E}}C.value=D==null?null:D;return C.value},getSubmitValue:function(){var A=this.getValue();if(Ext.isEmpty(A)){A=""}return A},isEqual:function(E,D){var B=Ext.Array.from,C,A;E=B(E);D=B(D);A=E.length;if(A!==D.length){return false}for(C=0;C<A;C++){if(D[C]!==E[C]){return false}}return true},clearValue:function(){this.setValue(null)}})