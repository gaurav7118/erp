Ext.define("Ext.form.field.HtmlEditor",{extend:"Ext.form.FieldContainer",mixins:{field:"Ext.form.field.Field"},alias:"widget.htmleditor",alternateClassName:"Ext.form.HtmlEditor",requires:["Ext.tip.QuickTipManager","Ext.picker.Color","Ext.layout.container.VBox","Ext.toolbar.Item","Ext.toolbar.Toolbar","Ext.util.Format","Ext.layout.component.field.HtmlEditor","Ext.util.TaskManager","Ext.layout.container.boxOverflow.Menu"],focusable:true,componentLayout:"htmleditor",textareaCls:Ext.baseCSSPrefix+"htmleditor-textarea",componentTpl:["{beforeTextAreaTpl}",'<textarea id="{id}-textareaEl" data-ref="textareaEl" name="{name}" tabindex="-1" {inputAttrTpl}',' class="{textareaCls}" autocomplete="off">',"{[Ext.util.Format.htmlEncode(values.value)]}","</textarea>","{afterTextAreaTpl}","{beforeIFrameTpl}",'<iframe id="{id}-iframeEl" data-ref="iframeEl" name="{iframeName}" frameBorder="0" {iframeAttrTpl}',' src="{iframeSrc}" class="{iframeCls}"></iframe>',"{afterIFrameTpl}",{disableFormats:true}],stretchInputElFixed:true,subTplInsertions:["beforeTextAreaTpl","afterTextAreaTpl","beforeIFrameTpl","afterIFrameTpl","iframeAttrTpl","inputAttrTpl"],enableFormat:true,enableFontSize:true,enableColors:true,enableAlignments:true,enableLists:true,enableSourceEdit:true,enableLinks:true,enableFont:true,createLinkText:"Please enter the URL for the link:",defaultLinkValue:"http://",fontFamilies:["Arial","Courier New","Tahoma","Times New Roman","Verdana"],defaultValue:Ext.isOpera?"&#160;":"&#8203;",extraFieldBodyCls:Ext.baseCSSPrefix+"html-editor-wrap",defaultButtonUI:"default-toolbar",initialized:false,activated:false,sourceEditMode:false,iframePad:3,hideMode:"offsets",maskOnDisable:true,containerElCls:Ext.baseCSSPrefix+"html-editor-container",reStripQuotes:/^['"]*|['"]*$/g,textAlignRE:/text-align:(.*?);/i,safariNonsenseRE:/\sclass="(?:Apple-style-span|Apple-tab-span|khtml-block-placeholder)"/gi,nonDigitsRE:/\D/g,initComponent:function(){var A=this;A.items=[A.createToolbar(),A.createInputCmp()];A.layout={type:"vbox",align:"stretch"};if(A.value==null){A.value=""}A.callParent(arguments);A.initField()},createInputCmp:function(){this.inputCmp=Ext.widget(this.getInputCmpCfg());return this.inputCmp},getInputCmpCfg:function(){var A=this,C=A.id+"-inputCmp",B={id:C,name:A.name,textareaCls:A.textareaCls+" "+Ext.baseCSSPrefix+"hidden",value:A.value,iframeName:Ext.id(),iframeSrc:Ext.SSL_SECURE_URL,iframeCls:Ext.baseCSSPrefix+"htmleditor-iframe"};A.getInsertionRenderData(B,A.subTplInsertions);return{flex:1,xtype:"component",tpl:A.getTpl("componentTpl"),childEls:["iframeEl","textareaEl"],id:C,cls:Ext.baseCSSPrefix+"html-editor-input",data:B}},createToolbar:function(){this.toolbar=Ext.widget(this.getToolbarCfg());return this.toolbar},getToolbarCfg:function(){var G=this,B=[],E,A=Ext.quickTipsActive&&Ext.tip.QuickTipManager.isEnabled(),D=Ext.baseCSSPrefix,H,F;function C(K,I,J){return{itemId:K,cls:D+"btn-icon",iconCls:D+"edit-"+K,enableToggle:I!==false,scope:G,handler:J||G.relayBtnCmd,clickEvent:"mousedown",tooltip:A?G.buttonTips[K]||F:F,overflowText:G.buttonTips[K].title||F,tabIndex:-1}}if(G.enableFont&&!Ext.isSafari2){H=Ext.widget("component",{itemId:"fontSelect",renderTpl:['<select id="{id}-selectEl" data-ref="selectEl" class="'+D+'font-select">',"</select>"],childEls:["selectEl"],afterRender:function(){G.fontSelect=this.selectEl;Ext.Component.prototype.afterRender.apply(this,arguments)},onDisable:function(){var I=this.selectEl;if(I){I.dom.disabled=true}Ext.Component.prototype.onDisable.apply(this,arguments)},onEnable:function(){var I=this.selectEl;if(I){I.dom.disabled=false}Ext.Component.prototype.onEnable.apply(this,arguments)},listeners:{change:function(){G.win.focus();G.relayCmd("fontName",G.fontSelect.dom.value);G.deferFocus()},element:"selectEl"}});B.push(H,"-")}if(G.enableFormat){B.push(C("bold"),C("italic"),C("underline"))}if(G.enableFontSize){B.push("-",C("increasefontsize",false,G.adjustFont),C("decreasefontsize",false,G.adjustFont))}if(G.enableColors){B.push("-",{itemId:"forecolor",cls:D+"btn-icon",iconCls:D+"edit-forecolor",overflowText:G.buttonTips.forecolor.title,tooltip:A?G.buttonTips.forecolor||F:F,tabIndex:-1,menu:Ext.widget("menu",{plain:true,items:[{xtype:"colorpicker",allowReselect:true,focus:Ext.emptyFn,value:"000000",plain:true,clickEvent:"mousedown",handler:function(J,I){G.relayCmd("forecolor",Ext.isWebKit||Ext.isIE?"#"+I:I);this.up("menu").hide()}}]})},{itemId:"backcolor",cls:D+"btn-icon",iconCls:D+"edit-backcolor",overflowText:G.buttonTips.backcolor.title,tooltip:A?G.buttonTips.backcolor||F:F,tabIndex:-1,menu:Ext.widget("menu",{plain:true,items:[{xtype:"colorpicker",focus:Ext.emptyFn,value:"FFFFFF",plain:true,allowReselect:true,clickEvent:"mousedown",handler:function(J,I){if(Ext.isGecko){G.execCmd("useCSS",false);G.execCmd("hilitecolor","#"+I);G.execCmd("useCSS",true);G.deferFocus()}else{G.relayCmd(Ext.isOpera?"hilitecolor":"backcolor",Ext.isWebKit||Ext.isIE||Ext.isOpera?"#"+I:I)}this.up("menu").hide()}}]})})}if(G.enableAlignments){B.push("-",C("justifyleft"),C("justifycenter"),C("justifyright"))}if(!Ext.isSafari2){if(G.enableLinks){B.push("-",C("createlink",false,G.createLink))}if(G.enableLists){B.push("-",C("insertorderedlist"),C("insertunorderedlist"))}if(G.enableSourceEdit){B.push("-",C("sourceedit",true,function(){G.toggleSourceEdit(!G.sourceEditMode)}))}}for(E=0;E<B.length;E++){if(B[E].itemId!=="sourceedit"){B[E].disabled=true}}return{xtype:"toolbar",defaultButtonUI:G.defaultButtonUI,cls:Ext.baseCSSPrefix+"html-editor-tb",enableOverflow:true,items:B,listeners:{click:function(I){I.preventDefault()},element:"el"}}},getMaskTarget:function(){return Ext.isGecko?this.inputCmp.el:this.bodyEl},setReadOnly:function(E){var D=this,C=D.textareaEl,B=D.iframeEl,A;D.readOnly=E;if(C){C.dom.readOnly=E}if(D.initialized){A=D.getEditorBody();if(Ext.isIE){B.setDisplayed(false);A.contentEditable=!E;B.setDisplayed(true)}else{D.setDesignMode(!E)}if(A){A.style.cursor=E?"default":"text"}D.disableItems(E)}},getDocMarkup:function(){var B=this,A=B.iframeEl.getHeight()-B.iframePad*2;return Ext.String.format('<!DOCTYPE html><html><head><style type="text/css">'+(Ext.isOpera||Ext.isIE?"p{margin:0;}":"")+"body{border:0;margin:0;padding:{0}px;direction:"+(B.rtl?"rtl;":"ltr;")+(Ext.isIE8?Ext.emptyString:"min-")+"height:{1}px;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;cursor:text;background-color:white;"+(Ext.isIE?"":"font-size:12px;font-family:{2}")+"}</style></head><body></body></html>",B.iframePad,A,B.defaultFont)},getEditorBody:function(){var A=this.getDoc();return A.body||A.documentElement},getDoc:function(){return this.iframeEl.dom.contentDocument||this.getWin().document},getWin:function(){return this.iframeEl.dom.contentWindow||window.frames[this.iframeEl.dom.name]},initDefaultFont:function(){var G=this,A=0,H,B,I,E,D,F,C;if(!G.defaultFont){B=G.textareaEl.getStyle("font-family");B=Ext.String.capitalize(B.split(",")[0]);H=Ext.Array.clone(G.fontFamilies);Ext.Array.include(H,B);H.sort();G.defaultFont=B;I=G.down("#fontSelect").selectEl.dom;for(D=0,F=H.length;D<F;++D){B=H[D];C=B.toLowerCase();E=new Option(B,C);if(B===G.defaultFont){A=D}E.style.fontFamily=C;if(Ext.isIE){I.add(E)}else{I.options.add(E)}}I.options[A].selected=true}},isEqual:function(B,A){return this.isEqualAsString(B,A)},afterRender:function(){var B=this,A=B.inputCmp;B.callParent(arguments);B.iframeEl=A.iframeEl;B.textareaEl=A.textareaEl;B.inputEl=B.iframeEl;if(B.enableFont){B.initDefaultFont()}B.monitorTask=Ext.TaskManager.start({run:B.checkDesignMode,scope:B,interval:100})},initFrameDoc:function(){var B=this,C,A;Ext.TaskManager.stop(B.monitorTask);C=B.getDoc();B.win=B.getWin();C.open();C.write(B.getDocMarkup());C.close();A={run:function(){var D=B.getDoc();if(D.body||D.readyState==="complete"){Ext.TaskManager.stop(A);B.setDesignMode(true);Ext.defer(B.initEditor,10,B)}},interval:10,duration:10000,scope:B};Ext.TaskManager.start(A)},checkDesignMode:function(){var A=this,B=A.getDoc();if(B&&(!B.editorInitialized||A.getDesignMode()!=="on")){A.initFrameDoc()}},setDesignMode:function(C){var A=this,B=A.getDoc();if(B){if(A.readOnly){C=false}B.designMode=(/on|true/i).test(String(C).toLowerCase())?"on":"off"}},getDesignMode:function(){var A=this.getDoc();return !A?"":String(A.designMode).toLowerCase()},disableItems:function(D){var B=this.getToolbar().items.items,C,A=B.length,E;for(C=0;C<A;C++){E=B[C];if(E.getItemId()!=="sourceedit"){E.setDisabled(D)}}},toggleSourceEdit:function(B){var F=this,D=F.iframeEl,A=F.textareaEl,E=Ext.baseCSSPrefix+"hidden",C=F.getToolbar().getComponent("sourceedit");if(!Ext.isBoolean(B)){B=!F.sourceEditMode}F.sourceEditMode=B;if(C.pressed!==B){C.toggle(B)}if(B){F.disableItems(true);F.syncValue();D.addCls(E);A.removeCls(E);A.dom.removeAttribute("tabIndex");A.focus();F.inputEl=A}else{if(F.initialized){F.disableItems(F.readOnly)}F.pushValue();D.removeCls(E);A.addCls(E);A.dom.setAttribute("tabIndex",-1);F.deferFocus();F.inputEl=D}F.fireEvent("editmodechange",F,B);F.updateLayout()},createLink:function(){var A=prompt(this.createLinkText,this.defaultLinkValue);if(A&&A!=="http://"){this.relayCmd("createlink",A)}},clearInvalid:Ext.emptyFn,setValue:function(C){var B=this,A=B.textareaEl;if(C===null||C===undefined){C=""}if(B.value!==C){if(A){A.dom.value=C}B.pushValue();if(!B.rendered&&B.inputCmp){B.inputCmp.data.value=C}B.mixins.field.setValue.call(B,C)}return B},cleanHtml:function(A){A=String(A);if(Ext.isWebKit){A=A.replace(this.safariNonsenseRE,"")}if(A.charCodeAt(0)===parseInt(this.defaultValue.replace(this.nonDigitsRE,""),10)){A=A.substring(1)}return A},syncValue:function(){var F=this,B,G,D,A,C,E;if(F.initialized){B=F.getEditorBody();D=B.innerHTML;E=F.textareaEl.dom;if(Ext.isWebKit){A=B.getAttribute("style");C=A.match(F.textAlignRE);if(C&&C[1]){D='<div style="'+C[0]+'">'+D+"</div>"}}D=F.cleanHtml(D);if(F.fireEvent("beforesync",F,D)!==false){if(Ext.isGecko&&E.value===""&&D==="<br>"){D=""}if(E.value!==D){E.value=D;G=true}F.fireEvent("sync",F,D);if(G){F.checkChange()}}}},getValue:function(){var A=this,B;if(!A.sourceEditMode){A.syncValue()}B=A.rendered?A.textareaEl.dom.value:A.value;A.value=B;return B},pushValue:function(){var B=this,A;if(B.initialized){A=B.textareaEl.dom.value||"";if(!B.activated&&A.length<1){A=B.defaultValue}if(B.fireEvent("beforepush",B,A)!==false){B.getEditorBody().innerHTML=A;if(Ext.isGecko){B.setDesignMode(false);B.setDesignMode(true)}B.fireEvent("push",B,A)}}},focus:function(D,B){var C=this,E,A;if(B){if(!C.focusTask){C.focusTask=new Ext.util.DelayedTask(C.focus)}C.focusTask.delay(Ext.isNumber(B)?B:10,null,C,[D,false])}else{if(D){if(C.textareaEl&&C.textareaEl.dom){E=C.textareaEl.dom.value}if(E&&E.length){C.execCmd("selectall",true)}}A=C.getFocusEl();if(A&&A.focus){A.focus()}}return C},initEditor:function(){var D=this,C,A,F,G,B;if(D.destroying||D.destroyed){return }C=D.getEditorBody();if(!C){setTimeout(function(){D.initEditor()},10);return }A=D.textareaEl.getStyle(["font-size","font-family","background-image","background-repeat","background-color","color"]);A["background-attachment"]="fixed";C.bgProperties="fixed";Ext.DomHelper.applyStyles(C,A);F=D.getDoc();G=Ext.get(F);if(G){try{G.clearListeners()}catch(E){}B=D.onEditorEvent.bind(D);G.on({mousedown:B,dblclick:B,click:B,keyup:B,delegated:false,buffer:100});B=D.onRelayedEvent;G.on({mousedown:B,mousemove:B,mouseup:B,click:B,dblclick:B,delegated:false,scope:D});if(Ext.isGecko){G.on("keypress",D.applyCommand,D)}if(D.fixKeys){G.on("keydown",D.fixKeys,D,{delegated:false})}if(D.fixKeysAfter){G.on("keyup",D.fixKeysAfter,D,{delegated:false})}if(Ext.isIE9){Ext.get(F.documentElement).on("focus",D.focus,D)}if(Ext.isIE8){G.on("focusout",function(){D.savedSelection=F.selection.type!=="None"?F.selection.createRange():null},D);G.on("focusin",function(){if(D.savedSelection){D.savedSelection.select()}},D)}Ext.getWin().on("beforeunload",D.beforeDestroy,D);F.editorInitialized=true;D.initialized=true;D.pushValue();D.setReadOnly(D.readOnly);D.fireEvent("initialize",D)}},beforeDestroy:function(){var A=this,D=A.monitorTask,C,E;if(D){Ext.TaskManager.stop(D)}if(A.rendered){Ext.getWin().un(A.beforeDestroy,A);C=A.getDoc();if(C){Ext.get(C).destroy();if(C.hasOwnProperty){for(E in C){try{if(C.hasOwnProperty(E)){delete C[E]}}catch(B){}}}}delete A.iframeEl;delete A.textareaEl;delete A.toolbar;delete A.inputCmp}A.callParent()},onRelayedEvent:function(C){var B=this.iframeEl,D=Ext.fly(B).getTrueXY(),E=C.getXY(),A=C.getXY();C.xy=[D[0]+A[0],D[1]+A[1]];C.injectEvent(B);C.xy=E},onFirstFocus:function(){var C=this,B,A;C.activated=true;C.disableItems(C.readOnly);if(Ext.isGecko){C.win.focus();B=C.win.getSelection();if(B.focusNode&&!C.getValue().length){A=B.getRangeAt(0);A.selectNodeContents(C.getEditorBody());A.collapse(true);C.deferFocus()}try{C.execCmd("useCSS",true);C.execCmd("styleWithCSS",false)}catch(D){}}C.fireEvent("activate",C)},adjustFont:function(D){var E=D.getItemId()==="increasefontsize"?1:-1,C=this.getDoc().queryCommandValue("FontSize")||"2",A=Ext.isString(C)&&C.indexOf("px")!==-1,B;C=parseInt(C,10);if(A){if(C<=10){C=1+E}else{if(C<=13){C=2+E}else{if(C<=16){C=3+E}else{if(C<=18){C=4+E}else{if(C<=24){C=5+E}else{C=6+E}}}}}C=Ext.Number.constrain(C,1,6)}else{B=Ext.isSafari;if(B){E*=2}C=Math.max(1,C+E)+(B?"px":0)}this.relayCmd("FontSize",C)},onEditorEvent:function(){this.updateToolbar()},updateToolbar:function(){var H=this,E,C,D,I,B,F,A,G;if(H.readOnly){return }if(!H.activated){H.onFirstFocus();return }D=H.getToolbar().items.map;I=H.getDoc();if(H.enableFont&&!Ext.isSafari2){F=I.queryCommandValue("fontName");B=(F?F.split(",")[0].replace(H.reStripQuotes,""):H.defaultFont).toLowerCase();A=H.fontSelect.dom;if(B!==A.value||B!==F){A.value=B}}function J(){var K;for(E=0,C=arguments.length,B;E<C;E++){B=arguments[E];try{K=I.queryCommandState(B)}catch(L){K=false}D[B].toggle(K)}}if(H.enableFormat){J("bold","italic","underline")}if(H.enableAlignments){J("justifyleft","justifycenter","justifyright")}if(!Ext.isSafari2&&H.enableLists){J("insertorderedlist","insertunorderedlist")}G=H.toolbar.query("menu");for(E=0;E<G.length;E++){G[E].hide()}H.syncValue()},relayBtnCmd:function(A){this.relayCmd(A.getItemId())},relayCmd:function(B,A){Ext.defer(function(){var C=this;if(!this.destroyed){C.win.focus();C.execCmd(B,A);C.updateToolbar()}},10,this)},execCmd:function(C,B){var A=this,D=A.getDoc();D.execCommand(C,false,(B===undefined?null:B));A.syncValue()},applyCommand:function(C){if(C.ctrlKey){var A=this,D=C.getCharCode(),B;if(D>0){D=String.fromCharCode(D);switch(D){case"b":B="bold";break;case"i":B="italic";break;case"u":B="underline";break}if(B){A.win.focus();A.execCmd(B);A.deferFocus();C.preventDefault()}}}},insertAtCursor:function(J){var H=this,G=H.getWin(),I=H.getDoc(),C,F,D,K,E,B,A;if(H.activated){G.focus();if(G.getSelection){C=G.getSelection();if(C.getRangeAt&&C.rangeCount){F=C.getRangeAt(0);F.deleteContents();D=I.createElement("div");D.innerHTML=J;K=I.createDocumentFragment();while((E=D.firstChild)){B=K.appendChild(E)}A=K.firstChild;F.insertNode(K);if(B){F=F.cloneRange();F.setStartAfter(B);F.collapse(true);C.removeAllRanges();C.addRange(F)}}}else{if(I.selection&&C.type!=="Control"){C=I.selection;F=C.createRange();F.collapse(true);C.createRange().pasteHTML(J)}}H.deferFocus()}},fixKeys:(function(){var A;if(Ext.isIE10m){return function(G){var D=this,C=G.getKey(),F=D.getDoc(),H=D.readOnly,B,E;if(C===G.TAB){G.stopEvent();if(!H){B=F.selection.createRange();if(B){if(B.collapse){B.collapse(true);B.pasteHTML("&#160;&#160;&#160;&#160;")}D.deferFocus()}}}}}if(Ext.isOpera){return function(D){var C=this,B=D.getKey(),E=C.readOnly;if(B===D.TAB){D.stopEvent();if(!E){C.win.focus();C.execCmd("InsertHTML","&#160;&#160;&#160;&#160;");C.deferFocus()}}}}return null}()),fixKeysAfter:(function(){if(Ext.isIE){return function(D){var B=this,A=D.getKey(),C=B.getDoc(),F=B.readOnly,E;if(!F&&(A===D.BACKSPACE||A===D.DELETE)){E=C.body.innerHTML;if(E==="<p>&nbsp;</p>"||E==="<P>&nbsp;</P>"){C.body.innerHTML=""}}}}return null}()),getToolbar:function(){return this.toolbar},buttonTips:{bold:{title:"Bold (Ctrl+B)",text:"Make the selected text bold.",cls:Ext.baseCSSPrefix+"html-editor-tip"},italic:{title:"Italic (Ctrl+I)",text:"Make the selected text italic.",cls:Ext.baseCSSPrefix+"html-editor-tip"},underline:{title:"Underline (Ctrl+U)",text:"Underline the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},increasefontsize:{title:"Grow Text",text:"Increase the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},decreasefontsize:{title:"Shrink Text",text:"Decrease the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},backcolor:{title:"Text Highlight Color",text:"Change the background color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},forecolor:{title:"Font Color",text:"Change the color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyleft:{title:"Align Text Left",text:"Align text to the left.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifycenter:{title:"Center Text",text:"Center text in the editor.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyright:{title:"Align Text Right",text:"Align text to the right.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertunorderedlist:{title:"Bullet List",text:"Start a bulleted list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertorderedlist:{title:"Numbered List",text:"Start a numbered list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},createlink:{title:"Hyperlink",text:"Make the selected text a hyperlink.",cls:Ext.baseCSSPrefix+"html-editor-tip"},sourceedit:{title:"Source Edit",text:"Switch to source editing mode.",cls:Ext.baseCSSPrefix+"html-editor-tip"}},privates:{deferFocus:function(){this.focus(false,true)},getFocusEl:function(){return this.sourceEditMode?this.textareaEl:this.iframeEl}}})