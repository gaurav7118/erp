Ext.define("Ext.form.field.Tag",{extend:"Ext.form.field.ComboBox",requires:["Ext.selection.Model","Ext.data.Store","Ext.data.ChainedStore"],xtype:"tagfield",noWrap:false,multiSelect:true,delimiter:",",tipTpl:undefined,forceSelection:true,createNewOnEnter:false,createNewOnBlur:false,encodeSubmitValue:false,triggerOnClick:true,stacked:false,filterPickList:false,grow:true,growMin:false,growMax:false,selectOnFocus:true,fieldSubTpl:['<div id="{cmpId}-listWrapper" data-ref="listWrapper" class="'+Ext.baseCSSPrefix+'tagfield {fieldCls} {typeCls} {typeCls}-{ui}" style="{wrapperStyle}">','<ul id="{cmpId}-itemList" data-ref="itemList" class="'+Ext.baseCSSPrefix+'tagfield-list{itemListCls}">','<li id="{cmpId}-inputElCt" data-ref="inputElCt" class="'+Ext.baseCSSPrefix+'tagfield-input">','<div id="{cmpId}-emptyEl" data-ref="emptyEl" class="{emptyCls}">{emptyText}</div>','<input id="{cmpId}-inputEl" data-ref="inputEl" type="{type}" ','<tpl if="name">name="{name}" </tpl>','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>','<tpl if="size">size="{size}" </tpl>','<tpl if="tabIdx != null">tabindex="{tabIdx}" </tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','class="'+Ext.baseCSSPrefix+'tagfield-input-field {inputElCls}" autocomplete="off">',"</li>","</ul>","</div>",{disableFormats:true}],extraFieldBodyCls:Ext.baseCSSPrefix+"tagfield-body",childEls:["listWrapper","itemList","inputEl","inputElCt","emptyEl"],emptyInputCls:Ext.baseCSSPrefix+"tagfield-emptyinput",clearValueOnEmpty:false,tagItemCls:Ext.baseCSSPrefix+"tagfield-item",tagItemTextCls:Ext.baseCSSPrefix+"tagfield-item-text",tagItemCloseCls:Ext.baseCSSPrefix+"tagfield-item-close",tagItemSelector:"."+Ext.baseCSSPrefix+"tagfield-item",tagItemCloseSelector:"."+Ext.baseCSSPrefix+"tagfield-item-close",tagSelectedCls:Ext.baseCSSPrefix+"tagfield-item-selected",initComponent:function(){var C=this,B=C.typeAhead,A=C.delimiter;if(B&&!C.editable){Ext.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}if(C.createNewOnEnter||C.createNewOnBlur){C.forceSelection=false}C.typeAhead=false;if(C.value==null){C.value=[]}C.selectionModel=new Ext.selection.Model({mode:"MULTI",onSelectChange:function(D,F,E,G){G()},listeners:{scope:C,selectionchange:C.onSelectionChange,focuschange:C.onFocusChange}});C.callParent();C.typeAhead=B;if(A&&C.multiSelect){C.delimiterRegexp=new RegExp(Ext.String.escapeRegex(A))}},initEvents:function(){var A=this,B=A.inputEl;A.callParent(arguments);if(!A.enableKeyEvents){B.on("keydown",A.onKeyDown,A);B.on("keyup",A.onKeyUp,A)}A.listWrapper.on({scope:A,click:A.onItemListClick,mousedown:A.onItemMouseDown})},isValid:function(){var B=this,A=B.disabled,C=B.forceValidation||!A;return C?B.validateValue(B.getValue()):A},onBindStore:function(A){var B=this;B.callParent([A]);if(A){B.valueStore=new Ext.data.Store({model:A.getModel(),useModelWarning:false});B.selectionModel.bindStore(B.valueStore);if(B.filterPickList){B.listFilter=new Ext.util.Filter({scope:B,filterFn:B.filterPicked});B.changingFilters=true;A.filter(B.listFilter);B.changingFilters=false}}},filterPicked:function(A){return !this.valueCollection.contains(A)},onUnbindStore:function(A){var C=this,D=C.valueStore,B=C.picker;if(B){B.bindStore(null)}if(D){D.destroy();C.valueStore=null}if(C.filterPickList&&!A.destroyed){C.changingFilters=true;A.removeFilter(C.listFilter);C.changingFilters=false}C.callParent(arguments)},onValueCollectionEndUpdate:function(){var A=this,C=A.valueCollection.items,B=A.valueStore;if(A.isSelectionUpdating()){return }if(A.filterPickList){A.changingFilters=true;A.store.filter(A.listFilter);A.changingFilters=false}A.callParent();Ext.suspendLayouts();if(B){B.suspendEvents();B.loadRecords(C);B.resumeEvents()}Ext.resumeLayouts(true);A.alignPicker()},checkValueOnDataChange:Ext.emptyFn,onSelectionChange:function(A,B){this.applyMultiselectItemMarkup();this.fireEvent("valueselectionchange",this,B)},onFocusChange:function(A,C,B){this.fireEvent("valuefocuschange",this,C,B)},onDestroy:function(){this.selectionModel=Ext.destroy(this.selectionModel);this.callParent(arguments)},getSubTplData:function(C){var H=this,G=H.callParent(arguments),D=H.emptyText,E=H.emptyInputCls,F=D&&G.value.length<1,I=H.growMin,A=H.growMax,B="";G.value="";G.emptyText=F?D:"";G.emptyCls=F?H.emptyCls:E;G.inputElCls=F?E:"";G.itemListCls="";if(H.grow){if(Ext.isNumber(I)&&I>0){B+="min-height:"+I+"px;"}if(Ext.isNumber(A)&&A>0){B+="max-height:"+A+"px;"}}G.wrapperStyle=B;if(H.stacked===true){G.itemListCls+=" "+Ext.baseCSSPrefix+"tagfield-stacked"}if(!H.multiSelect){G.itemListCls+=" "+Ext.baseCSSPrefix+"tagfield-singleselect"}return G},afterRender:function(){var B=this,C=B.inputEl,A=B.emptyText;if(A){if(Ext.supports.Placeholder&&C){C.dom.removeAttribute("placeholder")}else{B.applyEmptyText()}}B.applyMultiselectItemMarkup();B.callParent(arguments)},findRecord:function(C,B){var A=this.getStore().queryRecords(C,B);return A.length?A[0]:false},getCursorPosition:function(){var A;if(document.selection){A=document.selection.createRange();A.collapse(true);A.moveStart("character",-this.inputEl.dom.value.length);A=A.text.length}else{A=this.inputEl.dom.selectionStart}return A},hasSelectedText:function(){var C=this.inputEl.dom,B,A;if(document.selection){B=document.selection;A=B.createRange();return(A.parentElement()===C)}else{return C.selectionStart!==C.selectionEnd}},onKeyDown:function(E){var F=this,I=E.getKey(),H=F.inputEl,C=H.dom.value,A=F.valueCollection,D=F.selectionModel,B=false,G;if(F.readOnly||F.disabled||!F.editable){return }if(A.getCount()>0&&(C===""||(F.getCursorPosition()===0&&!F.hasSelectedText()))){G=(D.getCount()>0)?A.indexOf(D.getLastSelected()):-1;if(I===E.BACKSPACE||I===E.DELETE){if(G>-1){if(D.getCount()>1){G=-1}A.remove(D.getSelection())}else{A.remove(A.last())}D.clearSelections();if(G>0){D.select(G-1)}else{if(A.getCount()){D.select(A.last())}}B=true}else{if(I===E.RIGHT||I===E.LEFT){if(G===-1&&I===E.LEFT){D.select(A.last());B=true}else{if(G>-1){if(I===E.RIGHT){if(G<(A.getCount()-1)){D.select(G+1,E.shiftKey);B=true}else{if(!E.shiftKey){D.deselectAll();B=true}}}else{if(I===E.LEFT&&(G>0)){D.select(G-1,E.shiftKey);B=true}}}}}else{if(I===E.A&&E.ctrlKey){D.selectAll();B=E.A}}}}if(B){F.preventKeyUpEvent=B;E.stopEvent();return }if(F.isExpanded&&I===E.ENTER&&F.picker.highlightedItem){F.preventKeyUpEvent=true}if(F.enableKeyEvents){F.callParent(arguments)}if(!E.isSpecialKey()&&!E.hasModifier()){D.deselectAll()}},onKeyUp:function(F,B){var C=this,E=C.inputEl,D=E.dom.value,A=C.preventKeyUpEvent;if(C.preventKeyUpEvent){F.stopEvent();if(A===true||F.getKey()===A){delete C.preventKeyUpEvent}return }if(C.multiSelect&&C.delimiterRegexp&&C.delimiterRegexp.test(D)||(C.createNewOnEnter&&F.getKey()===F.ENTER)){D=Ext.Array.clean(D.split(C.delimiterRegexp));E.dom.value="";C.setValue(C.valueStore.getRange().concat(D));E.focus()}C.callParent([F,B])},onTypeAhead:function(){var F=this,E=F.displayField,D=F.inputEl.dom,C=F.getPicker(),B=F.getStore().findRecord(E,D.value),G,A,H;if(B){G=B.get(E);A=G.length;H=D.value.length;C.highlightItem(C.getNode(B));if(H!==0&&H!==A){D.value=G;F.selectText(H,G.length)}}},onItemListClick:function(D){var C=this,A=C.selectionModel,B=D.getTarget(C.tagItemSelector),E=B?D.getTarget(C.tagItemCloseSelector):false;if(C.readOnly||C.disabled){return }D.stopPropagation();if(B){if(E){C.removeByListItemNode(B);if(C.valueStore.getCount()>0){C.fireEvent("select",C,C.valueStore.getRange())}}else{C.toggleSelectionByListItemNode(B,D.shiftKey)}if(!Ext.supports.TouchEvents){C.inputEl.focus()}}else{if(A.getCount()>0){A.deselectAll()}C.inputEl.focus();if(C.triggerOnClick){C.onTriggerClick()}}},onItemMouseDown:function(A){A.preventDefault()},getMultiSelectItemMarkup:function(){var B=this,A=(B._getChildElCls&&B._getChildElCls())||"";if(!B.multiSelectItemTpl){if(!B.labelTpl){B.labelTpl="{"+B.displayField+"}"}B.labelTpl=B.getTpl("labelTpl");if(B.tipTpl){B.tipTpl=B.getTpl("tipTpl")}B.multiSelectItemTpl=new Ext.XTemplate(['<tpl for=".">','<li data-selectionIndex="{[xindex - 1]}" data-recordId="{internalId}" class="'+B.tagItemCls+A,'<tpl if="this.isSelected(values)">'," "+B.tagSelectedCls,"</tpl>","{%","values = values.data;","%}",B.tipTpl?'" data-qtip="{[this.getTip(values)]}">':'">','<div class="'+B.tagItemTextCls+'">{[this.getItemLabel(values)]}</div>','<div class="'+B.tagItemCloseCls+A+'"></div>',"</li>","</tpl>",{isSelected:function(C){return B.selectionModel.isSelected(C)},getItemLabel:function(C){return Ext.String.htmlEncode(B.labelTpl.apply(C))},getTip:function(C){return Ext.String.htmlEncode(B.tipTpl.apply(C))},strict:true}])}if(!B.multiSelectItemTpl.isTemplate){B.multiSelectItemTpl=this.getTpl("multiSelectItemTpl")}return B.multiSelectItemTpl.apply(B.valueCollection.getRange())},applyMultiselectItemMarkup:function(){var B=this,A=B.itemList;if(A){A.select("."+Ext.baseCSSPrefix+"tagfield-item").destroy();B.inputElCt.insertHtml("beforeBegin",B.getMultiSelectItemMarkup());B.autoSize()}},getRecordByListItemNode:function(A){return this.valueCollection.items[Number(A.getAttribute("data-selectionIndex"))]},toggleSelectionByListItemNode:function(B,D){var C=this,E=C.getRecordByListItemNode(B),A=C.selectionModel;if(E){if(A.isSelected(E)){A.deselect(E)}else{A.select(E,D)}}},removeByListItemNode:function(A){var B=this,C=B.getRecordByListItemNode(A);if(C){B.pickerSelectionModel.deselect(C)}},getDisplayValue:function(){return this.getRawValue()},getRawValue:function(){var E=this,C=E.getValueRecords(),B=[],D,A;for(D=0,A=C.length;D<A;D++){B.push(C[D].data[E.displayField])}return B.join(",")},setRawValue:function(A){return },removeValue:function(G){var F=this,B=F.valueCollection,A,C,E,D=[];if(G){G=Ext.Array.from(G);for(C=0,A=G.length;C<A;++C){E=G[C];if(!E.isModel){E=B.byValue.get(E)}if(E){D.push(E)}}F.valueCollection.beginUpdate();F.pickerSelectionModel.deselect(D);F.valueCollection.endUpdate()}},setValue:function(L,J,D){var R=this,G=R.valueStore,A=R.valueField,I=[],H=R.store,N=R.autoLoadOnValue,F=H.getCount()>0||H.isLoaded(),B=H.hasPendingLoad(),K=N&&!F&&!B,E,P,O,M,C,Q;if(Ext.isEmpty(L)){L=null}else{if(Ext.isString(L)&&R.multiSelect){L=L.split(R.delimiter)}else{L=Ext.Array.from(L,true)}}if(L&&R.queryMode==="remote"&&!H.isEmptyStore&&D!==true&&K){for(O=0,P=L.length;O<P;O++){E=L[O];if(!E||!E.isModel){M=G.findExact(A,E);if(M>-1){L[O]=G.getAt(M)}else{M=R.findRecord(A,E);if(!M){if(R.forceSelection){I.push(E)}else{M={};M[R.valueField]=E;M[R.displayField]=E;C=R.valueStore.getModel();M=new C(M)}}if(M){L[O]=M}}}}if(I.length){Q={};Q[R.valueParam||R.valueField]=I.join(R.delimiter);H.load({params:Q,callback:function(){R.setValue(L,J,true);R.autoSize();R.lastQuery=false}});return false}}if(!R.multiSelect&&L.length>0){for(O=L.length-1;O>=0;O--){if(L[O].isModel){L=L[O];break}}if(Ext.isArray(L)){L=L[L.length-1]}}return R.callParent([L,J])},updateValue:function(){var D=this,C=D.valueCollection.getRange(),A=C.length,B;for(B=0;B<A;B++){C[B]=C[B].get(D.valueField)}D.setHiddenValue(C);D.value=D.multiSelect?C:C[0];if(!Ext.isDefined(D.value)){D.value=undefined}D.applyMultiselectItemMarkup();D.checkChange();D.applyEmptyText()},getValueRecords:function(){return this.valueCollection.getRange()},getSubmitData:function(){var A=this,B=A.callParent(arguments);if(A.multiSelect&&A.encodeSubmitValue&&B&&B[A.name]){B[A.name]=Ext.encode(B[A.name])}return B},assertValue:function(){var A=this,C=A.inputEl.dom.value,D=!Ext.isEmpty(C)?A.findRecordByDisplay(C):false,B=false;if(!D&&!A.forceSelection&&A.createNewOnBlur&&!Ext.isEmpty(C)){B=C}else{if(D){B=D}}if(B){A.addValue(B)}A.inputEl.dom.value="";A.collapse()},isEqual:function(H,G){var B=Ext.Array.from,C=this.valueField,D,A,F,E;H=B(H);G=B(G);A=H.length;if(A!==G.length){return false}for(D=0;D<A;D++){F=H[D].isModel?H[D].get(C):H[D];E=G[D].isModel?G[D].get(C):G[D];if(F!==E){return false}}return true},applyEmptyText:function(){var F=this,B=F.emptyText,D=F.emptyEl,G=F.inputEl,A=F.listWrapper,E=F.emptyCls,C=F.emptyInputCls,H;if(F.rendered&&B){H=Ext.isEmpty(F.value)&&!F.hasFocus;if(H){G.dom.value="";D.setHtml(B);D.addCls(E);D.removeCls(C);A.addCls(E);G.addCls(C)}else{D.addCls(C);D.removeCls(E);A.removeCls(E);G.removeCls(C)}F.autoSize()}},preFocus:function(){var A=this,B=A.inputEl,C=B.dom.value==="";A.emptyEl.addCls(A.emptyInputCls);A.emptyEl.removeCls(A.emptyCls);A.listWrapper.removeCls(A.emptyCls);A.inputEl.removeCls(A.emptyInputCls);if(A.selectOnFocus||C){B.dom.select()}},onFocus:function(){var C=this,B=C.focusCls,A=C.itemList;if(B&&A){A.addCls(B)}C.callParent(arguments)},onBlur:function(){var C=this,B=C.focusCls,A=C.itemList;if(B&&A){A.removeCls(B)}C.callParent(arguments)},renderActiveError:function(){var D=this,C=D.invalidCls,B=D.itemList,A=D.hasActiveError();if(C&&B){B[A?"addCls":"removeCls"](D.invalidCls+"-field")}D.callParent(arguments)},autoSize:function(){var A=this;if(A.grow&&A.rendered){A.autoSizing=true;A.updateLayout()}return A},afterComponentLayout:function(){var B=this,A;if(B.autoSizing){A=B.getHeight();if(A!==B.lastInputHeight){if(B.isExpanded){B.alignPicker()}B.fireEvent("autosize",B,A);B.lastInputHeight=A;B.autoSizing=false}}}})