Ext.define("Ext.grid.RowEditor",{extend:"Ext.form.Panel",alias:"widget.roweditor",requires:["Ext.tip.ToolTip","Ext.util.KeyNav","Ext.grid.RowEditorButtons"],saveBtnText:"Update",cancelBtnText:"Cancel",errorsText:"Errors",dirtyText:"You need to commit or cancel your changes",lastScrollLeft:0,lastScrollTop:0,border:false,_wrapCls:Ext.baseCSSPrefix+"grid-row-editor-wrap",errorCls:Ext.baseCSSPrefix+"grid-row-editor-errors-item",buttonUI:"default",hideMode:"offsets",_cachedNode:false,initComponent:function(){var D=this,B=D.editingPlugin.grid,A=Ext.container.Container,C,E,F;D.cls=Ext.baseCSSPrefix+"grid-editor "+Ext.baseCSSPrefix+"grid-row-editor";D.layout={type:"hbox",align:"middle"};D.lockable=B.lockable;if(D.lockable){D.items=[F=D.lockedColumnContainer=new A({id:B.id+"-locked-editor-cells",scrollable:{x:false,y:false},layout:{type:"hbox",align:"middle"},margin:"0 1 0 0"}),E=D.normalColumnContainer=new A({scrollable:{x:false,y:false},flex:1,id:B.id+"-normal-editor-cells",layout:{type:"hbox",align:"middle"}})];F.getScrollable().addPartner(B.lockedGrid.view.getScrollable(),"x");E.getScrollable().addPartner(B.normalGrid.view.getScrollable(),"x")}else{D.setScrollable({x:false,y:false});D.getScrollable().addPartner(B.view.getScrollable(),"x");D.lockedColumnContainer=D.normalColumnContainer=D}D.callParent();if(D.fields){D.addFieldsForColumn(D.fields,true);D.insertColumnEditor(D.fields);delete D.fields}D.mon(Ext.GlobalEvents,{scope:D,show:D.repositionIfVisible});C=D.getForm();C.trackResetOnLoad=true;C.on("validitychange",D.onValidityChange,D);C.on("errorchange",D.onErrorChange,D)},onGridResize:function(){var C=this,E=C.getClientWidth(),A=C.editingPlugin.grid,D=A.body,B=C.getFloatingButtons();C.wrapEl.setLocalX(D.getOffsetsTo(A)[0]+D.getBorderWidth("l")-A.el.getBorderWidth("l"));C.setWidth(E);B.setLocalX((E-B.getWidth())/2);if(C.lockable){C.lockedColumnContainer.setWidth(A.lockedGrid.view.el.dom.clientWidth)}},syncAllFieldWidths:function(){var E=this,D=E.query("[isEditorComponent]"),A=D.length,C,B;for(B=0;B<A;++B){C=D[B].column;if(C.isVisible()){E.onColumnShow(C)}}},syncFieldWidth:function(B){var C=B.getEditor(),A;C._marginWidth=(C._marginWidth||C.el.getMargin("lr"));A=B.getWidth()-C._marginWidth;C.setWidth(A);if(C.xtype==="displayfield"){C.inputWidth=A}},onValidityChange:function(B,A){this.updateButton(A)},onErrorChange:function(){var B=this,A;if(B.errorSummary&&B.isVisible()){A=B.getForm().isValid();B[A?"hideToolTip":"showToolTip"]()}},updateButton:function(B){var A=this.floatingButtons;if(A){A.child("#update").setDisabled(!B)}else{this.updateButtonDisabled=!B}},afterRender:function(){var D=this,C=D.editingPlugin,B=C.grid,A=B.lockable?B.normalGrid.view:B.view;D.callParent(arguments);D.scrollingView=A;D.scrollingViewEl=A.el;A.on("scroll",D.onViewScroll,D);D.mon(D.el,{click:Ext.emptyFn,stopPropagation:true});D.mon(B,"resize",D.onGridResize,D);if(D.lockable){B.lockedGrid.view.on("resize","onGridResize",D)}D.el.swallowEvent(["keypress","keydown"]);D.initKeyNav();D.mon(C.view,{beforerefresh:D.onBeforeViewRefresh,refresh:D.onViewRefresh,itemremove:D.onViewItemRemove,scope:D});D.preventReposition=true;D.syncAllFieldWidths();delete D.preventReposition},initKeyNav:function(){var B=this,A=B.editingPlugin;B.keyNav=new Ext.util.KeyNav(B.el,{tab:{fn:B.onFieldTab,scope:B},enter:A.onEnterKey,esc:A.onEscKey,scope:A})},onBeforeViewRefresh:function(B){var C=this,A=B.el.dom;if(C.el.dom.parentNode===A){A.removeChild(C.el.dom)}},onViewRefresh:function(A){var C=this,B=C.context,D;if(!C.completing){if(B&&(D=A.getRow(B.record))){B.row=D;C.reposition();if(C.tooltip&&C.tooltip.isVisible()){C.tooltip.setTarget(B.row)}}else{C.editingPlugin.cancelEdit()}}},onViewItemRemove:function(D,G,H,J){var I=this,B,K,A,C,E,F;if(!J.refreshing){F=I.editingPlugin;B=F.grid;K=B.getStore();A=I.editingPlugin.view;C=this.context;if(K.getById(I.getRecord().getId())&&!I._cachedNode){if(F.editing){this._cachedNode=true;this.mon(A,{itemadd:I.onViewItemAdd,scope:I})}}else{if(!I._cachedNode){this.activeField=null;this.editingPlugin.cancelEdit()}}}},onViewItemAdd:function(C,D,B,A){var G=this,H,F=G.editingPlugin;if(G._cachedNode&&F.editing){H=F.view;for(var E=0;E<C.length;E++){if(C[E]===G.context.record){G.context.node=B[E];G.context.row=H.getRow(B[E]);G.context.cell=H.getCellByPosition(G.context,true);G.clearCache();break}}}},onViewScroll:function(){var C=this,B=C.editingPlugin.view.el,G=C.scrollingView,D=G.getScrollY(),F=G.getScrollX(),A=D!==C.lastScrollTop,E;C.lastScrollTop=D;C.lastScrollLeft=F;if(C.isVisible()){E=Ext.getDom(C.context.row);if(E&&B.contains(E)){if(C.getLocalY()){C.setLocalY(0)}if(A){C.context.row=E;C.reposition(null,true);if((C.tooltip&&C.tooltip.isVisible())||C.hiddenTip){C.repositionTip()}C.syncEditorClip()}}else{C.setLocalY(-400)}}},onColumnResize:function(B,A){var C=this;if(C.rendered&&!C.editingPlugin.reconfiguring){C.onGridResize();C.onViewScroll();if(!B.isGroupHeader){C.syncFieldWidth(B);C.repositionIfVisible()}}},onColumnHide:function(A){if(!this.editingPlugin.reconfiguring&&!A.isGroupHeader){A.getEditor().hide();this.repositionIfVisible()}},onColumnShow:function(A){var B=this;if(B.rendered&&!B.editingPlugin.reconfiguring&&!A.isGroupHeader&&A.getEditor){A.getEditor().show();B.syncFieldWidth(A);if(!B.preventReposition){this.repositionIfVisible()}}},onColumnMove:function(C,A,K){var J=this,G=C.isLocked(),H=G?J.lockedColumnContainer:J.normalColumnContainer,D,F,I,B,E;if(C.isGroupHeader){Ext.suspendLayouts();B=K>A;E=B?1:0;D=C.getGridColumns();for(F=0,I=D.length;F<I;++F){C=D[F];K=C.getIndex();if(B){++E}J.setColumnEditor(C,K+E,H)}Ext.resumeLayouts(true)}else{J.setColumnEditor(C,C.getIndex(),H)}},setColumnEditor:function(B,A,C){this.addFieldsForColumn(B);C.insert(A,B.getEditor())},onColumnAdd:function(A){if(A.isGroupHeader){A=A.getGridColumns()}this.addFieldsForColumn(A);this.insertColumnEditor(A);this.preventReposition=false},insertColumnEditor:function(C){var D=this,E,F,A,B;if(Ext.isArray(C)){for(B=0,A=C.length;B<A;B++){D.insertColumnEditor(C[B])}return }if(!C.getEditor){return }F=C.isLocked()?D.lockedColumnContainer:D.normalColumnContainer;F.insert(C.getIndex(),E=C.getEditor());E.on("focus",D.onFieldFocus,D);D.needsSyncFieldWidths=true},onFieldFocus:function(A){if(Ext.isIE){A.inputEl.dom.value=A.inputEl.dom.value}this.activeField=A;this.context.setColumn(A.column);if(!this.skipFocusScroll){A.column.getView().getScrollable().scrollIntoView(A.el)}else{this.skipFocusScroll=null}},onFieldTab:function(F){var D=this,A=D.activeField,C=D.context.rowIdx,B=!F.shiftKey,E=A[B?"nextNode":"previousNode"](":focusable");if(!E||!E.isDescendant(D)){if(D.isDirty()){F.preventDefault();D.floatingButtons.child("#update").focus()}else{C=C+(B?1:-1);if(C>=0&&C<=D.view.dataSource.getCount()){if(B){E=D.down(":focusable:not([isButton]):first");A.column.getView().getScrollable().scrollIntoView(A.ownerCt.child(":focusable").el)}else{E=D.down(":focusable:not([isButton]):last")}D.editingPlugin.startEdit(C,E.column)}}}},destroyColumnEditor:function(A){var B;if(A.hasEditor()&&(B=A.getEditor())){B.destroy()}},getFloatingButtons:function(){var B=this,A=B.floatingButtons;if(!A){B.floatingButtons=A=new Ext.grid.RowEditorButtons({ownerCmp:B,rowEditor:B})}return A},repositionIfVisible:function(C){var B=this,A=B.view;if(C&&(C===B||!C.el.isAncestor(A.el))){return }if(B.isVisible()&&A.isVisible(true)){B.reposition()}},isLayoutChild:function(A){return false},getRefOwner:function(){return this.editingPlugin.grid},getRefItems:function(B){var C=this,A;if(C.lockable){A=[C.lockedColumnContainer];A.push.apply(A,C.lockedColumnContainer.getRefItems(B));A.push(C.normalColumnContainer);A.push.apply(A,C.normalColumnContainer.getRefItems(B))}else{A=C.callParent(arguments)}A.push.apply(A,C.getFloatingButtons().getRefItems(B));return A},reposition:function(H,E){var F=this,B=F.context,J=B&&B.row,I=F.wrapEl,A,C,D,G;if(J&&Ext.isElement(J)){D=F.syncButtonPosition(F.getScrollDelta());A=F.calculateLocalRowTop(J);C=F.calculateEditorTop(A);if(!E){G=function(){if(D){F.scrollingViewEl.scrollBy(0,D,true)}F.focusColumnField(B.column)}}F.syncEditorClip();if(H){I.animate(Ext.applyIf({to:{top:C},duration:H.duration||125,callback:G},H))}else{I.setLocalY(C);if(G){G()}}}},getScrollDelta:function(){var E=this,D=E.scrollingViewEl.dom,C=E.context,B=E.body,A=0;if(C){A=Ext.fly(C.row).getOffsetsTo(D)[1];if(A<0){A-=B.getBorderPadding().beforeY}else{if(A>0){A=Math.max(A+E.getHeight()+E.floatingButtons.getHeight()-D.clientHeight-B.getBorderWidth("b"),0);if(A>0){A-=B.getBorderPadding().afterY}}}}return A},calculateLocalRowTop:function(B){var A=this.editingPlugin.grid;return Ext.fly(B).getOffsetsTo(A)[1]-A.el.getBorderWidth("t")+this.lastScrollTop},calculateEditorTop:function(A){return A-this.body.getBorderPadding().beforeY-this.lastScrollTop},getClientWidth:function(){var C=this,B=C.editingPlugin.grid,A;if(C.lockable){A=B.lockedGrid.getWidth()+B.normalGrid.view.el.dom.clientWidth}else{A=B.view.el.dom.clientWidth}return A},getEditor:function(A){var B=this;if(Ext.isNumber(A)){return B.query("[isEditorComponent]")[A]}else{if(A.isHeader&&!A.isGroupHeader){return A.getEditor()}}},addFieldsForColumn:function(C,A){var E=this,B,D,F;if(Ext.isArray(C)){for(B=0,D=C.length;B<D;B++){E.addFieldsForColumn(C[B],A)}return }if(C.getEditor){F=C.getEditor(null,E.getDefaultFieldCfg());if(C.align==="right"){F.fieldStyle="text-align:right"}if(C.xtype==="actioncolumn"){F.fieldCls+=" "+Ext.baseCSSPrefix+"form-action-col-field"}if(E.isVisible()&&E.context){if(F.is("displayfield")){E.renderColumnData(F,E.context.record,C)}else{F.suspendEvents();F.setValue(E.context.record.get(C.dataIndex));F.resumeEvents()}}if(C.hidden){E.onColumnHide(C)}else{if(C.rendered&&!A){E.onColumnShow(C)}}}},getDefaultFieldCfg:function(){return{xtype:"displayfield",getModelData:function(){return null}}},loadRecord:function(D){var H=this,A=H.getForm(),E=A.getFields(),G=E.items,B=G.length,C,F,J,I;for(C=0;C<B;C++){I=G[C];I.suspendEvents();I.resetToInitialValue()}A.loadRecord(D);for(C=0;C<B;C++){G[C].resumeEvents()}if(A.hasInvalidField()===A.wasValid){delete A.wasValid}J=A.isValid();if(H.errorSummary){if(J){H.hideToolTip()}else{H.showToolTip()}}H.updateButton(J);F=H.query(">displayfield");B=F.length;for(C=0;C<B;C++){H.renderColumnData(F[C],D)}},renderColumnData:function(L,H,C){var J=this,A=J.editingPlugin.grid,E=A.headerCt,K=J.scrollingView,N=K.dataSource,F=C||L.column,M=H.get(F.dataIndex),I=F.editRenderer||F.renderer,B,D,G,O=(F.usingDefaultRenderer&&!F.scope)?F:F.scope;if(I){B={tdCls:"",style:""};D=N.indexOf(H);G=E.getHeaderIndex(F);M=I.call(O||E.ownerCt,M,B,H,D,G,N,K)}L.setRawValue(M)},beforeEdit:function(){var A=this,B;if(A.isVisible()&&A.errorSummary&&!A.autoCancel&&A.isDirty()){B=A.getScrollDelta();if(B){A.scrollingViewEl.scrollBy(0,B,true)}A.showToolTip();return false}},startEdit:function(B,H){var G=this,C=G.editingPlugin,E=C.grid,D=G.context=C.context,F=G.isVisible(),A=G.wrapEl;if(G._cachedNode){G.clearCache()}Ext.suspendLayouts();if(!G.rendered){G.width=G.getClientWidth();G.render(E.el,E.el.dom.firstChild);A=G.wrapEl=G.el.wrap();A.setVisibilityMode(3);A.addCls(G._wrapCls);G.getFloatingButtons().render(A);G.onViewScroll()}G.setLocalY(0);D.grid.getSelectionModel().selectByPosition({row:B,column:H});G.onGridResize();G.loadRecord(B);Ext.resumeLayouts(F);if(F){G.reposition(true)}else{G.skipFocusScroll=true;G.show()}},syncButtonPosition:function(C){var B=this,A=B.getFloatingButtons(),E=B.scrollingView,D=B.getScrollDelta()-(E.getScrollable().getSize().y-E.getScrollY()-B.scrollingViewEl.dom.clientHeight);if(D>0){if(!B._buttonsOnTop){A.setButtonPosition("top");B._buttonsOnTop=true}C=0}else{if(B._buttonsOnTop!==false){A.setButtonPosition("bottom");B._buttonsOnTop=false}else{A.setButtonPosition(A.position)}}return C},syncEditorClip:function(){var H=this,B=H.getScrollDelta(),A=H.el,E=H.floatingButtons,D=E.el,I=Math.max,F,C,G;if(B){H.isOverflowing=true;F=H.body;C=E.getHeight();G=H.getHeight();I=Math.max;if(B>0){if(H._buttonsOnTop){B-=(C-F.getBorderWidth("b"));H.clipBottom(A,I(G-B),0);B-=(G-F.getBorderWidth("t"));if(B>0){H.clipBottom(D,I(C-B,0))}else{H.clearClip(D)}}else{H.clipBottom(D,I(C-B,0));B-=(C-F.getBorderWidth("b"));if(B>0){H.clipBottom(A,I(G-B,0))}else{H.clearClip(A)}}}else{if(B<0){B=Math.abs(B);H.clipTop(A,B);B-=(G-F.getBorderWidth("b"));if(B>0){H.clipTop(D,B)}else{H.clearClip(D)}}}}else{if(H.isOverflowing){H.clearClip(D);H.clearClip(A);H.isOverflowing=false}}},focusColumnField:function(B){var C,A;if(B&&!B.destroyed){if(B.isVisible()){C=this.getEditor(B);if(C&&C.isFocusable(true)){A=true;C.focus()}}if(!A){this.focusColumnField(B.next())}}},cancelEdit:function(){var F=this,E=F.getForm(),A=E.getFields(),B=A.items,D=B.length,C;if(F._cachedNode){F.clearCache()}F.hide();E.clearInvalid();for(C=0;C<D;C++){B[C].suspendEvents()}E.reset();for(C=0;C<D;C++){B[C].resumeEvents()}},clearCache:function(){var A=this;A.mun(A.editingPlugin.view,{itemadd:A.onViewItemAdd,scope:A});A._cachedNode=false},completeEdit:function(){var B=this,A=B.getForm();if(!A.isValid()){return false}B.completing=true;A.updateRecord(B.context.record);B.hide();B.completing=false;return true},onShow:function(){var A=this;A.wrapEl.show();A.callParent(arguments);if(A.needsSyncFieldWidths){A.suspendLayouts();A.syncAllFieldWidths();A.resumeLayouts(true)}delete A.needsSyncFieldWidths;A.reposition()},onHide:function(){var D=this,B=D.context,C,A,E=Ext.Element.getActiveElement();if(D.el.contains(E)){C=D.activeField.column}else{C=B.column}A=new Ext.grid.CellContext(C.getView()).setPosition(D.context.record,C);A.view.getNavigationModel().setPosition(A);D.activeField=null;D.wrapEl.hide();D.callParent(arguments);if(D.tooltip){D.hideToolTip()}},onResize:function(B,A){this.wrapEl.setSize(B,A)},isDirty:function(){return this.getForm().isDirty()},getToolTip:function(){var B=this,C=B.tooltip,A=B.editingPlugin.grid;if(!C){B.tooltip=C=new Ext.tip.ToolTip({cls:Ext.baseCSSPrefix+"grid-row-editor-errors",title:B.errorsText,autoHide:false,closable:true,closeAction:"disable",anchor:"left",anchorToTarget:true,constrainPosition:true,constrainTo:document.body});A.add(C);B.mon(A,{afterlayout:B.onGridLayout,scope:B})}return C},hideToolTip:function(){var A=this,B=A.getToolTip();if(B.rendered){B.disable()}A.hiddenTip=false},showToolTip:function(){var A=this,B=A.getToolTip();B.update(A.getErrors());A.repositionTip();B.enable()},onGridLayout:function(){if(this.tooltip&&this.tooltip.isVisible()){this.repositionTip()}},repositionTip:function(){var H=this,I=H.getToolTip(),C=H.context,K=Ext.get(C.row),J=H.scrollingViewEl,E=J.dom.clientHeight,F=J.getY(),G=F+E,B=K.getHeight(),A=K.getY(),D=A+B;if(D>F&&A<G){I.anchorTarget=J;I.mouseOffset=[0,K.getOffsetsTo(J)[1]];I.show();H.hiddenTip=false}else{I.hide();H.hiddenTip=true}},getErrors:function(){var E=this,G=[],B=E.query(">[isFormField]"),D=B.length,C,A,F;for(C=0;C<D;C++){F=B[C];A=F.getErrors();if(A.length){G.push(E.createErrorListItem(A[0],F.column.text))}}if(!G.length&&!E.autoCancel&&E.isDirty()){G[0]=E.createErrorListItem(E.dirtyText)}return'<ul class="'+Ext.baseCSSPrefix+'list-plain">'+G.join("")+"</ul>"},createErrorListItem:function(B,A){B=A?A+": "+B:B;return'<li class="'+this.errorCls+'">'+B+"</li>"},beforeDestroy:function(){Ext.destroy(this.floatingButtons,this.tooltip);this.callParent()},clipBottom:function(A,B){A.setStyle("clip","rect(0 auto "+B+"px 0)")},clipTop:function(A,B){A.setStyle("clip","rect("+B+"px, auto, auto, 0)")},clearClip:function(A){A.setStyle("clip",Ext.isIE8?"rect(-1000px auto 1000px auto)":"auto")}})