Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",mixins:{summary:"Ext.grid.feature.AbstractSummary"},requires:["Ext.grid.feature.GroupStore"],alias:"feature.grouping",eventPrefix:"group",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",refreshData:{},wrapsItem:true,groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",hdNotCollapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-not-collapsible",collapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-collapsible",ctCls:Ext.baseCSSPrefix+"group-hd-container",groupByText:"Group by this field",showGroupsText:"Show in groups",hideGroupedHeader:false,startCollapsed:false,enableGroupingMenu:true,enableNoGroups:true,collapsible:true,groupers:null,expandTip:"Click to expand. CTRL key collapses all others",collapseTip:"Click to collapse. CTRL/click collapses all others",showSummaryRow:false,outerTpl:["{%","if (!(this.groupingFeature.disabled || values.rows.length === 1 && values.rows[0].isSummary)) {","this.groupingFeature.setup(values.rows, values.view.rowValues);","}","this.nextTpl.applyOut(values, out, parent);","if (!(this.groupingFeature.disabled || values.rows.length === 1 && values.rows[0].isSummary)) {","this.groupingFeature.cleanup(values.rows, values.view.rowValues);","}","%}",{priority:200}],groupRowTpl:["{%","var me = this.groupingFeature,",'colspan = "colspan=" + values.columns.length;',"if (me.disabled || parent.rows.length === 1 && parent.rows[0].isSummary) {","values.needsWrap = false;","} else {","me.setupRowData(values.record, values.rowIndex, values);","}","%}",'<tpl if="needsWrap">','<tpl if="isFirstRow">',"{% values.view.renderColumnSizer(values, out); %}",'<tr data-boundView="{view.id}" data-recordId="{record.internalId:htmlEncode}" data-recordIndex="{[values.isCollapsedGroup ? -1 : values.recordIndex]}" class="{groupHeaderCls}">','<td class="{[me.ctCls]}" {[colspan]}>',"{%",'var groupTitleStyle = (!values.view.lockingPartner || (values.view.ownerCt === values.view.ownerCt.ownerLockable.lockedGrid) || (values.view.lockingPartner.headerCt.getVisibleGridColumns().length === 0)) ? "" : "visibility:hidden";',"%}",'<div data-groupname="{groupName:htmlEncode}" class="',Ext.baseCSSPrefix,'grid-group-hd {collapsibleCls}" nottabindex="0" hidefocus="on" {ariaCellInnerAttr}>','<div class="',Ext.baseCSSPrefix,'grid-group-title" style="{[groupTitleStyle]}" {ariaGroupTitleAttr} data-qtip="{[values.isCollapsedGroup ? me.expandTip : me.collapseTip]}">','{[values.groupHeaderTpl.apply(values.metaGroupCache, parent) || "&#160;"]}',"</div>","</div>","</td>","</tr>","</tpl>",'<tpl if="!isCollapsedGroup">',"{%","values.itemClasses.length = 0;","this.nextTpl.applyOut(values, out, parent);","%}","</tpl>",'<tpl if="summaryRecord">',"{%me.outputSummaryRecord(values.summaryRecord, values, out, parent);%}","</tpl>","<tpl else>","{%this.nextTpl.applyOut(values, out, parent);%}","</tpl>",{priority:200,beginRowSync:function(A){var B=this.groupingFeature;A.add("header",B.eventSelector);A.add("summary",B.summaryRowSelector)},syncContent:function(B,H,A){B=Ext.fly(B,"syncDest");H=Ext.fly(H,"syncSrc");var E=this.groupingFeature,D=B.down(E.eventSelector,true),C=H.down(E.eventSelector,true),G=B.down(E.summaryRowSelector,true),F=H.down(E.summaryRowSelector,true);if(D&&C){Ext.fly(D).syncContent(C)}if(G&&F){if(A){this.groupingFeature.view.updateColumns(G,F,A)}else{Ext.fly(G).syncContent(F)}}}}],init:function(C){var E=this,A=E.view,B=E.getGridStore(),D,F;A.isGrouping=B.isGrouped();E.mixins.summary.init.call(E);E.callParent([C]);A.headerCt.on({columnhide:E.onColumnHideShow,columnshow:E.onColumnHideShow,columnmove:E.onColumnMove,scope:E});A.addTpl(Ext.XTemplate.getTpl(E,"outerTpl")).groupingFeature=E;A.addRowTpl(Ext.XTemplate.getTpl(E,"groupRowTpl")).groupingFeature=E;A.preserveScrollOnRefresh=true;if(B.isBufferedStore){E.collapsible=false}else{D=E.lockingPartner;if(D&&D.dataSource){E.dataSource=A.dataSource=F=D.dataSource}else{E.dataSource=A.dataSource=F=new Ext.grid.feature.GroupStore(E,B)}}C=C.ownerLockable||C;C.on("beforereconfigure",E.beforeReconfigure,E);A.on({afterrender:E.afterViewRender,scope:E,single:true});if(F){F.on("groupchange",E.onGroupChange,E)}else{E.setupStoreListeners(B)}E.mixins.summary.bindStore.call(E,C,C.getStore())},getGridStore:function(){return this.view.getStore()},indexOf:function(A){return this.dataSource.indexOf(A)},indexOfPlaceholder:function(A){return this.dataSource.indexOfPlaceholder(A)},isInCollapsedGroup:function(B){var E=this,D=E.getGridStore(),A=false,C;if(D.isGrouped()&&(C=E.getMetaGroup(B))){A=!!(C&&C.isCollapsed)}return A},createCache:function(){var A=this.metaGroupCache={},B=this.lockingPartner;if(B){B.metaGroupCache=A}A.map={};return A},getCache:function(){return this.metaGroupCache||this.createCache()},invalidateCache:function(){var A=this.lockingPartner;this.metaGroupCache=null;if(A){A.metaGroupCache=null}},vetoEvent:function(A,C,D,B){if(B.type!=="mouseover"&&B.type!=="mouseout"&&B.type!=="mouseenter"&&B.type!=="mouseleave"&&B.getTarget(this.eventSelector)){return false}},enable:function(){var C=this,A=C.view,B=C.getGridStore(),E=C.hideGroupedHeader&&C.getGroupedHeader(),D;A.isGrouping=true;if(A.lockingPartner){A.lockingPartner.isGrouping=true}C.callParent();if(C.lastGrouper){B.group(C.lastGrouper);C.lastGrouper=null}if(E){E.hide()}D=C.view.headerCt.getMenu().down("#groupToggleMenuItem");if(D){D.setChecked(true,true)}},disable:function(){var C=this,A=C.view,B=C.getGridStore(),F=C.hideGroupedHeader&&C.getGroupedHeader(),E=B.getGrouper(),D;A.isGrouping=false;if(A.lockingPartner){A.lockingPartner.isGrouping=false}C.callParent();if(E){C.lastGrouper=E;B.clearGrouping()}if(F){F.show()}D=C.view.headerCt.getMenu().down("#groupToggleMenuItem");if(D){D.setChecked(false,true);D.disable()}},afterViewRender:function(){var B=this,A=B.view;A.on({scope:B,groupclick:B.onGroupClick});if(B.enableGroupingMenu){B.injectGroupingMenu()}B.pruneGroupedHeader();B.lastGrouper=B.getGridStore().getGrouper();if(B.disabled){B.disable()}},injectGroupingMenu:function(){var A=this,B=A.view.headerCt;B.showMenuBy=A.showMenuBy;B.getMenuItems=A.getMenuItems()},onColumnHideShow:function(D,G){var J=this,K=J.view,B=K.headerCt,A=B.getMenu(),C=A.activeHeader,L=A.down("#groupMenuItem"),F,M=J.grid.getVisibleColumnManager().getColumns().length,I,H,E;if(C&&L){F=C.groupable===false||!C.dataIndex||J.view.headerCt.getVisibleGridColumns().length<2?"disable":"enable";L[F]()}if(K.rendered&&M){I=K.el.query("."+J.ctCls);for(E=0,H=I.length;E<H;++E){I[E].colSpan=M}}},onColumnMove:function(){var E=this,B=E.view,H,A,F,G,D,C;if(B.getStore().isGrouped()){A=E.getCache().map;Ext.suspendLayouts();for(H in A){F=E.getGroup(H);G=F.first();D=F.last();C=E.getMetaGroup(H);if(C.isCollapsed){G=D=E.dataSource.getGroupPlaceholder(H)}B.refreshNode(G);if(E.showSummaryRow&&D!==G){B.refreshNode(D)}}Ext.resumeLayouts(true)}},showMenuBy:function(H,I,C){var E=this,A=E.getMenu(),F=A.down("#groupMenuItem"),D=C.groupable===false||!C.dataIndex||E.view.headerCt.getVisibleGridColumns().length<2?"disable":"enable",B=A.down("#groupToggleMenuItem"),G=E.grid.getStore().isGrouped();F[D]();if(B){B.setChecked(G,true);B[G?"enable":"disable"]()}Ext.grid.header.Container.prototype.showMenuBy.apply(E,arguments)},getMenuItems:function(){var F=this,C=F.groupByText,E=F.disabled||!F.getGroupField(),A=F.showGroupsText,D=F.enableNoGroups,B=F.view.headerCt.getMenuItems;return function(){var G=B.call(this);G.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:C,handler:F.onGroupMenuItemClick,scope:F});if(D){G.push({itemId:"groupToggleMenuItem",text:A,checked:!E,checkHandler:F.onGroupToggleMenuItemClick,scope:F})}return G}},onGroupMenuItemClick:function(C,E){var D=this,F=C.parentMenu,G=F.activeHeader,A=D.view,B=D.getGridStore();if(D.disabled){D.lastGrouper=null;D.block();D.enable();D.unblock()}A.isGrouping=true;B.group(D.getGrouper(G.dataIndex)||G.dataIndex);D.pruneGroupedHeader()},block:function(A){var B=this;B.blockRefresh=B.view.blockRefresh=true;if(B.lockingPartner&&!A){B.lockingPartner.block(true)}},unblock:function(A){var B=this;B.blockRefresh=B.view.blockRefresh=false;if(B.lockingPartner&&!A){B.lockingPartner.unblock(true)}},onGroupToggleMenuItemClick:function(A,B){this[B?"enable":"disable"]()},pruneGroupedHeader:function(){var A=this,B=A.getGroupedHeader();if(A.hideGroupedHeader&&B){Ext.suspendLayouts();if(A.prunedHeader&&A.prunedHeader!==B){A.prunedHeader.show()}A.prunedHeader=B;if(B.rendered){B.hide()}Ext.resumeLayouts(true)}},getHeaderNode:function(F){var D=this.view.getEl(),B,C,A,E;if(D){F=Ext.htmlEncode(F);B=D.query(this.eventSelector);for(C=0,A=B.length;C<A;++C){E=B[C];if(E.getAttribute("data-groupName")===F){return E}}}},getGroup:function(B){var A=this.getGridStore(),C=B,D;if(A.isGrouped()){if(B.isModel){B=B.get(A.getGroupField())}if(typeof B!=="string"){B=A.getGrouper().getGroupString(C)}D=A.getGroups().getByKey(B)}return D},getGrouper:function(A){var B=this.groupers;if(!B){return null}return Ext.Array.findBy(B,function(C){return C.property===A})},getGroupField:function(){return this.getGridStore().getGroupField()},getMetaGroup:function(D){var A=this.metaGroupCache||this.createCache(),C,B;if(D.isModel){D=this.getGroup(D)}if(D!=null){C=(typeof D==="string")?D:D.getGroupKey();B=A[C];if(!B){B=A[C]={isCollapsed:false,lastGroup:null,lastGroupGeneration:null,lastFilterGeneration:null,aggregateRecord:new Ext.data.Model()};A.map[C]=true}}return B},isExpanded:function(A){return !this.getMetaGroup(A).isCollapsed},expand:function(B,A){this.doCollapseExpand(false,B,A)},expandAll:function(){var C=this,A=C.getCache(),B=C.lockingPartner,D;for(D in A){if(A.hasOwnProperty(D)){A[D].isCollapsed=false}}Ext.suspendLayouts();C.dataSource.onRefresh();Ext.resumeLayouts(true);for(D in A){if(A.hasOwnProperty(D)){C.afterCollapseExpand(false,D);if(B){B.afterCollapseExpand(false,D)}}}},collapse:function(B,A){this.doCollapseExpand(true,B,A)},isAllCollapsed:function(){var B=this,A=B.getCache(),C;for(C in A){if(A.hasOwnProperty(C)){if(!A[C].isCollapsed){return false}}}return true},isAllExpanded:function(){var B=this,A=B.getCache(),C;for(C in A){if(A.hasOwnProperty(C)){if(A[C].isCollapsed){return false}}}return true},collapseAll:function(){var C=this,A=C.getCache(),D,B=C.lockingPartner;for(D in A){if(A.hasOwnProperty(D)){A[D].isCollapsed=true}}Ext.suspendLayouts();C.dataSource.onRefresh();Ext.resumeLayouts(true);for(D in A){if(A.hasOwnProperty(D)){C.afterCollapseExpand(true,D);if(B){B.afterCollapseExpand(true,D)}}}},doCollapseExpand:function(E,F,A){var C=this,B=C.lockingPartner,D=C.getGroup(F);if(C.getMetaGroup(D).isCollapsed!==E){C.isExpandingOrCollapsing=true;Ext.suspendLayouts();if(E){C.dataSource.collapseGroup(D)}else{C.dataSource.expandGroup(D)}Ext.resumeLayouts(true);C.afterCollapseExpand(E,F,A);if(B){B.afterCollapseExpand(E,F,false)}C.isExpandingOrCollapsing=false}},afterCollapseExpand:function(D,G,B){var C=this,A=C.view,F=A.bufferedRenderer,E;E=C.getHeaderNode(G);A.fireEvent(D?"groupcollapse":"groupexpand",A,E,G);if(B){if(E){A.scrollElIntoView(Ext.fly(E).up(A.getItemSelector()),false,true)}else{if(F){F.scrollTo(C.getGroup(G).getAt(0))}}}},onGroupChange:function(B,A){if(!A){this.view.ownerGrid.getView().refreshView()}else{this.lastGrouper=A}},getMenuItem:function(B){var A=this.view,D=A.headerCt.down("gridcolumn[dataIndex="+B+"]"),C=A.headerCt.getMenu();return D?C.down("menuitem[headerId="+D.id+"]"):null},onGroupKey:function(C,B){var A=this,D=A.getGroupName(B.target);if(D){A.onGroupClick(A.view,B.target,D,B)}},onGroupClick:function(F,A,H,D){var E=this,G=E.getCache(),I=G.map,C=!E.isExpanded(H),B;if(E.collapsible){if(D.ctrlKey){Ext.suspendLayouts();for(B in I){if(B===H){if(C){E.expand(H)}}else{if(!G[B].isCollapsed){E.doCollapseExpand(true,B,false)}}}Ext.resumeLayouts(true);return }if(C){E.expand(H)}else{E.collapse(H)}}},setupRowData:function(B,I,L){var T=this,C=L.recordIndex,U=T.refreshData,A=T.getCache(),P=U.header,S=U.groupField,F=T.getGridStore(),Q=T.view.dataSource,O=Q.isBufferedStore,D=T.grid.columnManager.getHeaderByDataIndex(S),E=!!(D&&D.renderer),R=B.groupKey,G=B.isCollapsedPlaceholder&&R?T.getGroup(R):B.group,N,H,K,M,J;L.isCollapsedGroup=false;L.summaryRecord=L.groupHeaderCls=null;if(U.doGrouping){N=F.getGrouper();if(B.isCollapsedPlaceholder){H=G.getGroupKey();J=G.items;L.isFirstRow=L.isLastRow=true;L.groupHeaderCls=T.hdCollapsedCls;L.isCollapsedGroup=L.needsWrap=true;L.groupName=H;L.metaGroupCache=A;A.groupField=S;A.name=A.renderedGroupValue=E?D.renderer(G.getAt(0).get(S),{},B):H;A.groupValue=J[0].get(S);A.columnName=P?P.text:S;L.collapsibleCls=T.collapsible?T.collapsibleCls:T.hdNotCollapsibleCls;A.rows=A.children=J;if(T.showSummaryRow){L.summaryRecord=U.summaryData[H]}return }H=N.getGroupString(B);if(G){J=G.items;L.isFirstRow=B===J[0];L.isLastRow=B===J[J.length-1]}else{L.isFirstRow=C===0;if(!L.isFirstRow){K=F.getAt(C-1);if(K){L.isFirstRow=!K.isEqual(N.getGroupString(K),H)}}L.isLastRow=C===(O?F.getTotalCount():F.getCount())-1;if(!L.isLastRow){M=F.getAt(C+1);if(M){L.isLastRow=!M.isEqual(N.getGroupString(M),H)}}}if(L.isFirstRow){A.groupField=S;A.name=A.renderedGroupValue=E?D.renderer(B.get(S),{},B):H;A.groupValue=B.get(S);A.columnName=P?P.text:S;L.collapsibleCls=T.collapsible?T.collapsibleCls:T.hdNotCollapsibleCls;L.groupName=H;if(!T.isExpanded(H)){L.itemClasses.push(T.hdCollapsedCls);L.isCollapsedGroup=true}if(O){A.rows=A.children=[]}else{A.rows=A.children=T.getRecordGroup(B).items}L.metaGroupCache=A}if(L.isLastRow){if(T.showSummaryRow){L.summaryRecord=U.summaryData[H];L.itemClasses.push(Ext.baseCSSPrefix+"grid-group-last")}}L.needsWrap=(L.isFirstRow||L.summaryRecord)}},setup:function(E,F){var C=this,D=C.refreshData,A=F.view,B=A.isGrouping=!C.disabled&&C.getGridStore().isGrouped(),G=A.bufferedRenderer;C.skippedRows=0;if(G){G.variableRowHeight=A.bufferedRenderer.variableRowHeight||B}D.groupField=C.getGroupField();D.header=C.getGroupedHeader(D.groupField);D.doGrouping=B;F.groupHeaderTpl=Ext.XTemplate.getTpl(C,"groupHeaderTpl");if(B&&C.showSummaryRow){D.summaryData=C.generateSummaryData()}},cleanup:function(B,C){var A=this.refreshData;C.metaGroupCache=C.groupHeaderTpl=C.isFirstRow=null;A.groupField=A.header=A.summaryData=null},getAggregateRecord:function(A,B){var C;if(B===true||!A.aggregateRecord){C=new Ext.data.Model();A.aggregateRecord=C;C.isNonData=C.isSummary=true}return A.aggregateRecord},generateSummaryData:function(){var M=this,O=M.getGridStore(),C=O.getFilters(),D=O.getGroups().items,J=O.getProxy().getReader(),A=M.getGroupField(),L=M.lockingPartner,Q=M.updateSummaryRow,H={},E=M.view.ownerCt,G,K,P,F,I,B,N;if(M.remoteRoot){N=M.mixins.summary.generateSummaryData.call(M,A);B=!!N}for(G=0,K=D.length;G<K;++G){P=D[G];F=M.getMetaGroup(P);if(Q||B||O.updating||M.grid.reconfiguring||M.didGroupChange(P,F,C)){I=M.populateRecord(P,F,N);if(!L||(E===E.ownerLockable.normalGrid)){F.lastGroup=P;F.lastGroupGeneration=P.generation;F.lastFilterGeneration=C.generation}}else{I=M.getAggregateRecord(F)}H[P.getGroupKey()]=I}M.updateSummaryRow=false;return H},getGroupName:function(B){var D=this,A=D.view,C=D.eventSelector,F,E;F=Ext.fly(B).findParent(C);if(!F){E=Ext.fly(B).findParent(A.itemSelector);if(E){F=E.down(C,true)}}if(F){return Ext.htmlDecode(F.getAttribute("data-groupname"))}},getRecordGroup:function(A){var C=this.getGridStore(),B=C.getGrouper();if(B){return C.getGroups().getByKey(B.getGroupString(A))}},getGroupedHeader:function(B){var D=this,E=D.view.headerCt,C=D.lockingPartner,A,F;B=B||D.getGroupField();if(B){A="[dataIndex="+B+"]";F=E.down(A);if(!F&&C){F=C.view.headerCt.down(A)}}return F||null},getFireEventArgs:function(B,A,D,C){return[B,A,D,this.getGroupName(D),C]},destroy:function(){var A=this,B=A.dataSource;A.storeListeners=Ext.destroy(A.storeListeners);A.view=A.prunedHeader=A.grid=A.dataSource=A.groupers=null;A.invalidateCache();A.callParent();if(B){B.bindStore(null);Ext.destroy(B)}},beforeReconfigure:function(C,I,D,A,E){var G=this,H=G.view,B=G.dataSource,F;if(I&&I!==A){F=I.isBufferedStore;if(!B){Ext.destroy(G.storeListeners);G.setupStoreListeners(I)}if(F!==A.isBufferedStore){Ext.raise("Cannot reconfigure grouping switching between buffered and non-buffered stores")}H.isGrouping=!!I.getGrouper();B.bindStore(I)}},populateRecord:function(N,E,L){var I=this,J=I.grid.ownerLockable?I.grid.ownerLockable.view:I.view,M=I.getGridStore(),G=I.getAggregateRecord(E),D=J.headerCt.getGridColumns(),H=D.length,P=N.getGroupKey(),C,K,F,B,O,A;G.beginEdit();if(L){C=L[P];for(K in C){if(C.hasOwnProperty(K)){if(K!==G.idProperty){G.set(K,C[K])}}}}for(F=0;F<H;++F){B=D[F];O=B.dataIndex||B.getItemId();if(!L){A=I.getSummary(M,B.summaryType,O,N);G.set(O,A)}else{A=G.get(B.dataIndex)}I.setSummaryData(G,B.getItemId(),A,P)}G.ownerGroup=P;G.endEdit(true);G.commit();return G},privates:{didGroupChange:function(D,A,C){var B=true;if(D===A.lastGroup){B=A.lastGroupGeneration!==D.generation||A.lastFilterGeneration!==C.generation}return B},setupStoreListeners:function(A){var B=this;B.storeListeners=A.on({groupchange:B.onGroupChange,scope:B,destroyable:true})}}})