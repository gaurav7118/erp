Ext.define("Ext.grid.feature.Summary",{extend:"Ext.grid.feature.AbstractSummary",alias:"feature.summary",dock:undefined,dockedSummaryCls:Ext.baseCSSPrefix+"docked-summary",panelBodyCls:Ext.baseCSSPrefix+"summary-",hasFeatureEvent:false,fullSummaryTpl:["{%","var me = this.summaryFeature,","    record = me.summaryRecord,","    view = values.view,","    bufferedRenderer = view.bufferedRenderer;","this.nextTpl.applyOut(values, out, parent);","if (!me.disabled && me.showSummaryRow && view.store.isLast(values.record)) {","if (bufferedRenderer) {","    bufferedRenderer.variableRowHeight = true;","}","me.outputSummaryRecord((record && record.isModel) ? record : me.createSummaryRecord(view), values, out, parent);","}","%}",{priority:300,beginRowSync:function(A){A.add("fullSummary",this.summaryFeature.summaryRowSelector)},syncContent:function(D,G,C){D=Ext.fly(D,"syncDest");G=Ext.fly(G,"sycSrc");var B=this.owner,A=B.summaryRowSelector,F=D.down(A,true),E=G.down(A,true);if(F&&E){if(C){this.summaryFeature.view.updateColumns(F,E,C)}else{Ext.fly(F).syncContent(E)}}}}],init:function(B){var D=this,A=D.view,C=D.dock;D.callParent(arguments);if(C){B.addBodyCls(D.panelBodyCls+C);B.headerCt.on({add:D.onStoreUpdate,afterlayout:D.onStoreUpdate,scope:D});B.on({beforerender:function(){var E=[D.summaryTableCls];if(A.columnLines){E[E.length]=A.ownerCt.colLinesCls}D.summaryBar=B.addDocked({childEls:["innerCt","item"],renderTpl:['<div id="{id}-innerCt" data-ref="innerCt" role="presentation">','<table id="{id}-item" data-ref="item" cellPadding="0" cellSpacing="0" class="'+E.join(" ")+'">','<tr class="'+D.summaryRowCls+'"></tr>',"</table>","</div>"],scrollable:{x:false,y:false},hidden:!D.showSummaryRow,itemId:"summaryBar",cls:[D.dockedSummaryCls,D.dockedSummaryCls+"-"+C],xtype:"component",dock:C,weight:10000000})[0]},afterrender:function(){B.getView().getScrollable().addPartner(D.summaryBar.getScrollable());D.onStoreUpdate()},single:true});B.headerCt.afterComponentLayout=Ext.Function.createSequence(B.headerCt.afterComponentLayout,function(){var E=this.getTableWidth(),F=D.summaryBar.innerCt;D.summaryBar.item.setWidth(E);if(this.tooNarrow){E+=Ext.getScrollbarSize().width}F.setWidth(E)})}else{if(B.bufferedRenderer){D.wrapsItem=true;A.addRowTpl(Ext.XTemplate.getTpl(D,"fullSummaryTpl")).summaryFeature=D;A.on("refresh",D.onViewRefresh,D)}else{D.wrapsItem=false;D.view.addFooterFn(D.renderSummaryRow)}}B.ownerGrid.on({beforereconfigure:D.onBeforeReconfigure,columnmove:D.onStoreUpdate,scope:D});D.bindStore(B,B.getStore())},onBeforeReconfigure:function(B,A){this.summaryRecord=null;if(A){this.bindStore(B,A)}},bindStore:function(B,A){var C=this;Ext.destroy(C.storeListeners);C.storeListeners=A.on({scope:C,destroyable:true,update:C.onStoreUpdate,datachanged:C.onStoreUpdate});C.callParent([B,A])},renderSummaryRow:function(C,D,E){var B=C.view,F=B.findFeature("summary"),A,G;if(!F.disabled&&F.showSummaryRow){A=F.summaryRecord;D.push('<table cellpadding="0" cellspacing="0" class="'+F.summaryItemCls+'" style="table-layout: fixed; width: 100%;">');F.outputSummaryRecord((A&&A.isModel)?A:F.createSummaryRecord(B),C,D,E);D.push("</table>")}},toggleSummaryRow:function(D,A){var C=this,B=C.summaryBar;C.callParent([D,A]);if(B){B.setVisible(C.showSummaryRow);C.onViewScroll()}},getSummaryBar:function(){return this.summaryBar},vetoEvent:function(A,C,D,B){return !B.getTarget(this.summaryRowSelector)},onViewScroll:function(){this.summaryBar.setScrollX(this.view.getScrollX())},onViewRefresh:function(B){var C=this,A,D;if(!C.disabled&&C.showSummaryRow&&!B.all.getCount()){A=C.createSummaryRecord(B);D=Ext.fly(B.getNodeContainer()).createChild({tag:"table",cellpadding:0,cellspacing:0,cls:C.summaryItemCls,style:"table-layout: fixed; width: 100%"},false,true);D.appendChild(Ext.fly(B.createRowElement(A,-1)).down(C.summaryRowSelector,true))}},createSummaryRecord:function(H){var G=this,D=H.headerCt.getGridColumns(),A=G.remoteRoot,F=G.summaryRecord,J=D.length,E,C,I,B,K;if(!F){K={id:H.id+"-summary-record"};F=G.summaryRecord=new Ext.data.Model(K)}F.beginEdit();if(A){B=G.generateSummaryData();if(B){F.set(B)}}else{for(E=0;E<J;E++){C=D[E];I=C.dataIndex||C.getItemId();B=G.getSummary(H.store,C.summaryType,I);F.set(I,B);G.setSummaryData(F,C.getItemId(),B)}}F.endEdit(true);F.commit(true);F.isSummary=true;return F},onStoreUpdate:function(){var G=this,C=G.view,A=G.summaryRowSelector,F=G.dock,B,E,D,H;if(!C.rendered){return }B=G.createSummaryRecord(C);E=Ext.fly(C.createRowElement(B,-1)).down(A,true);if(!E){return }if(F){H=G.summaryBar.item.dom.firstChild;D=H.firstChild}else{D=G.view.el.down(A,true);H=D?D.parentNode:C.getNodeContainer()}if(H){H.insertBefore(E,D);if(D){H.removeChild(D)}}if(F){G.onColumnHeaderLayout()}},onColumnHeaderLayout:function(){var B=this.view,D=B.headerCt.getVisibleGridColumns(),F,A=D.length,C,G=this.summaryBar.el,E;for(C=0;C<A;C++){F=D[C];E=G.down(B.getCellSelector(F),true);if(E){Ext.fly(E).setWidth(F.width||(F.lastBox?F.lastBox.width:100))}}},destroy:function(){var A=this;A.summaryRecord=A.storeListeners=Ext.destroy(A.storeListeners);A.callParent()}})