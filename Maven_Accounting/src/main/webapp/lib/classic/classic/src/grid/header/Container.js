Ext.define("Ext.grid.header.Container",{extend:"Ext.container.Container",requires:["Ext.grid.ColumnLayout","Ext.grid.plugin.HeaderResizer","Ext.grid.plugin.HeaderReorderer","Ext.util.KeyNav"],uses:["Ext.grid.column.Column","Ext.grid.ColumnManager","Ext.menu.Menu","Ext.menu.CheckItem","Ext.menu.Separator"],mixins:["Ext.util.FocusableContainer"],border:true,alias:"widget.headercontainer",baseCls:Ext.baseCSSPrefix+"grid-header-ct",dock:"top",weight:100,defaultType:"gridcolumn",detachOnRemove:false,defaultWidth:100,sortAscText:"Sort Ascending",sortDescText:"Sort Descending",sortClearText:"Clear Sort",columnsText:"Columns",headerOpenCls:Ext.baseCSSPrefix+"column-header-open",menuSortAscCls:Ext.baseCSSPrefix+"hmenu-sort-asc",menuSortDescCls:Ext.baseCSSPrefix+"hmenu-sort-desc",menuColsIcon:Ext.baseCSSPrefix+"cols-icon",blockEvents:false,dragging:false,sortOnClick:true,enableFocusableContainer:false,childHideCount:0,sortable:true,enableColumnHide:true,initComponent:function(){var A=this;A.plugins=A.plugins||[];A.defaults=A.defaults||{};if(!A.isColumn){if(A.enableColumnResize){A.resizer=new Ext.grid.plugin.HeaderResizer();A.plugins.push(A.resizer)}if(A.enableColumnMove){A.reorderer=new Ext.grid.plugin.HeaderReorderer();A.plugins.push(A.reorderer)}}if(A.isColumn&&!A.isGroupHeader){if(!A.items||A.items.length===0){A.isContainer=A.isFocusableContainer=false;A.focusable=true;A.layout={type:"container",calculate:Ext.emptyFn}}}else{A.layout=Ext.apply({type:"gridcolumn",align:"stretch"},A.initialConfig.layout);A.defaults.columnLines=A.columnLines;if(!A.isGroupHeader){A.isRootHeader=true;if(!A.hiddenHeaders){A.enableFocusableContainer=true;A.ariaRole="rowgroup"}A.columnManager=new Ext.grid.ColumnManager(false,A);A.visibleColumnManager=new Ext.grid.ColumnManager(true,A);if(A.grid){A.grid.columnManager=A.columnManager;A.grid.visibleColumnManager=A.visibleColumnManager}}else{A.visibleColumnManager=new Ext.grid.ColumnManager(true,A);A.columnManager=new Ext.grid.ColumnManager(false,A)}}A.menuTask=new Ext.util.DelayedTask(A.updateMenuDisabledState,A);A.callParent()},insertNestedHeader:function(F){var B=this,E=F.ownerCt,A=B.ownerCt,D=A.layout.owner,C;if(E){if(B.isGroupHeader&&!A.isNestedParent){C=D.items.indexOf(B)}E.remove(F,false)}if(C===undefined){C=D.items.indexOf(B)}D.insert(C,F)},isNested:function(){return !!this.getRootHeaderCt().down("[isNestedParent]")},isNestedGroupHeader:function(){var B=this,A=B.getRefOwner().query(">:not([hidden])");return(A.length===1&&A[0]===B)},maybeShowNestedGroupHeader:function(){var A=this.items,B;if(A&&A.length===1&&(B=A.getAt(0))&&B.hidden){B.show()}},setNestedParent:function(A){A.isNestedParent=false;A.ownerCt.isNestedParent=!!(this.ownerCt.items.length===1&&A.ownerCt.items.length===1)},initEvents:function(){var C=this,A,B;C.callParent();if(!C.isColumn&&!C.isGroupHeader){A=C.onHeaderCtEvent;B={click:A,dblclick:A,contextmenu:A,mouseover:C.onHeaderCtMouseOver,mouseout:C.onHeaderCtMouseOut,scope:C};if(Ext.supports.Touch){B.longpress=C.onHeaderCtLongPress}C.mon(C.el,B)}},onHeaderCtEvent:function(D,B){var C=this,G=C.getHeaderElByEvent(D),F,E,A;if(C.longPressFired){C.longPressFired=false;return }if(G&&!C.blockEvents){F=Ext.getCmp(G.id);if(F){E=F[F.clickTargetName];if((!F.isGroupHeader&&!F.isContainer)||D.within(E)){if(D.type==="click"||D.type==="tap"){A=F.onTitleElClick(D,E,C.sortOnClick);if(A){C.onHeaderTriggerClick(A,D,D.pointerType==="touch"?A.el:A.triggerEl)}else{C.onHeaderClick(F,D,B)}}else{if(D.type==="contextmenu"){C.onHeaderContextMenu(F,D,B)}else{if(D.type==="dblclick"&&F.resizable){F.onTitleElDblClick(D,E.dom)}}}}}}},blockNextEvent:function(){this.blockEvents=true;Ext.asap(this.unblockEvents,this)},unblockEvents:function(){this.blockEvents=false},onHeaderCtMouseOver:function(B,A){var E,D,C;if(!B.within(this.el,true)){E=B.getTarget("."+Ext.grid.column.Column.prototype.baseCls);D=E&&Ext.getCmp(E.id);if(D){C=D[D.clickTargetName];if(B.within(C)){D.onTitleMouseOver(B,C.dom)}}}},onHeaderCtMouseOut:function(E,C){var D="."+Ext.grid.column.Column.prototype.baseCls,B=E.getTarget(D),A=E.getRelatedTarget(D),G,F;if(B!==A){if(B){G=Ext.getCmp(B.id);if(G){F=G[G.clickTargetName];G.onTitleMouseOut(E,F.dom)}}if(A){G=Ext.getCmp(A.id);if(G){F=G[G.clickTargetName];G.onTitleMouseOver(E,F.dom)}}}},onHeaderCtLongPress:function(B){var A=this,D=A.getHeaderElByEvent(B),C=Ext.getCmp(D.id);if(!C.menuDisabled){A.longPressFired=true;A.showMenuBy(B,D,C)}},getHeaderElByEvent:function(A){return A.getTarget("."+Ext.grid.column.Column.prototype.baseCls)},isLayoutRoot:function(){if(this.hiddenHeaders){return false}return this.callParent()},getRootHeaderCt:function(){var A=this;return A.isRootHeader?A:A.up("[isRootHeader]")},onDestroy:function(){var A=this;if(A.menu){A.menu.un("hide",A.onMenuHide,A)}A.menuTask.cancel();A.callParent();Ext.destroy(A.visibleColumnManager,A.columnManager,A.menu);A.columnManager=A.visibleColumnManager=null},applyColumnsState:function(G,D){if(!G||!G.length){return }var N=this,L=N.items.items,K=L.length,H=0,B=G.length,M,C,A,J,O=false,I=[],E={},F=[];for(M=0;M<B;M++){A=G[M];A.index=M;E[A.id]=A}for(H=0;H<K;H++){C=L[H];A=E[C.getStateId()];if(A){J=A.index;I[J]=C;if(H!==J){O=true}if(C.applyColumnState){C.applyColumnState(A,D)}}else{F.push({index:H,column:C})}}I=Ext.Array.clean(I);B=F.length;if(B){for(H=0;H<B;H++){A=F[H];J=A.index;if(J<I.length){O=true;Ext.Array.splice(I,J,0,A.column)}else{I.push(A.column)}}}if(O){N.applyingState=true;N.removeAll(false);delete N.applyingState;N.add(I);N.purgeCache()}},getColumnsState:function(){var B=this,A=[],C;B.items.each(function(D){C=D.getColumnState&&D.getColumnState();if(C){A.push(C)}});return A},onAdd:function(B){var A=this;if(!A._usedIDs){A._usedIDs={}}if(A._usedIDs[B.headerId]){Ext.log.warn(this.$className+" attempted to reuse an existing id: "+B.headerId)}A._usedIDs[B.headerId]=true;A.callParent(arguments);A.onHeadersChanged(B,A.isDDMoveInGrid)},move:function(C,E){var D=this,B=D.items,A;if(C.isComponent){A=C;C=B.indexOf(A)}else{A=B.getAt(C)}A.visibleFromIdx=D.getRootHeaderCt().visibleColumnManager.indexOf(A);D.callParent(arguments)},onMove:function(A,D,G){var F=this,E=F.getRootHeaderCt(),B=E.visibleColumnManager,H=1,C;F.onHeadersChanged(A,true);C=B.indexOf(A);if(C>=A.visibleFromIdx){C++}F.callParent(arguments);if(A.isGroupHeader){H=A.visibleColumnManager.getColumns().length}E.onHeaderMoved(A,H,A.visibleFromIdx,C)},maybeContinueRemove:function(){var A=this;return(A.isGroupHeader&&!A.applyingState)&&!A.isNestedParent&&A.ownerCt&&!A.items.getCount()},onRemove:function(E,C){var D=this,B=D.ownerCt,A=E.lastHiddenHeader;D.callParent([E,C]);if(!D._usedIDs){D._usedIDs={}}delete D._usedIDs[E.headerId];if(!D.destroying){if(!D.isDDMoveInGrid){D.onHeadersChanged(E,false)}if(D.maybeContinueRemove()){if(E.rendered){D.detachComponent(E)}Ext.suspendLayouts();B.remove(D);Ext.resumeLayouts(true)}}},onHeadersChanged:function(D,A){var B,C=this.getRootHeaderCt();this.purgeHeaderCtCache(this);if(C){C.onColumnsChanged();if(!D.isGroupHeader){B=C.ownerCt;if(B&&!A){B.onHeadersChanged(C,D)}}}},onHeaderMoved:function(F,A,C,E){var D=this,B=D.ownerCt;if(D.rendered){if(B&&B.onHeaderMove){B.onHeaderMove(D,F,A,C,E)}D.fireEvent("columnmove",D,F,C,E)}},onColumnsChanged:function(){var C=this,D=C.menu,A,B;if(C.rendered){C.fireEvent("columnschanged",C);if(D&&(A=D.child("#columnItemSeparator"))){B=D.child("#columnItem");A.destroy();B.destroy()}}},lookupComponent:function(B){var A=this.callParent(arguments);if(!A.isGroupHeader&&A.width===undefined&&!A.flex){A.width=this.defaultWidth}return A},setSortState:function(){var B=this.up("[store]").store,D=this.visibleColumnManager.getColumns(),A=D.length,C,F,E;for(C=0;C<A;C++){F=D[C];E=F.getSorter();if(E){if(!B.getSorters().contains(E)){E=null}}else{E=B.getSorters().get(F.getSortParam())}F.setSortState(E)}},getHeaderMenu:function(){var B=this.getMenu(),A;if(B){A=B.child("#columnItem");if(A){return A.menu}}return null},onHeaderVisibilityChange:function(E,D){var B=this,C=B.getHeaderMenu(),A;B.purgeHeaderCtCache(E.ownerCt);if(C){A=B.getMenuItemForHeader(C,E);if(A){A.setChecked(D,true)}if(C.isVisible()){B.menuTask.delay(50)}}},updateMenuDisabledState:function(G){var F=this,D=F.query("gridcolumn:not([hidden])"),C,A=D.length,E,B,H;if(!G){G=F.getMenu()}for(C=0;C<A;++C){E=D[C];B=F.getMenuItemForHeader(G,E);if(B){H=E.isHideable()?"enable":"disable";if(B.menu){H+="CheckChange"}B[H]()}}},getMenuItemForHeader:function(A,B){return B?A.down("menucheckitem[headerId="+B.id+"]"):null},onHeaderShow:function(D){var C=this,B=C.ownerCt,A=D.lastHiddenHeader;if(!B){return }if(C.forceFit){delete C.flex}if(A&&!D.query("[hidden=false]").length){A.show();D.lastHiddenHeader=null}C.onHeaderVisibilityChange(D,true);B.onHeaderShow(C,D);C.fireEvent("columnshow",C,D);C.fireEvent("columnschanged",this)},onHeaderHide:function(C){var B=this,A=B.ownerCt;if(!A){return }B.onHeaderVisibilityChange(C,false);A.onHeaderHide(B,C);B.fireEvent("columnhide",B,C);B.fireEvent("columnschanged",this)},onHeaderResize:function(D,A){var C=this,B=C.ownerCt;if(B){B.onHeaderResize(C,D,A)}C.fireEvent("columnresize",C,D,A)},onHeaderClick:function(E,D,B){var C=this,A=E.getView().getSelectionModel();E.fireEvent("headerclick",C,E,D,B);if(C.fireEvent("headerclick",C,E,D,B)!==false){if(A.onHeaderClick){A.onHeaderClick(C,E,D)}}},onHeaderContextMenu:function(C,B,A){C.fireEvent("headercontextmenu",this,C,B,A);this.fireEvent("headercontextmenu",this,C,B,A)},onHeaderTriggerClick:function(D,C,A){var B=this;if(D.fireEvent("headertriggerclick",B,D,C,A)!==false&&B.fireEvent("headertriggerclick",B,D,C,A)!==false){if(D.activeMenu){if(C.pointerType){D.activeMenu.hide()}else{D.activeMenu.focus()}}else{B.showMenuBy(C,A,D)}}},showMenuBy:function(A,D,H){var F=this.getMenu(),G=F.down("#ascItem"),E=F.down("#descItem"),C,B=A&&A.pointerType==="touch";F.activeHeader=F.ownerCmp=H;H.setMenuActive(F);C=H.sortable?"enable":"disable";if(G){G[C]()}if(E){E[C]()}F.autoFocus=!A||A.keyCode;F.showBy(D,"tl-bl?");if(!F.isVisible()){this.onMenuHide(F)}},hideMenu:function(){if(this.menu){this.menu.hide()}},onMenuHide:function(A){A.activeHeader.setMenuActive(false)},purgeHeaderCtCache:function(A){while(A){A.purgeCache();if(A.isRootHeader){return }A=A.ownerCt}},purgeCache:function(){var C=this,B=C.visibleColumnManager,A=C.columnManager;C.gridVisibleColumns=C.gridDataColumns=C.hideableColumns=null;if(B){B.invalidate();A.invalidate()}},getMenu:function(){var B=this,A=B.view&&B.view.ownerGrid;if(!B.menu){B.menu=new Ext.menu.Menu({hideOnParentHide:false,items:B.getMenuItems(),listeners:{beforeshow:B.beforeMenuShow,hide:B.onMenuHide,scope:B}});B.fireEvent("menucreate",B,B.menu);if(A){A.fireEvent("headermenucreate",A,B.menu,B)}}return B.menu},beforeMenuShow:function(E){var C=this,B=E.child("#columnItem"),A,D;if(!B){A=C.enableColumnHide?C.getColumnMenu(C):null;D=C.sortable?2:0;if(A&&A.length){E.insert(D,[{itemId:"columnItemSeparator",xtype:"menuseparator"},{itemId:"columnItem",text:C.columnsText,iconCls:C.menuColsIcon,menu:{items:A},hideOnClick:false}])}}C.updateMenuDisabledState(C.menu)},getMenuItems:function(){var C=this,B=[],A=C.enableColumnHide?C.getColumnMenu(C):null;if(C.sortable){B=[{itemId:"ascItem",text:C.sortAscText,iconCls:C.menuSortAscCls,handler:C.onSortAscClick,scope:C},{itemId:"descItem",text:C.sortDescText,iconCls:C.menuSortDescCls,handler:C.onSortDescClick,scope:C}]}if(A&&A.length){if(C.sortable){B.push({itemId:"columnItemSeparator",xtype:"menuseparator"})}B.push({itemId:"columnItem",text:C.columnsText,iconCls:C.menuColsIcon,menu:A,hideOnClick:false})}return B},onSortAscClick:function(){var B=this.getMenu(),A=B.activeHeader;A.sort("ASC")},onSortDescClick:function(){var B=this.getMenu(),A=B.activeHeader;A.sort("DESC")},getColumnMenu:function(F){var C=[],B=0,E,A=F.query(">gridcolumn[hideable]"),G=A.length,D;for(;B<G;B++){E=A[B];D=new Ext.menu.CheckItem({text:E.menuText||E.text,checked:!E.hidden,hideOnClick:false,headerId:E.id,menu:E.isGroupHeader?this.getColumnMenu(E):undefined,checkHandler:this.onColumnCheckChange,scope:this});C.push(D)}return C.length?C:null},onColumnCheckChange:function(A,B){var C=Ext.getCmp(A.headerId);if(C.rendered){C[B?"show":"hide"]()}else{C.hidden=!B}},getColumnCount:function(){return this.getGridColumns().length},getTableWidth:function(){var C=0,B=this.getVisibleGridColumns(),D=B.length,A;for(A=0;A<D;A++){C+=B[A].getCellWidth()||0}return C},getVisibleGridColumns:function(){var G=this,C,E,B,A,D,F;if(G.gridVisibleColumns){return G.gridVisibleColumns}C=G.getGridColumns();E=G.getRootHeaderCt();B=[];A=C.length;for(D=0;D<A;D++){F=C[D];if(!F.hidden&&!F.isColumnHidden(E)){B[B.length]=F}}G.gridVisibleColumns=B;return B},isColumnHidden:function(B){var A=this.getRefOwner();while(A&&A!==B){if(A.hidden){return true}A=A.getRefOwner()}return false},getGridColumns:function(G,A){if(!G&&this.gridDataColumns){return this.gridDataColumns}var F=this,I=G||[],E,B,D,H,C;A=A||F.hidden;if(F.items){E=F.items.items;if(E){for(B=0,D=E.length;B<D;B++){H=E[B];if(H.isGroupHeader){H.visibleIndex=I.length;H.getGridColumns(I,A)}else{H.hiddenAncestor=A;I.push(H)}}}}if(!G){F.gridDataColumns=I}if(!G&&D){for(B=0,D=I.length;B<D;B++){H=I[B];H.fullColumnIndex=B;H.isFirstVisible=H.isLastVisible=false;if(!(H.hidden||H.hiddenAncestor)){if(!C){H.isFirstVisible=true}C=H}}if(C){C.isLastVisible=true}}return I},getHideableColumns:function(){var B=this,A=B.hideableColumns;if(!A){A=B.hideableColumns=B.query("[hideable]")}return A},getHeaderIndex:function(A){if(!this.columnManager){this.columnManager=this.getRootHeaderCt().columnManager}return this.columnManager.getHeaderIndex(A)},getHeaderAtIndex:function(A){if(!this.columnManager){this.columnManager=this.getRootHeaderCt().columnManager}return this.columnManager.getHeaderAtIndex(A)},getVisibleHeaderClosestToIndex:function(A){if(!this.visibleColumnManager){this.visibleColumnManager=this.getRootHeaderCt().visibleColumnManager}return this.visibleColumnManager.getVisibleHeaderClosestToIndex(A)},applyForceFit:function(G){var L=this,M=L.view,B=Ext.grid.plugin.HeaderResizer.prototype.minColWidth,D=false,Q=Ext.grid.header.Container.prototype.defaultWidth,A=L.el.dom.clientWidth-(M.el.dom.scrollHeight>M.el.dom.clientHeight?Ext.getScrollbarSize().width:0),E=0,K=L.getVisibleGridColumns(),H=G.hidden,J,F,P,I,C;function N(){for(F=0,J=K.length;F<J;F++){P=K[F];if(P===G){continue}P.flex=P.flex||P.width||P.getWidth();E+=P.flex;P.width=null}}function O(){var R;for(F=0,J=K.length;F<J;F++){P=K[F];R=(P===G);if(D&&!R){P.flex=B;P.width=null}else{if(!R){C=P.flex||Q;P.flex=Math.max(Math.ceil((C/E)*A),B);P.width=null}}P.setWidth(P.width||P.flex)}}Ext.suspendLayouts();I=(A-((K.length+1)*B));G.flex=null;if(H){C=G.width||G.savedWidth;G.savedWidth=null}else{C=M.getMaxContentWidth(G)}if(C>I){G.width=I;D=true}else{G.width=C;A-=C+Q;N()}O();Ext.resumeLayouts(true)},autoSizeColumn:function(B){var A=this.view;if(A){A.autoSizeColumn(B);if(this.forceFit){this.applyForceFit(B)}}},getRefItems:function(B){var A=this.callParent([B]);if(this.menu){A.push(this.menu)}return A},privates:{beginChildHide:function(){++this.childHideCount},endChildHide:function(){--this.childHideCount},getFocusables:function(){return this.isRootHeader?this.getVisibleGridColumns():this.items.items},createFocusableContainerKeyNav:function(A){var B=this;return new Ext.util.KeyNav(A,{scope:B,down:B.showHeaderMenu,left:B.onFocusableContainerLeftKey,right:B.onFocusableContainerRightKey,home:B.onHomeKey,end:B.onEndKey,space:B.onHeaderActivate,enter:B.onHeaderActivate})},onHomeKey:function(A){return this.focusChild(null,true,A)},onEndKey:function(A){return this.focusChild(null,false,A)},showHeaderMenu:function(B){var A=this.getFocusableFromEvent(B);if(A&&A.isColumn&&A.triggerEl){this.onHeaderTriggerClick(A,B,A.triggerEl)}},onHeaderActivate:function(D){var C=this.getFocusableFromEvent(D),A,B;if(C&&C.isColumn){A=C.getView();if(C.sortable&&this.sortOnClick){B=A.getNavigationModel().getLastFocused();C.toggleSortState();if(B){A.ownerCt.ensureVisible(B.record)}}this.onHeaderClick(C,D,C.el)}},onFocusableContainerMousedown:function(C,B){var A=Ext.Component.fromElement(B);if(A===this){C.preventDefault()}else{A.focus()}}}})