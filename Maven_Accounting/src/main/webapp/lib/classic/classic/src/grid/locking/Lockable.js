Ext.define("Ext.grid.locking.Lockable",{alternateClassName:"Ext.grid.Lockable",requires:["Ext.grid.locking.View","Ext.grid.header.Container","Ext.grid.locking.HeaderContainer","Ext.view.Table"],syncRowHeight:true,headerCounter:0,scrollDelta:40,lockedGridCls:Ext.baseCSSPrefix+"grid-inner-locked",normalGridCls:Ext.baseCSSPrefix+"grid-inner-normal",lockingBodyCls:Ext.baseCSSPrefix+"grid-locking-body",unlockText:"Unlock",lockText:"Lock",bothCfgCopy:["hideHeaders","enableColumnHide","enableColumnMove","enableColumnResize","sortableColumns","multiColumnSort","columnLines","rowLines","variableRowHeight","numFromEdge","trailingBufferZone","leadingBufferZone","scrollToLoadBuffer","syncRowHeight"],normalCfgCopy:["scroll"],lockedCfgCopy:[],determineXTypeToCreate:function(E){var C=this,G,D,B,F,A;if(C.subGridXType){G=C.subGridXType}else{if(!E){return"gridpanel"}D=this.getXTypes().split("/");B=D.length;F=D[B-1];A=D[B-2];if(A!=="tablepanel"){G=A}else{G=F}}return G},injectLockable:function(){this.focusable=false;this.lockable=true;this.hasView=true;var U=this,J=Ext.getScrollbarSize(),N=J.width,E=U.store=Ext.StoreManager.lookup(U.store),C=U.lockedViewConfig,T=U.normalViewConfig,L=Ext.Object,H,I,R,G,K,B,F,Q,S=U.viewConfig,A=S&&S.loadMask,M=(A!==undefined)?A:U.loadMask,O=U.bufferedRenderer,P=N>0&&Ext.supports.touchScroll!==2,D=U.getInherited().rtl;H=U.constructLockableFeatures();U.features=null;I=U.constructLockablePlugins();U.plugins=I.topPlugins;R={id:U.id+"-locked",$initParent:U,isLocked:true,bufferedRenderer:O,ownerGrid:U,ownerLockable:U,xtype:U.determineXTypeToCreate(true),store:E,reserveScrollbar:P,scrollable:{indicators:{x:true,y:false}},scrollerOwner:false,animate:false,border:false,cls:U.lockedGridCls,isLayoutRoot:function(){return this.floatedFromCollapse||U.normalGrid.floatedFromCollapse},features:H.lockedFeatures,plugins:I.lockedPlugins};G={id:U.id+"-normal",$initParent:U,isLocked:false,bufferedRenderer:O,ownerGrid:U,ownerLockable:U,xtype:U.determineXTypeToCreate(),store:E,reserveScrollbar:U.reserveScrollbar,scrollerOwner:false,border:false,cls:U.normalGridCls,isLayoutRoot:function(){return this.floatedFromCollapse||U.lockedGrid.floatedFromCollapse},features:H.normalFeatures,plugins:I.normalPlugins};U.addCls(Ext.baseCSSPrefix+"grid-locked");Ext.copy(G,U,U.bothCfgCopy,true);Ext.copy(R,U,U.bothCfgCopy,true);Ext.copy(G,U,U.normalCfgCopy,true);Ext.copy(R,U,U.lockedCfgCopy,true);Ext.apply(G,U.normalGridConfig);Ext.apply(R,U.lockedGridConfig);for(K=0;K<U.normalCfgCopy.length;K++){delete U[U.normalCfgCopy[K]]}for(K=0;K<U.lockedCfgCopy.length;K++){delete U[U.lockedCfgCopy[K]]}U.addStateEvents(["lockcolumn","unlockcolumn"]);B=U.processColumns(U.columns||[],R);R.columns=B.locked;if(!R.columns.items.length){R.hidden=true}G.columns=B.normal;if(!G.columns.items.length){G.hidden=true}G.flex=1;R.viewConfig=C=(C?L.chain(C):{});G.viewConfig=T=(T?L.chain(T):{});C.loadingUseMsg=false;C.loadMask=false;if(P){if(D){C.margin="0 0 0 -"+N+"px"}else{C.margin="0 -"+N+"px 0 0"}}T.loadMask=false;if(S&&S.id){Ext.log.warn('id specified on Lockable viewConfig, it will be shared between both views: "'+S.id+'"')}Ext.applyIf(C,S);Ext.applyIf(T,S);if(!U.initialConfig.layout){U.layout={type:"hbox",align:"stretch"}}U.getLayout();if(U.layout.type==="border"){if(U.split){R.split=true}if(!R.region){R.region="west"}if(!G.region){G.region="center"}U.addCls(Ext.baseCSSPrefix+"grid-locked-split")}if(!(U.layout instanceof Ext.layout.container.Box)){U.split=false}U.view=new Ext.grid.locking.View({loadMask:M,locked:R,normal:G,ownerGrid:U});R=U.lockedGrid;G=U.normalGrid;G.getView().getScrollable().addPartner(R.getView().getScrollable(),"y");if(J.height&&Ext.supports.touchScroll!==2){R.on({afterlayout:U.afterLockedViewLayout,scope:U});R.getView().getOverflowStyle()}F=R.headerCt;Q=G.headerCt;if(P&&!D){F.reserveScrollbar=false}U.headerCt=U.view.headerCt=new Ext.grid.locking.HeaderContainer(U);F.lockedCt=true;F.lockableInjected=true;Q.lockableInjected=true;F.on({add:U.delaySyncLockedWidth,remove:U.delaySyncLockedWidth,columnshow:U.delaySyncLockedWidth,columnhide:U.delaySyncLockedWidth,sortchange:U.onLockedHeaderSortChange,columnresize:U.delaySyncLockedWidth,scope:U});Q.on({add:U.delaySyncLockedWidth,remove:U.delaySyncLockedWidth,columnshow:U.delaySyncLockedWidth,columnhide:U.delaySyncLockedWidth,sortchange:U.onNormalHeaderSortChange,scope:U});U.modifyHeaderCt();U.items=[R];if(U.split){U.addCls(Ext.baseCSSPrefix+"grid-locked-split");U.items[1]={xtype:"splitter"}}U.items.push(G);U.relayHeaderCtEvents(F);U.relayHeaderCtEvents(Q);U.storeRelayers=U.relayEvents(E,["filterchange","groupchange","beforeload","load"]);U.gridRelayers=U.relayEvents(G,["viewready"])},afterInjectLockable:function(){delete this.lockedGrid.$initParent;delete this.normalGrid.$initParent},getLockingViewConfig:function(){return{xclass:"Ext.grid.locking.View",locked:this.lockedGrid,normal:this.normalGrid,panel:this}},processColumns:function(F,D){var L=this,G,I,E,K=new Ext.grid.header.Container({"$initParent":L}),J=[],C=[],B={itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt",items:J},H={itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt",items:C},M={locked:B,normal:H},A;if(Ext.isObject(F)){Ext.applyIf(B,F);Ext.applyIf(H,F);A=Ext.apply({},F);delete A.items;Ext.apply(K,A);F=F.items}K.constructing=true;for(G=0,I=F.length;G<I;++G){E=F[G];if(!E.isComponent){E=K.applyDefaults(E);E.$initParent=K;E=K.lookupComponent(E);delete E.$initParent}E.processed=true;if(E.locked||E.autoLock){J.push(E)}else{C.push(E)}}L.fireEvent("processcolumns",L,J,C);K.destroy();return M},afterLockedViewLayout:function(){var D=this,A=D.lockedGrid,C=D.normalGrid,I=A.getView(),B=C.getView(),H=I.scrollFlags.x&&A.headerCt.tooNarrow,G=B.scrollFlags.x&&C.headerCt.tooNarrow,E=B.getScrollable(),F=I.getScrollable();if(H!==G){if(H){E.setX("scroll");F.setX(true)}else{F.setX("scroll");E.setX(true)}}else{F.setX(G?"scroll":true);E.setX(true)}},ensureLockedVisible:function(){this.lockedGrid.ensureVisible.apply(this.lockedGrid,arguments);this.normalGrid.ensureVisible.apply(this.normalGrid,arguments)},onLockedViewMouseWheel:function(H){var D=this,A=-D.scrollDelta*H.getWheelDeltas().y,C=D.lockedGrid.getView(),E=C.el.dom,G,B,F;if(!D.ignoreMousewheel){if(E){G=C.getScrollY();B=G!==E.scrollHeight-E.clientHeight;F=G!==0}if((A<0&&F)||(A>0&&B)){H.stopEvent();G+=A;C.setScrollY(G);D.normalGrid.getView().setScrollY(G);D.onNormalViewScroll()}}},onLockedViewScroll:function(){var F=this,E=F.lockedGrid.getView(),D=F.normalGrid.getView(),C=E.getScrollY(),G=D.getScrollY(),A,B;if(G!==C){D.setScrollY(C);if(D.bufferedRenderer){B=E.body.dom;A=D.body.dom;A.style.position="absolute";A.style.top=B.style.top}}},onNormalViewScroll:function(){var D=this,C=D.lockedGrid.getView(),B=D.normalGrid.getView(),A=C.getScrollY(),F=B.getScrollY(),E;if(F!==A){C.setScrollY(F);if(B.bufferedRenderer){E=C.body;if(E.dom){E.dom.style.position="absolute";E.translate(null,B.bufferedRenderer.bodyTop)}}}},syncRowHeights:function(){if(!this.destroyed){var D=this,B=D.normalGrid.getView(),C=D.lockedGrid.getView(),F=B.syncRowHeightBegin(),A=C.syncRowHeightBegin(),E;B.syncRowHeightMeasure(F);C.syncRowHeightMeasure(A);B.syncRowHeightFinish(F,A);C.syncRowHeightFinish(A,F);E=B.getScrollY();C.setScrollY(E)}},modifyHeaderCt:function(){var A=this;A.lockedGrid.headerCt.getMenuItems=A.getMenuItems(A.lockedGrid.headerCt.getMenuItems,true);A.normalGrid.headerCt.getMenuItems=A.getMenuItems(A.normalGrid.headerCt.getMenuItems,false);A.lockedGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(A.lockedGrid.headerCt.showMenuBy,A.showMenuBy);A.normalGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(A.normalGrid.headerCt.showMenuBy,A.showMenuBy)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},showMenuBy:function(A,C,G){var F=this.getMenu(),D=F.down("#unlockItem"),E=F.down("#lockItem"),B=D.prev();if(G.lockable===false){B.hide();D.hide();E.hide()}else{B.show();D.show();E.show();if(!D.initialConfig.disabled){D.setDisabled(G.lockable===false)}if(!E.initialConfig.disabled){E.setDisabled(!G.isLockable())}}},getMenuItems:function(F,C){var G=this,H=G.unlockText,A=G.lockText,I=Ext.baseCSSPrefix+"hmenu-unlock",B=Ext.baseCSSPrefix+"hmenu-lock",E=G.onUnlockMenuClick.bind(G),D=G.onLockMenuClick.bind(G);return function(){var J=F.call(this);J.push("-",{itemId:"unlockItem",iconCls:I,text:H,handler:E,disabled:!C});J.push({itemId:"lockItem",iconCls:B,text:A,handler:D,disabled:C});return J}},syncTaskDelay:1,delaySyncLockedWidth:function(){var B=this,A=B.syncLockedWidthTask;if(!B.view.all.getCount()){return }if(!A){A=B.syncLockedWidthTask=new Ext.util.DelayedTask(B.syncLockedWidth,B)}if(B.syncTaskDelay===0){B.syncLockedWidth()}else{A.delay(1)}},syncLockedWidth:function(){var E=this,H=E.rendered,C=E.lockedGrid,D=C.view,G=E.normalGrid,F=C.getVisibleColumnManager().getColumns().length,A=G.getVisibleColumnManager().getColumns().length,B=E.syncLockedWidthTask;if(B){B.cancel()}Ext.suspendLayouts();if(A){G.show();if(F){if(H&&C.shrinkWrapColumns&&!C.headerCt.forceFit){delete C.flex;C.setWidth(C.headerCt.getTableWidth()+C.gridPanelBorderWidth)}C.addCls(E.lockedGridCls);C.show();if(C.split){E.child("splitter").show();E.addCls(Ext.baseCSSPrefix+"grid-locked-split")}}else{if(H){C.getView().clearViewEl(true)}C.hide();if(C.split){E.child("splitter").hide();E.removeCls(Ext.baseCSSPrefix+"grid-locked-split")}}if(Ext.supports.touchScroll!==2&&Ext.Component.pendingLayouts){D.getScrollable().setX(true)}if(H){E.ignoreMousewheel=D.scrollFlags.y}}else{G.hide();C.flex=1;delete C.width;C.removeCls(E.lockedGridCls);C.show();E.ignoreMousewheel=true}Ext.resumeLayouts(true);return[F,A]},onLockedHeaderSortChange:Ext.emptyFn,onNormalHeaderSortChange:Ext.emptyFn,lock:function(F,K,E){var H=this,G=H.normalGrid,C=H.lockedGrid,D=G.view,M=C.view,J=G.headerCt,I,A,B,L;F=F||J.getMenu().activeHeader;B=F.hasFocus;E=E||C.headerCt;A=F.ownerCt;if(!F.isLockable()){return }if(F.flex&&C.shrinkWrapColumns){F.width=F.getWidth();F.flex=null}Ext.suspendLayouts();if(C.hidden){if(!C.componentLayoutCounter){if(M.bufferedRenderer){M.bufferedRenderer.onViewResize(M,0,D.getHeight())}L=D.getScrollY()}C.show()}D.blockRefresh=M.blockRefresh=true;F.ownerCmp=F.ownerCt;A.remove(F,false);F.locked=true;if(Ext.isDefined(K)){E.insert(K,F)}else{E.add(F)}D.blockRefresh=M.blockRefresh=false;F.ownerCmp=null;I=H.syncLockedWidth();if(I[0]){C.getView().refreshView()}if(I[1]){G.getView().refreshView()}H.fireEvent("lockcolumn",H,F);Ext.resumeLayouts(true);if(L){M.setScrollY(L);D.setScrollY(L)}if(B){F.focus()}},unlock:function(E,J,D){var G=this,F=G.normalGrid,B=G.lockedGrid,C=F.view,K=B.view,I=B.headerCt,H,A;if(!Ext.isDefined(J)){J=0}E=E||I.getMenu().activeHeader;A=E.hasFocus;D=D||F.headerCt;Ext.suspendLayouts();C.blockRefresh=K.blockRefresh=true;E.ownerCmp=E.ownerCt;E.ownerCt.remove(E,false);E.locked=false;D.insert(J,E);C.blockRefresh=K.blockRefresh=false;E.ownerCmp=null;H=G.syncLockedWidth();if(H[0]){B.getView().refreshView()}if(H[1]){F.getView().refreshView()}G.fireEvent("unlockcolumn",G,E);Ext.resumeLayouts(true);if(A){E.focus()}},reconfigureLockable:function(B,C){var E=this,H=E.store,G=E.lockedGrid,F=E.normalGrid,A,D;if(B&&B!==H){B=Ext.data.StoreManager.lookup(B);E.store=B;G.view.blockRefresh=F.view.blockRefresh=true;G.bindStore(B);A=G.view;A.store=B;if(!A.dataSource.isFeatureStore){A.dataSource=B}if(A.bufferedRenderer){A.bufferedRenderer.bindStore(B)}F.bindStore(B);A=F.view;A.store=B;if(!A.dataSource.isFeatureStore){A.dataSource=B}if(A.bufferedRenderer){A.bufferedRenderer.bindStore(B)}E.view.store=B;D=E.view.loadMask;if(D&&D.isLoadMask){D.bindStore(B)}E.view.bindStore(F.view.dataSource,false,"dataSource");G.view.blockRefresh=F.view.blockRefresh=false}if(C){G.reconfiguring=F.reconfiguring=true;G.headerCt.removeAll();F.headerCt.removeAll();C=E.processColumns(C,G);G.headerCt.add(C.locked.items);F.headerCt.add(C.normal.items);G.reconfiguring=F.reconfiguring=false;E.syncLockedWidth()}E.refreshCounter=G.view.refreshCounter},afterReconfigureLockable:function(){var A=this.lockedGrid.getView();if(this.refreshCounter===A.refreshCounter){this.view.refresh()}},constructLockableFeatures:function(){var E=this.features,C,D,F,G,B=0,A;if(E){if(!Ext.isArray(E)){E=[E]}F=[];G=[];A=E.length;for(;B<A;B++){C=E[B];if(!C.isFeature){C=Ext.create("feature."+C.ftype,C)}switch(C.lockableScope){case"locked":F.push(C);break;case"normal":G.push(C);break;default:C.lockableScope="both";F.push(C);G.push(D=C.clone());D.lockingPartner=C;C.lockingPartner=D}}}return{normalFeatures:G,lockedFeatures:F}},constructLockablePlugins:function(){var C=this.plugins,G,B,A,I,J,E,F=0,H,K,D;if(C){if(!Ext.isArray(C)){C=[C]}I=[];J=[];E=[];H=C.length;for(;F<H;F++){G=C[F];if(G.init){K=G.lockableScope}else{D=G.ptype?Ext.ClassManager.getByAlias(("plugin."+G.ptype)):Ext.ClassManager.get(G.xclass);K=D.prototype.lockableScope}switch(K){case"both":J.push(A=G.clonePlugin());E.push(B=G.clonePlugin());A.lockingPartner=B;B.lockingPartner=A;Ext.destroy(G);break;case"locked":J.push(G);break;case"normal":E.push(G);break;default:I.push(G)}}}return{topPlugins:I,normalPlugins:E,lockedPlugins:J}},destroyLockable:function(){var B=this,A=B.syncLockedWidthTask;if(A){A.cancel();B.syncLockedWidthTask=null}if(B.lockedGrid&&B.lockedGrid.headerCt){B.lockedGrid.headerCt.showMenuBy=null}if(B.normalGrid&&B.normalGrid.headerCt){B.normalGrid.headerCt.showMenuBy=null}Ext.destroy(B.view,B.headerCt)}},function(){this.borrow(Ext.Component,["constructPlugin"])})