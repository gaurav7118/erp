Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",alias:"plugin.bufferedrenderer",isBufferedRenderer:true,lockableScope:"both",numFromEdge:2,trailingBufferZone:10,leadingBufferZone:20,synchronousRender:true,scrollToLoadBuffer:200,viewSize:100,rowHeight:21,position:0,lastScrollDirection:1,bodyTop:0,scrollHeight:0,loadId:0,init:function(C){var D=this,A=C.view,B={scroll:D.onViewScroll,scrollend:D.onViewScrollEnd,refresh:D.onViewRefresh,columnschanged:D.checkVariableRowHeight,boxready:D.onViewBoxReady,scope:D,destroyable:true},E=A.initialConfig;if(C.isTree||(C.ownerLockable&&C.ownerLockable.isTree)){A.blockRefresh=false;if(E&&E.loadMask===undefined){A.loadMask=true}}if(A.positionBody){B.refresh=D.onViewRefresh}if(Ext.isWebKit&&Ext.supports.touchScroll!==2){D.needsPointerEventsFix=true;B.scrollEnd=D.onViewScrollEnd}D.grid=C;D.view=A;D.isRTL=A.getInherited().rtl;A.bufferedRenderer=D;A.preserveScrollOnRefresh=true;A.animate=false;D.bindStore(A.dataSource);if(A.hasOwnProperty("rowHeight")){D.rowHeight=A.rowHeight}D.position=0;D.viewListeners=A.on(B)},checkVariableRowHeight:function(){this.variableRowHeight=this.view.hasVariableRowHeight()},bindStore:function(C){var D=this,A=D.store,B=D.view;if(A&&A.isFeatureStore){return }if(A){D.unbindStore()}D.storeListeners=C.on({scope:D,groupchange:D.onStoreGroupChange,clear:D.onStoreClear,beforeload:D.onBeforeStoreLoad,load:D.onStoreLoad,destroyable:true});D.store=C;if(D.view.componentLayout.layoutCount){delete D.viewSize;if(C.isBufferedStore){C.setViewSize(D.viewSize)}D.onViewResize(D.view,0,D.view.getHeight())}},unbindStore:function(){this.storeListeners.destroy();this.storeListeners=this.store=null},onBeforeStoreLoad:function(B){var C=this,A=C.view;if(A&&A.refreshCounter){if(B.isTreeStore||A.preserveScrollOnReload){C.nextRefreshStartIndex=A.all.startIndex}else{if(C.scrollTop!==0){C.setBodyTop(C.bodyTop=C.scrollTop=C.position=C.scrollHeight=C.nextRefreshStartIndex=0);A.setScrollY(0)}}C.lastScrollDirection=C.scrollOffset=null}C.disable()},onStoreLoad:function(){this.enable()},onStoreClear:function(){var B=this,A=B.view;if(A.rendered&&!B.store.destroyed){if(B.scrollTop!==0){B.bodyTop=B.scrollTop=B.position=B.scrollHeight=0;B.nextRefreshStartIndex=null;A.setScrollY(0)}A.refresh();B.lastScrollDirection=B.scrollOffset=null}},onStoreGroupChange:function(A){this.refreshSize()},onViewBoxReady:function(A){this.refreshScroller(A,this.scrollHeight)},onViewRefresh:function(B,C){var D=this,E=B.all,A;D.checkVariableRowHeight();if(!B.componentLayoutCounter&&(B.headerCt.down("{flex}")||D.variableRowHeight)){B.on({boxready:Ext.Function.pass(D.onViewRefresh,[B,C],D),single:true});D.skipNextRefreshSize=true;return }D.skipNextRefreshSize=false;if(D.refreshing){return }D.refreshSize();if(D.scrollTop!==B.getScrollY()){D.onViewScroll();D.onViewScrollEnd()}else{if(!D.hasOwnProperty("bodyTop")){D.bodyTop=E.startIndex*D.rowHeight;B.setScrollY(D.bodyTop)}D.setBodyTop(D.bodyTop);A=B.getHeight();if(E.getCount()&&A>0){D.onViewResize(B,null,A);if(C&&(E.getCount()!==C.length)){C.length=0;C.push.apply(C,D.store.getRange(E.startIndex,E.endIndex))}}}},beforeTableLayout:function(A){var B=this.view.body.dom;if(B){A.bodyHeight=B.offsetHeight;A.bodyWidth=B.offsetWidth}},afterTableLayout:function(D){var B=this,A=B.view,C;if(D.bodyHeight&&A.body.dom){delete B.rowHeight;B.refreshSize();C=A.body.dom.offsetHeight;if(C!==D.bodyHeight){B.onViewResize(A,null,A.el.lastBox.height);if(C<D.bodyHeight){if(B.viewSize>=B.store.getCount()){B.setBodyTop(0)}else{if(B.bodyTop>B.scrollTop||B.bodyTop+C<B.scrollTop+B.viewClientHeight){B.setBodyTop(B.scrollTop-B.trailingBufferZone*B.rowHeight)}}}if(A.all.endIndex===(A.dataSource.getCount())-1){B.stretchView(A,B.scrollHeight=B.bodyTop+C-1)}}}},refreshSize:function(){var B=this,A=B.view,C=B.skipNextRefreshSize,D=A.body.dom;B.skipNextRefreshSize=false;if(C||!D){return }B.bodyHeight=A.body.dom.offsetHeight;B.scrollHeight=B.getScrollHeight();B.stretchView(A,B.scrollHeight)},onViewResize:function(C,E,A,B,G){var F=this,D;if(!G||A!==G){D=Math.ceil(A/F.rowHeight)+F.trailingBufferZone+F.leadingBufferZone;F.viewSize=F.setViewSize(D);F.viewClientHeight=C.el.dom.clientHeight}},stretchView:function(B,A){var C=this;if(C.scrollTop>A){C.position=C.scrollTop=Math.max(A-C.bodyHeight,0);B.setScrollY(C.scrollTop)}if(C.bodyTop>A){B.body.translate(null,C.bodyTop=C.position)}if(B.getScrollable()){C.refreshScroller(B,A)}},refreshScroller:function(C,B){var A=C.getScrollable();if(A){if(A.setElementSize){A.setElementSize()}A.setSize({x:C.headerCt.getTableWidth(),y:B})}},setViewSize:function(K,C){var J=this,N=J.store,L=J.view,O=L.all,F=O.getCount(),B,E,H=J.view.lockingPartner&&J.view.lockingPartner.bufferedRenderer,M=F-K,D,A,G,I;if(H&&!C&&H.view.componentLayoutCounter){if(H.viewSize>K){K=H.viewSize}else{H.setViewSize(K,true)}}M=F-K;if(M){J.scrollTop=L.getScrollY();J.viewSize=K;if(N.isBufferedStore){N.setViewSize(K)}if(F){I=N.getCount();B=O.startIndex;E=Math.min(B+K-1,I-1);if(B===O.startIndex&&E===O.endIndex){if(M<0){J.handleViewScroll(-1)}}else{if(H){H.disable()}if(M<0){if(I>F){N.getRange(O.endIndex+1,E,{callback:function(P,Q){G=L.doAdd(P,Q);L.fireEvent("itemadd",P,Q,G);J.setBodyTop(J.bodyTop)}})}else{J.refreshView(0)}}else{B=O.endIndex-(M-1);E=O.endIndex;A=O.slice(B,E+1);O.removeRange(B,E,true);if(L.hasListeners.itemremove){D=N.getRange(B,E);L.fireEvent("itemremove",D,B,A)}J.setBodyTop(J.bodyTop)}if(H){H.enable()}}}}return K},getViewRange:function(){var B=this,C=B.view.all,A=B.store,D=0;if(C.getCount()){D=C.startIndex}else{if(A.isBufferedStore){if(!A.currentPage){A.currentPage=1}D=C.startIndex=(A.currentPage-1)*(A.pageSize||1);A.currentPage=1}}if(A.data.getCount()){return A.getRange(D,D+(B.viewSize||A.defaultViewSize)-1)}else{return[]}},onReplace:function(I,J,E,F){var G=this,H=G.view,L=H.all,A,D=L.getCount(),C=J+E.length-1,K=F.length-E.length,B=K*G.rowHeight;if(J>=L.startIndex+G.viewSize){G.refreshSize();return }if(D&&C<L.startIndex&&L.getCount()>=G.viewSize){L.moveBlock(K);G.refreshSize();A=L.startIndex;if(K>0){G.doNotMirror=true;G.handleViewScroll(-1);G.doNotMirror=false}if(L.startIndex===A){if(L.startIndex){G.setBodyTop(G.bodyTop+=B);H.suspendEvent("scroll");H.scrollBy(0,B);H.resumeEvent("scroll");G.position=G.scrollTop=H.getScrollY()}}else{H.suspendEvent("scroll");H.scrollBy(0,(A-L.startIndex)*G.rowHeight);H.resumeEvent("scroll")}H.refreshSize(L.getCount()!==D);return }if(D&&J>L.endIndex){G.refreshSize();if(K>0){G.onRangeFetched(null,L.startIndex,Math.min(I.getCount(),L.startIndex+G.viewSize)-1,null,true)}H.refreshSize(L.getCount()!==D);return }if(J<L.startIndex&&C<=L.endIndex){G.refreshView(L.startIndex-E.length+F.length);return }if(J<L.startIndex&&C<=L.endIndex&&B){H.suspendEvent("scroll");H.setScrollY(G.position=G.scrollTop+=B);H.resumeEvent("scroll")}G.refreshView()},scrollTo:function(M,P){var G=arguments,I=this,K=I.view,F=K.lockingPartner&&K.lockingPartner.grid.isVisible()&&K.lockingPartner.bufferedRenderer,N=I.store,J=N.getCount(),H,B,A,O,C,D,E,L;if(P!==undefined&&!(P instanceof Object)){P={select:G[1],callback:G[2],scope:G[3]}}if((C=K.dataSource.groupingFeature)&&(C.collapsible)){if(M.isEntity){E=M}else{E=K.store.getAt(Math.min(Math.max(M,0),K.store.getCount()-1))}D=C.getMetaGroup(E);if(D&&D.isCollapsed){if(!C.isExpandingOrCollapsing){C.expand(C.getGroup(E).getGroupKey());J=N.getCount();M=C.indexOf(E)}else{E=D.placeholder;M=C.indexOfPlaceholder(E)}}else{M=C.indexOf(E)}}else{if(M.isEntity){E=M;M=N.indexOf(E);if(M===-1){Ext.raise("Unknown record passed to BufferedRenderer#scrollTo");return }}else{M=Math.min(Math.max(M,0),J-1);E=N.getAt(M)}}if(E&&(A=K.getNode(E))){K.grid.ensureVisible(E,P);I.onViewScroll();I.onViewScrollEnd();return }if(M<K.all.startIndex){L=-1;H=Math.max(Math.min(M-(Math.floor((I.leadingBufferZone+I.trailingBufferZone)/2)),J-I.viewSize+1),0);B=Math.min(H+I.viewSize-1,J-1)}else{L=1;B=Math.min(M+(Math.floor((I.leadingBufferZone+I.trailingBufferZone)/2)),J-1);H=Math.max(B-(I.viewSize-1),0)}O=Math.max(H*I.rowHeight,0);N.getRange(H,B,{callback:function(R,S,Q){I.renderRange(S,Q,true,true);E=N.data.getRange(M,M+1)[0];A=K.getNode(E);K.body.translate(null,I.bodyTop=O);if(L===1){I.refreshSize()}if(F){F.renderRange(S,Q,true,true);I.syncRowHeights();F.view.body.translate(null,F.bodyTop=O);if(L===1){F.refreshSize()}}if(!A){return }K.grid.ensureVisible(E,P);I.scrollTop=I.position=I.view.getScrollY();if(F){F.position=F.scrollTop=I.scrollTop}}})},onViewScroll:function(){var D=this,B=D.store,A=(B.getCount()),C,F,E=D.scrollTop=D.view.getScrollY();if(D.needsPointerEventsFix){D.view.body.dom.style.pointerEvents="none"}if(!(D.disabled||A<D.viewSize)){C=E-D.position;F=C>0?1:-1;if(Math.abs(C)>=20||(F!==D.lastScrollDirection)){D.lastScrollDirection=F;D.handleViewScroll(D.lastScrollDirection)}}},onViewScrollEnd:function(){if(this.needsPointerEventsFix){this.view.body.dom.style.pointerEvents=""}},handleViewScroll:function(G){var E=this,F=E.view.all,A=E.store,H=E.viewSize,C=A.getCount()-1,D,B;if(G===-1){if(F.startIndex){if(E.topOfViewCloseToEdge()){D=Math.max(0,E.getLastVisibleRowIndex()+E.trailingBufferZone-H)}}}else{if(F.endIndex<C){if(E.bottomOfViewCloseToEdge()){D=Math.max(0,E.getFirstVisibleRowIndex()-E.trailingBufferZone)}}}if(D==null){E.position=E.scrollTop;E.loadId++}else{B=Math.min(D+H-1,C);if(E.variableRowHeight&&B===F.endIndex&&B<C){B++;E.viewSize=H++;if(A.isBufferedStore){A.setViewSize(E.viewSize)}}if(D!==F.startIndex||B!==F.endIndex){E.renderRange(D,B);return true}}},bottomOfViewCloseToEdge:function(){var A=this;if(A.variableRowHeight){return A.bodyTop+A.bodyHeight<A.scrollTop+A.view.lastBox.height+(A.numFromEdge*A.rowHeight)}else{return(A.view.all.endIndex-A.getLastVisibleRowIndex())<A.numFromEdge}},topOfViewCloseToEdge:function(){var A=this;if(A.variableRowHeight){return A.bodyTop>A.scrollTop-(A.numFromEdge*A.rowHeight)}else{return(A.getFirstVisibleRowIndex()-A.view.all.startIndex)<A.numFromEdge}},refreshView:function(F){var C=this,H=C.viewSize,E=C.view.all,A=C.store,G=A.getCount(),B=Math.max(0,G-1),D;if(!G){return C.doRefreshView([],0,0)}else{if(G<H){F=0;D=B}else{if(F==null){if(C.nextRefreshStartIndex!=null){F=C.nextRefreshStartIndex;C.nextRefreshStartIndex=null}else{F=E.startIndex}}F=Math.max(0,Math.min(F,B-(H-C.leadingBufferZone)+1));D=Math.min(F+H-1,B);if(D-F+1>H){F=D-H+1}}}if(F===0&&D===0&&G===0){C.doRefreshView([],0,0)}else{A.getRange(F,D,{callback:C.doRefreshView,scope:C})}},doRefreshView:function(G,O,F,Q){var M=this,N=M.view,P=N.all,K=P.startIndex,I=P.endIndex,L,J,B=P.getCount(),E,A=O!==P.startIndex,D,C,H;if(N.refreshCounter){if(N.hasListeners.beforerefresh&&N.fireEvent("beforerefresh",N)===false){return }N.refreshing=M.refreshing=true;H=N.saveFocusState();N.clearViewEl(true);N.refreshCounter++;if(G.length){E=N.doAdd(G,O);if(A){L=P.item(K,true);J=P.item(I,true);if(L){C=-L.offsetTop}else{if(J){C=P.last(true).offsetTop-J.offsetTop}}if(C){M.bodyTop=Math.max(M.bodyTop+C,0);M.scrollTop=M.bodyTop?M.scrollTop+C:0}else{M.bodyTop=D=O*M.rowHeight;M.scrollTop=Math.max(D-M.rowHeight*(D<M.bodyTop?M.leadingBufferZone:M.trailingBufferZone,0))}}}else{if(M.scrollTop){M.bodyTop=M.scrollTop=0}N.addEmptyText()}if(A){M.setBodyTop(M.bodyTop);N.suspendEvent("scroll");N.setScrollY(M.position=M.scrollTop);N.resumeEvent("scroll")}M.refreshSize();N.refreshSize(P.getCount()!==B);N.fireEvent("refresh",N,G);H();N.headerCt.setSortState();N.refreshNeeded=N.refreshing=M.refreshing=false}else{N.refresh()}},renderRange:function(G,A,F,C){var D=this,E=D.view.all,B=D.store;if(!(G===E.startIndex&&A===E.endIndex)){if(B.rangeCached(G,A)){D.cancelLoad();if(D.synchronousRender||F){D.onRangeFetched(null,G,A,null,C)}else{if(!D.renderTask){D.renderTask=new Ext.util.DelayedTask(D.onRangeFetched,D,null,false)}D.renderTask.delay(1,null,null,[null,G,A,null,C])}}else{D.attemptLoad(G,A)}}},onRangeFetched:function(O,G,E,D,Q){var X=this,N=X.view,J=N.el,C,M=N.all,I,W=0,T,K,L=(N.lockingPartner&&!Q&&!X.doNotMirror)&&N.lockingPartner.bufferedRenderer,U,B,V,A,S,R=X.variableRowHeight,F,P,H;if(N.destroyed){return }if(O){X.scrollTop=X.view.getScrollY()}else{O=X.store.getRange(G,E);if(!O){return }}F=Ext.Element.getActiveElement();P=J.contains(F);T=G*X.rowHeight;if(G<M.startIndex&&E>M.endIndex){V=M.startIndex-G;N.clearViewEl(true);U=N.doAdd(O,G);N.fireEvent("itemadd",O,G,U);for(S=0;S<V;S++){W-=U[S].offsetHeight}K=X.bodyTop+W}else{if(X.teleported||G>M.endIndex||E<M.startIndex){K=T;if(R){A=X.scrollTop<X.position?X.leadingBufferZone:X.trailingBufferZone;if(G>A){K=X.scrollTop-X.rowHeight*A}}N.clearViewEl(true);X.teleported=false}if(!M.getCount()){U=N.doAdd(O,G);N.fireEvent("itemadd",O,G,U)}else{if(E>M.endIndex){I=Math.max(G-M.startIndex,0);if(R){W=M.item(M.startIndex+I,true).offsetTop}U=M.scroll(Ext.Array.slice(O,M.endIndex+1-G),1,I);if(R){K=X.bodyTop+W}else{K=T}}else{I=Math.max(M.endIndex-E,0);C=M.startIndex;U=M.scroll(Ext.Array.slice(O,0,M.startIndex-G),-1,I);if(R){K=X.bodyTop-M.item(C,true).offsetTop;if(!M.startIndex){if(K){N.setScrollY(X.position=(X.scrollTop-=K));K=0}}else{if(K<0){W=M.startIndex*X.rowHeight;N.setScrollY(X.position=(X.scrollTop+=W));K=X.bodyTop+W}}}else{K=T}}}X.position=X.scrollTop}if(P&&!J.contains(F)){H=N.actionableMode?N.actionPosition:N.lastFocused;if(H&&H.column){N.onFocusLeave({});H.column.focus()}}K=Math.max(Math.floor(K),0);if(N.positionBody){X.setBodyTop(K)}if(U&&L&&!L.disabled){L.scrollTop=L.position=X.scrollTop;if(L.view.ownerCt.isVisible()){B=L.onRangeFetched(null,G,E,D,true);if(N.ownerGrid.syncRowHeight||(L.variableRowHeight!==R)){X.syncRowHeights(U,B);X.bodyHeight=N.body.dom.offsetHeight}}if(L.bodyTop!==K){L.setBodyTop(K)}L.view.setScrollY(X.scrollTop)}return U},syncRowHeights:function(F,A){var H=this,G=0,J=1,I=[],B=[],D=Ext.grid.locking.RowSynchronizer,C,E;if(F&&A){G=F.length;J=A.length}if(G!==J){F=H.view.all.slice();A=H.view.lockingPartner.all.slice();G=J=F.length}for(C=0;C<G;C++){I[C]=E=new D(H.view,F[C]);E.measure()}for(C=0;C<J;C++){B[C]=E=new D(H.view.lockingPartner,A[C]);E.measure()}for(C=0;C<G;C++){I[C].finish(B[C]);B[C].finish(I[C])}H.syncRowHeightsFinish()},syncRowHeightsFinish:function(){var C=this,A=C.view,B=A.lockingPartner.bufferedRenderer;if(A.componentLayoutCounter){delete C.rowHeight;C.refreshSize();if(B.rowHeight!==C.rowHeight){delete B.rowHeight;B.refreshSize()}}},setBodyTop:function(D){var E=this,B=E.view,F=B.all,C=E.store,A=B.body;if(!A.dom){return }E.translateBody(A,D);if(E.variableRowHeight){E.bodyHeight=A.dom.offsetHeight;if(F.endIndex===C.getCount()-1){E.scrollHeight=D+E.bodyHeight-1}else{E.scrollHeight=E.getScrollHeight()}E.stretchView(B,E.scrollHeight)}else{E.bodyHeight=F.getCount()*E.rowHeight}},translateBody:function(A,B){A.translate(null,this.bodyTop=B)},getFirstVisibleRowIndex:function(J,C,B,F){var G=this,H=G.view,L=H.all,A=L.elements,D=G.viewClientHeight,E,K,I=G.bodyTop;if(L.getCount()&&G.variableRowHeight){if(!arguments.length){J=L.startIndex;C=L.endIndex;B=G.scrollTop;F=B+D;if(I>F||I+G.bodyHeight<B){G.teleported=true;return Math.floor(G.scrollTop/G.rowHeight)}E=J+Math.min(G.numFromEdge+((G.lastScrollDirection===-1)?G.leadingBufferZone:G.trailingBufferZone),Math.floor((C-J)/2))}else{E=J+Math.floor((C-J)/2)}K=I+A[E].offsetTop;if(K+A[E].offsetHeight<=B){return G.getFirstVisibleRowIndex(E+1,C,B,F)}if(K<=B){return E}else{if(E!==J){return G.getFirstVisibleRowIndex(J,E-1,B,F)}}}return Math.floor(G.scrollTop/G.rowHeight)},getLastVisibleRowIndex:function(K,C,B,F){var H=this,I=H.view,M=I.all,A=M.elements,D=H.viewClientHeight,E,L,G,J=H.bodyTop;if(M.getCount()&&H.variableRowHeight){if(!arguments.length){K=M.startIndex;C=M.endIndex;B=H.scrollTop;F=B+D;if(J>F||J+H.bodyHeight<B){H.teleported=true;return Math.floor(H.scrollTop/H.rowHeight)+Math.ceil(D/H.rowHeight)}E=C-Math.min(H.numFromEdge+((H.lastScrollDirection===1)?H.leadingBufferZone:H.trailingBufferZone),Math.floor((C-K)/2))}else{E=K+Math.floor((C-K)/2)}L=J+A[E].offsetTop;if(L>F){return H.getLastVisibleRowIndex(K,E-1,B,F)}G=L+A[E].offsetHeight;if(G>=F){return E}else{if(E!==C){return H.getLastVisibleRowIndex(E+1,C,B,F)}}}return H.getFirstVisibleRowIndex()+Math.ceil(D/H.rowHeight)},getScrollHeight:function(){var C=this,E=C.view,I=E.all,F=C.store,J=F.getCount(),D=I.getCount(),H,B,A,G;if(!J){return 0}if(!C.hasOwnProperty("rowHeight")){if(D){if(C.variableRowHeight){C.rowHeight=Math.floor(C.bodyHeight/D)}else{H=I.first();B=H.getHeight();if(Ext.isIE8){A=H.getBorderWidth("b");if(A>0){B-=A}}C.rowHeight=B}}else{delete C.rowHeight}}if(C.variableRowHeight){if(I.endIndex===J-1){G=C.bodyTop+C.bodyHeight-1}else{G=Math.floor((J-D)*C.rowHeight)+C.bodyHeight;G+=C.bodyTop-I.startIndex*C.rowHeight}}else{G=Math.floor(J*C.rowHeight)}return(C.scrollHeight=G)},attemptLoad:function(C,A){var B=this;if(B.scrollToLoadBuffer){if(!B.loadTask){B.loadTask=new Ext.util.DelayedTask(B.doAttemptLoad,B,[])}B.loadTask.delay(B.scrollToLoadBuffer,B.doAttemptLoad,B,[C,A])}else{B.doAttemptLoad(C,A)}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(C,A){var B=this;if(!B.destroyed){B.store.getRange(C,A,{loadId:++B.loadId,callback:function(E,G,D,F){if(F.loadId===B.loadId){B.onRangeFetched(E,G,D,F)}},fireEvent:false})}},destroy:function(){var B=this,A=B.view;B.cancelLoad();if(A&&A.el){A.un("scroll",B.onViewScroll,B)}if(B.store){B.unbindStore()}B.viewListeners=B.gridListeners=B.view=B.grid=Ext.destroy(B.viewListeners,B.stretcher,B.gridListeners);B.callParent()}},function(A){if(Ext.supports.Touch){A.prototype.leadingBufferZone=A.prototype.trailingBufferZone=2;A.prototype.numFromEdge=1}})