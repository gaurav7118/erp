Ext.define("Ext.grid.plugin.RowExpander",{extend:"Ext.plugin.Abstract",lockableScope:"normal",requires:["Ext.grid.feature.RowBody"],alias:"plugin.rowexpander",columnWidth:24,rowBodyTpl:null,lockedTpl:null,expandOnDblClick:true,selectRowOnExpand:false,headerWidth:24,bodyBefore:false,rowBodyTrSelector:"."+Ext.baseCSSPrefix+"grid-rowbody-tr",rowBodyHiddenCls:Ext.baseCSSPrefix+"grid-row-body-hidden",rowCollapsedCls:Ext.baseCSSPrefix+"grid-row-collapsed",addCollapsedCls:{fn:function(B,A,C){var D=this.rowExpander;if(!D.recordsExpanded[A.record.internalId]){A.itemClasses.push(D.rowCollapsedCls)}this.nextTpl.applyOut(A,B,C)},syncRowHeights:function(A,B){this.rowExpander.syncRowHeights(A,B)},priority:20000},setCmp:function(A){var C=this,B;C.callParent(arguments);C.recordsExpanded={};if(!C.rowBodyTpl){Ext.raise("The 'rowBodyTpl' config is required and is not defined.")}C.rowBodyTpl=Ext.XTemplate.getTpl(C,"rowBodyTpl");B=C.getFeatureConfig(A);if(A.features){A.features=Ext.Array.push(B,A.features)}else{A.features=B}},getFeatureConfig:function(A){var C=this,B=[],D={ftype:"rowbody",rowExpander:C,bodyBefore:C.bodyBefore,recordsExpanded:C.recordsExpanded,rowBodyHiddenCls:C.rowBodyHiddenCls,rowCollapsedCls:C.rowCollapsedCls,setupRowData:C.getRowBodyFeatureData,setup:C.setup};B.push(Ext.apply({lockableScope:"normal",getRowBodyContents:C.getRowBodyContentsFn(C.rowBodyTpl)},D));if(A.enableLocking){B.push(Ext.apply({lockableScope:"locked",getRowBodyContents:C.lockedTpl?C.getRowBodyContentsFn(C.lockedTpl):function(){return""}},D))}return B},getRowBodyContentsFn:function(A){var B=this;return function(C){A.owner=B;return A.applyTemplate(C.record.getData())}},init:function(B){if(B.lockable){B=B.normalGrid}var D=this,E=B.ownerLockable,A,C;D.callParent(arguments);D.grid=B;A=D.view=B.getView();D.bindView(A);A.addRowTpl(D.addCollapsedCls).rowExpander=D;if(E){D.addExpander(E.lockedGrid.headerCt.items.getCount()?E.lockedGrid:B);C=E.lockedGrid.getView();D.bindView(C);C.addRowTpl(D.addCollapsedCls).rowExpander=D;E.mon(E,{processcolumns:D.onLockableProcessColumns,lockcolumn:D.onColumnLock,unlockcolumn:D.onColumnUnlock,scope:D});D.viewListeners=A.on({itemadd:D.onItemAdd,scope:D})}else{D.addExpander(B);B.on("beforereconfigure",D.beforeReconfigure,D)}},onItemAdd:function(F,H,C){var E=this,G=E.grid.ownerLockable,B=E.lockableSyncRowHeights||(E.lockableSyncRowHeights=Ext.Function.createAnimationFrame(G.syncRowHeights,G)),A=C.length,D;for(D=0;D<A;D++){if(!Ext.fly(C[D]).hasCls(E.rowCollapsedCls)){B();return }}},beforeReconfigure:function(D,A,C,F,B){var E=this;if(E.viewListeners){E.viewListeners.destroy()}if(C){E.expanderColumn=new Ext.grid.Column(E.getHeaderConfig());C.unshift(E.expanderColumn)}},onLockableProcessColumns:function(C,B,A){this.addExpander(B.length?C.lockedGrid:C.normalGrid)},addExpander:function(B){var A=this;A.grid=B;A.expanderColumn=B.headerCt.insert(0,A.getHeaderConfig());B.getSelectionModel().injectCheckbox=1},getRowBodyFeatureData:function(B,A,D){var C=this;C.self.prototype.setupRowData.apply(C,arguments);D.rowBody=C.getRowBodyContents(D);D.rowBodyCls=C.recordsExpanded[B.internalId]?"":C.rowBodyHiddenCls},setup:function(C,D){var B=this,A=B.grid.ownerLockable;B.self.prototype.setup.apply(B,arguments);if(A&&Ext.Array.indexOf(B.grid.columnManager.getColumns(),B.rowExpander.expanderColumn)!==-1){D.rowBodyColspan-=1}},bindView:function(A){A.on("itemkeydown",this.onKeyDown,this);if(this.expandOnDblClick){A.on("itemdblclick",this.onDblClick,this)}},onKeyDown:function(G,C,I,A,D){var E=this,H=D.getKey(),F=G.getNavigationModel().getPosition(),B;if(F){I=Ext.fly(I);B=I.hasCls(E.rowCollapsedCls);if(((H===107||(H===187&&D.shiftKey))&&B)||((H===109||H===189)&&!B)){E.toggleRow(A,C)}}},onDblClick:function(B,A,E,C,D){this.toggleRow(C,A)},toggleRow:function(B,F){var K=this,L=K.view,N=L.bufferedRenderer,G=L.getScrollable(),O=L,C=L.getNode(B),E=Ext.fly(C),D,H=E.down(K.rowBodyTrSelector,true),P=E.hasCls(K.rowCollapsedCls),M=P?"removeCls":"addCls",J=P?2:1,A=K.grid.ownerLockable,I;E[M](K.rowCollapsedCls);Ext.fly(H)[M](K.rowBodyHiddenCls);K.recordsExpanded[F.internalId]=P;if(K.grid.ownerLockable){O=A.getView();if(A.lockedGrid.isVisible()){L=A.view.lockedGrid.view;D=Ext.fly(L.getNode(B));if(D){D[M](K.rowCollapsedCls);H=D.down(K.rowBodyTrSelector,true);Ext.fly(H)[M](K.rowBodyHiddenCls)}}}if(K.expanderColumn){I=Ext.fly(L.getRow(B)).down(K.expanderColumn.getCellSelector(),true);if(I){I.rowSpan=J}}O.fireEvent(P?"expandbody":"collapsebody",C,F,H);if(L.getSizeModel().height.shrinkWrap||A){L.refreshSize(true)}if(G){if(N){N.refreshSize()}else{G.refresh(true)}}},syncRowHeights:function(A,G){var D=this,C=Ext.fly(A).down(D.rowBodyTrSelector),B=Ext.fly(G).down(D.rowBodyTrSelector),F,E;if(B.isVisible()){if((F=C.getHeight())!==(E=B.getHeight())){if(F>E){B.setHeight(F)}else{C.setHeight(E)}}}else{C.dom.style.height=B.dom.style.height=""}},onColumnUnlock:function(C,A){var B=this,D;C=B.grid.ownerLockable;D=C.lockedGrid.visibleColumnManager.getColumns();if(D.length===1){if(D[0]===B.expanderColumn){C.unlock(B.expanderColumn);B.grid=C.normalGrid}else{C.lock(B.expanderColumn,0)}}},onColumnLock:function(C,A){var B=this,E,D;C=B.grid.ownerLockable;E=C.lockedGrid.visibleColumnManager.getColumns();if(E.length===1){B.grid=D=C.lockedGrid;D.headerCt.insert(0,B.expanderColumn)}},getHeaderConfig:function(){var B=this,A=B.grid.ownerLockable;return{width:B.headerWidth,ignoreExport:true,lockable:false,autoLock:true,sortable:false,resizable:false,draggable:false,hideable:false,menuDisabled:true,tdCls:Ext.baseCSSPrefix+"grid-cell-special",innerCls:Ext.baseCSSPrefix+"grid-cell-inner-row-expander",renderer:function(){return'<div class="'+Ext.baseCSSPrefix+'grid-row-expander" role="presentation" tabIndex="0"></div>'},processEvent:function(G,E,C,I,F,H,D){if((G==="click"&&H.getTarget("."+Ext.baseCSSPrefix+"grid-row-expander"))||(G==="keydown"&&H.getKey()===H.SPACE)){B.toggleRow(I,D);return B.selectRowOnExpand}},isLocked:function(){return A&&(A.lockedGrid.isVisible()||this.locked)},editRenderer:function(){return"&#160;"}}}})