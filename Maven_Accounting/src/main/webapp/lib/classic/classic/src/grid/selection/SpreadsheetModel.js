Ext.define("Ext.grid.selection.SpreadsheetModel",{extend:"Ext.selection.Model",requires:["Ext.grid.selection.Selection","Ext.grid.selection.Cells","Ext.grid.selection.Rows","Ext.grid.selection.Columns","Ext.grid.selection.SelectionExtender"],alias:"selection.spreadsheet",isSpreadsheetModel:true,config:{columnSelect:{$value:false,lazy:true},cellSelect:{$value:true,lazy:true},rowSelect:{$value:true,lazy:true},dragSelect:{$value:true,lazy:true},selected:null,extensible:{$value:true,lazy:true}},checkboxSelect:false,checkboxColumnIndex:0,showHeaderCheckbox:true,checkboxHeaderWidth:24,rowNumbererHeaderWidth:46,columnSelectCls:Ext.baseCSSPrefix+"ssm-column-select",rowNumbererHeaderCls:Ext.baseCSSPrefix+"ssm-row-numberer-hd",checkerOnCls:Ext.baseCSSPrefix+"grid-hd-checker-on",tdCls:Ext.baseCSSPrefix+"grid-cell-special "+Ext.baseCSSPrefix+"grid-cell-row-checker",bindComponent:function(A){var C=this,B,D;if(C.view!==A){if(C.view){C.navigationModel=null;Ext.destroy(C.viewListeners,C.navigationListeners)}C.view=A;if(A){C.getCellSelect();D=A.ownerGrid.lockedGrid;if(D){C.hasLockedHeader=true;C.onViewCreated(D,D.getView())}else{A.grid.on({viewcreated:C.onViewCreated,scope:C,single:true})}C.gridListeners=A.ownerGrid.on({columnschanged:C.onColumnsChanged,columnmove:C.onColumnMove,scope:C,destroyable:true});B=C.getViewListeners();B.scope=C;B.destroyable=true;C.viewListeners=A.on(B);C.navigationModel=A.getNavigationModel();C.navigationListeners=C.navigationModel.on({navigate:C.onNavigate,scope:C,destroyable:true});if(C.getColumnSelect()){A.ownerGrid.addCls(C.columnSelectCls)}}}},getCheckboxHeaderConfig:function(){var A=this,B=A.showHeaderCheckbox!==false;return{ignoreExport:true,isCheckerHd:B,text:"&#160;",clickTargetName:"el",width:A.checkboxHeaderWidth,sortable:false,draggable:false,resizable:false,hideable:false,menuDisabled:true,dataIndex:"",tdCls:A.tdCls,cls:B?Ext.baseCSSPrefix+"column-header-checkbox ":"",defaultRenderer:A.checkboxRenderer.bind(A),editRenderer:"&#160;",locked:A.hasLockedHeader}},checkboxRenderer:function(){return'<div class="'+Ext.baseCSSPrefix+'grid-row-checker" role="presentation">&#160;</div>'},onHeaderClick:function(G,H,F){var D=this,E=D.selected,A,B,C;if(H===D.numbererColumn||H===D.checkColumn){F.stopEvent();if(!E||!E.isAllSelected()){D.selectAll()}else{D.deselectAll()}D.updateHeaderState();D.lastColumnSelected=null}else{if(D.columnSelect){if(F.shiftKey&&E&&E.lastColumnSelected){E.clear();A=this.view.ownerGrid.getVisibleColumnManager();B=Ext.Array.sort([A.indexOf(E.lastColumnSelected),A.indexOf(H)],Ext.Array.numericSortFn);for(C=B[0];C<=B[1];C++){D.selectColumn(A.getHeaderAtIndex(C),true)}}else{if(D.isColumnSelected(H)){D.deselectColumn(H);D.selected.lastColumnSelected=null}else{D.selectColumn(H,F.ctrlKey);D.selected.lastColumnSelected=H}}}}},updateHeaderState:function(){var E=this,C=E.view.dataSource,H=C.getCount(),B=E.views,F=E.selected,G=F&&F.isRows&&!C.isBufferedStore&&H>0&&(H===F.getCount()),D=E.checkColumn,A=E.checkerOnCls;if(B&&B.length){if(D){if(G){D.addCls(A)}else{D.removeCls(A)}}}},onBeforeReconfigure:function(D,A,C,F,B){var E=this;if(C){Ext.suspendLayouts();if(E.numbererColumn){E.numbererColumn.ownerCt.remove(E.numbererColumn,false);C.unshift(E.numbererColumn)}if(E.checkColumn){E.checkColumn.ownerCt.remove(E.checkColumn,false);C.unshift(E.checkColumn)}Ext.resumeLayouts()}},getCellContext:function(A,B){return new Ext.grid.CellContext(this.view.ownerGrid.getView()).setPosition(A,B)},select:function(B,K,J){var G=this,A=G.selected,H=G.view,I=H.dataSource,F,D,E,C=false;if(!A||!A.isRows||A.view!==H){G.resetSelection(true);A=G.selected=new Ext.grid.selection.Rows(H)}else{if(!K){A.clear()}}if(!Ext.isArray(B)){B=[B]}F=B.length;for(D=0;D<F;D++){E=B[D];if(typeof E==="number"){E=I.getAt(E)}if(!A.contains(E)){A.add(E);C=true}}if(C){G.updateHeaderState();if(J){G.fireSelectionChange()}}},deselect:function(B,I){var G=this,A=G.selected,H=G.view.dataSource,F,D,E,C=false;if(A&&A.isRows){if(!Ext.isArray(B)){B=[B]}F=B.length;for(D=0;D<F;D++){E=B[D];if(typeof E==="number"){E=H.getAt(E)}C=C||A.remove(E)}}if(C){G.updateHeaderState();if(!I){G.fireSelectionChange()}}},selectCells:function(F,E,B){var C=this,A=C.view.ownerGrid.view,D;F=F.isCellContext?F.clone():new Ext.grid.CellContext(A).setPosition(F);E=E.isCellContext?E.clone():new Ext.grid.CellContext(A).setPosition(E);C.resetSelection(true);C.selected=D=new Ext.grid.selection.Cells(F.view);D.setRangeStart(F);D.setRangeEnd(E);if(!B){C.fireSelectionChange()}},selectAll:function(C){var D=this,E=D.selected,A,B=D.view;if(D.rowSelect){if(!E||!E.isRows){D.resetSelection(true);D.selected=E=new Ext.grid.selection.Rows(B)}A=true}else{if(D.cellSelect){if(!E||!E.isCells){D.resetSelection(true);D.selected=E=new Ext.grid.selection.Cells(B)}A=true}else{if(D.columnSelect){if(!E||!E.isColumns){D.resetSelection(true);D.selected=E=new Ext.grid.selection.Columns(B)}A=true}}}if(A){E.selectAll();D.updateHeaderState();if(!C){D.fireSelectionChange()}}},deselectAll:function(A){var B=this.selected;if(B&&B.getCount()){B.clear();if(!A){this.fireSelectionChange()}}},selectRows:function(H,E,C){var F=this,G=F.selected,B=G&&G.isRows,A=H.length,D;if(!E||!B){F.resetSelection(true)}if(!B){F.selected=G=new Ext.grid.selection.Rows(F.view)}if(H.isEntity){G.add(H)}else{for(D=0;D<A;D++){G.add(H[D])}}if(!C){F.fireSelectionChange()}},isSelected:function(A){return this.isRowSelected(A)},selectColumn:function(D,C,B){var E=this,F=E.selected,A=D.getView();if(!F||!F.isColumns||F.view!==A.ownerGrid.view){E.resetSelection(true);E.selected=F=new Ext.grid.selection.Columns(A)}if(!F.contains(D)){if(!C){F.clear()}F.add(D);E.updateHeaderState();if(!B){E.fireSelectionChange()}}},deselectColumn:function(B,A){var C=this,D=C.getSelected();if(D&&D.isColumns&&D.contains(B)){D.remove(B);C.updateHeaderState();if(!A){C.fireSelectionChange()}}},getSelection:function(){var A=this.selected;if(A&&A.isRows){return A.getRecords()}return[]},destroy:function(){var B=this,A=B.scrollEls;Ext.destroy(B.gridListeners,B.viewListeners,B.selected,B.navigationListeners,B.extensible);if(A){Ext.dd.ScrollManager.unregister(A)}B.selected=B.gridListeners=B.viewListeners=B.selectionData=B.navigationListeners=B.scrollEls=null;B.callParent()},privates:{axesConfigs:{x:1,y:2,xy:3,both:3,"true":3},getViewListeners:function(){return{beforerefresh:this.onBeforeViewRefresh,refresh:this.onViewRefresh,keyup:{element:"el",fn:this.onViewKeyUp,scope:this}}},onViewKeyUp:function(B){var A=this.selected;if(B.keyCode===B.SHIFT&&A&&A.isRows&&A.getRangeSize()){A.addRange()}},onColumnsChanged:function(){var F=this.selected,G,E,H,D,A,B,C;if(F){A=F.view;if(F.isCells){B=new Ext.grid.CellContext(A);G=F.getRowRange();E=A.getVisibleColumnManager().getColumns().length;for(D=G[0];D<=G[1];D++){B.setRow(D);for(H=0;H<E;H++){B.setColumn(H);A.onCellDeselect(B)}}}else{if(F.isColumns){C=false;F.eachColumn(function(I,J){if(!I.isVisible()||!A.ownerGrid.isAncestor(I)){this.remove(I);C=true}})}}}Ext.on("idle",C?this.fireSelectionChange:this.updateSelectionExtender,this,{single:true})},onColumnMove:function(){this.updateSelectionExtender()},onBeforeViewRefresh:function(A){var B=this.selected;if(A.refreshCounter){if(B&&B.isCells){this.resetSelection()}}},onViewRefresh:function(A){var C=this,D=this.selected,B=C.view.store,E=false;if(D&&D.isRows&&B.isFiltered()){D.eachRow(function(F){if(!B.contains(F)){this.remove(F);E=true}})}this[E?"fireSelectionChange":"updateSelectionExtender"]()},resetSelection:function(A){var B=this.selected;if(B){B.clear();if(!A){this.fireSelectionChange()}}},onViewCreated:function(B,A){var C=this,D=A.ownerGrid,E=A.headerCt;if(!D.lockable||A.isLockedView){if(C.getRowSelect()){C.getNumbererColumn()}if(C.checkboxSelect){C.addCheckbox(A,true)}C.mon(A.ownerGrid,"beforereconfigure",C.onBeforeReconfigure,C)}E.sortOnClick=!C.getColumnSelect();if(C.getDragSelect()){A.on("render",C.onViewRender,C,{single:true})}},onViewRender:function(C){var F=this,E=C.getEl(),B=F.views,A=B.length,D;for(D=0;D<A;D++){B[D].headerCt.sortOnClick=!F.columnSelect}E.ddScrollConfig={vthresh:50,hthresh:50,frequency:300,increment:100};Ext.dd.ScrollManager.register(E);(F.scrollEls||(F.scrollEls=[])).push(E);C.on("cellmousedown",F.handleMouseDown,F);if(C.lockingPartner){C.lockingPartner.on("cellmousedown",F.handleMouseDown,F)}},handleMouseDown:function(K,C,J,F,H,A,G){var I=this,B=I.selected,E=G.position.column,D,L;if(G.button||G.shiftKey||G.altKey||G.pointerType==="touch"){return }if(E){D=E===I.checkColumn;if(E===I.numbererColumn||D||!I.cellSelect){if(I.rowSelect){if(B&&B.isRows){if(!G.ctrlKey&&!D){B.clear()}}else{if(B){B.clear()}B=I.selected=new Ext.grid.selection.Rows(K)}L=true}}else{if(B){B.clear()}if(!B||!B.isCells){B=I.selected=new Ext.grid.selection.Cells(K)}L=true}I.lastOverRecord=I.lastOverColumn=null;Ext.getBody().on("mouseup",I.onMouseUp,I,{single:true,view:B.view});if(L){B.view.el.on("mousemove",I.onMouseMove,I,{view:B.view})}}},onMouseMove:function(F,G,A){var J=this,L=A.view,E,B,M=F.getTarget(L.cellSelector),D=A.view.getHeaderByCell(M),I=J.selected,K,H,C;if(J.extensible){J.extensible.disable()}if(D){E=L.getRecord(M.parentNode);B=J.store.indexOf(E);H=E!==J.lastOverRecord;C=D!==J.lastOverColumn;if(H||C){K=J.getCellContext(E,D)}if(I.isRows){if(H){if(J.lastOverRecord){I.setRangeEnd(B)}else{I.setRangeStart(B)}}}else{if(H||C){if(J.lastOverRecord){I.setRangeEnd(K)}else{I.setRangeStart(K)}}}if(H||C){L.getNavigationModel().setPosition(new Ext.grid.CellContext(D.getView()).setPosition(E,D))}J.lastOverColumn=D;J.lastOverRecord=E}},onMouseUp:function(E,D,C){var B=this,A=C.view;if(A&&!A.destroyed){if(B.extensible){B.extensible.disable()}A.el.un("mousemove",B.onMouseMove,B);if(B.selected.isRows){B.selected.addRange()}B.fireSelectionChange()}},addCheckbox:function(A,B){var C=this,D=C.checkboxColumnIndex,E=A.headerCt;if(D!==false){if(D==="first"){D=0}else{if(D==="last"){D=E.getColumnCount()}}C.checkColumn=E.add(D,C.getCheckboxHeaderConfig())}if(B!==true){A.refresh()}},onNavigate:function(E){var F=this,H=E.view.ownerGrid.view,C=E.record,A=F.selected,G=new Ext.grid.CellContext(H).setPosition(C,E.column),D=E.keyEvent,I=D.getKey(),B;if(D.stopSelection){return }if(D.ctrlKey&&(I===D.UP||I===D.LEFT||I===D.RIGHT||I===D.DOWN)){return }if(A&&A.isCells&&A.getCount()>1&&D.type==="click"){return }if(!(F.cellSelect||F.columnSelect||F.rowSelect)||!E.record||D.type==="mousedown"){return }if(D.ctrlKey&&D.keyCode===D.A){if(!A||A.getCount()<2){F.selectAll()}else{F.deselectAll()}F.updateHeaderState();return }if(D.shiftKey){if(G.column===F.numbererColumn||G.column===F.checkColumn||!F.cellSelect||(A&&A.isRows)){if(F.rowSelect){if(!A||!A.isRows||A.view!==H){F.resetSelection(true);A=F.selected=new Ext.grid.selection.Rows(H)}if(!A.getRangeSize()){A.setRangeStart(E.previousRecordIndex||0)}A.setRangeEnd(E.recordIndex);A.addRange();B=true}}else{if(F.cellSelect){if(!A||!A.isCells||A.view!==H){F.resetSelection(true);A=F.selected=new Ext.grid.selection.Cells(H)}if(!A.getRangeSize()){A.setRangeStart(E.previousPosition||F.getCellContext(0,0))}A.setRangeEnd(G);B=true}}}else{if(G.column===F.numbererColumn||G.column===F.checkColumn||!F.cellSelect){if(F.rowSelect){if(!A||!A.isRows||A.view!==H){F.resetSelection(true);A=F.selected=new Ext.grid.selection.Rows(H)}if(D.ctrlKey||G.column===F.checkColumn){if(A.contains(C)){A.remove(C)}else{A.add(C)}}else{A.clear();A.add(C)}B=true}}else{if(F.cellSelect){if(!A||!A.isCells||A.view!==H){F.resetSelection(true);F.selected=A=new Ext.grid.selection.Cells(H)}else{A.clear()}A.setRangeStart(G);B=true}}}if(B){if(A.isRows){F.updateHeaderState()}F.fireSelectionChange()}},isRowSelected:function(A){var B=this,C=B.selected;if(C&&C.isRows){A=Ext.isNumber(A)?B.store.getAt(A):A;return C.contains(A)}else{return false}},isColumnSelected:function(A){var B=this,C=B.selected;if(C&&C.isColumns){return C.contains(A)}else{return false}},isCellSelected:function(A,F,C){var D=this,B,E=D.selected;A=A.ownerGrid.view;if(E){if(E.isColumns){if(typeof C==="number"){C=A.getVisibleColumnManager().getColumns()[C]}return E.contains(C)}if(E.isCells){B=new Ext.grid.CellContext(A).setPosition({row:F,column:C});return E.contains(B)}}return false},applySelected:function(A){if(A&&!(A.isRows||A.isCells||A.isColumns)){Ext.raise("SpreadsheelModel#setSelected must be passed an instance of Ext.grid.selection.Selection")}return A},updateSelected:function(F,G){var C,E,B,D,A;if(G){G.clear()}if(F&&F.getCount()){C=F.view;if(F.isRows){F.eachRow(C.onRowSelect,C)}else{if(F.isColumns){E=F.getColumns();B=E.length;if(B){A=new Ext.grid.CelContext(C);C.store.each(function(H){A.setRow(H);for(D=0;D<B;D++){A.setColumn(E[D]);C.onCellSelect(A)}})}}else{if(F.isCells){F.eachCell(C.onCellSelect,C)}}}}},getNumbererColumn:function(C){var D=this,A=D.numbererColumn,B=D.view;if(!A){if(B.isNormalView){B=B.ownerGrid.lockedGrid}A=D.numbererColumn=B.headerCt.down("rownumberer")||B.headerCt.add(0,D.getNumbererColumnConfig())}return A},getNumbererColumnConfig:function(){var A=this;return{xtype:"rownumberer",width:A.rowNumbererHeaderWidth,editRenderer:"&#160;",tdCls:A.rowNumbererTdCls,cls:A.rowNumbererHeaderCls,locked:A.hasLockedHeader}},updateRowSelect:function(C){var B=this,D=B.selected,A=B.view;if(A&&A.rendered){if(A.isNormalView){A=A.lockingPartner}if(C){if(B.checkColumn){B.checkColumn.show()}B.getNumbererColumn().show()}else{if(B.checkColumn){B.checkColumn.hide()}if(B.numbererColumn){B.numbererColumn.hide()}}if(!C&&D&&D.isRows){D.clear();B.fireSelectionChange()}}},updateColumnSelect:function(F){var D=this,E=D.selected,B=D.views,A=B?B.length:0,C;for(C=0;C<A;C++){B[C].headerCt.sortOnClick=!F}if(!F&&E&&E.isColumns){E.clear();D.fireSelectionChange()}if(F){D.view.ownerGrid.addCls(D.columnSelectCls)}else{D.view.ownerGrid.removeCls(D.columnSelectCls)}},updateCellSelect:function(A){var B=this,C=B.selected;if(!A&&C&&C.isCells){C.clear();B.fireSelectionChange()}},fireSelectionChange:function(){var A=this.view.ownerGrid,B=this.selected;this.updateSelectionExtender();A.fireEvent("selectionchange",A,B)},updateSelectionExtender:function(){var A=this.selected;if(A){A.onSelectionFinish()}},onSelectionFinish:function(D,C,A){var B=this.getExtensible();if(B){B.setHandle(C,A)}},applyExtensible:function(A){var B=this;if(A===true||typeof A==="string"){A={axes:B.axesConfigs[A]}}else{A=Ext.Object.chain(A)}A.view=B.selected.view;return new Ext.grid.selection.SelectionExtender(A)},extendSelection:function(C){var A=this,B=A.selected;if(A.view.ownerGrid.fireEvent("beforeselectionextend",A.view.ownerGrid,B,C)!==false){B.extendRange(C);A.fireSelectionChange()}},onIdChanged:function(A,E,D,B){var C=this.selected;if(C&&C.isRows&&C.selectedRecords){C.selectedRecords.updateKey(E,D)}},onPageAdd:function(D,C,E){var H=this.selected,A=E.length,F,B,G=H&&H.selectedRecords;if(G&&H.isRows){for(F=0;F<A;F++){B=E[F];if(G.get(B.id)){G.replace(B)}}}},refresh:function(){var A=this.getSelected();if(A&&A.isRows){this.callParent()}},onStoreAdd:function(){var A=this.getSelected();if(A&&A.isRows){this.callParent(arguments);this.updateHeaderState()}},onStoreClear:function(){this.resetSelection()},onStoreLoad:function(){var A=this.getSelected();if(A&&A.isRows){this.callParent(arguments);this.updateHeaderState()}},onStoreRefresh:function(){var A=this.selected;if(A&&A.isRows&&A.selectedRecords){this.updateSelectedInstances(A.selectedRecords)}this.updateHeaderState()},onStoreRemove:function(){var A=this.getSelected();if(A&&A.isRows){this.callParent(arguments)}}}},function(B){var A=Ext.ClassManager.get("Ext.grid.column.RowNumberer");if(A){B.prototype.rowNumbererTdCls=Ext.grid.column.RowNumberer.prototype.tdCls+" "+Ext.baseCSSPrefix+"ssm-row-numberer-cell"}})