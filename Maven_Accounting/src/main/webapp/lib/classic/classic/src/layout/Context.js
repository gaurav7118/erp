Ext.define("Ext.layout.Context",{requires:["Ext.perf.Monitor","Ext.util.Queue","Ext.layout.ContextItem","Ext.layout.Layout","Ext.fx.Anim","Ext.fx.Manager"],remainingLayouts:0,state:0,cycleWatchDog:200,constructor:function(A){var B=this;Ext.apply(B,A);B.items={};B.layouts={};B.blockCount=0;B.cycleCount=0;B.flushCount=0;B.calcCount=0;B.animateQueue=B.newQueue();B.completionQueue=B.newQueue();B.finalizeQueue=B.newQueue();B.finishQueue=B.newQueue();B.flushQueue=B.newQueue();B.invalidateData={};B.layoutQueue=B.newQueue();B.invalidQueue=[];B.triggers={data:{},dom:{}}},callLayout:function(B,A){this.currentLayout=B;B[A](this.getCmp(B.owner))},cancelComponent:function(H,A,J){var M=this,G=H,I=!H.isComponent,B=I?G.length:1,D,C,L,K,F,P,N,O,Q,E;for(D=0;D<B;++D){if(I){H=G[D]}if(J){if(H.ownerCt){E=this.items[H.ownerCt.el.id];if(E){Ext.Array.remove(E.childItems,M.getCmp(H))}}else{if(H.rendered){M.removeEl(H.el)}}}if(!A){N=M.invalidQueue;L=N.length;if(L){M.invalidQueue=P=[];for(C=0;C<L;++C){O=N[C];Q=O.item.target;if(Q!==H&&!Q.up(H)){P.push(O)}}}}F=H.componentLayout;M.cancelLayout(F);if(F.getLayoutItems){K=F.getLayoutItems();if(K.length){M.cancelComponent(K,true)}}if(H.isContainer&&!H.collapsed){F=H.layout;M.cancelLayout(F);K=F.getVisibleItems();if(K.length){M.cancelComponent(K,true)}}}},cancelLayout:function(B){var A=this;A.completionQueue.remove(B);A.finalizeQueue.remove(B);A.finishQueue.remove(B);A.layoutQueue.remove(B);if(B.running){A.layoutDone(B)}B.ownerContext=null},clearTriggers:function(F,G){var A=F.id,E=this.triggers[G?"dom":"data"],H=E&&E[A],B=(H&&H.length)||0,D,I,C;for(D=0;D<B;++D){C=H[D];I=C.item;E=G?I.domTriggers:I.triggers;delete E[C.prop][A]}},flush:function(){var D=this,A=D.flushQueue.clear(),C=A.length,B;if(C){++D.flushCount;for(B=0;B<C;++B){A[B].flush()}}},flushAnimations:function(){var D=this,B=D.animateQueue.clear(),A=B.length,C;if(A){for(C=0;C<A;C++){if(B[C].target.animate!==false){B[C].flushAnimations()}}Ext.fx.Manager.runner()}},flushInvalidates:function(){var G=this,A=G.invalidQueue,F=A&&A.length,B,E,D,C;G.invalidQueue=[];if(F){E=[];for(C=0;C<F;++C){B=(D=A[C]).item.target;if(!B.container.isDetachedBody){E.push(B);if(D.options){G.invalidateData[B.id]=D.options}}}G.invalidate(E,null)}},flushLayouts:function(G,A,C){var F=this,H=C?F[G].items:F[G].clear(),E=H.length,B,D;if(E){for(B=0;B<E;++B){D=H[B];if(!D.running){F.callLayout(D,A)}}F.currentLayout=null}},getCmp:function(A){return this.getItem(A,A.el)},getEl:function(B,A){var C=this.getItem(A,A);if(!C.parent){C.parent=B;if(B.children.length){B.children.push(C)}else{B.children=[C]}}return C},getItem:function(D,B){var E=B.id,A=this.items,C=A[E]||(A[E]=new Ext.layout.ContextItem({context:this,target:D,el:B}));return C},handleFailure:function(){var C=this.layouts,B,A;Ext.failedLayouts=(Ext.failedLayouts||0)+1;for(A in C){B=C[A];if(C.hasOwnProperty(A)){B.running=false;B.ownerContext=null}}if(Ext.devMode===2&&!this.pageAnalyzerMode){Ext.raise("Layout run failed")}else{Ext.log.error("Layout run failed")}},invalidate:function(J,L){var N=this,K=!J.isComponent,C,O,A,F,I,P,M,B,G,H,E,D,Q;for(F=0,B=K?J.length:1;F<B;++F){I=K?J[F]:J;if(I.rendered&&!I.hidden){O=I.ownerLayout;G=I.componentLayout;Q=false;if((!O||!O.needsItemSize)&&I.liquidLayout){Q=true}if(!Q||(O&&O.setsItemSize)){P=N.getCmp(I);A=!P.state;H=(I.isContainer&&!I.collapsed)?I.layout:null;E=N.invalidateData[P.id];delete N.invalidateData[P.id];D=P.init(L,E)}if(Q){continue}if(E){N.processInvalidate(E,P,"before")}if(G.beforeLayoutCycle){G.beforeLayoutCycle(P)}if(H&&H.beforeLayoutCycle){H.beforeLayoutCycle(P)}D=P.initContinue(D);C=true;if(G.getLayoutItems){G.renderChildren();M=G.getLayoutItems();if(M.length){N.invalidate(M,true)}}if(H){C=false;H.renderChildren();if(H.needsItemSize||H.activeItemCount){M=H.getVisibleItems();if(M.length){N.invalidate(M,true)}}}P.initDone(C);N.resetLayout(G,P,A);if(H){N.resetLayout(H,P,A)}P.initAnimation();if(E){N.processInvalidate(E,P,"after")}}}N.currentLayout=null},isDescendant:function(A,B){if(A.isContainer){for(var C=B.ownerCt;C;C=C.ownerCt){if(C===A){return true}}}return false},layoutDone:function(A){var B=A.ownerContext;A.running=false;if(A.isComponentLayout){if(B.measuresBox){B.onBoxMeasured()}B.setProp("done",true)}else{B.setProp("containerLayoutDone",true)}--this.remainingLayouts;++this.progressCount},newQueue:function(){return new Ext.util.Queue()},processInvalidate:function(B,E,A){if(B[A]){var D=this,C=D.currentLayout;D.currentLayout=B.layout||null;B[A](E,B);D.currentLayout=C}},queueAnimation:function(A){this.animateQueue.add(A)},queueCompletion:function(A){this.completionQueue.add(A)},queueFinalize:function(A){this.finalizeQueue.add(A)},queueFlush:function(A){this.flushQueue.add(A)},chainFns:function(A,H,F){var D=this,C=A.layout,E=H.layout,B=A[F],G=H[F];return function(I){var J=D.currentLayout;if(B){D.currentLayout=C;B.call(A.scope||A,I,A)}D.currentLayout=E;G.call(H.scope||H,I,H);D.currentLayout=J}},purgeInvalidates:function(){var G=this,J=[],H=G.invalidQueue,E=H.length,I,K,D,C,B,F,A;for(I=0;I<E;++I){B=H[I];F=B.item.target;A=true;for(K=J.length;K--;){D=J[K];C=D.item.target;if(F.isLayoutChild(C)){A=false;break}if(C.isLayoutChild(F)){Ext.Array.erase(J,K,1)}}if(A){J.push(B)}}G.invalidQueue=J},queueInvalidate:function(J,K){var G=this,I=[],H=G.invalidQueue,F=H.length,D,B,E,A,C;if(J.isComponent){D=J;J=G.items[D.el.id];if(J){J.recalculateSizeModel()}else{J=G.getCmp(D)}}else{D=J.target}J.invalid=true;while(F--){B=H[F];E=B.item.target;if(!D.isFloating&&D.up(E)){return }if(E===D){if(!(A=B.options)){B.options=K}else{if(K){if(K.widthModel){A.widthModel=K.widthModel}if(K.heightModel){A.heightModel=K.heightModel}if(!(C=A.state)){A.state=K.state}else{if(K.state){Ext.apply(C,K.state)}}if(K.before){A.before=G.chainFns(A,K,"before")}if(K.after){A.after=G.chainFns(A,K,"after")}}}return }if(!E.isLayoutChild(D)){I.push(B)}}I.push({item:J,options:K});G.invalidQueue=I},queueItemLayouts:function(C){var A=C.isComponent?C:C.target,B=A.componentLayout;if(!B.pending&&!B.invalid&&!B.done){this.queueLayout(B)}B=A.layout;if(B&&!B.pending&&!B.invalid&&!B.done&&!A.collapsed){this.queueLayout(B)}},queueLayout:function(A){this.layoutQueue.add(A);A.pending=true},removeEl:function(D,C){var E=D.id,B=C?C.children:null,A=this.items;if(B){Ext.Array.remove(B,A[E])}delete A[E]},resetLayout:function(B,C,D){var A=this;A.currentLayout=B;B.done=false;B.pending=true;B.firedTriggers=0;A.layoutQueue.add(B);if(D){A.layouts[B.id]=B;B.running=true;if(B.finishedLayout){A.finishQueue.add(B)}++A.remainingLayouts;++B.layoutCount;B.ownerContext=C;B.beginCount=0;B.blockCount=0;B.calcCount=0;B.triggerCount=0;if(!B.initialized){B.initLayout()}B.beginLayout(C)}else{++B.beginCount;if(!B.running){++A.remainingLayouts;B.running=true;B.ownerContext=C;if(B.isComponentLayout){C.unsetProp("done")}A.completionQueue.remove(B);A.finalizeQueue.remove(B)}}B.beginLayoutCycle(C,D)},run:function(){var C=this,B=false,A=C.cycleWatchDog;C.purgeInvalidates();C.flushInvalidates();C.state=1;C.totalCount=C.layoutQueue.getCount();C.flush();while((C.remainingLayouts||C.invalidQueue.length)&&A--){if(C.invalidQueue.length){C.flushInvalidates()}if(C.runCycle()){B=false}else{if(!B){C.flush();B=true;C.flushLayouts("completionQueue","completeLayout")}else{if(!C.invalidQueue.length){C.state=2;break}}}if(!(C.remainingLayouts||C.invalidQueue.length)){C.flush();C.flushLayouts("completionQueue","completeLayout");C.flushLayouts("finalizeQueue","finalizeLayout")}}return C.runComplete()},runComplete:function(){var A=this;A.state=2;if(A.remainingLayouts){A.handleFailure();return false}A.flush();A.flushLayouts("finishQueue","finishedLayout",true);A.flushLayouts("finishQueue","notifyOwner");A.flush();A.flushAnimations();return true},runCycle:function(){var C=this,D=C.layoutQueue.clear(),B=D.length,A;++C.cycleCount;C.progressCount=0;for(A=0;A<B;++A){C.runLayout(C.currentLayout=D[A])}C.currentLayout=null;return C.progressCount>0},runLayout:function(B){var A=this,C=A.getCmp(B.owner);B.pending=false;if(C.state.blocks){return }B.done=true;++B.calcCount;++A.calcCount;B.calculate(C);if(B.done){A.layoutDone(B);if(B.completeLayout){A.queueCompletion(B)}if(B.finalizeLayout){A.queueFinalize(B)}}else{if(!B.pending&&!B.invalid&&!(B.blockCount+B.triggerCount-B.firedTriggers)){A.queueLayout(B)}}},setItemSize:function(G,F,B){var D=G,A=1,C,E;if(G.isComposite){D=G.elements;A=D.length;G=D[0]}else{if(!G.dom&&!G.el){A=D.length;G=D[0]}}for(E=0;E<A;){C=this.get(G);C.setSize(F,B);G=D[++E]}},debugHooks:{$enabled:false,pageAnalyzerMode:true,logOn:{0:0},cancelComponent:function(A){if(this.logOn.cancelComponent){Ext.log("cancelCmp: ",A.id)}this.callParent(arguments)},cancelLayout:function(A){if(this.logOn.cancelLayout){Ext.log("cancelLayout: ",this.getLayoutName(A))}this.callParent(arguments)},callLayout:function(C,B){var A=this.accumByType[C.type],D=A&&A.enter();this.callParent(arguments);if(A){D.leave()}},checkRemainingLayouts:function(){var D=this,C=0,A,B;for(A in D.layouts){B=D.layouts[A];if(D.layouts.hasOwnProperty(A)&&B.running){++C}}if(D.remainingLayouts!==C){Ext.raise({msg:"Bookkeeping error me.remainingLayouts"})}},flush:function(){if(this.logOn.flush){var A=this.flushQueue;Ext.log("--- Flush ",A&&A.getCount())}return this.callParent(arguments)},flushInvalidates:function(){if(this.logOn.flushInvalidate){Ext.log(">> flushInvalidates")}var A=this.callParent(arguments);if(this.logOn.flushInvalidate){Ext.log("<< flushInvalidates")}return A},getCmp:function(B){var A=this.callParent(arguments);if(!A.wrapsComponent){Ext.raise({msg:B.id+" is not a component"})}return A},getEl:function(B,C){var A=this.callParent(arguments);if(A&&A.wrapsComponent){Ext.raise({msg:B.id+"/"+C.id+" is a component (expected element)"})}return A},getLayoutName:function(A){return A.owner.id+"<"+A.type+">"},layoutDone:function(C){var B=this,A=B.getLayoutName(C);if(B.logOn.layoutDone){Ext.log("layoutDone: ",A," ( ",B.remainingLayouts," running)")}if(!C.running){Ext.raise({msg:A+" is already done"})}if(!B.remainingLayouts){Ext.raise({msg:A+" finished but no layouts are running"})}B.callParent(arguments)},layoutTreeHasFailures:function(D,A){var C=this;function E(H){var F=!H.done,G,I;if(H.done){for(G in C.layouts){if(C.layouts.hasOwnProperty(G)){I=C.layouts[G];if(I.owner.ownerLayout===H){if(E(I)){F=true}}}}}return F}if(E(D)){return true}function B(G){var F,H;A[G.id]=1;for(F in C.layouts){if(C.layouts.hasOwnProperty(F)){H=C.layouts[F];if(H.owner.ownerLayout===G){B(H)}}}}B(D);return false},queueLayout:function(A){if(A.done||A.blockCount||A.pending){Ext.raise({msg:this.getLayoutName(A)+" should not be queued for layout"})}if(this.logOn.queueLayout){Ext.log("Queue ",this.getLayoutName(A))}return this.callParent(arguments)},reportLayoutResult:function(H,O){var J=this,A=H.owner,D=J.getCmp(A),F=[],G=[],M,L,E,B,K,N,I,C;O[H.id]=1;for(M in H.blockedBy){if(H.blockedBy.hasOwnProperty(M)){F.push(H.blockedBy[M])}}F.sort();for(M in J.triggersByLayoutId[H.id]){if(J.triggersByLayoutId[H.id].hasOwnProperty(M)){L=J.triggersByLayoutId[H.id][M];G.push({name:M,info:L})}}G.sort(function(Q,P){return Q.name<P.name?-1:(P.name<Q.name?1:0)});Ext.log({indent:1},(H.done?"++":"--"),J.getLayoutName(H),(D.isBoxParent?" [isBoxParent]":""),(D.boxChildren?" - boxChildren: "+D.state.boxesMeasured+"/"+D.boxChildren.length:""),D.boxParent?(" - boxParent: "+D.boxParent.id):""," - size: ",D.widthModel.name,"/",D.heightModel.name);if(!H.done||J.reportOnSuccess){if(F.length){++Ext.log.indent;Ext.log({indent:1},"blockedBy:  count=",H.blockCount);B=F.length;for(E=0;E<B;E++){Ext.log(F[E])}Ext.log.indent-=2}if(G.length){++Ext.log.indent;Ext.log({indent:1},"triggeredBy: count="+H.triggerCount);B=G.length;for(E=0;E<B;E++){C=L.info||L;N=C.item;I=(N.setBy&&N.setBy[C.name])||"?";L=G[E];Ext.log(L.name," (",N.props[C.name],") dirty: ",(N.dirty?!!N.dirty[C.name]:false),", setBy: ",I)}Ext.log.indent-=2}}for(M in J.layouts){if(J.layouts.hasOwnProperty(M)){K=J.layouts[M];if(!K.done&&K.owner.ownerLayout===H){J.reportLayoutResult(K,O)}}}for(M in J.layouts){if(J.layouts.hasOwnProperty(M)){K=J.layouts[M];if(K.done&&K.owner.ownerLayout===H){J.reportLayoutResult(K,O)}}}--Ext.log.indent},resetLayout:function(E){var D=this,C=E.type,B=D.getLayoutName(E),A=D.accumByType[C],F;if(D.logOn.resetLayout){Ext.log("resetLayout: ",B," ( ",D.remainingLayouts," running)")}if(!D.state){if(!A&&D.profileLayoutsByType){D.accumByType[C]=A=Ext.Perf.get("layout_"+E.type)}D.numByType[C]=(D.numByType[C]||0)+1}F=A&&A.enter();D.callParent(arguments);if(A){F.leave()}D.checkRemainingLayouts()},round:function(A){return Math.round(A*1000)/1000},run:function(){var L=this,H,D,N,F,G,I,B,C,O,K,A,M,J,E;L.accumByType={};L.calcsByType={};L.numByType={};L.timesByType={};L.triggersByLayoutId={};Ext.log.indentSize=3;Ext.log("==================== LAYOUT ====================");D=Ext.perf.getTimestamp();H=L.callParent(arguments);D=Ext.perf.getTimestamp()-D;if(L.logOn.boxParent&&L.boxParents){for(N in L.boxParents){if(L.boxParents.hasOwnProperty(N)){I=L.boxParents[N];B=I.boxChildren;C=B.length;Ext.log("boxParent: ",I.id);for(F=0;F<C;++F){Ext.log(" --> ",B[F].id)}}}}if(H){Ext.log("----------------- SUCCESS -----------------")}else{Ext.log({level:"error"},"----------------- FAILURE -----------------")}for(N in L.layouts){if(L.layouts.hasOwnProperty(N)){G=L.layouts[N];if(G.running){Ext.log.error("Layout left running: ",L.getLayoutName(G))}if(G.ownerContext){Ext.log.error("Layout left connected: ",L.getLayoutName(G))}}}if(!H||L.reportOnSuccess){O={};K=0;for(N in L.layouts){if(L.layouts.hasOwnProperty(N)){G=L.layouts[N];if(L.items[G.owner.el.id].isTopLevel){if(L.reportOnSuccess||L.layoutTreeHasFailures(G,O)){L.reportLayoutResult(G,O)}}}}for(N in L.layouts){if(L.layouts.hasOwnProperty(N)){G=L.layouts[N];if(!O[G.id]){if(!K){Ext.log("----- Unreported!! -----")}++K;L.reportLayoutResult(G,O)}}}}Ext.log("Cycles: ",L.cycleCount,", Flushes: ",L.flushCount,", Calculates: ",L.calcCount," in ",L.round(D)," msec");Ext.log("Calculates by type:");A=[];for(N in L.numByType){if(L.numByType.hasOwnProperty(N)){M=L.numByType[N];A.push({type:N,total:M,calcs:L.calcsByType[N],multiple:Math.round(L.calcsByType[N]/M*10)/10,calcTime:L.round(L.timesByType[N]),avgCalcTime:L.round(L.timesByType[N]/L.calcsByType[N])})}}A.sort(function(Q,P){return P.calcTime-Q.calcTime});J=A.length;for(F=0;F<J;F++){E=A[F];Ext.log(E.type,": ",E.total," in ",E.calcs," tries (",E.multiple,"x) at ",E.calcTime," msec (avg ",E.avgCalcTime," msec)")}return H},runCycle:function(){if(this.logOn.runCycle){Ext.log(">>> Cycle ",this.cycleCount," (queue length: ",this.layoutQueue.length,")")}return this.callParent(arguments)},runLayout:function(E){var D=this,C=E.type,A=D.accumByType[C],G,B,F;if(D.logOn.calculate){Ext.log("-- calculate ",this.getLayoutName(E))}G=A&&A.enter();F=Ext.perf.getTimestamp();B=D.callParent(arguments);F=Ext.perf.getTimestamp()-F;if(A){G.leave()}D.calcsByType[C]=(D.calcsByType[C]||0)+1;D.timesByType[C]=(D.timesByType[C]||0)+F;return B}}})