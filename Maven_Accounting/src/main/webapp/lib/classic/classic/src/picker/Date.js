Ext.define("Ext.picker.Date",{extend:"Ext.Component",requires:["Ext.XTemplate","Ext.button.Button","Ext.button.Split","Ext.util.ClickRepeater","Ext.util.KeyNav","Ext.fx.Manager","Ext.picker.Month"],alias:"widget.datepicker",alternateClassName:"Ext.DatePicker",todayText:"Today",ariaTitle:"Date Picker: {0}",ariaTitleDateFormat:"F d",todayTip:"{0} (Spacebar)",minText:"This date is before the minimum date",ariaMinText:"This date is before the minimum date",maxText:"This date is after the maximum date",ariaMaxText:"This date is after the maximum date",disabledDaysText:"Disabled",ariaDisabledDaysText:"This day of week is disabled",disabledDatesText:"Disabled",ariaDisabledDatesText:"This date is disabled",nextText:"Next Month (Control+Right)",prevText:"Previous Month (Control+Left)",monthYearText:"Choose a month (Control+Up/Down to move years)",monthYearFormat:"F Y",startDay:0,showToday:true,disableAnim:false,baseCls:Ext.baseCSSPrefix+"datepicker",longDayFormat:"F d, Y",footerButtonUI:"default",isDatePicker:true,ariaRole:"region",focusable:true,childEls:["innerEl","eventEl","prevEl","nextEl","middleBtnEl","footerEl"],border:true,renderTpl:['<div id="{id}-innerEl" data-ref="innerEl" role="presentation">','<div class="{baseCls}-header">','<div id="{id}-prevEl" data-ref="prevEl" class="{baseCls}-prev {baseCls}-arrow" role="presentation" title="{prevText}"></div>','<div id="{id}-middleBtnEl" data-ref="middleBtnEl" class="{baseCls}-month" role="heading">{%this.renderMonthBtn(values, out)%}</div>','<div id="{id}-nextEl" data-ref="nextEl" class="{baseCls}-next {baseCls}-arrow" role="presentation" title="{nextText}"></div>',"</div>",'<table role="grid" id="{id}-eventEl" data-ref="eventEl" class="{baseCls}-inner" cellspacing="0" tabindex="0">',"<thead>",'<tr role="row">','<tpl for="dayNames">','<th role="columnheader" class="{parent.baseCls}-column-header" aria-label="{.}">','<div role="presentation" class="{parent.baseCls}-column-header-inner">{.:this.firstInitial}</div>',"</th>","</tpl>","</tr>","</thead>","<tbody>",'<tr role="row">','<tpl for="days">',"{#:this.isEndOfWeek}",'<td role="gridcell">','<div hidefocus="on" class="{parent.baseCls}-date"></div>',"</td>","</tpl>","</tr>","</tbody>","</table>",'<tpl if="showToday">','<div id="{id}-footerEl" data-ref="footerEl" role="presentation" class="{baseCls}-footer">{%this.renderTodayBtn(values, out)%}</div>',"</tpl>",'<div id="{id}-todayText" class="'+Ext.baseCSSPrefix+'hidden-clip">{todayText}.</div>','<div id="{id}-ariaMinText" class="'+Ext.baseCSSPrefix+'hidden-clip">{ariaMinText}.</div>','<div id="{id}-ariaMaxText" class="'+Ext.baseCSSPrefix+'hidden-clip">{ariaMaxText}.</div>','<div id="{id}-ariaDisabledDaysText" class="'+Ext.baseCSSPrefix+'hidden-clip">{ariaDisabledDaysText}.</div>','<div id="{id}-ariaDisabledDatesText" class="'+Ext.baseCSSPrefix+'hidden-clip">{ariaDisabledDatesText}.</div>',"</div>",{firstInitial:function(A){return Ext.picker.Date.prototype.getDayInitial(A)},isEndOfWeek:function(B){B--;var A=B%7===0&&B!==0;return A?'</tr><tr role="row">':""},renderTodayBtn:function(A,B){Ext.DomHelper.generateMarkup(A.$comp.todayBtn.getRenderTree(),B)},renderMonthBtn:function(A,B){Ext.DomHelper.generateMarkup(A.$comp.monthBtn.getRenderTree(),B)}}],initHour:12,numDays:42,initComponent:function(){var B=this,A=Ext.Date.clearTime;B.selectedCls=B.baseCls+"-selected";B.disabledCellCls=B.baseCls+"-disabled";B.prevCls=B.baseCls+"-prevday";B.activeCls=B.baseCls+"-active";B.cellCls=B.baseCls+"-cell";B.nextCls=B.baseCls+"-prevday";B.todayCls=B.baseCls+"-today";if(!B.format){B.format=Ext.Date.defaultFormat}if(!B.dayNames){B.dayNames=Ext.Date.dayNames}B.dayNames=B.dayNames.slice(B.startDay).concat(B.dayNames.slice(0,B.startDay));B.callParent();B.value=B.value?A(B.value,true):A(new Date());B.initDisabledDays()},getRefOwner:function(){return this.pickerField||this.callParent()},getRefItems:function(){var A=[],C=this.monthBtn,B=this.todayBtn;if(C){A.push(C)}if(B){A.push(B)}return A},beforeRender:function(){var C=this,B=Ext.String.htmlEncode,D=new Array(C.numDays),A=Ext.Date.format(new Date(),C.format);if(C.padding&&!C.width){C.cacheWidth()}C.monthBtn=new Ext.button.Split({ownerCt:C,ownerLayout:C.getComponentLayout(),text:"",tooltip:C.monthYearText,tabIndex:-1,ariaRole:"presentation",listeners:{click:C.doShowMonthPicker,arrowclick:C.doShowMonthPicker,scope:C}});if(C.showToday){C.todayBtn=new Ext.button.Button({ui:C.footerButtonUI,ownerCt:C,ownerLayout:C.getComponentLayout(),text:Ext.String.format(C.todayText,A),tooltip:Ext.String.format(C.todayTip,A),tooltipType:"title",tabIndex:-1,ariaRole:"presentation",handler:C.selectToday,scope:C})}C.callParent();Ext.applyIf(C,{renderData:{}});Ext.apply(C.renderData,{dayNames:C.dayNames,showToday:C.showToday,prevText:B(C.prevText),nextText:B(C.nextText),todayText:B(C.todayText),ariaMinText:B(C.ariaMinText),ariaMaxText:B(C.ariaMaxText),ariaDisabledDaysText:B(C.ariaDisabledDaysText),ariaDisabledDatesText:B(C.ariaDisabledDatesText),days:D});C.protoEl.unselectable()},cacheWidth:function(){var A=this,B=A.parseBox(A.padding),C=Ext.getBody().createChild({cls:A.baseCls+" "+A.borderBoxCls,style:"position:absolute;top:-1000px;left:-1000px;"});A.self.prototype.width=C.getWidth()+B.left+B.right;C.destroy()},onRender:function(B,A){var C=this;C.callParent(arguments);C.cells=C.eventEl.select("tbody td");C.textNodes=C.eventEl.query("tbody td div");C.eventEl.set({"aria-labelledby":C.monthBtn.id});C.mon(C.eventEl,{scope:C,mousewheel:C.handleMouseWheel,click:{fn:C.handleDateClick,delegate:"div."+C.baseCls+"-date"}})},initEvents:function(){var C=this,D=C.pickerField,A=Ext.Date,B=A.DAY;C.callParent();if(D){C.el.on("mousedown",C.onMouseDown,C)}C.monthBtn.el.on("mousedown",C.onMouseDown,C);C.prevRepeater=new Ext.util.ClickRepeater(C.prevEl,{handler:C.showPrevMonth,scope:C,mousedownStopEvent:true});C.nextRepeater=new Ext.util.ClickRepeater(C.nextEl,{handler:C.showNextMonth,scope:C,mousedownStopEvent:true});C.keyNav=new Ext.util.KeyNav(C.eventEl,Ext.apply({scope:C,left:function(E){if(E.ctrlKey){E.preventDefault();C.showPrevMonth()}else{C.update(A.add(C.activeDate,B,-1))}},right:function(E){if(E.ctrlKey){E.preventDefault();C.showNextMonth()}else{C.update(A.add(C.activeDate,B,1))}},up:function(E){if(E.ctrlKey){C.showNextYear()}else{C.update(A.add(C.activeDate,B,-7))}},down:function(E){if(E.ctrlKey){C.showPrevYear()}else{C.update(A.add(C.activeDate,B,7))}},pageUp:function(E){if(E.ctrlKey){C.showPrevYear()}else{C.showPrevMonth()}},pageDown:function(E){if(E.ctrlKey){C.showNextYear()}else{C.showNextMonth()}},tab:function(E){C.handleTabKey(E);return true},enter:function(E){C.handleDateClick(E,C.activeCell.firstChild)},space:function(){C.setValue(new Date(C.activeCell.firstChild.dateValue));var E=C.startValue,F=C.value,G;if(D){G=D.getValue();if(G&&E&&G.getTime()===F.getTime()){D.setValue(E)}else{D.setValue(F)}}},home:function(E){C.update(A.getFirstDateOfMonth(C.activeDate))},end:function(E){C.update(A.getLastDateOfMonth(C.activeDate))}},C.keyNavConfig));if(C.disabled){C.syncDisabled(true)}C.update(C.value)},onMouseDown:function(A){A.preventDefault()},handleTabKey:function(D){var C=this,A=C.getSelectedDate(C.activeDate),B=C.handler;if(!C.disabled&&A.dateValue&&!Ext.fly(A.parentNode).hasCls(C.disabledCellCls)){C.setValue(new Date(A.dateValue));C.fireEvent("select",C,C.value);if(B){B.call(C.scope||C,C,C.value)}C.onSelect()}else{C.fireEventArgs("tabout",[C])}},getSelectedDate:function(A){var C=this,G=A.getTime(),H=C.cells,I=C.selectedCls,E=H.elements,D=E.length,F,B;H.removeCls(I);for(B=0;B<D;B++){F=E[B].firstChild;if(F.dateValue===G){return F}}return null},initDisabledDays:function(){var F=this,B=F.disabledDates,E="(?:",A,G,C,D;if(!F.disabledDatesRE&&B){A=B.length-1;C=B.length;for(G=0;G<C;G++){D=B[G];E+=Ext.isDate(D)?"^"+Ext.String.escapeRegex(Ext.Date.dateFormat(D,F.format))+"$":D;if(G!==A){E+="|"}}F.disabledDatesRE=new RegExp(E+")")}},setDisabledDates:function(A){var B=this;if(Ext.isArray(A)){B.disabledDates=A;B.disabledDatesRE=null}else{B.disabledDatesRE=A}B.initDisabledDays();B.update(B.value,true);return B},setDisabledDays:function(A){this.disabledDays=A;return this.update(this.value,true)},setMinDate:function(A){this.minDate=A;return this.update(this.value,true)},setMaxDate:function(A){this.maxDate=A;return this.update(this.value,true)},setValue:function(A){this.value=Ext.Date.clearTime(A||new Date(),true);return this.update(this.value)},getValue:function(){return this.value},getDayInitial:function(A){return A.substr(0,1)},onEnable:function(){var A=this;A.callParent();A.syncDisabled(false);A.update(A.activeDate)},onShow:function(){var A=this;A.callParent();A.syncDisabled(false);if(A.pickerField){A.startValue=A.pickerField.getValue()}},onHide:function(){this.callParent();this.syncDisabled(true)},onDisable:function(){this.callParent();this.syncDisabled(true)},getActive:function(){return this.activeDate||this.value},runAnimation:function(C){var B=this.monthPicker,A={duration:200,callback:function(){B.setVisible(!C)}};if(C){B.el.slideOut("t",A)}else{B.el.slideIn("t",A)}},hideMonthPicker:function(A){var C=this,B=C.monthPicker;if(B&&B.isVisible()){if(C.shouldAnimate(A)){C.runAnimation(true)}else{B.hide()}}return C},doShowMonthPicker:function(){this.showMonthPicker()},doHideMonthPicker:function(){this.hideMonthPicker()},showMonthPicker:function(A){var D=this,C=D.el,B;if(D.rendered&&!D.disabled){B=D.createMonthPicker();if(!B.isVisible()){B.setValue(D.getActive());B.setSize(C.getSize());B.floatParent=null;B.setPosition(-C.getBorderWidth("l"),-C.getBorderWidth("t"));if(D.shouldAnimate(A)){D.runAnimation(false)}else{B.show()}}}return D},shouldAnimate:function(A){return Ext.isDefined(A)?A:!this.disableAnim},createMonthPicker:function(){var B=this,A=B.monthPicker;if(!A){B.monthPicker=A=new Ext.picker.Month({renderTo:B.el,ownerCmp:B,floating:true,padding:B.padding,shadow:false,small:B.showToday===false,footerButtonUI:B.footerButtonUI,listeners:{scope:B,cancelclick:B.onCancelClick,okclick:B.onOkClick,yeardblclick:B.onOkClick,monthdblclick:B.onOkClick}});if(!B.disableAnim){A.el.setStyle("display","none")}A.hide();B.on("beforehide",B.doHideMonthPicker,B)}return A},onOkClick:function(B,E){var D=this,F=E[0],C=E[1],A=new Date(C,F,D.getActive().getDate());if(A.getMonth()!==F){A=Ext.Date.getLastDateOfMonth(new Date(C,F,1))}D.setValue(A);D.hideMonthPicker()},onCancelClick:function(){this.selectedUpdate(this.activeDate);this.hideMonthPicker()},showPrevMonth:function(A){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.MONTH,-1))},showNextMonth:function(A){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.MONTH,1))},showPrevYear:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.YEAR,-1))},showNextYear:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.YEAR,1))},handleMouseWheel:function(A){var B;A.stopEvent();if(!this.disabled){B=A.getWheelDelta();if(B>0){this.showPrevMonth()}else{if(B<0){this.showNextMonth()}}}},handleDateClick:function(D,A){var C=this,B=C.handler;D.stopEvent();if(!C.disabled&&A.dateValue&&!Ext.fly(A.parentNode).hasCls(C.disabledCellCls)){C.setValue(new Date(A.dateValue));C.fireEvent("select",C,C.value);if(B){B.call(C.scope||C,C,C.value)}C.onSelect()}},onSelect:function(){if(this.hideOnSelect){this.hide()}},selectToday:function(){var C=this,A=C.todayBtn,B=C.handler;if(A&&!A.disabled){C.setValue(Ext.Date.clearTime(new Date()));C.fireEvent("select",C,C.value);if(B){B.call(C.scope||C,C,C.value)}C.onSelect()}return C},selectedUpdate:function(D){var F=this,E=D.getTime(),C=F.cells,B=F.selectedCls,H,G=C.getCount(),A;F.eventEl.dom.setAttribute("aria-busy","true");A=F.activeCell;if(A){Ext.fly(A).removeCls(B);A.setAttribute("aria-selected",false)}for(H=0;H<G;H++){A=C.item(H);if(F.textNodes[H].dateValue===E){F.activeCell=A.dom;F.eventEl.dom.setAttribute("aria-activedescendant",A.dom.id);A.dom.setAttribute("aria-selected",true);A.addCls(B);F.fireEvent("highlightitem",F,A);break}}F.eventEl.dom.removeAttribute("aria-busy")},fullUpdate:function(X){var b=this,D=b.cells.elements,C=b.textNodes,d=b.disabledCellCls,K=Ext.Date,T=0,a=0,I=+K.clearTime(X,true),W=+K.clearTime(new Date()),R=b.minDate?K.clearTime(b.minDate,true):Number.NEGATIVE_INFINITY,S=b.maxDate?K.clearTime(b.maxDate,true):Number.POSITIVE_INFINITY,Z=b.disabledDatesRE,Q=b.disabledDatesText,e=b.disabledDays?b.disabledDays.join(""):false,Y=b.disabledDaysText,U=b.format,H=K.getDaysInMonth(X),N=K.getFirstDateOfMonth(X),E=N.getDay()-b.startDay,V=K.add(X,K.MONTH,-1),M=b.ariaTitleDateFormat,G,O,A,c,J,L,B,F,P;if(E<0){E+=7}H+=E;G=K.getDaysInMonth(V)-E;O=new Date(V.getFullYear(),V.getMonth(),G,b.initHour);if(b.showToday){c=K.clearTime(new Date());A=(c<R||c>S||(Z&&U&&Z.test(K.dateFormat(c,U)))||(e&&e.indexOf(c.getDay())!==-1));if(!b.disabled){b.todayBtn.setDisabled(A)}}J=function(h,g){var f=D[h],i=[];if(!f.hasAttribute("id")){f.setAttribute("id",b.id+"-cell-"+h)}P=+K.clearTime(O,true);f.firstChild.dateValue=P;f.setAttribute("aria-label",K.format(O,M));f.removeAttribute("aria-describedby");f.removeAttribute("data-qtip");if(P===W){g+=" "+b.todayCls;i.push(b.id+"-todayText")}if(P===I){b.activeCell=f;b.eventEl.dom.setAttribute("aria-activedescendant",f.id);f.setAttribute("aria-selected",true);g+=" "+b.selectedCls;b.fireEvent("highlightitem",b,f)}else{f.setAttribute("aria-selected",false)}if(P<R){g+=" "+d;i.push(b.id+"-ariaMinText");f.setAttribute("data-qtip",b.minText)}else{if(P>S){g+=" "+d;i.push(b.id+"-ariaMaxText");f.setAttribute("data-qtip",b.maxText)}else{if(e&&e.indexOf(O.getDay())!==-1){f.setAttribute("data-qtip",Y);i.push(b.id+"-ariaDisabledDaysText");g+=" "+d}else{if(Z&&U){F=K.dateFormat(O,U);if(Z.test(F)){f.setAttribute("data-qtip",Q.replace("%0",F));i.push(b.id+"-ariaDisabledDatesText");g+=" "+d}}}}}if(i.length){f.setAttribute("aria-describedby",i.join(" "))}f.className=g+" "+b.cellCls};b.eventEl.dom.setAttribute("aria-busy","true");for(;T<b.numDays;++T){if(T<E){L=(++G);B=b.prevCls}else{if(T>=H){L=(++a);B=b.nextCls}else{L=T-E+1;B=b.activeCls}}C[T].innerHTML=L;O.setDate(O.getDate()+1);J(T,B)}b.eventEl.dom.removeAttribute("aria-busy");b.monthBtn.setText(Ext.Date.format(X,b.monthYearFormat))},update:function(A,D){var B=this,C=B.activeDate;if(B.rendered){B.activeDate=A;if(!D&&C&&B.el&&C.getMonth()===A.getMonth()&&C.getFullYear()===A.getFullYear()){B.selectedUpdate(A,C)}else{B.fullUpdate(A,C)}}return B},beforeDestroy:function(){var A=this;if(A.rendered){Ext.destroy(A.keyNav,A.monthPicker,A.monthBtn,A.nextRepeater,A.prevRepeater,A.todayBtn,A.todayElSpan);delete A.textNodes;delete A.cells.elements}A.callParent()},privates:{finishRenderChildren:function(){var A=this;A.callParent();A.monthBtn.finishRender();if(A.showToday){A.todayBtn.finishRender()}},getFocusEl:function(){return this.eventEl},syncDisabled:function(B){var C=this,A=C.keyNav;if(A){A.setDisabled(B);C.prevRepeater.setDisabled(B);C.nextRepeater.setDisabled(B);if(C.todayBtn){C.todayBtn.setDisabled(B)}}}}})