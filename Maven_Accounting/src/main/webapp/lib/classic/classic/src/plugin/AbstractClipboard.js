Ext.define("Ext.plugin.AbstractClipboard",{extend:"Ext.plugin.Abstract",requires:["Ext.util.KeyMap"],cachedConfig:{formats:{text:{get:"getTextData",put:"putTextData"}}},config:{memory:null,source:"system",system:"text"},destroy:function(){var A=this,C=A.keyMap,B=A.shared;if(C){A.keyMap=Ext.destroy(C);if(!--B.counter){B.textArea=Ext.destroy(B.textArea)}}else{A.renderListener=Ext.destroy(A.renderListener)}A.callParent()},init:function(A){var B=this;if(A.rendered){this.finishInit(A)}else{B.renderListener=A.on({render:function(){B.renderListener=null;B.finishInit(A)},destroyable:true,single:true})}},getTarget:function(A){return A.el},privates:{shared:{counter:0,data:null,textArea:null},applyMemory:function(B){B=this.applySource(B);if(B){for(var A=B.length;A-->0;){if(B[A]==="system"){Ext.raise('Invalid clipboard format "'+B[A]+'"')}}}return B},applySource:function(C){if(C){if(Ext.isString(C)){C=[C]}else{if(C.length===0){C=null}}}if(C){var A=this.getFormats();for(var B=C.length;B-->0;){if(C[B]!=="system"&&!A[C[B]]){Ext.raise('Invalid clipboard format "'+C[B]+'"')}}}return C||null},applySystem:function(B){var A=this.getFormats();if(!A[B]){Ext.raise('Invalid clipboard format "'+B+'"')}return B},doCutCopy:function(E,B){var D=this,A=D.allFormats||D.syncFormats(),G=D.getData(B,A),H=D.getMemory(),C=D.getSystem(),F;D.shared.data=H&&G;if(C){F=G[C];if(A[C]<3){delete G[C]}D.setClipboardData(F)}},doPaste:function(C,B){var A=this.getFormats();this[A[C].put](B,C)},finishInit:function(A){var B=this;B.keyMap=new Ext.util.KeyMap({target:B.getTarget(A),binding:[{ctrl:true,key:"x",fn:B.onCut,scope:B},{ctrl:true,key:"c",fn:B.onCopy,scope:B},{ctrl:true,key:"v",fn:B.onPaste,scope:B}]});++B.shared.counter;A.on({destroy:"destroy",scope:B})},getData:function(D,H){var E=this,A=E.getFormats(),F,C,B,G;if(Ext.isString(H)){if(!A[H]){Ext.raise('Invalid clipboard format "'+H+'"')}F=E[A[H].get](H,D)}else{F={};G=[];if(H){for(B in H){if(!A[B]){Ext.raise('Invalid clipboard format "'+B+'"')}G.push(B)}}else{G=Ext.Object.getAllKeys(A)}for(C=G.length;C-->0;){F[B]=E[A[B].get](B,D&&!C)}}return F},getHiddenTextArea:function(){var B=this.shared,A;A=B.textArea;if(!A){A=B.textArea=Ext.getBody().createChild({tag:"textarea",tabIndex:-1,style:{position:"absolute",top:"-1000px",width:"1px",height:"1px"}});A.suspendFocusEvents()}return A},onCopy:function(B,A){this.doCutCopy(A,false)},onCut:function(B,A){this.doCutCopy(A,true)},onPaste:function(G,E){var D=this,A=D.shared.data,F=D.getSource(),B,H,C;if(F){for(B=0,H=F.length;B<H;++B){C=F[B];if(C==="system"){C=D.getSystem();D.pasteClipboardData(C);break}else{if(A&&(C in A)){D.doPaste(C,A[C]);break}}}}},pasteClipboardData:function(E){var D=this,A=window.clipboardData,C,B;if(A&&A.getData){D.doPaste(E,A.getData("text"))}else{B=Ext.Element.getActiveElement(true);C=D.getHiddenTextArea().dom;C.value="";if(B){B.suspendFocusEvents()}C.focus();Ext.defer(function(){if(B){B.focus();B.resumeFocusEvents()}D.doPaste(E,C.value);C.value=""},100,D)}},setClipboardData:function(E){var A=window.clipboardData;if(A&&A.setData){A.setData("text",E)}else{var D=this,C=D.getHiddenTextArea().dom,B=Ext.Element.getActiveElement(true);C.value=E;if(B){B.suspendFocusEvents()}C.focus();C.select();Ext.defer(function(){C.value="";if(B){B.focus();B.resumeFocusEvents()}},50)}},syncFormats:function(){var D=this,E={},F=D.getMemory(),C=D.getSystem(),A,B;if(C){E[C]=1}if(F){for(A=F.length;A-->0;){B=F[A];E[B]=E[B]?3:2}}return D.allFormats=E},updateMemory:function(){this.allFormats=null},updateSystem:function(){this.allFormats=null}}})