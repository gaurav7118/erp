Ext.define("Ext.selection.Model",{extend:"Ext.mixin.Observable",alternateClassName:"Ext.AbstractSelectionModel",mixins:["Ext.util.StoreHolder","Ext.mixin.Factoryable"],alias:"selection.abstract",factoryConfig:{defaultType:"dataviewmodel"},$configPrefixed:false,$configStrict:false,config:{store:null,selected:{}},isSelectionModel:true,allowDeselect:undefined,toggleOnClick:true,selected:null,pruneRemoved:true,suspendChange:0,ignoreRightMouseSelection:false,constructor:function(A){var B=this;B.modes={SINGLE:true,SIMPLE:true,MULTI:true};B.callParent([A]);B.setSelectionMode(B.mode);if(B.selectionMode!=="SINGLE"){B.allowDeselect=true}},updateStore:function(A,B){this.bindStore(A,!B)},applySelected:function(A){if(!A.isCollection){A=new Ext.util.Collection(Ext.apply({rootProperty:"data"},A))}return A},getStoreListeners:function(){var A=this;return{add:A.onStoreAdd,clear:A.onStoreClear,remove:A.onStoreRemove,update:A.onStoreUpdate,idchanged:A.onIdChanged,load:A.onStoreLoad,refresh:A.onStoreRefresh,pageadd:A.onPageAdd,pageremove:A.onPageRemove}},suspendChanges:function(){++this.suspendChange},resumeChanges:function(){if(this.suspendChange){--this.suspendChange}},selectAll:function(A){var C=this,B=C.store.getRange(),D=C.getSelection().length;C.suspendChanges();C.doSelect(B,true,A);C.resumeChanges();if(!A&&!C.destroyed){C.maybeFireSelectionChange(C.getSelection().length!==D)}},deselectAll:function(I){var F=this,B=F.getSelection(),G={},H=F.store,A=B.length,E,C,D;for(E=0,C=B.length;E<C;E++){D=B[E];G[D.id]=H.indexOf(D)}B=Ext.Array.sort(B,function(L,J){var M=G[L.id],K=G[J.id];return M<K?-1:1});F.suspendChanges();F.doDeselect(B,I);F.resumeChanges();if(!I&&!F.destroyed){F.maybeFireSelectionChange(F.getSelection().length!==A)}},getSelectionStart:function(){return this.selectionStart},setSelectionStart:function(A){this.selectionStart=A},selectWithEvent:function(B,E){var D=this,C=D.isSelected(B),A=E.shiftKey;switch(D.selectionMode){case"MULTI":D.selectWithEventMulti(B,E,C);break;case"SIMPLE":D.selectWithEventSimple(B,E,C);break;case"SINGLE":D.selectWithEventSingle(B,E,C);break}if(!A){if(D.isSelected(B)){D.selectionStart=B}else{D.selectionStart=null}}},vetoSelection:function(A){if(A.stopSelection){return true}else{if(A.type!=="keydown"&&A.button!==0){if(this.ignoreRightMouseSelection||this.isSelected(A.record)){return true}}else{return A.type==="mousedown"}}},onNavigate:function(F){if(!F.record||this.vetoSelection(F.keyEvent)){return }this.onBeforeNavigate(F);var H=this,G=F.keyEvent,B=G.ctrlKey||F.ctrlKey,D=F.recordIndex,E=F.record,L=F.previousRecord,C=H.isSelected(E),J=(H.selectionStart&&H.isSelected(F.previousRecord))?H.selectionStart:(H.selectionStart=F.previousRecord),A=F.previousRecordIndex,K=G.getCharCode(),M=K===G.SPACE,I=K===G.UP||K===G.PAGE_UP||K===G.HOME?"up":(K===G.DOWN||K===G.PAGE_DOWN||K===G.END?"down":null);switch(H.selectionMode){case"MULTI":H.setSelectionStart(F.selectionStart);if(K===G.A&&B){H.selected.beginUpdate();H.selectRange(0,H.store.getCount()-1);H.selected.endUpdate()}else{if(M){if(G.shiftKey){H.selectRange(J,E,B)}else{if(C){if(H.allowDeselect){H.doDeselect(E)}}else{H.doSelect(E,B)}}}else{if(G.shiftKey&&J){if(I==="up"&&A<=D){H.deselectRange(L,D+1)}else{if(I==="down"&&A>=D){H.deselectRange(L,D-1)}else{if(J!==E){H.selectRange(J,E,B)}}}H.lastSelected=E}else{if(K){if(!B){H.doSelect(E,false)}}else{H.selectWithEvent(E,G)}}}}break;case"SIMPLE":if(K===G.A&&B){H.selected.beginUpdate();H.selectRange(0,H.store.getCount()-1);H.selected.endUpdate()}else{if(C){H.doDeselect(E)}else{H.doSelect(E,true)}}break;case"SINGLE":if(!B){if(I){H.doSelect(E,false)}else{if(M||!K){H.selectWithEvent(E,G)}}}}if(!G.shiftKey&&!H.destroyed&&H.isSelected(E)){H.selectionStart=E;H.selectionStartIdx=D}},selectRange:function(K,D,L){var H=this,J=H.store,C=H.selected.items,M,F,G,E,A,I,B;if(H.isLocked()){return }M=H.normalizeRowRange(K,D);K=M[0];D=M[1];E=[];for(F=K;F<=D;F++){if(!H.isSelected(J.getAt(F))){E.push(J.getAt(F))}}if(!L){A=[];H.suspendChanges();for(F=0,G=C.length;F<G;++F){B=C[F];I=J.indexOf(B);if(I<K||I>D){A.push(B)}}for(F=0,G=A.length;F<G;++F){H.doDeselect(A[F])}H.resumeChanges()}if(!H.destroyed){if(E.length){H.doMultiSelect(E,true)}else{if(A){H.maybeFireSelectionChange(A.length>0)}}}},deselectRange:function(E,D){var H=this,C=H.store,A,G,F,B;if(H.isLocked()){return }A=H.normalizeRowRange(E,D);E=A[0];D=A[1];F=[];for(G=E;G<=D;G++){B=C.getAt(G);if(H.isSelected(B)){F.push(B)}}if(F.length){H.doDeselect(F)}},normalizeRowRange:function(C,B){var A=this.store,D;if(!Ext.isNumber(C)){C=A.indexOf(C)}C=Math.max(0,C);if(!Ext.isNumber(B)){B=A.indexOf(B)}B=Math.min(B,A.getCount()-1);if(C>B){D=B;B=C;C=D}return[C,B]},select:function(B,C,A){if(Ext.isDefined(B)&&!(Ext.isArray(B)&&!B.length)){this.doSelect(B,C,A)}},deselect:function(B,A){this.doDeselect(B,A)},doSelect:function(C,E,B){var D=this,A;if(D.locked||C==null){return }if(typeof C==="number"){A=D.store.getAt(C);if(!A){return }C=[A]}if(D.selectionMode==="SINGLE"){if(C.isModel){C=[C]}if(C.length){D.doSingleSelect(C[0],B)}}else{D.doMultiSelect(C,E,B)}},doMultiSelect:function(A,J,I){var G=this,B=G.selected,H=false,K,D,F,E,C;if(G.locked){return }A=!Ext.isArray(A)?[A]:A;F=A.length;if(!J&&B.getCount()>0){K=G.deselectDuringSelect(A,I);if(G.destroyed){return }if(K[0]){G.maybeFireSelectionChange(K[1]>0&&!I);return }else{H=K[1]>0}}C=function(){if(!B.getCount()){G.selectionStart=E}B.add(E);H=true};for(D=0;D<F;D++){E=A[D];if(G.isSelected(E)){continue}G.onSelectChange(E,true,I,C);if(G.destroyed){return }}G.lastSelected=E;G.maybeFireSelectionChange(H&&!I)},deselectDuringSelect:function(D,H){var G=this,A=G.selected.getRange(),F=A.length,C=0,E=false,I,B;G.suspendChanges();G.deselectingDuringSelect=true;for(B=0;B<F;++B){I=A[B];if(!Ext.Array.contains(D,I)){if(G.doDeselect(I,H)){++C}else{E=true}}if(G.destroyed){E=true;C=0;break}}G.deselectingDuringSelect=false;G.resumeChanges();return[E,C]},doDeselect:function(A,I){var H=this,B=H.selected,D=0,G,E,J=0,F=0,C;if(H.locked||!H.store){return false}if(typeof A==="number"){E=H.store.getAt(A);if(!E){return false}A=[E]}else{if(!Ext.isArray(A)){A=[A]}}C=function(){++F;B.remove(E);if(E===H.selectionStart){H.selectionStart=null}};G=A.length;H.suspendChanges();for(;D<G;D++){E=A[D];if(H.isSelected(E)){if(H.lastSelected===E){H.lastSelected=B.last()}++J;H.onSelectChange(E,false,I,C);if(H.destroyed){return false}}}H.resumeChanges();H.maybeFireSelectionChange(F>0&&!I);return F===J},doSingleSelect:function(A,B){var D=this,F=false,C=D.selected,E;if(D.locked){return }if(D.isSelected(A)){return }E=function(){if(C.getCount()){D.suspendChanges();var G=D.deselectDuringSelect([A],B);if(D.destroyed){return }D.resumeChanges();if(G[0]){return false}}D.lastSelected=A;if(!C.getCount()){D.selectionStart=A}C.add(A);F=true};D.onSelectChange(A,true,B,E);if(F&&!D.destroyed){D.maybeFireSelectionChange(!B)}},maybeFireSelectionChange:function(A){var B=this;if(A&&!B.suspendChange){B.fireEvent("selectionchange",B,B.getSelection())}},getLastSelected:function(){return this.lastSelected},getSelection:function(){return this.selected.getRange()},getSelectionMode:function(){return this.selectionMode},setSelectionMode:function(A){A=A?A.toUpperCase():"SINGLE";this.selectionMode=this.modes[A]?A:"SINGLE"},isLocked:function(){return this.locked},setLocked:function(A){this.locked=!!A},isRangeSelected:function(D,C){var F=this,B=F.store,E,A;A=F.normalizeRowRange(D,C);D=A[0];C=A[1];for(E=D;E<=C;E++){if(!F.isSelected(B.getAt(E))){return false}}return true},isSelected:function(A){A=Ext.isNumber(A)?this.store.getAt(A):A;return this.selected.contains(A)},hasSelection:function(){var A=this.getSelected();return !!(A&&A.getCount())},refresh:function(){var J=this,M=J.store,F=[],I=[],E=J.getSelection(),G=E.length,C=J.getSelected(),K,H,A,L,B,D;if(!M||!(C.isCollection||C.isRows)||!C.getCount()){return }A=M.getData();if(A.getSource){H=A.getSource();if(H){A=H}}J.refreshing=true;C.beginUpdate();J.suspendChanges();for(D=0;D<G;D++){L=E[D];B=A.get(L.getId());if(B){F.push(B)}else{if(!J.pruneRemoved){I.push(L)}}if(J.mode==="SINGLE"&&I.length){break}}if(C.getCount()!==(F.length+I.length)){K=true}J.clearSelections();if(F.length){J.doSelect(F,false,true)}if(I.length){C.add(I);if(!J.lastSelected){J.lastSelected=I[I.length-1]}}J.resumeChanges();if(K){C.endUpdate()}else{C.updating--}J.refreshing=false;J.maybeFireSelectionChange(K)},clearSelections:function(){var A=this.getSelected();if(A){A.clear()}this.lastSelected=null},onStoreAdd:Ext.emptyFn,onStoreClear:function(){if(!this.store.isLoading()&&this.hasSelection()){this.clearSelections();this.maybeFireSelectionChange(true)}},onStoreRemove:function(I,B,E,J){var H=this,A=B,D,F,C,G;if(H.selectionStart&&Ext.Array.contains(B,H.selectionStart)){H.selectionStart=null}if(J||H.locked||!H.pruneRemoved){return }G=I.isMoving(null,true);if(G){A=null;for(D=0,F=B.length;D<F;++D){C=B[D];if(!G[C.id]){(A||(A=[])).push(C)}}}if(A){H.deselect(A)}},onPageRemove:function(B,A,C){this.onStoreRemove(this.store,C)},onPageAdd:function(D,C,E){var A=E.length,F,B;for(F=0;F<A;F++){B=E[F];if(this.selected.get(B.id)){this.selected.replace(B)}}},getCount:function(){return this.selected.getCount()},onUpdate:Ext.emptyFn,destroy:function(){var A=this;A.clearSelections();A.bindStore(null);A.selected=Ext.destroy(A.selected);A.callParent()},onStoreUpdate:Ext.emptyFn,onIdChanged:function(A,D,C,B){this.selected.updateKey(D,C)},onStoreRefresh:function(){this.updateSelectedInstances(this.selected)},updateSelectedInstances:function(E){var I=this,K=I.getStore(),J=I.lastSelected,A=0,C=I.pruneRemovedOnRefresh(),H,B,F,L,D,G;if(K.isBufferedStore){return }H=E.getRange();B=H.length;if(J){I.lastSelected=K.getById(J.id);G=I.lastSelected!==J}I.refreshing=true;for(F=0;F<B;++F){L=H[F];D=K.getById(L.id);if(D){if(D!==L){E.replace(D)}}else{if(C){E.remove(L);++A}}}I.refreshing=false;I.maybeFireSelectionChange(A>0);if(G){I.fireEvent("lastselectedchanged",I,I.getSelection(),I.lastSelected)}},pruneRemovedOnRefresh:function(){return this.pruneRemoved},onStoreLoad:Ext.emptyFn,onSelectChange:function(A,D,C,F){var E=this,B=D?"select":"deselect";if((C||E.fireEvent("before"+B,E,A))!==false&&F()!==false){if(!C){E.fireEvent(B,E,A)}}},onEditorKey:Ext.emptyFn,beforeViewRender:function(A){Ext.Array.include(this.views||(this.views=[]),A)},onHeaderClick:Ext.emptyFn,resolveListenerScope:function(C){var A=this.view,B;if(A){B=A.resolveSatelliteListenerScope(this,C)}return B||this.callParent([C])},bindComponent:Ext.emptyFn,privates:{onBeforeNavigate:Ext.privateFn,selectWithEventMulti:function(H,J,D){var K=this,E=J.shiftKey,A=J.ctrlKey,C=E?(K.getSelectionStart()):null,F=K.getSelection(),I=F.length,B,G,L;if(E&&C){K.selectRange(C,H,A)}else{if(A&&D){if(K.allowDeselect){K.doDeselect(H,false)}}else{if(A){K.doSelect(H,true,false)}else{if(D&&!E&&!A&&I>1){if(K.allowDeselect){B=[];for(G=0;G<I;++G){L=F[G];if(L!==H){B.push(L)}}K.doDeselect(B)}}else{if(!D){K.doSelect(H,false)}}}}}},selectWithEventSimple:function(A,C,B){if(B){this.doDeselect(A)}else{this.doSelect(A,true)}},selectWithEventSingle:function(B,E,C){var D=this,A=D.allowDeselect;if(A&&!E.ctrlKey){A=D.toggleOnClick}if(A&&C){D.doDeselect(B)}else{D.doSelect(B,false)}}}})