Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:false,allowContainerDrops:false,appendOnly:false,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(B){var A=this.view;this.expandProcId=false;if(!B.isLeaf()&&!B.isExpanded()){A.expand(B);this.expandProcId=false}},queueExpand:function(A){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[A])},cancelExpand:function(){if(this.expandProcId){clearTimeout(this.expandProcId);this.expandProcId=false}},getPosition:function(E,B){var H=this.view,C=H.getRecord(B),F=E.getY(),I=C.isLeaf(),A=false,G=Ext.fly(B).getRegion(),D;if(C.isRoot()){return"append"}if(this.appendOnly){return I?false:"append"}if(!this.allowParentInserts){A=C.hasChildNodes()&&C.isExpanded()}D=(G.bottom-G.top)/(I?2:3);if(F>=G.top&&F<(G.top+D)){return"before"}else{if(!A&&(I||(F>=(G.bottom-D)&&F<=G.bottom))){return"after"}else{return"append"}}},isValidDropPoint:function(B,G,K,H,E){if(!B||!E.item){return false}var L=this.view,I=L.getRecord(B),D=E.records,A=D.length,J=D.length,C,F;if(!(I&&G&&A)){return false}for(C=0;C<J;C++){F=D[C];if(F.isNode&&F.contains(I)){return false}}if(G==="append"&&I.get("allowDrop")===false){return false}else{if(G!=="append"&&I.parentNode.get("allowDrop")===false){return false}}if(Ext.Array.contains(D,I)){return false}return L.fireEvent("nodedragover",I,G,E,H)!==false},onNodeOver:function(A,G,E,C){var D=this.getPosition(E,A),B=this.dropNotAllowed,H=this.view,F=H.getRecord(A),I=this.getIndicator(),J=0;this.cancelExpand();if(D==="append"&&!this.expandProcId&&!Ext.Array.contains(C.records,F)&&!F.isLeaf()&&!F.isExpanded()){this.queueExpand(F)}if(this.isValidDropPoint(A,D,G,E,C)){this.valid=true;this.currentPosition=D;this.overRecord=F;I.setWidth(Ext.fly(A).getWidth());J=Ext.fly(A).getY()-Ext.fly(H.el).getY()-1;if(H.touchScroll===2){J+=H.getScrollY()}if(D==="before"){B=F.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between";I.showAt(0,J);G.proxy.show()}else{if(D==="after"){B=F.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between";J+=Ext.fly(A).getHeight();I.showAt(0,J);G.proxy.show()}else{B=Ext.baseCSSPrefix+"tree-drop-ok-append";I.hide()}}}else{this.valid=false}this.currentCls=B;return B},onNodeOut:function(D,A,C,B){this.valid=false;this.getIndicator().hide()},onContainerOver:function(A,C,B){return this.allowContainerDrops?this.dropAllowed:C.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},onContainerDrop:function(A,C,B){if(this.allowContainerDrops){this.valid=true;this.currentPosition="append";this.overRecord=this.view.store.getRoot();this.onNodeDrop(this.overRecord,A,C,B)}},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(F,L,H){var N=this,A=N.view,I=L?L.parentNode:A.panel.getRootNode(),B=A.store.getModel(),C,E,K,G,D,J,M,O;if(F.copy){C=F.records;F.records=[];for(E=0,K=C.length;E<K;E++){G=C[E];if(G.isNode){F.records.push(G.copy())}else{F.records.push(new B(Ext.apply({},G.data)))}}}N.cancelExpand();if(H==="before"){D=I.insertBefore;J=[null,L];L=I}else{if(H==="after"){if(L.nextSibling){D=I.insertBefore;J=[null,L.nextSibling]}else{D=I.appendChild;J=[null]}L=I}else{if(!(L.isExpanded()||L.isLoading())){M=true}D=L.appendChild;J=[null]}}O=function(){var P,Q;Ext.suspendLayouts();for(E=0,K=F.records.length;E<K;E++){G=F.records[E];if(!G.isNode){if(G.isModel){G=new B(G.data,G.getId())}else{G=new B(G)}F.records[E]=G}J[0]=G;D.apply(L,J)}if(N.sortOnDrop){L.sort(L.getOwnerTree().store.getSorters().sortFn)}Ext.resumeLayouts(true);G=F.records[0];A.ownerGrid.ensureVisible(G);A.getNavigationModel().setPosition(G);if(Ext.enableFx&&N.dropHighlight){P=N.dropHighlightColor;for(E=0;E<K;E++){Q=A.getNode(F.records[E]);if(Q){Ext.fly(Q).highlight(P)}}}};if(M){L.expand(false,O)}else{if(L.isLoading()){L.on({expand:O,delay:1,single:true})}else{O()}}}})