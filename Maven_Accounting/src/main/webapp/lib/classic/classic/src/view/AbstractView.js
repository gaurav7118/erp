Ext.define("Ext.view.AbstractView",{extend:"Ext.Component",requires:["Ext.LoadMask","Ext.CompositeElementLite","Ext.selection.DataViewModel","Ext.view.NavigationModel"],mixins:["Ext.util.StoreHolder"],inheritableStatics:{getRecord:function(A){return this.getBoundView(A).getRecord(A)},getBoundView:function(A){return Ext.getCmp(A.getAttribute("data-boundView"))}},defaultBindProperty:"store",renderBuffer:document.createElement("div"),statics:{updateDelay:200,queueRecordChange:function(L,N,G,B,C){var K=this,A=K.changeQueue||(K.changeQueue={}),H=G.internalId,J,F,I,D,O,M,E;J=A[H]||(A[H]={operation:B,record:G,data:{},views:[]});F=J.data;Ext.Array.include(J.views,L);if(C&&(I=C.length)){for(D=0;D<I;D++){O=C[D];M=G.data[O];if(F.hasOwnProperty(O)){if(G.isEqual(F[O],M)){delete F[O];E=true}}else{F[O]=M}}if(E&&!Ext.Object.getKeys(F).length){delete A[H]}}else{Ext.apply(F,G.data)}if(!K.flushQueueTask){K.flushQueueTask=Ext.util.TaskManager.newTask({run:Ext.global.requestAnimationFrame?Ext.Function.createAnimationFrame(K.onFlushTick,K):Ext.Function.bind(K.onFlushTick,K),interval:Ext.view.AbstractView.updateDelay,repeat:1})}K.flushQueueTask.start()},onFlushTick:function(){Ext.AnimationQueue.start(this.flushChangeQueue,this)},flushChangeQueue:function(){var E=this,F,A,H,D,G,C,B;if(Ext.isScrolling){E.flushQueueTask.start();return }H=E.changeQueue;this.changeQueue={};for(G in H){D=H[G];F=D.views;A=F.length;for(C=0;C<A;C++){B=F[C];if(!B.destroyed){B.handleUpdate(B.dataSource,D.record,D.operation,Ext.Object.getKeys(D.data))}}}Ext.AnimationQueue.stop(E.flushChangeQueue,E)}},config:{selection:null,store:"ext-empty-store",navigationModel:{type:"default"},selectionModel:{type:"dataviewmodel"}},publishes:["selection"],twoWayBindable:["selection"],throttledUpdate:false,deferInitialRefresh:false,itemCls:Ext.baseCSSPrefix+"dataview-item",loadingText:"Loading...",loadMask:true,loadingUseMsg:true,selectedItemCls:Ext.baseCSSPrefix+"item-selected",emptyText:"",deferEmptyText:true,trackOver:false,blockRefresh:false,preserveScrollOnRefresh:false,preserveScrollOnReload:false,ariaRole:"listbox",itemAriaRole:"option",last:false,focusable:true,tabIndex:0,triggerEvent:"itemclick",triggerCtEvent:"containerclick",refreshNeeded:true,updateSuspendCounter:0,addCmpEvents:Ext.emptyFn,constructor:function(A){if(A&&A.selModel){A.selectionModel=A.selModel}this.callParent([A])},initComponent:function(){var D=this,B=Ext.isDefined,E=D.itemTpl,C={},A;if(E){if(Ext.isArray(E)){if(typeof E[E.length-1]!=="string"){E=E.slice(0);C=E.pop()}E=E.join("")}else{if(Ext.isObject(E)){C=Ext.apply(C,E.initialConfig);E=E.html}}if(!D.itemSelector){D.itemSelector="."+D.itemCls}E=Ext.String.format('<tpl for="."><div class="{0}" role="{2}">{1}</div></tpl>',D.itemCls,E,D.itemAriaRole);D.tpl=new Ext.XTemplate(E,C)}if(!B(D.tpl)||!B(D.itemSelector)){Ext.raise({sourceClass:"Ext.view.View",tpl:D.tpl,itemSelector:D.itemSelector,msg:"DataView requires both tpl and itemSelector configurations to be defined."})}D.callParent();D.tpl=D.getTpl("tpl");if(B(D.overCls)||B(D.overClass)){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.view.View: Using the deprecated overCls or overClass configuration. Use overItemCls instead.")}D.overItemCls=D.overCls||D.overClass;delete D.overCls;delete D.overClass}if(B(D.selectedCls)||B(D.selectedClass)){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.view.View: Using the deprecated selectedCls or selectedClass configuration. Use selectedItemCls instead.")}D.selectedItemCls=D.selectedCls||D.selectedClass;delete D.selectedCls;delete D.selectedClass}if(D.overItemCls){D.trackOver=true}D.addCmpEvents();A=D.store=Ext.data.StoreManager.lookup(D.store||"ext-empty-store");if(!D.dataSource){D.dataSource=A}D.bindStore(A,true);D.getNavigationModel().bindComponent(this);if(!D.all){D.all=new Ext.CompositeElementLite()}D.scrollState={top:0,left:0};D.savedTabIndexAttribute="data-savedtabindex-"+D.id},getElConfig:function(){var A=this.mixins.renderable.getElConfig.call(this);if(this.focusable){A.tabIndex=0}return A},onRender:function(){var A=this.loadMask;this.callParent(arguments);if(A){this.createMask(A)}},beforeLayout:function(){var A=this;A.callParent(arguments);if(A.refreshNeeded&&!A.pendingRefresh){if(A.refreshCounter){A.refresh()}else{A.doFirstRefresh(A.dataSource)}}},onMaskBeforeShow:function(){var B=this,A=B.loadingHeight;if(A&&A>B.getHeight()){B.hasLoadingHeight=true;B.oldMinHeight=B.minHeight;B.minHeight=A;B.updateLayout()}},onMaskHide:function(){var A=this;if(!A.destroying&&A.hasLoadingHeight){A.minHeight=A.oldMinHeight;A.updateLayout();delete A.hasLoadingHeight}},beforeRender:function(){this.callParent(arguments);this.getSelectionModel().beforeViewRender(this)},afterRender:function(){this.callParent(arguments);if(this.focusable){this.focusEl=this.el}},getRefItems:function(){var B=this.loadMask,A=[];if(B&&B.isComponent){A.push(B)}return A},getSelection:function(){return this.getSelectionModel().getSelection()},updateSelection:function(A){var B=this,C;if(!B.ignoreNextSelection){B.ignoreNextSelection=true;C=B.getSelectionModel();if(A){C.select(A)}else{C.deselectAll()}B.ignoreNextSelection=false}},updateBindSelection:function(A,C){var D=this,B=null;if(!D.ignoreNextSelection){D.ignoreNextSelection=true;if(C.length){B=A.getLastSelected();D.hasHadSelection=true}if(D.hasHadSelection){D.setSelection(B)}D.ignoreNextSelection=false}},applySelectionModel:function(B,F){var E=this,D=E.grid,G,C,A;if(F){F.un({scope:E,selectionchange:E.updateBindSelection,lastselectedchanged:E.updateBindSelection,select:E.ariaSelect,deselect:E.ariaDeselect});Ext.destroy(E.selModelRelayer);B=Ext.Factory.selection(B)}else{if(B&&B.isSelectionModel){B.locked=E.disableSelection}else{if(E.simpleSelect){G="SIMPLE"}else{if(E.multiSelect){G="MULTI"}else{G="SINGLE"}}if(typeof B==="string"){B={type:B}}B=Ext.Factory.selection(Ext.apply({allowDeselect:E.allowDeselect||E.multiSelect,mode:G,locked:E.disableSelection},B))}}if(B.mode!=="SINGLE"){A=(D||E).ariaEl.dom;if(A){A.setAttribute("aria-multiselectable",true)}else{if(!D){C=E.ariaRenderAttributes||(E.ariaRenderAttributes={});C["aria-multiselectable"]=true}}}E.selModelRelayer=E.relayEvents(B,["selectionchange","beforeselect","beforedeselect","select","deselect","focuschange"]);B.on({scope:E,lastselectedchanged:E.updateBindSelection,selectionchange:E.updateBindSelection,select:E.ariaSelect,deselect:E.ariaDeselect});return B},updateSelectionModel:function(A){this.selModel=A},applyNavigationModel:function(A){return Ext.Factory.viewNavigation(A)},onFocusEnter:function(D){var C=this,B=C.getNavigationModel(),A;C.toggleChildrenTabbability(false);if(!C.itemFocused&&C.all.getCount()){A=B.getLastFocused();B.setPosition(A||0,D.event,null,!A);C.itemFocused=B.getPosition()!=null}if(C.itemFocused){this.el.dom.setAttribute("tabIndex","-1")}C.callParent([D])},onFocusLeave:function(B){var A=this;if(A.itemFocused&&!A.refreshing){A.getNavigationModel().setPosition(null,B.event,null,true);A.itemFocused=false;A.el.dom.setAttribute("tabIndex",0)}A.callParent([B])},ariaSelect:function(B,A){var C=this.getNode(A);if(C){C.setAttribute("aria-selected",true)}},ariaDeselect:function(B,A){var C=this.getNode(A);if(C){C.removeAttribute("aria-selected")}},onRemoved:function(A){this.callParent([A]);if(!A){this.onFocusLeave({})}},refresh:function(){var I=this,H=I.all,K=H.getCount(),G=I.refreshCounter,J,C,B,F=I.getSelectionModel(),E,D=G&&H.getCount()&&I.preserveScrollOnRefresh&&I.getScrollable(),A;if(!I.rendered||I.destroyed){return }if(!I.hasListeners.beforerefresh||I.fireEvent("beforerefresh",I)!==false){I.refreshing=true;E=I.saveFocusState();J=I.getTargetEl();B=I.getViewRange();C=J.dom;if(D){A=D.getPosition();if(!(A.x||A.y)){A=null}}if(G){I.clearViewEl();I.refreshCounter++}else{I.refreshCounter=1}I.tpl.append(J,I.collectData(B,H.startIndex||0));if(B.length<1){I.addEmptyText();H.clear()}else{I.collectNodes(J.dom);I.updateIndexes(0)}E();if(I.refreshSelmodelOnRefresh!==false){F.refresh()}I.refreshNeeded=false;I.refreshSize(H.getCount()!==K);I.fireEvent("refresh",I,B);if(D){D.scrollTo(A)}if(!I.viewReady){I.viewReady=true;I.fireEvent("viewready",I)}I.refreshing=false;I.refreshScroll();I.cleanupData()}},addEmptyText:function(){var B=this,A=B.getStore();if(B.emptyText&&!A.isLoading()&&(!B.deferEmptyText||B.refreshCounter>1||A.isLoaded())){B.emptyEl=Ext.core.DomHelper.insertHtml("beforeEnd",B.getTargetEl().dom,B.emptyText)}},getViewRange:function(){return this.dataSource.getRange()},refreshSize:function(D){var C=this,B=C.getSizeModel(),A=C.getScrollable();if(B.height.shrinkWrap||B.width.shrinkWrap||D){C.updateLayout()}else{if(C.touchScroll&&!C.bufferedRenderer){if(A){A.refresh()}else{C.on({boxready:C.refreshScroll,scope:C,single:true})}}}},afterFirstLayout:function(C,B){var D=this,A=D.getScrollable();if(A){A.on({scroll:D.onViewScroll,scrollend:D.onViewScrollEnd,scope:D,onFrame:!!Ext.global.requestAnimationFrame})}D.callParent([C,B])},clearViewEl:function(){var B=this,C=B.getTargetEl(),A=B.getNodeContainer()===C;B.clearEmptyEl();B.all.clear(!A);if(A){C.dom.innerHTML=""}},clearEmptyEl:function(){var A=this.emptyEl;if(A){Ext.removeNode(A)}this.emptyEl=null},onViewScroll:function(B,A,C){this.fireEvent("scroll",this,A,C)},onViewScrollEnd:function(B,A,C){this.fireEvent("scrollend",this,A,C)},saveScrollState:function(){var A=this,B=A.scrollState;if(A.rendered){B.left=A.getScrollX();B.top=A.getScrollY()}},restoreScrollState:function(){var A=this,B=A.scrollState;if(A.rendered){A.setScrollX(B.left);A.setScrollY(B.top)}},prepareData:function(E,D,C){var B,A,F;if(C){B=C.getAssociatedData();for(A in B){if(B.hasOwnProperty(A)){if(!F){E=Ext.Object.chain(E);F=true}E[A]=B[A]}}}return E},collectData:function(C,F){var E=[],D=0,A=C.length,B;for(;D<A;D++){B=C[D];E[D]=this.prepareData(B.data,F+D,B)}return E},cleanupData:Ext.emptyFn,bufferRender:function(D,E){var G=this,H=G.renderBuffer,B=document.createDocumentFragment(),C,A,F;G.tpl.overwrite(H,G.collectData(D,E));C=Ext.fly(H).query(G.getItemSelector());for(F=0,A=C.length;F<A;F++){B.appendChild(C[F])}return{fragment:B,children:C}},nodeContainerSelector:null,getNodeContainer:function(){var B=this.getTargetEl(),A=this.nodeContainerSelector;return A?B.down(A,true):B},getNodeContainerSelector:function(){return this.nodeContainerSelector},onUpdate:function(D,B,C,G,E){var F=this,A=E&&E.filtered;if(!A&&F.getNode(B)){if(F.throttledUpdate){F.statics().queueRecordChange(F,D,B,C,G)}else{F.handleUpdate.apply(F,arguments)}}},handleUpdate:function(C,A){var F=this,D,E,B=F.getSelectionModel();if(F.viewReady){D=F.dataSource.indexOf(A);if(D>-1){if(F.getNode(A)){E=F.bufferRender([A],D).children[0];F.all.replaceElement(D,E,true);F.updateIndexes(D,D);B.onUpdate(A);F.refreshSizePending=true;if(B.isSelected(A)){F.onItemSelect(A)}if(F.hasListeners.itemupdate){F.fireEvent("itemupdate",A,D,E)}return E}}}},onReplace:function(J,L,B,C){var H=this,I=H.all,F=H.getSelectionModel(),M=L,O,N,G,A,K,D,E;if(H.rendered){O=H.bufferRender(C,L,true);G=O.fragment;A=O.children;N=I.item(L);if(N){I.item(L).insertSibling(G,"before",true)}else{H.appendNodes(G)}I.insert(L,A);if(B.length){E=H.saveFocusState()}L+=C.length;D=L+B.length-1;K=I.removeRange(L,D,true);if(H.refreshSelmodelOnRefresh!==false){F.refresh()}H.updateIndexes(L);if(H.hasListeners.itemremove){H.fireEvent("itemremove",B,M,K,H)}if(H.hasListeners.itemadd){H.fireEvent("itemadd",C,M,A)}E();H.refreshSize()}},onAdd:function(D,C,E){var F=this,B,A=F.getSelectionModel();if(F.rendered){if(F.all.getCount()===0){F.refresh();B=F.all.slice()}else{B=F.doAdd(C,E);if(F.refreshSelmodelOnRefresh!==false){A.refresh()}F.updateIndexes(E);F.refreshSizePending=true}if(F.hasListeners.itemadd){F.fireEvent("itemadd",C,E,B)}}},appendNodes:function(A){var B=this.all,C=B.getCount();if(this.nodeContainerSelector){this.getNodeContainer().appendChild(A)}else{B.item(C-1).insertSibling(A,"after")}},doAdd:function(C,E){var G=this,J=G.bufferRender(C,E,true),F=J.fragment,B=J.children,H=G.all,D=H.getCount(),I=H.startIndex||0,A=H.endIndex||D-1;if(D===0||E>A){G.appendNodes(F)}else{if(E<=I){H.item(I).insertSibling(F,"before",true)}else{H.item(E).insertSibling(B,"before",true)}}H.insert(E,B);return B},onRemove:function(K,D,H){var I=this,L=I.all,B=I.hasListeners.itemremove,J,E,F,A,C,G;if(L.getCount()){if(I.dataSource.getCount()===0){if(B){I.fireEvent("itemremove",D,H,I.getNodes(H,H+D.length-1))}I.refresh()}else{G=I.saveFocusState();if(B){A=[]}for(E=D.length-1;E>=0;--E){F=D[E];J=H+E;if(A){C=L.item(J);A[E]=C?C.dom:undefined}if(L.item(J)){I.doRemove(F,J)}}if(B){I.fireEvent("itemremove",D,H,A,I)}G();I.updateIndexes(H)}I.refreshSizePending=true}},doRemove:function(A,B){this.all.removeElement(B,true)},saveFocusState:function(){var D=this,A=D.dataSource||D.store,B=D.getNavigationModel(),C=B.recordIndex,E=B.record;if(D.el.contains(Ext.Element.getActiveElement())){D.el.dom.focus();return function(){if(A.getCount()){C=Math.min(C,D.all.getCount()-1);B.setPosition(A.contains(E)?E:C,null,null,true)}}}return Ext.emptyFn},refreshNode:function(A){if(Ext.isNumber(A)){A=this.store.getAt(A)}this.onUpdate(this.dataSource,A)},updateIndexes:function(G,F){var B=this.all.elements,E,A=this.getViewRange(),D,C=this.id;G=G||0;F=F||((F===0)?0:(B.length-1));for(D=G;D<=F;D++){E=B[D];E.setAttribute("data-recordIndex",D);E.setAttribute("data-recordId",A[D].internalId);E.setAttribute("data-boundView",C)}},bindStore:function(B,C){var E=this,A=E.getSelectionModel(),D=E.getNavigationModel();A.bindStore(B);A.bindComponent(B?E:null);E.mixins.storeholder.bindStore.apply(E,arguments);D.setStore(B);if(B&&E.componentLayoutCounter){E.doFirstRefresh(B,!C)}},doFirstRefresh:function(A,C){var B=this;if(B.deferInitialRefresh&&!C){Ext.defer(B.doFirstRefresh,1,B,[A,true])}else{if(A&&!A.isLoading()){B.refresh()}}},onUnbindStore:function(A){this.setMaskBind(null);if(this.dataSource===A){this.dataSource=null}},onBindStore:function(A,C){var B=this;if(B.store.isBufferedStore){B.store.preserveScrollOnReload=B.preserveScrollOnReload}if(C&&C.isBufferedStore){delete C.preserveScrollOnReload}B.setMaskBind(A);if(!B.dataSource){B.dataSource=A}},setMaskBind:function(B){var A=this.loadMask;if(this.rendered&&A&&B&&!A.bindStore){A=this.createMask()}if(A&&A.bindStore){A.bindStore(B)}},getStoreListeners:function(){var A=this;return{refresh:A.onDataRefresh,replace:A.onReplace,add:A.onAdd,remove:A.onRemove,update:A.onUpdate,clear:A.onDataRefresh,beginupdate:A.onBeginUpdate,endupdate:A.onEndUpdate}},onBeginUpdate:function(){++this.updateSuspendCounter;Ext.suspendLayouts()},onEndUpdate:function(){var A=this;if(A.updateSuspendCounter){--A.updateSuspendCounter}Ext.resumeLayouts(true);if(A.refreshSizePending){A.refreshSize(true);A.refreshSizePending=false}},onDataRefresh:function(A){var C=this,B=C.preserveScrollOnRefresh;if(A.loadCount>C.lastRefreshLoadCount){C.preserveScrollOnRefresh=C.preserveScrollOnReLoad}C.refreshView();C.preserveScrollOnRefresh=B;C.lastRefreshLoadCount=A.loadCount},refreshView:function(){var B=this,A=B.blockRefresh||!B.rendered||B.up("[collapsed],[isCollapsingOrExpanding],[hidden]");if(A){B.refreshNeeded=true}else{if(B.bufferedRenderer){B.bufferedRenderer.refreshView()}else{B.refresh()}}},findItemByChild:function(A){return Ext.fly(A).findParent(this.getItemSelector(),this.getTargetEl())},findTargetByEvent:function(A){return A.getTarget(this.getItemSelector(),this.getTargetEl())},getSelectedNodes:function(){var B=[],A=this.getSelectionModel().getSelection(),D=A.length,C=0;for(;C<D;C++){B.push(this.getNode(A[C]))}return B},getRecords:function(C){var B=[],D=0,A=C.length,E=this.dataSource.data;for(;D<A;D++){B[B.length]=E.getByKey(C[D].getAttribute("data-recordId"))}return B},getRecord:function(A){return this.dataSource.getByInternalId(Ext.getDom(A).getAttribute("data-recordId"))},isSelected:function(B){var A=this.getRecord(B);return this.getSelectionModel().isSelected(A)},select:function(B,C,A){this.getSelectionModel().select(B,C,A)},deselect:function(B,A){this.getSelectionModel().deselect(B,A)},getNode:function(B){var C=this,A;if(C.rendered&&(B||B===0)){if(Ext.isString(B)){A=document.getElementById(B)}else{if(B.isModel){A=C.getNodeByRecord(B)}else{if(Ext.isNumber(B)){A=C.all.elements[B]}else{if(B.target&&B.target.nodeType){B=B.target}A=Ext.fly(B).findParent(C.itemSelector,C.getTargetEl())}}}}return A||null},getNodeByRecord:function(A){var B=this.store.indexOf(A);return this.all.elements[B]||null},getNodes:function(C,A){var B=this.all;if(A!==undefined){A++}return B.slice(C,A)},indexOf:function(A){A=this.getNode(A);if(!A&&A!==0){return -1}if(A.getAttribute("data-recordIndex")){return Number(A.getAttribute("data-recordIndex"))}return this.all.indexOf(A)},onDestroy:function(){var B=this,A=B.updateSuspendCounter;B.all.clear();B.emptyEl=null;B.callParent();B.bindStore(null);B.store=B.dataSource=B.storeListeners=null;if(B.selModelRelayer){B.selModelRelayer.destroy();B.selModelRelayer=null}Ext.destroy(B.navigationModel,B.selectionModel);B.navigationModel=B.selectionModel=B.selModel=null;B.loadMask=null;while(A--){Ext.resumeLayouts(true)}},onItemSelect:function(A){var B=this.getNode(A);if(B){Ext.fly(B).addCls(this.selectedItemCls)}},onItemDeselect:function(A){var B=this.getNode(A);if(B){Ext.fly(B).removeCls(this.selectedItemCls)}},getItemSelector:function(){return this.itemSelector},addItemCls:function(B,A){var C=this.getNode(B);if(C){Ext.fly(C).addCls(A)}},removeItemCls:function(B,A){var C=this.getNode(B);if(C){Ext.fly(C).removeCls(A)}},setStore:function(A){var B=this;if(B.store!==A){if(B.isConfiguring){B.store=A}else{B.bindStore(A,false)}}},privates:{toggleChildrenTabbability:function(B){var A=this.getTargetEl();if(B){A.restoreTabbableState(true)}else{A.saveTabbableState({skipSelf:true,includeSaved:false})}},collectNodes:function(C){var B=this.all,A={role:this.itemAriaRole};B.fill(Ext.fly(C).query(this.getItemSelector()),B.startIndex||0);if(this.focusable){A.tabindex="-1"}B.set(A)},createMask:function(B){var D=this,C=D.getStore(),A;if(C&&!C.isEmptyStore&&!C.loadsSynchronously()){A={target:D,msg:D.loadingText,useMsg:D.loadingUseMsg,store:C};if(D.loadingCls){A.msgCls=D.loadingCls}if(Ext.isObject(B)){A=Ext.apply(A,B)}D.loadMask=new Ext.LoadMask(A);D.loadMask.on({scope:D,beforeshow:D.onMaskBeforeShow,hide:D.onMaskHide})}return D.loadMask},getOverflowEl:function(){return Ext.Component.prototype.getTargetEl.call(this)},getTargetEl:function(){return this.touchScroll?this.getScrollerEl():this.callParent()}}},function(){Ext.deprecate("extjs","4.0",function(){Ext.view.AbstractView.override({getSelectionCount:function(){if(Ext.global.console){Ext.global.console.warn("DataView: getSelectionCount will be removed, please interact with the Ext.selection.DataViewModel")}return this.selModel.getSelection().length},getSelectedRecords:function(){if(Ext.global.console){Ext.global.console.warn("DataView: getSelectedRecords will be removed, please interact with the Ext.selection.DataViewModel")}return this.selModel.getSelection()},select:function(A,B,D){if(Ext.global.console){Ext.global.console.warn("DataView: select will be removed, please access select through a DataView's SelectionModel, ie: view.getSelectionModel().select()")}var C=this.getSelectionModel();return C.select.apply(C,arguments)},clearSelections:function(){if(Ext.global.console){Ext.global.console.warn("DataView: clearSelections will be removed, please access deselectAll through DataView's SelectionModel, ie: view.getSelectionModel().deselectAll()")}var A=this.getSelectionModel();return A.deselectAll()}})})})