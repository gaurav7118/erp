describe("Ext.grid.feature.GroupingSummary",function(){var H,B,L,K,D,F,E,M=true,G=Ext.data.ProxyStore.prototype.load,J;function I(O,N,Q,P){H=[{student:"Student 1",subject:"Math",mark:84,allowance:15.5},{student:"Student 1",subject:"Science",mark:72,allowance:10.75},{student:"Student 2",subject:"Math",mark:96,allowance:100.75},{student:"Student 2",subject:"Science",mark:68,allowance:1.55}];Ext.define("spec.GroupingSummary",{extend:"Ext.data.Model",fields:["student","subject",{name:"mark",type:"int"},{name:"allowance",type:"float"}]});P=Ext.apply({model:"spec.GroupingSummary",data:H,autoDestroy:true},P);if(!P.grouper&&!P.hasOwnProperty("groupField")){P.groupField="subject"}L=new Ext.data.Store(P);K=new Ext.grid.feature.GroupingSummary(Ext.apply({ftype:"groupingsummary"},N));Q=Q||[{itemId:"studentColumn",dataIndex:"student",text:"Name",summaryType:"count",summaryRenderer:function(T,S,U,R){F=arguments;return Ext.String.format("{0} student{1}",T,T!==1?"s":"")}},{itemId:"markColumn",dataIndex:"mark",text:"Mark",summaryType:"average"},{itemId:"noDataIndexColumn",summaryType:function(T,S){var U=0,W=T.length,V=0,R;for(;U<W;++U){R=T[U];V+=R.get("allowance")}return V},summaryRenderer:function(T,S,U,R){return Ext.util.Format.usMoney(T||R.record.get("allowance"))},renderer:function(W,T,S,V,X,U,R){return Ext.util.Format.usMoney(S.get("allowance"))}}];B=new Ext.grid.Panel(Ext.apply({store:L,columns:Q,width:600,height:300,features:K,renderTo:Ext.getBody()},O));E=K.summaryRowSelector}function C(N,Q){var P=K.getMetaGroup(L.getGroups().getAt(0)),O=P.aggregateRecord;expect(O.get(N[0])).toBe(Q[0]);expect(O.get(N[1])).toBe(Q[1])}function A(N){var O=B.view.body.down(".x-grid-row-summary",true);expect((O.textContent||O.innerText).replace(/\s/g,"")).toBe(N)}beforeEach(function(){J=Ext.data.ProxyStore.prototype.load=function(){G.apply(this,arguments);if(M){this.flushLoad.apply(this,arguments)}return this}});afterEach(function(){Ext.data.ProxyStore.prototype.load=G;B.destroy();B=L=K=D=F=null;Ext.undefine("spec.GroupingSummary");Ext.data.Model.schema.clear()});describe("summaryRenderer",function(){it("should be passed the expected function parameters",function(){I();expect(F.length).toBe(4);expect(F[0]).toBe(2);expect(F[1]).toEqual({studentColumn:2,markColumn:70,noDataIndexColumn:12.3});expect(F[2]).toBe("student");expect(F[3].tdCls).toBeDefined()});it("should be able to read the data from the summary record when there is no column.dataIndex",function(){var N;I();N=B.view.all.item(1,true);expect((N.textContent||N.innerText).replace(/\r\n?|\n/g,"")).toBe("Student 296$100.752 students90$116.25")});it("should update when group records are removed",function(){var N;I();N=K.summaryData.Math;expect(N.markColumn).toBe(90);expect(N.noDataIndexColumn).toBe(116.25);expect(N.studentColumn).toBe(2);L.removeAt(1);expect(N.markColumn).toBe(84);expect(N.noDataIndexColumn).toBe(15.5);expect(N.studentColumn).toBe(1)})});describe("toggling the summary row",function(){function N(O){K.toggleSummaryRow(O)}it("should show the summary row by default",function(){I();expect(B.getView().getEl().select(E).getCount()).toBe(2)});it("should not render the summary rows if configured with showSummaryRow: false",function(){I(null,{showSummaryRow:false});expect(B.getView().getEl().select(E).getCount()).toBe(0)});it("should not show summary rows when toggling off",function(){I();expect(B.getView().getEl().select(E).getCount()).toBe(2);N();expect(B.getView().getEl().select(E).getCount()).toBe(0)});it("should show summary rows when toggling on",function(){I(null,{showSummaryRow:false});expect(B.getView().getEl().select(E).getCount()).toBe(0);N();expect(B.getView().getEl().select(E).getCount()).toBe(2)});it("should leave the summary visible when explicitly passing visible: true",function(){I();N(true);expect(B.getView().getEl().select(E).getCount()).toBe(2)});it("should leave the summary off when explicitly passed visible: false",function(){I();N();N(false);expect(B.getView().getEl().select(E).getCount()).toBe(0)});it("should update the summary row if the change happened while not visible",function(){I();N();L.first().set("mark",0);N();var Q=B.getView().getEl().select(E).first(),O=Q.down(B.down("#markColumn").getCellSelector());var P=O.down(B.getView().innerSelector).dom.innerHTML;expect(P).toBe("48")})});describe("when the view is refreshed",function(){function N(O){it("should retain the summary feature row information in the feature cache",function(){var Q=K.getMetaGroup(L.getGroups().getAt(0)),P=Q.aggregateRecord;expect(P.get("student")).toBe(O.student);expect(P.get("mark")).toBe(O.mark);expect(P.get("noDataIndexColumn")).toBe(O.noDataIndexColumn)});it("should retain the summary feature row information in the view",function(){var P=B.view.body.down(".x-grid-row-summary",true);expect((P.textContent||P.innerText).replace(/\s/g,"")).toBe(O.view)})}describe("when toggling the enabled/disabled state of the groups",function(){beforeEach(function(){I();K.disable();K.enable()});N({student:2,mark:90,noDataIndexColumn:116.25,view:"2students90$116.25"})});describe("when filtering the store",function(){beforeEach(function(){I();B.store.addFilter({property:"mark",operator:"eq",value:84})});describe("adding a filter",function(){N({student:1,mark:84,noDataIndexColumn:15.5,view:"1student84$15.50"})});describe("clearing the filters",function(){beforeEach(function(){B.store.clearFilter()});N({student:2,mark:90,noDataIndexColumn:116.25,view:"2students90$116.25"})})})});describe("reconfiguring",function(){beforeEach(function(){I()});describe("new store",function(){it("should update the summary row",function(){L=new Ext.data.Store({model:"spec.GroupingSummary",groupField:"subject",data:[{student:"Student 1",subject:"Math",mark:84,allowance:15.5},{student:"Student 2",subject:"Science",mark:68,allowance:1.55}],autoDestroy:true});B.reconfigure(L);C(["mark","noDataIndexColumn"],[84,15.5]);A("1student84$15.50")})});describe("new columns",function(){it("should update the summary row",function(){B.reconfigure(null,[{itemId:"studentColumn",dataIndex:"student",text:"Name",summaryType:"count",summaryRenderer:function(P,O,Q,N){F=arguments;return Ext.String.format("{0} student{1}",P,P!==1?"s":"")}},{itemId:"allowance",dataIndex:"allowance",text:"Allowance",summaryType:"average"}]);C(["student","allowance"],[2,58.125]);A("2students58.125")})})});describe("loading the store",function(){beforeEach(function(){MockAjaxManager.addMethods()});afterEach(function(){MockAjaxManager.removeMethods()});it("should update the summary when loading remote data",function(){I(null,null,null,{data:null,proxy:{type:"ajax",url:"Foo"}});L.load();Ext.Ajax.mockComplete({status:200,responseText:Ext.encode(H)});var N=B.view.el.query(K.summaryRowSelector);expect((N[0].textContent||N[0].innerText).replace(/\s/g,"")).toBe("2students90$116.25");expect((N[1].textContent||N[1].innerText).replace(/\s/g,"")).toBe("2students70$12.30");L.load();Ext.Ajax.mockComplete({status:200,responseText:Ext.encode([{student:"Student 1",subject:"Math",mark:77,allowance:30},{student:"Student 2",subject:"Science",mark:20,allowance:30.12},{student:"Student 3",subject:"Science",mark:30,allowance:12},{student:"Student 4",subject:"Science",mark:40,allowance:1}])});N=B.view.el.query(K.summaryRowSelector);expect((N[0].textContent||N[0].innerText).replace(/\s/g,"")).toBe("1student77$30.00");expect((N[1].textContent||N[1].innerText).replace(/\s/g,"")).toBe("3students30$43.12")});it("should update the summary when loading local data",function(){I();var N=B.view.el.query(K.summaryRowSelector);expect((N[0].textContent||N[0].innerText).replace(/\s/g,"")).toBe("2students90$116.25");expect((N[1].textContent||N[1].innerText).replace(/\s/g,"")).toBe("2students70$12.30");L.loadData([{student:"Student 1",subject:"Math",mark:77,allowance:30},{student:"Student 2",subject:"Science",mark:20,allowance:30.12},{student:"Student 3",subject:"Science",mark:30,allowance:12},{student:"Student 4",subject:"Science",mark:40,allowance:1}]);N=B.view.el.query(K.summaryRowSelector);expect((N[0].textContent||N[0].innerText).replace(/\s/g,"")).toBe("1student77$30.00");expect((N[1].textContent||N[1].innerText).replace(/\s/g,"")).toBe("3students30$43.12")})});describe("remoteRoot",function(){function N(O){Ext.Ajax.mockComplete({status:200,responseText:Ext.JSON.encode(O)})}beforeEach(function(){MockAjaxManager.addMethods();I(null,{remoteRoot:"summaryData"},null,{remoteSort:true,proxy:{type:"ajax",url:"data.json",reader:{type:"json",rootProperty:"data"}},grouper:{property:"student"},data:null});L.load();N({data:H,summaryData:[{allowance:67,mark:42,student:"Student 1"},{allowance:100,mark:99,student:"Student 2"}],total:4})});afterEach(function(){MockAjaxManager.removeMethods()});it("should correctly render the data in the view",function(){var O=B.view.body.query(".x-grid-row-summary");expect((O[0].textContent||O[0].innerText).replace(/\s/g,"")).toBe("Student1students42$67.00");expect((O[1].textContent||O[1].innerText).replace(/\s/g,"")).toBe("Student2students99$100.00")});it("should create a summaryData object for each group",function(){var O=K.summaryData;expect(O["Student 1"]).toBeDefined();expect(O["Student 2"]).toBeDefined()});it("should create a metaGroupCache entry for each group",function(){var O=K.getCache();expect(O["Student 1"]).toBeDefined();expect(O["Student 2"]).toBeDefined()})})})