describe("grid-grouping",function(){function A(B){describe(B?"with buffered rendering":"without buffered rendering",function(){var D,L,M,C,E,R=Ext.define(null,{extend:"Ext.data.Model",fields:["name","type"]});function G(T,S,V){var W={fn:V||Ext.emptyFn},U=spyOn(W,"fn");T.addListener(S,W.fn);return U}function H(U,W,V,T,S,Y){var X=N(W,V);jasmine.fireMouseEvent(X,U,S,Y,T)}function Q(V,U,T,S,W){var X=N(V,U);jasmine.fireKeyEvent(X,T,S,null,null,W)}function K(S,T){var U=F(S,T);jasmine.fireMouseEvent(U,"click")}function F(T,U){U=U||L;var S=(U.normalView||U).features[0];return S.getHeaderNode(T)}function N(T,S){return D.getView().getCellInclusive({row:T,column:S},true)}function P(S){return M.getAt(S)}function O(){var T=[],S,U;for(S=0;S<300;++S){U=S+1;T.push({id:U,name:"Item"+U,type:"group"+Ext.String.leftPad(Math.ceil(U/3),3,"0")})}return T}function J(W,T,Y,S,Z){var U=0,X=[],V;if(Ext.isArray(Y)){X=Y}else{if(typeof Y!=="number"){Y=100}for(;U<Y;U++){X.push({id:U+1,type:"t"+(Math.floor(U/25)+1),name:"Item "+(U+1)})}}V={model:R,data:X};if(!W){V.groupField="type"}M=new Ext.data.Store(V);E=S?new Ext.grid.feature.GroupingSummary(Z):new Ext.grid.feature.Grouping(Z);D=new Ext.grid.Panel(Ext.apply({columns:[{dataIndex:"name"}],trailingBufferZone:1000,leadingBufferZone:1000,store:M,features:[E],width:1000,height:500,bufferedRenderer:B,viewConfig:{mouseOverOutBuffer:false,deferHighlight:false},renderTo:Ext.getBody()},T));L=D.getView();C=L.dataSource}function I(T,S,X){var U=0,W=[],V;if(typeof X!=="number"){X=100}for(;U<X;U++){W.push({id:U+1,type:"t"+(Math.floor(U/25)+1),name:"Item "+(U+1)})}V=Ext.apply({model:R,groupField:"type",proxy:{type:"memory",data:W},autoLoad:true},T);M=new Ext.data.BufferedStore(V);E=new Ext.grid.feature.Grouping();D=new Ext.grid.Panel(Ext.apply({columns:[{dataIndex:"name"}],store:M,features:[E],width:1000,height:500,viewConfig:{mouseOverOutBuffer:false,deferHighlight:false},renderTo:Ext.getBody()},S));L=D.getView()}afterEach(function(){E=D=M=L=Ext.destroy(D,M)});describe("basic functionality",function(){beforeEach(function(){J()});it("should start with all groups expanded",function(){expect(L.all.getCount()).toBe(M.getCount());K("t1");K("t2");K("t3");K("t4");expect(L.all.getCount()).toBe(D.store.getGroups().length)});it("should collapse the header on clicking",function(){K("t1");expect(E.isExpanded("t1")).toBe(false)});it("should NOT fire itemupdate for records in collapsed groups",function(){var S=G(D.view,"itemupdate").andCallThrough();K("t1");D.view.refreshNode(1);expect(S).not.toHaveBeenCalled()});it("should fire itemupdate event with recordIndex",function(){var T=G(L,"itemupdate").andCallThrough(),U=L.store.getAt(25),S=L.dataSource.indexOf(U);D.view.refreshNode(25);expect(T).toHaveBeenCalledWith(U,25,L.all.item(S).dom)});it("should fire itemupdate event with recordIndex when group above is collapsed",function(){var T=G(L,"itemupdate").andCallThrough(),U=L.store.getAt(25),S;K("t1");S=L.dataSource.indexOf(U);D.view.refreshNode(25);expect(T).toHaveBeenCalledWith(U,25,L.all.item(S).dom)});it("should expand a collapsed header on clicking",function(){K("t1");K("t1");expect(E.isExpanded("t1")).toBe(true)});it("should allow selection after collapsing",function(){K("t1");H("click",1,0);expect(D.getSelectionModel().isSelected(P(25))).toBe(true)});it("should restore selection after collapsing and expading",function(){var S;H("click",0,0);K("t1");expect(L.getNode(P(0))==null).toBe(true);K("t1");expect(D.getSelectionModel().isSelected(P(0))).toBe(true);S=L.getNode(0);expect(Ext.fly(S).hasCls(L.selectedItemCls)).toBe(true);S=L.getRow(0);expect(Ext.fly(S).hasCls(L.selectedItemCls)).toBe(false)});describe("events",function(){if(!B){it("should fire itemremove for each item on collapse",function(){var W=jasmine.createSpy(),S=D.getView(),U,V,T;S.on("itemremove",W);U=S.getNodes(0,24);T=M.getRange(0,24);K("t1");expect(W.callCount).toBe(1);for(V=0;V<25;V++){expect(W.calls[0].args[0][V]).toBe(T[V]);expect(W.calls[0].args[1]).toBe(0);expect(W.calls[0].args[2][V]).toBe(U[V]);expect(W.calls[0].args[3]).toBe(S)}K("t1");W.reset();U=S.getNodes(75,99);T=M.getRange(75,99);K("t4");expect(W.callCount).toBe(1);for(V=0;V<25;V++){expect(W.calls[0].args[0][V]).toBe(T[V]);expect(W.calls[0].args[1]).toBe(75);expect(W.calls[0].args[2][V]).toBe(U[V]);expect(W.calls[0].args[3]).toBe(S)}})}})});describe("expand/collapse",function(){describe("expand",function(){describe("with focus: true",function(){describe("with the group in view",function(){it("should expand the group",function(){J(null,{height:400},O(),false,{startCollapsed:true});E.expand("group001",true);expect(E.isExpanded("group001")).toBe(true);expect(D.getView().getScrollable().getPosition()).toEqual({x:0,y:0})})});describe("with the group not in the view",function(){it("should expand the group & scroll to the first record",function(){J(null,{height:400,trailingBufferZone:20,leadingBufferZone:20},O(),false,{startCollapsed:true});E.expand("group100",true);expect(E.isExpanded("group100")).toBe(true);waitsFor(function(){var S=L.getNodeByRecord(M.getById(298));if(S){return L.getScrollable().isInView(S).y}});runs(function(){var S=L.getNodeByRecord(M.getById(298));expect(L.getScrollable().isInView(S).y).toBe(true)})})})})});describe("collapse",function(){describe("with focus: true",function(){describe("with the group in view",function(){it("should collapse the group",function(){J(null,{height:400},O());E.collapse("group001",true);expect(E.isExpanded("group001")).toBe(false);expect(D.getView().getScrollable().getPosition()).toEqual({x:0,y:0})})});describe("with the group not in the view",function(){it("should collapse the group & scroll to the placeholder",function(){J(null,{height:400,trailingBufferZone:20,leadingBufferZone:20},O());E.collapse("group100",true);expect(E.isExpanded("group100")).toBe(false);waitsFor(function(){var S=E.getHeaderNode("group100");if(S){return L.getScrollable().isInView(S).y}});runs(function(){var S=E.getHeaderNode("group100");expect(L.getScrollable().isInView(S).y).toBe(true)})})})})})});describe("moving columns",function(){function S(d,e,a,Y){var b=d.el.getBox(),V=b.x+b.width/2,U=b.y+b.height/2,Z=e.el.getBox(),f=Z.x,c=Z.y+Z.height/2,X=a?Z.width-6:5,T=f+X,W=a?Ext.dd.DragDropManager.clickPixelThresh+1:-Ext.dd.DragDropManager.clickPixelThresh-1;jasmine.fireMouseEvent(d.el.dom,"mouseover",V,U);jasmine.fireMouseEvent(d.titleEl.dom,"mousedown",V,U);jasmine.fireMouseEvent(d.el.dom,"mousemove",V+W,U);if(Y){jasmine.fireMouseEvent(e.el.dom,"mousemove",(a?T+1:T-1),c)}jasmine.fireMouseEvent(e.el.dom,"mousemove",T,c);jasmine.fireMouseEvent(e.el.dom,"mouseup",T,c)}describe("with collapsed group",function(){it("should move columns with a collapsed group without throwing an error",function(){J(null,{columns:[{text:"A",dataIndex:"name",preventUpdate:true},{text:"B",dataIndex:"name"},{text:"C",dataIndex:"name"}],height:400,trailingBufferZone:20,leadingBufferZone:20},O(),true);var T=D.getColumnManager().getColumns();E.collapse("group001",true);S(T[0],T[2],true);S(T[1],T[0])})});it("should not fire an update event on the store",function(){J(false,{columns:[{text:"A",dataIndex:"name"},{text:"B",dataIndex:"name"},{text:"C",dataIndex:"name"}]});var T=D.getColumnManager().getColumns(),U=G(M,"update");S(T[2],T[0],false);expect(U).not.toHaveBeenCalled()});it("should react to events when collapsed",function(){J(false,{columns:[{text:"A",dataIndex:"name"},{text:"B",dataIndex:"name"},{text:"C",dataIndex:"name"}]});var T=D.getColumnManager().getColumns();E.collapse("t1");S(T[2],T[0],false);K("t1");expect(E.isExpanded("t1")).toBe(true)});it("should update the summary rows",function(){function U(W,V){var W=Ext.fly(L.getNode(W)).down(E.summaryRowSelector);Ext.Array.forEach(D.getColumnManager().getColumns(),function(Y,X){var Z=W.down(Y.getCellInnerSelector()).dom.innerHTML;expect(Z).toBe(V[X])})}J(false,{columns:[{dataIndex:"name",summaryRenderer:function(Y,V,W,X){return"A"+X.record.ownerGroup}},{dataIndex:"name",summaryRenderer:function(Y,V,W,X){return"B"+X.record.ownerGroup}},{dataIndex:"name",summaryRenderer:function(Y,V,W,X){return"C"+X.record.ownerGroup}}]},null,true);U(24,["At1","Bt1","Ct1"]);U(49,["At2","Bt2","Ct2"]);U(74,["At3","Bt3","Ct3"]);U(99,["At4","Bt4","Ct4"]);var T=D.getColumnManager().getColumns();S(T[2],T[0],false);U(24,["Ct1","At1","Bt1"]);U(49,["Ct2","At2","Bt2"]);U(74,["Ct3","At3","Bt3"]);U(99,["Ct4","At4","Bt4"])})});describe("enable/disable",function(){describe("enable",function(){describe("when grouped",function(){it("should show group headers",function(){J();E.disable();E.enable();expect(L.el.select(".x-grid-group-hd").getCount()).toBe(4)})});describe("when not grouped",function(){it("should not show group headers",function(){J(true);E.disable();E.enable();expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0)})})});describe("disable",function(){describe("when grouped",function(){it("should not show group headers",function(){J();E.disable();expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0)});it("should show all rows when collapsed",function(){J();E.collapseAll();E.disable();expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0);expect(L.all.getCount()).toBe(100)})});describe("when not grouped",function(){it("should not show group headers",function(){J(true);E.disable();expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0);expect(L.all.getCount()).toBe(100)})})})});describe("markup generation",function(){it("should not cause an error when generating markup with group names with special characters",function(){expect(function(){J(false,null,[{type:"Foo Bar *&#^$%",name:"Group 1"}])}).not.toThrow()})});describe("column visibility",function(){it("should not throw an exception when hiding all columns",function(){J(false,{columns:[{dataIndex:"name",itemId:"col1"},{dataIndex:"name",itemId:"col2"},{dataIndex:"name",itemId:"col3"},{dataIndex:"name",itemId:"col4"},{dataIndex:"name",itemId:"col5"}]});expect(function(){D.down("#col1").hide();D.down("#col2").hide();D.down("#col3").hide();D.down("#col4").hide();D.down("#col5").hide()}).not.toThrow()})});if(B){describe("basic functionality with buffered renderer",function(){describe("collapseAll with locked columns",function(){beforeEach(function(){J(null,{columns:[{dataIndex:"type",width:100,locked:true},{dataIndex:"name",flex:1}]})});it("should collapseAll with no errors",function(){expect(C.getCount()).toBe(M.getCount());E.collapseAll();expect(C.getCount()).toBe(4)})});describe("expanding/collapsing, selecting and scrolling",function(){beforeEach(function(){J(null,{})});it("should start with all groups expanded - buffered rendering",function(){var S,U,V,T,W=M.getCount();expect(D.view.all.getCount()).toBe(Math.min(D.view.bufferedRenderer.viewSize,W));T=L.el.dom.scrollHeight;E.collapseAll();expect(L.el.dom.scrollHeight).toBeLessThan(T);E.expandAll();expect(L.el.dom.scrollHeight).toBeWithin(50,T);K("t1");K("t2");K("t3");K("t4");expect(D.view.all.getCount()).toBe(D.store.getGroups().length);L.bufferedRenderer.scrollTo(75,{select:true,focus:true});S=D.selModel.getSelection()[0];U=L.indexOf(S);V=L.all.item(U);expect(V).toHaveCls(L.selectedItemCls);expect(L.getCell(V,L.getHeaderAtIndex(0))).toHaveCls(L.focusedItemCls)});it("should collapse the header on clicking",function(){K("t1");expect(E.isExpanded("t1")).toBe(false)});it("should expand a collapsed header on clicking",function(){K("t1");K("t1");expect(E.isExpanded("t1")).toBe(true)});it("should allow selection after collapsing",function(){K("t1");H("click",1,0);expect(D.getSelectionModel().isSelected(P(25))).toBe(true)});it("should scroll to the passed row",function(){E.collapseAll();var S=D.view.getNode(D.store.getAt(75));expect(S==null).toBe(true);D.view.bufferedRenderer.scrollTo(75,true);var S=D.view.getNode(D.store.getAt(75));expect(S!=null).toBe(true)})});describe("grouping",function(){var T,S;beforeEach(function(){J(true,{},5000);T=D.view.bufferedRenderer;S=G(M,"clear");T.scrollTo(5000);D.store.group("type")});afterEach(function(){T=null});it("should scroll to the top",function(){var U=D.view.el.dom.scrollTop;expect(U).toBeWithin(1,U)});it("should reset object properties dealing with scrolling",function(){var V=T.scrollTop,U=T.position;waitsFor(function(){return T.bodyTop===62517});runs(function(){expect(V).toBeWithin(1,V);expect(U).toBeWithin(1,U)})});it("should not clear the store on data refresh",function(){expect(S).not.toHaveBeenCalled()})})})}describe("without grouping",function(){it("should render no headers",function(){J(true);expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0)});it("should allow selection",function(){J(true);H("click",0,0);expect(D.getSelectionModel().isSelected(P(0))).toBe(true)});it("should render group when 'group by this field' is clicked and not configured with grouping",function(){J(true,{columns:[{dataIndex:"name"},{dataIndex:"type",itemId:"type"}]});expect(L.el.select(".x-grid-group-hd").getCount()).toBe(0);jasmine.fireMouseEvent(D.down("#type").triggerEl.dom,"click");jasmine.fireMouseEvent(D.headerCt.getMenu().down("#groupMenuItem").getEl(),"click");expect(L.el.select(".x-grid-group-hd").getCount()).toBe(4)})});describe("selection/focus",function(){describe("when the grid is not focused",function(){it("should not focus/select when collapsing a group",function(){J();var S=D.getView(),T=S.getEl().select(".x-grid-group-hd").item(1);D.getView().scrollElIntoView(T);waitsFor(function(){return S.getEl().dom.scrollTop>0},"Never scrolled");runs(function(){K("t2");expect(D.getSelectionModel().getCount()).toBe(0);expect(D.getNavigationModel().getPosition()).toBeNull()})});it("should not focus/select when expanding a group",function(){J();E.collapse("t2");var S=D.getView(),T=S.getEl().select(".x-grid-group-hd").item(1);D.getView().scrollElIntoView(T);waitsFor(function(){return S.getEl().dom.scrollTop>0},"Never scrolled");runs(function(){K("t2");expect(D.getSelectionModel().getCount()).toBe(0);expect(D.getNavigationModel().getPosition()).toBeNull()})})})});describe("scrolling",function(){it("should not focus the selected row when collapsing a group",function(){J();D.getSelectionModel().preventFocus=true;D.getSelectionModel().select(0);D.scrollByDeltaY(2000);E.collapse("t4");var S=D.getView().el.dom;expect(S.scrollTop).toBe(S.scrollHeight-S.clientHeight)});it("should not focus the selected row when expanding a group",function(){J();D.getSelectionModel().select(0);D.scrollByDeltaY(2000);E.collapse("t4");var S=D.getView().el.dom,T=S.scrollTop;E.expand("t4");expect(S.scrollTop).toBe(T)});it("should scroll to the group when expanding and it is out of the viewport and not expand other groups",function(){var U=[],T;for(T=0;T<400;++T){U.push({id:T+1,type:Math.floor(T/2)+1,name:"Item "+(T+1)})}J(false,{height:400,trailingBufferZone:5,leadingBufferZone:5},U,false,{startCollapsed:true});E.expand("200",true);for(T=1;T<200;++T){expect(E.isExpanded(""+T)).toBe(false)}expect(E.isExpanded("200")).toBe(true);var S=L.getNodes(),V=L.getRecord(S[S.length-1]);expect(V.id).toBe(400);waitsFor(function(){return L.el.dom.scrollTop>0});runs(function(){expect(L.el.dom.scrollTop).toBeGreaterThan(0)})})});describe("adding",function(){it("should be able to add a record to an empty grid",function(){J(false,{},0);M.add({name:"Foo",type:"test"});expect(L.getNode(0).getAttribute("data-recordindex")).toBe("0")})});describe("updating",function(){describe("the id",function(){it("should be able to modify the id of the first item in a group",function(){J();M.first().set("id",1000);K("t1");expect(E.isExpanded("t1")).toBe(false);K("t1");expect(E.isExpanded("t1")).toBe(true)})});it("should not cause an error when updating the first row of a group",function(){J();expect(function(){M.first().set("name","foo")}).not.toThrow()});it("should not cause an error when updating the first row of a group that has a column with preventUpdate: true",function(){J(false,{columns:[{dataIndex:"name",preventUpdate:true}]});expect(function(){M.first().set("name","foo")}).not.toThrow()})});describe("locking",function(){it("should not cause an exception when collapsing/expanding after unlocking the only locked column",function(){J(false,{columns:[{locked:true,itemId:"locked",dataIndex:"name"},{dataIndex:"name"}]});D.unlock(D.down("#locked"));expect(function(){K("t1");K("t1")}).not.toThrow()});it("should not throw an exception when focusing a view in which all groups are collapsed",function(){J(false,{columns:[{locked:true,itemId:"locked",dataIndex:"name"},{dataIndex:"name"}]},null,null,{startCollapsed:true});var S=D.normalGrid.getView();S.focus();expect(Ext.Element.getActiveElement()).toBe(S.el.dom)})});describe("reconfiguring",function(){function S(T){describe(T?"with locking":"without locking",function(){var W;beforeEach(function(){E=new Ext.grid.feature.Grouping();J(null,{enableLocking:T,columns:[],store:null});W=[{dataIndex:"name",locked:T},{dataIndex:"name"}];M=U()});function V(){return T?D.normalGrid.getView():D.getView()}function U(X){return new Ext.data.Store(Ext.apply({model:R,groupField:"type",data:[{type:"t1",name:"A"},{type:"t1",name:"B"},{type:"t2",name:"C"},{type:"t2",name:"D"}]},X))}it("should render the rows",function(){D.reconfigure(M,W);waitsFor(function(){return V().getNodes().length>0},"Rows never rendered");runs(function(){expect(V().getNodes().length).toBe(4)})});it("should render the group headers",function(){D.reconfigure(M,W);waitsFor(function(){return V().getNodes().length>0},"Rows never rendered");runs(function(){var Y=F("t1",V()),X=F("t2",V());expect(Y).not.toBeNull();expect(X).not.toBeNull()})});it("should react to click events",function(){D.reconfigure(M,W);waitsFor(function(){return V().getNodes().length>0},"Rows never rendered");runs(function(){K("t1",V());expect(V().getNodes().length).toBe(3)})});it("should not cause an error when using an autoDestroy store",function(){M.autoDestroy=true;expect(function(){D.reconfigure(M,W)}).not.toThrow()});it("should be able to reconfigure from grouped store -> not grouped store",function(){D.reconfigure(M,W);expect(function(){D.reconfigure(U({groupField:""}))}).not.toThrow()});it("should be able to reconfigure from not grouped store -> grouped store",function(){M.destroy();M=U({groupField:""});D.reconfigure(M,W);expect(function(){D.reconfigure(U())}).not.toThrow()})})}S(false);S(true)});if(B){describe("Selection",function(){it("should skip collapsed groups",function(){J();K("t1");K("t4");expect(D.view.all.getCount()).toBe(E.getGroup("t2").getRange().length+E.getGroup("t3").getRange().length+2);H("click",1,0);Q(1,0,"keydown",Ext.event.Event.END,true);expect(D.selModel.getSelection()[0]===D.store.getAt(99)).toBe(true);Q(1,0,"keydown",Ext.event.Event.HOME,true);expect(D.selModel.getSelection()[0]===D.store.getAt(0)).toBe(true);K("t2");K("t3");expect(D.view.all.getCount()).toBe(E.getGroup("t1").getRange().length+E.getGroup("t4").getRange().length+2);H("click",0,0);Q(1,0,"keydown",Ext.event.Event.END,true);expect(D.selModel.getSelection()[0]===D.store.getAt(99)).toBe(true);H("click",24,0);Q(24,0,"keydown",Ext.event.Event.DOWN);expect(D.selModel.getSelection()[0]===D.store.getAt(75)).toBe(true);Q(27,0,"keydown",Ext.event.Event.UP);expect(D.selModel.getSelection()[0]===D.store.getAt(24)).toBe(true)})});describe("grouping buffered stores",function(){it("should work",function(){var S;I({listeners:{load:function(){S=true}}});waitsFor(function(){return S},"for initial load");runs(function(){L.bufferedRenderer.scrollTo(25);expect(L.all.item(25).contains(L.getRow(25))).toBe(true);expect(L.all.item(25,true).firstChild.firstChild===L.getRow(35)).not.toBe(true);L.bufferedRenderer.scrollTo(100);expect(L.all.item(75).contains(L.getRow(75))).toBe(true);expect(L.all.item(75).down("tbody",true).firstChild===L.getRow(75)).not.toBe(true);S=false;E.disable()});waitsFor(function(){return S},"second load after group clear");runs(function(){expect(L.all.item(0,true).firstChild.firstChild===L.getRow(0)).toBe(true)})})});describe("Expand *and scrollTo* unrendered group",function(){it("should use the buffered renderer to scroll to unrendered group headers",function(){J(null,{leadingBufferZone:Ext.grid.plugin.BufferedRenderer.prototype.leadingBufferZone,trailingBufferZone:Ext.grid.plugin.BufferedRenderer.prototype.trailingBufferZone},500);E.collapse(M.getGroups().last().getGroupKey(),true)})})}})}A(false);A(true)})