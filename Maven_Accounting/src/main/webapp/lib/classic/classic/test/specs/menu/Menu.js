describe("Ext.menu.Menu",function(){var B=jasmine.pressArrowKey,A=jasmine.waitForFocus,E,D=Ext.isWebKit||Ext.isGecko?it:xit;function C(F){E=new Ext.menu.Menu(F||{});return E}afterEach(function(){if(E){E.hide();Ext.destroy(E);E=null}});describe("dockedItems",function(){it("should move body below docked title",function(){C({title:"Some Menu",items:[{text:"Hello"},{text:"World"}]});E.show();var G=E.body.getXY();var H=E.el.getXY();var J=E.dockedItems.items[0];var I=J.el.getHeight();var F=J.el.getXY();expect(G[1]).toBe(F[1]+I)})});describe("reference",function(){it("should have a reference when used as a config on a button",function(){Ext.ComponentManager.fixReferences();var F=new Ext.container.Container({renderTo:Ext.getBody(),referenceHolder:true,items:{xtype:"button",text:"Foo",menu:{reference:"menu",items:[{reference:"item"}]}}});E=F.items.getAt(0).getMenu();expect(F.lookupReference("menu")).toBe(E);expect(F.lookupReference("item")).toBe(E.items.getAt(0));F.destroy()});it("should have a reference when used as an instance on a button",function(){Ext.ComponentManager.fixReferences();C({reference:"menu",items:[{reference:"item"}]});var F=new Ext.container.Container({renderTo:Ext.getBody(),referenceHolder:true,items:{xtype:"button",text:"Foo",menu:E}});expect(F.lookupReference("menu")).toBe(E);expect(F.lookupReference("item")).toBe(E.items.getAt(0));F.destroy()})});describe("MenuManager hideAll",function(){it("should hide a single menu",function(){C({items:{text:"Foo"}});E.show();expect(E.isVisible()).toBe(true);Ext.menu.Manager.hideAll();expect(E.isVisible()).toBe(false)});it("should hide multiple menus",function(){var H=C({items:{text:"M1"},allowOtherMenus:true}),G=C({items:{text:"M2"},allowOtherMenus:true}),F=C({items:{text:"M3"},allowOtherMenus:true});H.show();G.show();F.show();expect(H.isVisible()).toBe(true);expect(G.isVisible()).toBe(true);expect(F.isVisible()).toBe(true);Ext.menu.Manager.hideAll();expect(H.isVisible()).toBe(false);expect(G.isVisible()).toBe(false);expect(F.isVisible()).toBe(false);Ext.destroy(H,G,F)});it("should hide a menu and submenus",function(){C({items:{text:"Foo",menu:{items:{text:"Bar"}}}});E.show();var F=E.items.first();F.activated=true;F.expandMenu(null,0);expect(E.isVisible()).toBe(true);expect(F.getMenu().isVisible()).toBe(true);Ext.menu.Manager.hideAll();expect(E.isVisible()).toBe(false);expect(F.getMenu().isVisible()).toBe(false)});it("should only hide menus visible at the time of being called",function(){var H=C({allowOtherMenus:true,items:{text:"Foo"}}),G=C({allowOtherMenus:true,items:{text:"Bar"}}),F=C({allowOtherMenus:true,items:{text:"Baz"}});H.show();G.show();H.on("hide",function(){F.show()});expect(H.isVisible()).toBe(true);expect(G.isVisible()).toBe(true);expect(F.isVisible()).toBe(false);Ext.menu.Manager.hideAll();expect(H.isVisible()).toBe(false);expect(G.isVisible()).toBe(false);expect(F.isVisible()).toBe(true);Ext.destroy(H,G,F)})});describe("moving menu",function(){describe("moving from button to menu item",function(){it("should be able to show the menu",function(){C({items:[{text:"Foo"}]});var G=new Ext.button.Button({renderTo:Ext.getBody(),text:"Foo",menu:E});G.showMenu();G.hideMenu();delete E.menuClickBuffer;var F=new Ext.menu.Menu({items:[{text:"Child",menuExpandDelay:0}]}),H;H=F.items.getAt(0);H.setMenu(E);F.show();jasmine.focusAndWait(H);runs(function(){H.activated=true;H.expandMenu(null,0);expect(E.isVisible()).toBe(true);Ext.destroy(F,G)})})});describe("moving from menu item to button",function(){it("should be able to show the menu",function(){C({menuClickBuffer:0,items:[{text:"Foo"}]});var G=new Ext.button.Button({renderTo:Ext.getBody(),text:"Foo"});var F=new Ext.menu.Menu({items:[{text:"Child",menuExpandDelay:0,menu:E}]}),H;H=F.items.getAt(0);F.show();jasmine.focusAndWait(H);runs(function(){H.activated=true;H.expandMenu(null,0);F.hide();G.setMenu(E);delete E.menuClickBuffer;G.showMenu();expect(E.isVisible()).toBe(true);Ext.destroy(F,G)})})})});describe("hiding all other menus",function(){var G,F;afterEach(function(){Ext.destroy(G,F);G=F=null});it("should hide all other menus on menu show",function(){G=C();F=C();G.show();expect(G.isVisible()).toBe(true);F.show();expect(G.isVisible()).toBe(false);expect(F.isVisible()).toBe(true)});it("should not hide all other menus on menu show when allowOtherMenus: true",function(){G=C({allowOtherMenus:true});F=C({allowOtherMenus:true});G.show();expect(G.isVisible()).toBe(true);F.show();expect(F.isVisible()).toBe(true);expect(F.isVisible()).toBe(true)});it("should not hide menus when they are a child of a direct menu item",function(){C({items:[{text:"Foo",menu:{items:[{text:"Bar"}]}}]});var H=E.items.getAt(0),I=H.getMenu();E.show();H.activated=true;H.expandMenu(null,0);expect(E.isVisible()).toBe(true);expect(I.isVisible()).toBe(true)});it("should not hide menus when they are nested as part of other components",function(){C({items:{xtype:"container",items:[{xtype:"button",text:"Child",menu:{items:[{text:"Foo"}]}}]}});E.show();var H=E.items.getAt(0).items.getAt(0),I=H.getMenu();H.showMenu();expect(E.isVisible()).toBe(true);expect(I.isVisible()).toBe(true)})});describe("hiding when doing an action outside the menu",function(){it("should hide the menu",function(){var F=new Ext.form.field.Text({renderTo:Ext.getBody()});C({items:[{text:"Foo"}]});E.show();jasmine.fireMouseEvent(F.inputEl,"mousedown");expect(E.isVisible()).toBe(false);F.destroy()});it("should hide the menu even if the event propagation is stopped",function(){var F=Ext.getBody().createChild({tag:"input"});F.on("mousedown",function(G){G.stopPropagation()});C({items:[{text:"Foo"}]});E.show();jasmine.fireMouseEvent(F,"mousedown");expect(E.isVisible()).toBe(false);F.destroy()});it("should hide all menus",function(){var H=new Ext.form.field.Text({renderTo:Ext.getBody()});var G=C({allowOtherMenus:true,items:[{text:"Foo"}]}),F=C({allowOtherMenus:true,items:[{text:"Bar"}]});G.showAt(100,100);F.showAt(100,150);jasmine.fireMouseEvent(H.inputEl,"mousedown");expect(G.isVisible()).toBe(false);expect(F.isVisible()).toBe(false);Ext.destroy(H,G,F)})});describe("binding an ownerRef",function(){var F;beforeEach(function(){F=new Ext.container.Container({renderTo:Ext.getBody()})});afterEach(function(){F.destroy();F=null});it("should bind an ownerCt reference to the menu if added as an item to a container (but not rendered)",function(){C();F.add(E);expect(E.ownerCt).toBe(F)});it("should bind an floatParent reference to the menu when shown/rendered",function(){C();F.add(E);E.show();expect(E.floatParent).toBe(F)});it("should not have an ownerRef if not a child item of a container",function(){C();E.show();expect(E.floatParent).toBeUndefined();expect(E.ownerCt).toBeUndefined()})});describe("not floating",function(){it("should set constrain false",function(){C({floating:false});expect(E.constrain).toBe(false)});it("should not hide onFocusLeave",function(){C({renderTo:document.body,floating:false,items:[{text:"Menu Item 1"}]});E.items.items[0].focus();waitsFor(function(){return E.containsFocus});runs(function(){E.items.items[0].blur()});waitsFor(function(){return !E.containsFocus});runs(function(){expect(E.isVisible()).toBe(true)})})});describe("popup menu",function(){it("should have a full-height vertical separator",function(){C({id:"popup-menu",items:[{text:"Short",id:"popup-menu-short-item"},{text:"Shrink wrap to my width, and stretch mysibling!",id:"popup-menu-long-item",style:"width:268px"}]});E.showAt(0,0);expect(E.body.child(".x-menu-icon-separator").getHeight()).toEqual(E.body.getHeight())});xit("should stretch the shortest item to match the longest",function(){C({id:"popup-menu",items:[{text:"Short",id:"popup-menu-short-item"},{text:"Shrink wrap to my width, and stretch mysibling!",id:"popup-menu-long-item",style:"width:268px"}]});E.showAt(0,0);expect(E).toHaveLayout({"el":{"xywh":"0 0 274 62"},"body":{"xywh":"0 0 274 62"},"iconSepEl":{"xywh":"0 0 2 60"},"items":{"popup-menu-short-item":{"el":{"xywh":"3 3 268 28"},"arrowEl":{"xywh":"62 22 1 1"},"textEl":{"xywh":"36 12 26 13"},"iconEl":{"xywh":"7 8 16 16"},"itemEl":{"xywh":"4 4 266 26"}},"popup-menu-long-item":{"el":{"xywh":"3 31 268 28"},"arrowEl":{"xywh":"267 50 1 1"},"textEl":{"xywh":"36 40 231 13"},"iconEl":{"xywh":"7 36 16 16"},"itemEl":{"xywh":"4 32 266 26"}}}})})});describe("registering with an owner",function(){describe("constrainTo",function(){describe("when owner is a button",function(){var F;beforeEach(function(){C({width:200,items:[{text:"foo"}]})});afterEach(function(){F.destroy();F=null});it("should not constrain itself to the button",function(){F=new Ext.button.Button({menu:E,renderTo:Ext.getBody()});F.showMenu();expect(F.menu.constrainTo).toBeUndefined()})})})});(Ext.isIE?xdescribe:describe)("navigation",function(){var G="#foo",F;beforeEach(function(){F=jasmine.createSpy();Ext.getWin().on("hashchange",F);location.hash=G;waitsFor(function(){return F.callCount===1})});afterEach(function(){var H=F.callCount;location.hash="";waitsFor(function(){return F.callCount===(H+1)});runs(function(){Ext.getWin().un("hashchange",F)})});it("should navigate when a child item has an href config",function(){C({renderTo:Ext.getBody(),width:400,floating:false,items:[{text:"item with href",href:"#blah"}]});jasmine.fireMouseEvent(E.items.getAt(0).itemEl.dom,"click");waitsFor(function(){return F.callCount===2});runs(function(){expect(location.hash).toBe("#blah")})});it("should not navigate when a child item does not have an href config",function(){C({renderTo:Ext.getBody(),width:400,floating:false,items:[{text:"item with no href"}]});jasmine.fireMouseEvent(E.items.getAt(0).itemEl.dom,"click");waits(100);runs(function(){expect(F.callCount).toBe(1)})})});describe("ARIA attributes",function(){function G(H,I){jasmine.expectAriaAttr(E,H,I)}function F(H){jasmine.expectNoAriaAttr(E,H)}describe("floating",function(){beforeEach(function(){C();E.show();E.hide()});describe("aria-expanded",function(){it("should be false when hidden",function(){G("aria-expanded","false")});it("should be true after showing",function(){E.show();G("aria-expanded","true")})})});describe("non-floating",function(){beforeEach(function(){C({floating:false,renderTo:Ext.getBody()})});it("should not have aria-expanded attribute",function(){F("aria-expanded")})})});describe("focus anchor",function(){var J=jasmine.focusAndWait,G=jasmine.expectFocused,L=jasmine.simulateTabKey,K,I,H;function F(Q,O){var P,N;P=E;for(var M=1;M<=Q;M++){N=P.down('[text="submenu '+M+'"]');if(N&&N.menu){P=N.menu;N.focus();N.expandMenu(null,0)}}if(P&&O){H=P.down('[text="'+O+'"]')}if(H){H.focus()}return H}beforeEach(function(){K=new Ext.button.Button({renderTo:Ext.getBody(),text:"foo"});I=new Ext.button.Button({renderTo:Ext.getBody(),text:"bar"});C({defaults:{hideOnClick:false},items:[{text:"item 1"},{text:"item 2",},{text:"submenu 1",menu:[{text:"item 1"},{text:"item 2"},{text:"submenu 2",menu:[{text:"item 1"},{text:"should be enough"}]}]}]});J(K);runs(function(){E.show()})});afterEach(function(){Ext.destroy(K,I);K=I=H=null});it("should capture focus anchor when opening",function(){expect(E.focusAnchor).toBe(K.el.dom)});it("should tab from 1st level menu to bar",function(){F(0,"item 1");L(H,true);G(I)});it("should shift-tab from 1st level menu to foo",function(){E.focusAnchor=I.el.dom;F(0,"item 2");L(H,false);G(K)});it("should tab from 2nd level menu to bar",function(){F(1,"item 1");L(H,true);G(I)});it("should tab from 3rd level menu to bar",function(){F(2,"should be enough");L(H,true);G(I)})});describe("cleanup",function(){var F=Ext.menu.Manager;beforeEach(function(){C();E.show()});it("should be removed from visible array when hiding",function(){E.hide();var G=Ext.Array.contains(F.visible,E);expect(G).toBe(false)});it("should be removed from visible array after destroying",function(){E.destroy();var G=Ext.Array.contains(F.visible,E);expect(G).toBe(false)})});describe("hide on click",function(){var H,I,N,L,G,K,F,J,M;beforeEach(function(){H=new Ext.window.Window({renderTo:Ext.getBody(),width:300,tbar:[I=new Ext.button.Button({xtype:"button",text:"Foo",menu:N=new Ext.menu.Menu({onBeforeShow:function(){return true},items:L=new Ext.menu.Item({text:"Top menu item",menu:G=new Ext.menu.Menu({items:K=new Ext.menu.Item({text:"Second level menu item",menu:F=new Ext.menu.Menu({items:J=new Ext.menu.Item({text:"Third level menu",handler:function(){M=true}})})})})})})})]});H.show()});afterEach(function(){H.destroy()});D("should hide on click, and on reshow of parent, should not show again",function(){I.el.focus();waitsFor(function(){return I.hasFocus},"button to recieve focus");runs(function(){jasmine.fireMouseEvent(I.el,"click");jasmine.fireKeyEvent(I.el,"keydown",Ext.event.Event.DOWN)});waitsFor(function(){return N.isVisible()&&L.hasFocus},"topMenuItem to recieve focus");runs(function(){jasmine.fireKeyEvent(L.el,"keydown",Ext.event.Event.RIGHT)});waitsFor(function(){return G.isVisible()&&K.hasFocus},"menu2Item to recieve focus");runs(function(){jasmine.fireKeyEvent(K.el,"keydown",Ext.event.Event.RIGHT)});waitsFor(function(){return F.isVisible&&J.hasFocus},"menu3Item to recieve focus");runs(function(){expect(N.isVisible()).toBe(true);expect(G.isVisible()).toBe(true);expect(F.isVisible()).toBe(true);jasmine.fireMouseEvent(J.el,"click")});waitsFor(function(){return M===true&&!N.isVisible()&&!G.isVisible()&&!F.isVisible()&&I.hasFocus},"all menus to hide");runs(function(){jasmine.fireMouseEvent(I.el,"click")});waitsFor(function(){return N.isVisible()},"topMenu to show for the second time");runs(function(){expect(G.isVisible()).toBe(false);expect(F.isVisible()).toBe(false)})})});describe("keyboard interaction",function(){var H,G,F;beforeEach(function(){C({items:[{text:"item"},{text:"submenu",menu:[{text:"subitem"}]}]});H=E.down("[text=item]");G=E.down("[text=submenu]");F=G.menu.down("[text=subitem]")});afterEach(function(){H=G=F=null});describe("preventing parent scroll",function(){var J,K,I,L;beforeEach(function(){J=spyOn(E,"onFocusableContainerUpKey").andCallThrough();K=spyOn(E,"onFocusableContainerDownKey").andCallThrough();I=spyOn(E,"onFocusableContainerRightKey").andCallThrough();E.show()});afterEach(function(){J=K=I=L=null});it("should preventDefault on the Up arrow key",function(){B(G,"up");A(H);runs(function(){expect(J.mostRecentCall.args[0].defaultPrevented).toBe(true)})});it("should preventDefault on the Down arrow key",function(){B(H,"down");A(G);runs(function(){expect(K.mostRecentCall.args[0].defaultPrevented).toBe(true)})});it("should preventDefault on the Right key",function(){B(G,"right");runs(function(){A(F)});runs(function(){expect(I.mostRecentCall.args[0].defaultPrevented).toBe(true)})});it("should preventDefault on the Left key",function(){runs(function(){L=spyOn(G.menu,"onFocusableContainerLeftKey").andCallThrough();G.activated=true;G.expandMenu(null,0);B(F,"left")});A(G);runs(function(){expect(L.mostRecentCall.args[0].defaultPrevented).toBe(true)})})})})})