Ext.define("Ext.draw.Surface",{extend:"Ext.draw.SurfaceBase",xtype:"surface",requires:["Ext.draw.sprite.*","Ext.draw.gradient.*","Ext.draw.sprite.AttributeDefinition","Ext.draw.Matrix","Ext.draw.Draw"],uses:["Ext.draw.engine.Canvas"],devicePixelRatio:window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI,deprecated:{"5.1.0":{statics:{methods:{stableSort:function(A){return Ext.Array.sort(A,function(C,B){return C.attr.zIndex-B.attr.zIndex})}}}}},config:{cls:Ext.baseCSSPrefix+"surface",rect:null,background:null,items:[],dirty:false,flipRtlText:false},isSurface:true,isPendingRenderFrame:false,dirtyPredecessorCount:0,constructor:function(A){var B=this;B.predecessors=[];B.successors=[];B.map={};B.callParent([A]);B.matrix=new Ext.draw.Matrix();B.inverseMatrix=B.matrix.inverse()},roundPixel:function(A){return Math.round(this.devicePixelRatio*A)/this.devicePixelRatio},waitFor:function(A){var B=this,C=B.predecessors;if(!Ext.Array.contains(C,A)){C.push(A);A.successors.push(B);if(A.getDirty()){B.dirtyPredecessorCount++}}},updateDirty:function(D){var C=this.successors,E=C.length,B=0,A;for(;B<E;B++){A=C[B];if(D){A.dirtyPredecessorCount++;A.setDirty(true)}else{A.dirtyPredecessorCount--;if(A.dirtyPredecessorCount===0&&A.isPendingRenderFrame){A.renderFrame()}}}},applyBackground:function(A,B){this.setDirty(true);if(Ext.isString(A)){A={fillStyle:A}}return Ext.factory(A,Ext.draw.sprite.Rect,B)},applyRect:function(A,B){if(B&&A[0]===B[0]&&A[1]===B[1]&&A[2]===B[2]&&A[3]===B[3]){return }if(Ext.isArray(A)){return[A[0],A[1],A[2],A[3]]}else{if(Ext.isObject(A)){return[A.x||A.left,A.y||A.top,A.width||(A.right-A.left),A.height||(A.bottom-A.top)]}}},updateRect:function(H){var G=this,B=H[0],E=H[1],F=B+H[2],A=E+H[3],D=G.getBackground(),C=G.element;C.setLocalXY(Math.floor(B),Math.floor(E));C.setSize(Math.ceil(F-Math.floor(B)),Math.ceil(A-Math.floor(E)));if(D){D.setAttributes({x:0,y:0,width:Math.ceil(F-Math.floor(B)),height:Math.ceil(A-Math.floor(E))})}G.setDirty(true)},resetTransform:function(){this.matrix.set(1,0,0,1,0,0);this.inverseMatrix.set(1,0,0,1,0,0);this.setDirty(true)},get:function(A){return this.map[A]||this.getItems()[A]},add:function(){var G=this,E=Array.prototype.slice.call(arguments),I=Ext.isArray(E[0]),A=G.map,C=[],F,J,H,B,D;F=Ext.Array.clean(I?E[0]:E);if(!F.length){return C}for(B=0,D=F.length;B<D;B++){J=F[B];H=null;if(J.isSprite&&!A[J.getId()]){H=J}else{if(!A[J.id]){H=this.createItem(J)}}if(H){A[H.getId()]=H;C.push(H);H.setParent(G);H.setSurface(G);G.onAdd(H)}}F=G.getItems();if(F){F.push.apply(F,C)}G.dirtyZIndex=true;G.setDirty(true);if(!I&&C.length===1){return C[0]}else{return C}},onAdd:Ext.emptyFn,remove:function(A,C){var B=this,E,D;if(A){if(A.charAt){A=B.map[A]}if(!A||!A.isSprite){return null}if(A.isDestroyed||A.isDestroying){return A}E=A.getId();D=B.map[E];delete B.map[E];if(C){A.destroy()}if(!D){return A}A.setParent(null);A.setSurface(null);Ext.Array.remove(B.getItems(),A);B.dirtyZIndex=true;B.setDirty(true)}return A||null},removeAll:function(D){var A=this.getItems(),B=A.length-1,C;if(D){for(;B>=0;B--){A[B].destroy()}}else{for(;B>=0;B--){C=A[B];C.setParent(null);C.setSurface(null)}}A.length=0;this.map={};this.dirtyZIndex=true},applyItems:function(A){if(this.getItems()){this.removeAll(true)}return Ext.Array.from(this.add(A))},createItem:function(A){return Ext.create(A.xclass||"sprite."+A.type,A)},getBBox:function(F,B){var F=Ext.Array.from(F),C=Infinity,H=-Infinity,G=Infinity,A=-Infinity,I,J,D,E;for(D=0,E=F.length;D<E;D++){I=F[D];J=I.getBBox(B);if(C>J.x){C=J.x}if(H<J.x+J.width){H=J.x+J.width}if(G>J.y){G=J.y}if(A<J.y+J.height){A=J.y+J.height}}return{x:C,y:G,width:H-C,height:A-G}},emptyRect:[0,0,0,0],getEventXY:function(D){var F=this,E=F.getInherited().rtl,C=D.getXY(),A=F.getOwnerBody(),H=A.getXY(),G=F.getRect()||F.emptyRect,I=[],B;if(E){B=A.getWidth();I[0]=H[0]-C[0]-G[0]+B}else{I[0]=C[0]-H[0]-G[0]}I[1]=C[1]-H[1]-G[1];return I},clear:Ext.emptyFn,orderByZIndex:function(){var D=this,A=D.getItems(),E=false,B,C;if(D.getDirty()){for(B=0,C=A.length;B<C;B++){if(A[B].attr.dirtyZIndex){E=true;break}}if(E){Ext.Array.sort(A,function(G,F){return G.attr.zIndex-F.attr.zIndex});this.setDirty(true)}for(B=0,C=A.length;B<C;B++){A[B].attr.dirtyZIndex=false}}},repaint:function(){var A=this;A.repaint=Ext.emptyFn;Ext.defer(function(){delete A.repaint;A.element.repaint()},1)},renderFrame:function(){var G=this;if(!G.element){return }if(G.dirtyPredecessorCount>0){G.isPendingRenderFrame=true;return }var F=G.getRect(),C=G.getBackground(),A=G.getItems(),E,B,D;if(!F){return }G.orderByZIndex();if(G.getDirty()){G.clear();G.clearTransform();if(C){G.renderSprite(C)}for(B=0,D=A.length;B<D;B++){E=A[B];if(G.renderSprite(E)===false){return }E.attr.textPositionCount=G.textPosition}G.setDirty(false)}},renderSprite:Ext.emptyFn,clearTransform:Ext.emptyFn,destroy:function(){var A=this;A.removeAll(true);A.predecessors=null;A.successors=null;A.callParent()}})