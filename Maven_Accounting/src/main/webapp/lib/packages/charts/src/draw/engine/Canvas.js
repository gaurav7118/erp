Ext.define("Ext.draw.engine.Canvas",{extend:"Ext.draw.Surface",requires:["Ext.draw.engine.excanvas","Ext.draw.Animator","Ext.draw.Color"],config:{highPrecision:false},statics:{contextOverrides:{setGradientBBox:function(A){this.bbox=A},fill:function(){var C=this.fillStyle,A=this.fillGradient,B=this.fillOpacity,D=this.globalAlpha,E=this.bbox;if(C!==Ext.draw.Color.RGBA_NONE&&B!==0){if(A&&E){this.fillStyle=A.generateGradient(this,E)}if(B!==1){this.globalAlpha=D*B}this.$fill();if(B!==1){this.globalAlpha=D}if(A&&E){this.fillStyle=C}}},stroke:function(){var E=this.strokeStyle,C=this.strokeGradient,A=this.strokeOpacity,B=this.globalAlpha,D=this.bbox;if(E!==Ext.draw.Color.RGBA_NONE&&A!==0){if(C&&D){this.strokeStyle=C.generateGradient(this,D)}if(A!==1){this.globalAlpha=B*A}this.$stroke();if(A!==1){this.globalAlpha=B}if(C&&D){this.strokeStyle=E}}},fillStroke:function(D,E){var J=this,I=this.fillStyle,H=this.fillOpacity,F=this.strokeStyle,C=this.strokeOpacity,B=J.shadowColor,A=J.shadowBlur,G=Ext.draw.Color.RGBA_NONE;if(E===undefined){E=D.transformFillStroke}if(!E){D.inverseMatrix.toContext(J)}if(I!==G&&H!==0){J.fill();J.shadowColor=G;J.shadowBlur=0}if(F!==G&&C!==0){J.stroke()}J.shadowColor=B;J.shadowBlur=A},setLineDash:function(A){if(this.$setLineDash){this.$setLineDash(A)}},getLineDash:function(){if(this.$getLineDash){return this.$getLineDash()}},ellipse:function(G,E,C,A,J,B,F,D){var I=Math.cos(J),H=Math.sin(J);this.transform(I*C,H*C,-H*A,I*A,G,E);this.arc(0,0,1,B,F,D);this.transform(I/C,-H/A,H/C,I/A,-(I*G+H*E)/C,(H*G-I*E)/A)},appendPath:function(F){var E=this,C=0,B=0,A=F.commands,G=F.params,D=A.length;E.beginPath();for(;C<D;C++){switch(A[C]){case"M":E.moveTo(G[B],G[B+1]);B+=2;break;case"L":E.lineTo(G[B],G[B+1]);B+=2;break;case"C":E.bezierCurveTo(G[B],G[B+1],G[B+2],G[B+3],G[B+4],G[B+5]);B+=6;break;case"Z":E.closePath();break}}},save:function(){var C=this.toSave,D=C.length,E=D&&{},B=0,A;for(;B<D;B++){A=C[B];if(A in this){E[A]=this[A]}}this.state.push(E);this.$save()},restore:function(){var B=this.state.pop(),A;if(B){for(A in B){this[A]=B[A]}}this.$restore()}}},splitThreshold:3000,toSave:["fillGradient","strokeGradient"],element:{reference:"element",style:{position:"absolute"},children:[{reference:"innerElement",style:{width:"100%",height:"100%",position:"relative"}}]},createCanvas:function(){var C=Ext.Element.create({tag:"canvas",cls:Ext.baseCSSPrefix+"surface-canvas"});window["G_vmlCanvasManager"]&&G_vmlCanvasManager.initElement(C.dom);var D=Ext.draw.engine.Canvas.contextOverrides,A=C.dom.getContext("2d"),B;if(A.ellipse){delete D.ellipse}A.state=[];A.toSave=this.toSave;for(B in D){A["$"+B]=A[B]}Ext.apply(A,D);if(this.getHighPrecision()){this.enablePrecisionCompensation(A)}else{this.disablePrecisionCompensation(A)}this.innerElement.appendChild(C);this.canvases.push(C);this.contexts.push(A)},updateHighPrecision:function(D){var E=this.contexts,C=E.length,B,A;for(B=0;B<C;B++){A=E[B];if(D){this.enablePrecisionCompensation(A)}else{this.disablePrecisionCompensation(A)}}},precisionNames:["rect","fillRect","strokeRect","clearRect","moveTo","lineTo","arc","arcTo","save","restore","updatePrecisionCompensate","setTransform","transform","scale","translate","rotate","quadraticCurveTo","bezierCurveTo","createLinearGradient","createRadialGradient","fillText","strokeText","drawImage"],disablePrecisionCompensation:function(B){var A=Ext.draw.engine.Canvas.contextOverrides,F=this.precisionNames,E=F.length,D,C;for(D=0;D<E;D++){C=F[D];if(!(C in A)){delete B[C]}}this.setDirty(true)},enablePrecisionCompensation:function(J){var C=this,A=1,G=1,L=0,K=0,I=new Ext.draw.Matrix(),B=[],E={},D=Ext.draw.engine.Canvas.contextOverrides,H=J.constructor.prototype;var F={toSave:C.toSave,rect:function(M,P,N,O){return H.rect.call(this,M*A+L,P*G+K,N*A,O*G)},fillRect:function(M,P,N,O){this.updatePrecisionCompensateRect();H.fillRect.call(this,M*A+L,P*G+K,N*A,O*G);this.updatePrecisionCompensate()},strokeRect:function(M,P,N,O){this.updatePrecisionCompensateRect();H.strokeRect.call(this,M*A+L,P*G+K,N*A,O*G);this.updatePrecisionCompensate()},clearRect:function(M,P,N,O){return H.clearRect.call(this,M*A+L,P*G+K,N*A,O*G)},moveTo:function(M,N){return H.moveTo.call(this,M*A+L,N*G+K)},lineTo:function(M,N){return H.lineTo.call(this,M*A+L,N*G+K)},arc:function(N,R,M,P,O,Q){this.updatePrecisionCompensateRect();H.arc.call(this,N*A+L,R*A+K,M*A,P,O,Q);this.updatePrecisionCompensate()},arcTo:function(O,Q,N,P,M){this.updatePrecisionCompensateRect();H.arcTo.call(this,O*A+L,Q*G+K,N*A+L,P*G+K,M*A);this.updatePrecisionCompensate()},save:function(){B.push(I);I=I.clone();D.save.call(this);H.save.call(this)},restore:function(){I=B.pop();D.restore.call(this);H.restore.call(this);this.updatePrecisionCompensate()},updatePrecisionCompensate:function(){I.precisionCompensate(C.devicePixelRatio,E);A=E.xx;G=E.yy;L=E.dx;K=E.dy;H.setTransform.call(this,C.devicePixelRatio,E.b,E.c,E.d,0,0)},updatePrecisionCompensateRect:function(){I.precisionCompensateRect(C.devicePixelRatio,E);A=E.xx;G=E.yy;L=E.dx;K=E.dy;H.setTransform.call(this,C.devicePixelRatio,E.b,E.c,E.d,0,0)},setTransform:function(Q,O,N,M,R,P){I.set(Q,O,N,M,R,P);this.updatePrecisionCompensate()},transform:function(Q,O,N,M,R,P){I.append(Q,O,N,M,R,P);this.updatePrecisionCompensate()},scale:function(N,M){this.transform(N,0,0,M,0,0)},translate:function(N,M){this.transform(1,0,0,1,N,M)},rotate:function(O){var N=Math.cos(O),M=Math.sin(O);this.transform(N,M,-M,N,0,0)},quadraticCurveTo:function(N,P,M,O){H.quadraticCurveTo.call(this,N*A+L,P*G+K,M*A+L,O*G+K)},bezierCurveTo:function(R,P,O,N,M,Q){H.bezierCurveTo.call(this,R*A+L,P*G+K,O*A+L,N*G+K,M*A+L,Q*G+K)},createLinearGradient:function(N,P,M,O){this.updatePrecisionCompensateRect();var Q=H.createLinearGradient.call(this,N*A+L,P*G+K,M*A+L,O*G+K);this.updatePrecisionCompensate();return Q},createRadialGradient:function(P,R,O,N,Q,M){this.updatePrecisionCompensateRect();var S=H.createLinearGradient.call(this,P*A+L,R*A+K,O*A,N*A+L,Q*A+K,M*A);this.updatePrecisionCompensate();return S},fillText:function(O,M,P,N){H.setTransform.apply(this,I.elements);if(typeof N==="undefined"){H.fillText.call(this,O,M,P)}else{H.fillText.call(this,O,M,P,N)}this.updatePrecisionCompensate()},strokeText:function(O,M,P,N){H.setTransform.apply(this,I.elements);if(typeof N==="undefined"){H.strokeText.call(this,O,M,P)}else{H.strokeText.call(this,O,M,P,N)}this.updatePrecisionCompensate()},fill:function(){var M=this.fillGradient,N=this.bbox;this.updatePrecisionCompensateRect();if(M&&N){this.fillStyle=M.generateGradient(this,N)}H.fill.call(this);this.updatePrecisionCompensate()},stroke:function(){var M=this.strokeGradient,N=this.bbox;this.updatePrecisionCompensateRect();if(M&&N){this.strokeStyle=M.generateGradient(this,N)}H.stroke.call(this);this.updatePrecisionCompensate()},drawImage:function(U,S,R,Q,P,O,N,M,T){switch(arguments.length){case 3:return H.drawImage.call(this,U,S*A+L,R*G+K);case 5:return H.drawImage.call(this,U,S*A+L,R*G+K,Q*A,P*G);case 9:return H.drawImage.call(this,U,S,R,Q,P,O*A+L,N*G*K,M*A,T*G)}}};Ext.apply(J,F);this.setDirty(true)},updateRect:function(A){this.callParent([A]);var T=this,J=Math.floor(A[0]),D=Math.floor(A[1]),F=Math.ceil(A[0]+A[2]),S=Math.ceil(A[1]+A[3]),M=T.devicePixelRatio,U=T.canvases,C=F-J,P=S-D,H=Math.round(T.splitThreshold/M),B=T.xSplits=Math.ceil(C/H),E=T.ySplits=Math.ceil(P/H),N,L,K,R,Q,O,I,G;for(L=0,Q=0;L<E;L++,Q+=H){for(N=0,R=0;N<B;N++,R+=H){K=L*B+N;if(K>=U.length){T.createCanvas()}O=U[K].dom;O.style.left=R+"px";O.style.top=Q+"px";G=Math.min(H,P-Q);if(G*M!==O.height){O.height=G*M;O.style.height=G+"px"}I=Math.min(H,C-R);if(I*M!==O.width){O.width=I*M;O.style.width=I+"px"}T.applyDefaults(T.contexts[K])}}for(K+=1;K<U.length;K++){U[K].destroy()}T.activeCanvases=B*E;U.length=T.activeCanvases;T.clear()},clearTransform:function(){var F=this,A=F.xSplits,G=F.ySplits,D=F.contexts,H=F.splitThreshold,I=F.devicePixelRatio,E,C,B,J;for(E=0;E<A;E++){for(C=0;C<G;C++){B=C*A+E;J=D[B];J.translate(-H*E,-H*C);J.scale(I,I);F.matrix.toContext(J)}}},renderSprite:function(M){var X=this,B=X.getRect(),E=X.matrix,G=M.getParent(),R=Ext.draw.Matrix.fly([1,0,0,1,0,0]),L=X.splitThreshold/X.devicePixelRatio,C=X.xSplits,I=X.ySplits,V,U,O,A,N,K,D=0,W,J=0,F,H=B[2],T=B[3],S,Q,P;while(G&&(G!==X)){R.prependMatrix(G.matrix||G.attr&&G.attr.matrix);G=G.getParent()}R.prependMatrix(E);A=M.getBBox();if(A){A=R.transformBBox(A)}M.preRender(X);if(M.attr.hidden||M.attr.globalAlpha===0){M.setDirty(false);return }for(Q=0,U=0;Q<I;Q++,U+=L){for(S=0,V=0;S<C;S++,V+=L){P=Q*C+S;O=X.contexts[P];N=Math.min(L,H-V);K=Math.min(L,T-U);D=V;W=D+N;J=U;F=J+K;if(A){if(A.x>W||A.x+A.width<D||A.y>F||A.y+A.height<J){continue}}O.save();M.useAttributes(O,B);if(false===M.render(X,O,[D,J,N,K],B)){return false}O.restore()}}M.setDirty(false)},flatten:function(L,A){var I=document.createElement("canvas"),F=Ext.getClassName(this),G=this.devicePixelRatio,J=I.getContext("2d"),B,C,H,E,D,K;I.width=Math.ceil(L.width*G);I.height=Math.ceil(L.height*G);for(E=0;E<A.length;E++){B=A[E];if(Ext.getClassName(B)!==F){continue}H=B.getRect();for(D=0;D<B.canvases.length;D++){C=B.canvases[D];K=C.getOffsetsTo(C.getParent());J.drawImage(C.dom,(H[0]+K[0])*G,(H[1]+K[1])*G)}}return{data:I.toDataURL(),type:"png"}},applyDefaults:function(A){var B=Ext.draw.Color.RGBA_NONE;A.strokeStyle=B;A.fillStyle=B;A.textAlign="start";A.textBaseline="alphabetic";A.miterLimit=1},clear:function(){var D=this,E=D.activeCanvases,C,B,A;for(C=0;C<E;C++){B=D.canvases[C].dom;A=D.contexts[C];A.setTransform(1,0,0,1,0,0);A.clearRect(0,0,B.width,B.height)}D.setDirty(true)},destroy:function(){var C=this,A,B=C.canvases.length;for(A=0;A<B;A++){C.contexts[A]=null;C.canvases[A].destroy();C.canvases[A]=null}delete C.contexts;delete C.canvases;C.callParent()},privates:{initElement:function(){var A=this;A.callParent();A.canvases=[];A.contexts=[];A.activeCanvases=(A.xSplits=0)*(A.ySplits=0)}}},function(){var C=this,B=C.prototype,A=10000000000;if(Ext.os.is.Android4&&Ext.browser.is.Chrome){A=3000}else{if(Ext.is.iOS){A=2200}}B.splitThreshold=A})