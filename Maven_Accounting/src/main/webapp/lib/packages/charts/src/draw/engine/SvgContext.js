Ext.define("Ext.draw.engine.SvgContext",{requires:["Ext.draw.Color"],toSave:["strokeOpacity","strokeStyle","fillOpacity","fillStyle","globalAlpha","lineWidth","lineCap","lineJoin","lineDash","lineDashOffset","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","globalCompositeOperation","position","fillGradient","strokeGradient"],"strokeOpacity":1,"strokeStyle":"none","fillOpacity":1,"fillStyle":"none","lineDash":[],"lineDashOffset":0,"globalAlpha":1,"lineWidth":1,"lineCap":"butt","lineJoin":"miter","miterLimit":10,"shadowOffsetX":0,"shadowOffsetY":0,"shadowBlur":0,"shadowColor":"none","globalCompositeOperation":"src",urlStringRe:/^url\(#([\w\-]+)\)$/,constructor:function(A){this.surface=A;this.state=[];this.matrix=new Ext.draw.Matrix();this.path=null;this.clear()},clear:function(){this.group=this.surface.mainGroup;this.position=0;this.path=null},getElement:function(A){return this.surface.getSvgElement(this.group,A,this.position++)},removeElement:function(D){var D=Ext.fly(D),H,G,B,F,A,E,C;if(!D){return }if(D.dom.tagName==="g"){A=D.dom.gradients;for(C in A){A[C].destroy()}}else{H=D.getAttribute("fill");G=D.getAttribute("stroke");B=H&&H.match(this.urlStringRe);F=G&&G.match(this.urlStringRe);if(B&&B[1]){E=Ext.fly(B[1]);if(E){E.destroy()}}if(F&&F[1]){E=Ext.fly(F[1]);if(E){E.destroy()}}}D.destroy()},save:function(){var C=this.toSave,E={},D=this.getElement("g"),B,A;for(A=0;A<C.length;A++){B=C[A];if(B in this){E[B]=this[B]}}this.position=0;E.matrix=this.matrix.clone();this.state.push(E);this.group=D;return D},restore:function(){var D=this.toSave,E=this.state.pop(),C=this.group.dom.childNodes,B,A;while(C.length>this.position){this.removeElement(C[C.length-1])}for(A=0;A<D.length;A++){B=D[A];if(B in E){this[B]=E[B]}else{delete this[B]}}this.setTransform.apply(this,E.matrix.elements);this.group=this.group.getParent()},transform:function(F,B,E,G,D,C){if(this.path){var A=Ext.draw.Matrix.fly([F,B,E,G,D,C]).inverse();this.path.transform(A)}this.matrix.append(F,B,E,G,D,C)},setTransform:function(E,A,D,F,C,B){if(this.path){this.path.transform(this.matrix)}this.matrix.reset();this.transform(E,A,D,F,C,B)},scale:function(A,B){this.transform(A,0,0,B,0,0)},rotate:function(D){var C=Math.cos(D),A=Math.sin(D),B=-Math.sin(D),E=Math.cos(D);this.transform(C,A,B,E,0,0)},translate:function(A,B){this.transform(1,0,0,1,A,B)},setGradientBBox:function(A){this.bbox=A},beginPath:function(){this.path=new Ext.draw.Path()},moveTo:function(A,B){if(!this.path){this.beginPath()}this.path.moveTo(A,B);this.path.element=null},lineTo:function(A,B){if(!this.path){this.beginPath()}this.path.lineTo(A,B);this.path.element=null},rect:function(B,D,C,A){this.moveTo(B,D);this.lineTo(B+C,D);this.lineTo(B+C,D+A);this.lineTo(B,D+A);this.closePath()},strokeRect:function(B,D,C,A){this.beginPath();this.rect(B,D,C,A);this.stroke()},fillRect:function(B,D,C,A){this.beginPath();this.rect(B,D,C,A);this.fill()},closePath:function(){if(!this.path){this.beginPath()}this.path.closePath();this.path.element=null},arcSvg:function(D,A,F,G,C,B,E){if(!this.path){this.beginPath()}this.path.arcSvg(D,A,F,G,C,B,E);this.path.element=null},arc:function(B,F,A,D,C,E){if(!this.path){this.beginPath()}this.path.arc(B,F,A,D,C,E);this.path.element=null},ellipse:function(A,H,G,F,D,C,B,E){if(!this.path){this.beginPath()}this.path.ellipse(A,H,G,F,D,C,B,E);this.path.element=null},arcTo:function(B,E,A,D,G,F,C){if(!this.path){this.beginPath()}this.path.arcTo(B,E,A,D,G,F,C);this.path.element=null},bezierCurveTo:function(D,F,B,E,A,C){if(!this.path){this.beginPath()}this.path.bezierCurveTo(D,F,B,E,A,C);this.path.element=null},strokeText:function(D,A,E){D=String(D);if(this.strokeStyle){var B=this.getElement("text"),C=this.surface.getSvgElement(B,"tspan",0);this.surface.setElementAttributes(B,{"x":A,"y":E,"transform":this.matrix.toSvg(),"stroke":this.strokeStyle,"fill":"none","opacity":this.globalAlpha,"stroke-opacity":this.strokeOpacity,"style":"font: "+this.font,"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset});if(this.lineDash.length){this.surface.setElementAttributes(B,{"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset})}if(C.dom.firstChild){C.dom.removeChild(C.dom.firstChild)}this.surface.setElementAttributes(C,{"alignment-baseline":"alphabetic"});C.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(D)))}},fillText:function(D,A,E){D=String(D);if(this.fillStyle){var B=this.getElement("text"),C=this.surface.getSvgElement(B,"tspan",0);this.surface.setElementAttributes(B,{"x":A,"y":E,"transform":this.matrix.toSvg(),"fill":this.fillStyle,"opacity":this.globalAlpha,"fill-opacity":this.fillOpacity,"style":"font: "+this.font});if(C.dom.firstChild){C.dom.removeChild(C.dom.firstChild)}this.surface.setElementAttributes(C,{"alignment-baseline":"alphabetic"});C.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(D)))}},drawImage:function(C,K,I,L,E,P,N,A,G){var F=this,D=F.getElement("image"),J=K,H=I,B=typeof L==="undefined"?C.width:L,M=typeof E==="undefined"?C.height:E,O=null;if(typeof G!=="undefined"){O=K+" "+I+" "+L+" "+E;J=P;H=N;B=A;M=G}D.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",C.src);F.surface.setElementAttributes(D,{viewBox:O,x:J,y:H,width:B,height:M,opacity:F.globalAlpha,transform:F.matrix.toSvg()})},fill:function(){if(!this.path){return }if(this.fillStyle){var C,A=this.fillGradient,D=this.bbox,B=this.path.element;if(!B){C=this.path.toString();B=this.path.element=this.getElement("path");this.surface.setElementAttributes(B,{"d":C,"transform":this.matrix.toSvg()})}this.surface.setElementAttributes(B,{"fill":A&&D?A.generateGradient(this,D):this.fillStyle,"fill-opacity":this.fillOpacity*this.globalAlpha})}},stroke:function(){if(!this.path){return }if(this.strokeStyle){var C,B=this.strokeGradient,D=this.bbox,A=this.path.element;if(!A||!this.path.svgString){C=this.path.toString();if(!C){return }A=this.path.element=this.getElement("path");this.surface.setElementAttributes(A,{"fill":"none","d":C,"transform":this.matrix.toSvg()})}this.surface.setElementAttributes(A,{"stroke":B&&D?B.generateGradient(this,D):this.strokeStyle,"stroke-linecap":this.lineCap,"stroke-linejoin":this.lineJoin,"stroke-width":this.lineWidth,"stroke-opacity":this.strokeOpacity*this.globalAlpha,"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset});if(this.lineDash.length){this.surface.setElementAttributes(A,{"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset})}}},fillStroke:function(A,E){var B=this,D=B.fillStyle,G=B.strokeStyle,C=B.fillOpacity,F=B.strokeOpacity;if(E===undefined){E=A.transformFillStroke}if(!E){A.inverseMatrix.toContext(B)}if(D&&C!==0){B.fill()}if(G&&F!==0){B.stroke()}},appendPath:function(A){this.path=A.clone()},setLineDash:function(A){this.lineDash=A},getLineDash:function(){return this.lineDash},createLinearGradient:function(D,G,B,E){var F=this,C=F.surface.getNextDef("linearGradient"),A=F.group.dom.gradients||(F.group.dom.gradients={}),H;F.surface.setElementAttributes(C,{"x1":D,"y1":G,"x2":B,"y2":E,"gradientUnits":"userSpaceOnUse"});H=new Ext.draw.engine.SvgContext.Gradient(F,F.surface,C);A[C.dom.id]=H;return H},createRadialGradient:function(B,J,D,A,I,C){var G=this,E=G.surface.getNextDef("radialGradient"),F=G.group.dom.gradients||(G.group.dom.gradients={}),H;G.surface.setElementAttributes(E,{"fx":B,"fy":J,"cx":A,"cy":I,"r":C,"gradientUnits":"userSpaceOnUse"});H=new Ext.draw.engine.SvgContext.Gradient(G,G.surface,E,D/C);F[E.dom.id]=H;return H}});Ext.define("Ext.draw.engine.SvgContext.Gradient",{statics:{map:{}},constructor:function(C,A,D,B){var F=this.statics().map,E;E=F[D.dom.id];if(E){E.element=null}F[D.dom.id]=this;this.ctx=C;this.surface=A;this.element=D;this.position=0;this.compression=B||0},addColorStop:function(D,B){var C=this.surface.getSvgElement(this.element,"stop",this.position++),A=this.compression;this.surface.setElementAttributes(C,{"offset":(((1-A)*D+A)*100).toFixed(2)+"%","stop-color":B,"stop-opacity":Ext.draw.Color.fly(B).a.toFixed(15)})},toString:function(){var A=this.element.dom.childNodes;while(A.length>this.position){Ext.fly(A[A.length-1]).destroy()}return"url(#"+this.element.getId()+")"},destroy:function(){var B=this.statics().map,A=this.element;if(A&&A.dom){delete B[A.dom.id];A.destroy()}this.callParent()}})