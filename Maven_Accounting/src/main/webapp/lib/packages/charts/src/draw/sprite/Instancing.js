Ext.define("Ext.draw.sprite.Instancing",{extend:"Ext.draw.sprite.Sprite",alias:"sprite.instancing",type:"instancing",isInstancing:true,config:{template:null},instances:null,applyTemplate:function(A){if(!Ext.isObject(A)){Ext.raise("A template of an instancing sprite must either be a sprite instance or a valid config object from which a template sprite will be created.")}else{if(A.isInstancing||A.isComposite){Ext.raise("Can't use an instancing or composite sprite as a template for an instancing sprite.")}}if(!A.isSprite){if(!A.xclass&&!A.type){A.type="circle"}A=Ext.create(A.xclass||"sprite."+A.type,A)}A.setParent(this);return A},updateTemplate:function(A,B){if(B){delete B.ownAttr}A.setSurface(this.getSurface());A.ownAttr=A.attr;this.clearAll()},updateSurface:function(A){var B=this.getTemplate();if(B){B.setSurface(A)}},get:function(A){return this.instances[A]},getCount:function(){return this.instances.length},clearAll:function(){var A=this.getTemplate();A.attr.children=this.instances=[];this.position=0},createInstance:function(D,F,C){var E=this.getTemplate(),B=E.attr,A=Ext.Object.chain(B);E.topModifier.prepareAttributes(A);E.attr=A;E.setAttributes(D,F,C);A.template=E;this.instances.push(A);E.attr=B;this.position++;return A},getBBox:function(){return null},getBBoxFor:function(B,D){var C=this.getTemplate(),A=C.attr,E;C.attr=this.instances[B];E=C.getBBox(D);C.attr=A;return E},isVisible:function(){var B=this.attr,C=this.getParent(),A;A=C&&C.isSurface&&!B.hidden&&B.globalAlpha;return !!A},isInstanceVisible:function(C){var E=this,D=E.getTemplate(),B=D.attr,F=E.instances,A=false;if(!Ext.isNumber(C)||C<0||C>=F.length||!E.isVisible()){return A}D.attr=F[C];A=D.isVisible(point,options);D.attr=B;return A},render:function(B,K,D,H){if(!this.getTemplate()){Ext.raise("An instancing sprite must have a template.")}var G=this,I=G.getTemplate(),J=G.attr.matrix,C=I.attr,A=G.instances,E,F=G.position;J.toContext(K);I.preRender(B,K,D,H);I.useAttributes(K,H);for(E=0;E<F;E++){if(A[E].dirtyZIndex){break}}for(E=0;E<F;E++){if(A[E].hidden){continue}K.save();I.attr=A[E];I.useAttributes(K,H);I.render(B,K,D,H);K.restore()}I.attr=C},setAttributesFor:function(C,E,F){var D=this.getTemplate(),B=D.attr,A=this.instances[C];if(!A){return }D.attr=A;if(F){E=Ext.apply({},E)}else{E=D.self.def.normalize(E)}D.topModifier.pushDown(A,E);D.attr=B},destroy:function(){var B=this,A=B.getTemplate();B.instances=null;if(A){A.destroy()}B.callParent()}})