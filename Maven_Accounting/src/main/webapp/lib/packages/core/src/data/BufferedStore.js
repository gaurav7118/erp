Ext.define("Ext.data.BufferedStore",{extend:"Ext.data.ProxyStore",alias:"store.buffered",requires:["Ext.data.PageMap","Ext.util.Filter","Ext.util.Sorter","Ext.util.Grouper"],uses:["Ext.util.SorterCollection","Ext.util.FilterCollection","Ext.util.GroupCollection"],isBufferedStore:true,buffered:true,config:{data:0,pageSize:25,remoteSort:true,remoteFilter:true,sortOnLoad:false,purgePageCount:5,trailingBufferZone:25,leadingBufferZone:200,defaultViewSize:100,viewSize:0,trackRemoved:false},applyData:function(B){var A=this.data||(this.data=this.createDataCollection());if(B&&B!==true){Ext.raise("Cannot load a buffered store with local data - the store is a map of remote data")}return A},applyProxy:function(A){A=this.callParent([A]);if(A&&A.setEnablePaging){A.setEnablePaging(true)}return A},createFiltersCollection:function(){return new Ext.util.FilterCollection()},createSortersCollection:function(){return new Ext.util.SorterCollection()},updateRemoteFilter:function(A,B){if(A===false){Ext.raise("Buffered stores are always remotely filtered.")}this.callParent([A,B])},updateRemoteSort:function(B,A){if(B===false){Ext.raise("Buffered stores are always remotely sorted.")}this.callParent([B,A])},updateTrackRemoved:function(A){if(A!==false){Ext.raise("Cannot use trackRemoved with a buffered store.")}this.callParent(arguments)},updateGroupField:function(A){this.group(A)},getGrouper:function(){return this.grouper},isGrouped:function(){return !!this.grouper},createDataCollection:function(){var B=this,A=new Ext.data.PageMap({store:B,rootProperty:"data",pageSize:B.getPageSize(),maxSize:B.getPurgePageCount(),listeners:{clear:B.onPageMapClear,scope:B}});B.relayEvents(A,["beforepageremove","pageadd","pageremove"]);B.pageRequests={};return A},add:function(){Ext.raise("add method may not be called on a buffered store - the store is a map of remote data")},insert:function(){Ext.raise("insert method may not be called on a buffered store - the store is a map of remote data")},removeAll:function(A){var B=this,C=B.getData();if(C){if(A){B.suspendEvent("clear")}C.clear();if(A){B.resumeEvent("clear")}}},flushLoad:function(){var B=this,A=B.pendingLoadOptions;B.clearLoadTask();if(!A){return }B.getData().clear();A.page=1;A.start=0;A.limit=B.getViewSize()||B.getDefaultViewSize();A.loadCallback=A.callback;A.callback=null;return B.loadToPrefetch(A)},reload:function(L){var G=this,E=G.getData(),I=Number.MAX_VALUE,H,B,F,K,D,A,J,C;if(!L){L={}}if(G.loading||G.fireEvent("beforeload",G,L)===false){return }A=function(){var N=G.totalCount,M=B-H;if(B>=N){B=N-1;H=Math.max(B-M,0)}if(G.rangeCached(H,Math.min(B,G.totalCount))){G.loading=false;E.un("pageadd",A);C=E.getRange(H,B+1);G.fireEvent("load",G,C,true);G.fireEvent("refresh",G)}};J=Math.ceil((G.getLeadingBufferZone()+G.getTrailingBufferZone())/2);if(G.lastRequestStart&&G.preserveScrollOnReload){H=G.lastRequestStart;B=G.lastRequestEnd;I=G.getTotalCount()}else{H=L.start||0;B=H+(L.count||G.getPageSize())-1}E.clear(true);delete G.totalCount;H=Math.max(H-J,0);B=Math.min(B+J,I);F=G.getPageFromRecordIndex(H);K=G.getPageFromRecordIndex(B);G.loading=true;L.waitForReload=A;E.on("pageadd",A);for(D=F;D<=K;D++){G.prefetchPage(D,L)}},filter:function(){if(!this.getRemoteFilter()){Ext.raise("Local filtering may not be used on a buffered store - the store is a map of remote data")}this.callParent(arguments)},filterBy:function(B,A){Ext.raise("Local filtering may not be used on a buffered store - the store is a map of remote data")},loadData:function(B,A){Ext.raise("LoadData may not be used on a buffered store - the store is a map of remote data")},loadPage:function(C,A){var B=this;A=A||{};A.page=B.currentPage=C;A.start=(C-1)*B.getPageSize();A.limit=B.getViewSize()||B.getDefaultViewSize();A.loadCallback=A.callback;A.callback=null;return B.loadToPrefetch(A)},clearData:function(C){var A=this,B=A.getData();if(B){B.clear()}},getCount:function(){return this.totalCount||0},getRange:function(D,G,L){var K=this,E=K.totalCount-1,F=K.lastRequestStart,M=[],H=K.getData(),C,J,B,A,I;L=Ext.apply({prefetchStart:D,prefetchEnd:G},L);G=(G>=K.totalCount)?E:G;J=D===0?0:D-1;B=G===E?G:G+1;K.lastRequestStart=D;K.lastRequestEnd=G;if(K.rangeCached(J,B)){K.onRangeAvailable(L);M=H.getRange(D,G+1)}else{K.fireEvent("cachemiss",K,D,G);A=K.getPageFromRecordIndex(J);I=K.getPageFromRecordIndex(B);C=function(N,P,O){if(P>=A&&P<=I&&K.rangeCached(J,B)){K.fireEvent("cachefilled",K,D,G);H.un("pageadd",C);K.onRangeAvailable(L)}};H.on("pageadd",C);K.prefetchRange(D,G)}K.primeCache(D,G,D<F?-1:1);return M},getById:function(B){var A=this.data.findBy(function(C){return C.getId()===B});return A},getAt:function(A){var B=this.getData();if(B.hasRange(A,A)){return B.getAt(A)}},getByInternalId:function(A){return this.data.getByInternalId(A)},contains:function(A){return this.indexOf(A)>-1},indexOf:function(A){return this.getData().indexOf(A)},indexOfId:function(A){return this.indexOf(this.getById(A))},group:function(B,D){var C=this,A;if(B&&typeof B==="string"){A=C.grouper;if(!A){C.grouper=new Ext.util.Grouper({property:B,direction:D||"ASC",root:"data"})}else{if(D===undefined){A.toggle()}else{A.setDirection(D)}}}else{C.grouper=B?C.getSorters().decodeSorter(B,"Ext.util.Grouper"):null}C.getData().clear();C.loadPage(1,{callback:function(){C.fireEvent("groupchange",C,C.getGrouper())}})},getPageFromRecordIndex:function(A){return Math.floor(A/this.getPageSize())+1},calculatePageCacheSize:function(A){var C=this,B=C.getPurgePageCount();return B?Math.max(C.getData().getMaxSize()||0,Math.ceil((A+C.getTrailingBufferZone()+C.getLeadingBufferZone())/C.getPageSize())*2+B):0},loadToPrefetch:function(Q){var K=this,C=Q,G,B,M,L=Q.start,A=Q.start+Q.limit-1,P=(K.getViewSize()||Q.limit),H=Math.min(A,Q.start+P-1),I=K.getPageFromRecordIndex(Math.max(L-K.getTrailingBufferZone(),0)),O=K.getPageFromRecordIndex(A+K.getLeadingBufferZone()),F=K.getData(),J=function(){B=B||[];if(Q.loadCallback){Q.loadCallback.call(Q.scope||K,B,E,true)}if(Q.callback){Q.callback.call(Q.scope||K,B,L||0,A||0,Q)}},N=function(){K.fireEvent("datachanged",K);K.fireEvent("refresh",K);K.fireEvent("load",K,B,true)},D=function(){if(K.rangeCached(L,H)){K.loading=false;B=F.getRange(L,H+1);F.un("pageadd",D);if(K.hasListeners.guaranteedrange){K.guaranteeRange(L,H,Q.callback,Q.scope)}J();N()}},E;if(isNaN(K.pageSize)||!K.pageSize){Ext.raise("Buffered store configured without a pageSize",K)}F.setMaxSize(K.calculatePageCacheSize(P));if(K.fireEvent("beforeload",K,Q)!==false){delete K.totalCount;K.loading=true;if(Q.callback){C=Ext.apply({},Q);delete C.callback}K.on("prefetch",function(S,R,U,T){E=T;if(U){if((M=K.getTotalCount())){F.on("pageadd",D);H=Math.min(H,M-1);O=K.getPageFromRecordIndex(Math.min(H+K.getLeadingBufferZone(),M-1));for(G=I+1;G<=O;++G){K.prefetchPage(G,C)}}else{J();N()}}else{K.loading=false;J();K.fireEvent("load",K,R,false)}},null,{single:true});K.prefetchPage(I,C)}},prefetch:function(D){var E=this,B=E.getPageSize(),F=E.getData(),C,A;if(B){if(E.lastPageSize&&B!=E.lastPageSize){Ext.raise("pageSize cannot be dynamically altered")}if(!F.getPageSize()){F.setPageSize(B)}}else{E.pageSize=F.setPageSize(B=D.limit)}E.lastPageSize=B;if(!D.page){D.page=E.getPageFromRecordIndex(D.start);D.start=(D.page-1)*B;D.limit=Math.ceil(D.limit/B)*B}A=E.pageRequests[D.page];if(!A||A.getOperation().pageMapGeneration!==F.pageMapGeneration){D=Ext.apply({action:"read",filters:E.getFilters().items,sorters:E.getSorters().items,grouper:E.getGrouper(),internalCallback:E.onProxyPrefetch,internalScope:E},D);C=E.createOperation("read",D);C.pageMapGeneration=F.pageMapGeneration;if(E.fireEvent("beforeprefetch",E,C)!==false){E.pageRequests[D.page]=C.execute();if(E.getProxy().isSynchronous){delete E.pageRequests[D.page]}}}return E},onPageMapClear:function(){var C=this,B=C.wasLoading,A=C.pageRequests,E=C.getData(),D;E.clearListeners();E.on("clear",C.onPageMapClear,C);C.relayEvents(E,["beforepageremove","pageadd","pageremove"]);C.loading=true;C.totalCount=0;for(D in A){if(A.hasOwnProperty(D)){A[D].getOperation().abort()}}C.fireEvent("clear",C);C.loading=B},prefetchPage:function(E,B){var D=this,A=D.getPageSize(),F=(E-1)*A,C=D.totalCount;if(C!==undefined&&D.data.getCount()===C){return }D.prefetch(Ext.applyIf({page:E,start:F,limit:A},B))},onProxyPrefetch:function(D){if(this.destroyed){return }var H=this,I=D.getResultSet(),C=D.getRecords(),F=D.wasSuccessful(),G=D.getPage(),B=D.waitForReload,K=H.totalCount,A=H.pageRequests,J,E;if(D.pageMapGeneration===H.getData().pageMapGeneration){if(I){H.totalCount=I.getTotal();if(H.totalCount!==K){H.fireEvent("totalcountchange",H.totalCount)}}if(G!==undefined){delete H.pageRequests[G]}H.loading=false;H.fireEvent("prefetch",H,C,F,D);if(F){if(H.totalCount===0){if(B){for(J in A){E=A[J].getOperation();if(E.waitForReload===B){delete E.waitForReload}}H.getData().un("pageadd",B);H.fireEvent("load",H,[],true);H.fireEvent("refresh",H)}}else{H.cachePage(C,D.getPage())}}Ext.callback(D.getCallback(),D.getScope()||H,[C,D,F])}},cachePage:function(B,E){var D=this,A=B.length,C;if(!Ext.isDefined(D.totalCount)){D.totalCount=B.length;D.fireEvent("totalcountchange",D.totalCount)}for(C=0;C<A;C++){B[C].join(D)}D.getData().addPage(E,B)},rangeCached:function(B,A){return this.getData().hasRange(B,A)},pageCached:function(A){return this.getData().hasPage(A)},pagePending:function(A){return !!this.pageRequests[A]},rangeSatisfied:function(B,A){return this.rangeCached(B,A)},onRangeAvailable:function(D){var E=this,B=E.getTotalCount(),F=D.prefetchStart,A=(D.prefetchEnd>B-1)?B-1:D.prefetchEnd,C;A=Math.max(0,A);if(F>A){Ext.log({level:"warn",msg:"Start ("+F+") was greater than end ("+A+") for the range of records requested ("+F+"-"+D.prefetchEnd+")"+(this.storeId?' from store "'+this.storeId+'"':"")})}C=E.getData().getRange(F,A+1);if(D.fireEvent!==false){E.fireEvent("guaranteedrange",C,F,A,D)}if(D.callback){D.callback.call(D.scope||E,C,F,A,D)}},guaranteeRange:function(E,A,D,C,B){B=Ext.apply({callback:D,scope:C},B);this.getRange(E,A+1,B)},prefetchRange:function(G,B){var D=this,C,A,F,E=D.getData();if(!D.rangeCached(G,B)){C=D.getPageFromRecordIndex(G);A=D.getPageFromRecordIndex(B);E.setMaxSize(D.calculatePageCacheSize(B-G+1));for(F=C;F<=A;F++){if(!D.pageCached(F)){D.prefetchPage(F)}}}},primeCache:function(H,C,G){var F=this,E=F.getLeadingBufferZone(),D=F.getTrailingBufferZone(),B=F.getPageSize(),A=F.totalCount;if(G===-1){H=Math.max(H-E,0);C=Math.min(C+D,A-1)}else{if(G===1){H=Math.max(Math.min(H-D,A-B),0);C=Math.min(C+E,A-1)}else{H=Math.min(Math.max(Math.floor(H-((E+D)/2)),0),A-F.pageSize);C=Math.min(Math.max(Math.ceil(C+((E+D)/2)),0),A-1)}}F.prefetchRange(H,C)},sort:function(B,A,C){if(arguments.length===0){this.clearAndLoad()}else{this.getSorters().addSort(B,A,C)}},onSorterEndUpdate:function(){var A=this,B=A.getSorters().getRange();if(B.length){A.fireEvent("beforesort",A,B);A.clearAndLoad({callback:function(){A.fireEvent("sort",A,B)}})}else{A.fireEvent("sort",A,B)}},clearAndLoad:function(A){this.getData().clear();this.loadPage(1,A)},privates:{isLast:function(A){return this.indexOf(A)===this.getTotalCount()-1},isMoving:function(){return false}}})