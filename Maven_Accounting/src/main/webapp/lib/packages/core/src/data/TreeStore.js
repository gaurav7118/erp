Ext.define("Ext.data.TreeStore",{extend:"Ext.data.Store",alias:"store.tree",requires:["Ext.util.Sorter","Ext.data.TreeModel","Ext.data.NodeInterface"],isTreeStore:true,config:{root:null,rootVisible:false,defaultRootProperty:"children",parentIdProperty:null,clearOnLoad:true,clearRemovedOnLoad:true,nodeParam:"node",defaultRootId:"root",defaultRootText:"Root",folderSort:false},lazyFill:false,fillCount:0,bulkUpdate:0,_silentOptions:{silent:true},implicitModel:"Ext.data.TreeModel",constructor:function(A){var B=this;B.byIdMap={};B.callParent([A]);if(Ext.isDefined(B.nodeParameter)){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.data.TreeStore: nodeParameter has been deprecated. Please use nodeParam instead.")}B.nodeParam=B.nodeParameter;delete B.nodeParameter}},applyFields:function(A,C){var B=this;if(A){if(B.defaultRootProperty!==B.self.prototype.config.defaultRootProperty){A=A.concat({name:B.defaultRootProperty,type:"auto",defaultValue:null,persist:false})}}B.callParent([A,C])},onSorterEndUpdate:function(){var C=this,A=C.getSorters(),D=A.getRange(),B=C.getRoot(),E=C.getFolderSort();C.fireEvent("beforesort",C,D);if(B&&(E||D.length)){if(C.getRemoteSort()){if(D.length){C.load({callback:function(){C.fireEvent("sort",C,D)}})}}else{B.sort(this.getSortFn(),true);C.fireEvent("datachanged",C);C.fireEvent("refresh",C);C.fireEvent("sort",C,D)}}else{C.fireEvent("sort",C,D)}},updateFolderSort:function(A){this.needsFolderSort=A;this.onSorterEndUpdate()},getSortFn:function(){return this._sortFn||(this._sortFn=this.createSortFn())},createSortFn:function(){var A=this,B=this.sorters.getSortFn();return function(E,D){var F,G,C=0;if(A.needsFolderSort){F=E.data.leaf?1:0;G=D.data.leaf?1:0;C=F-G}if(A.needsIndexSort&&C===0){C=E.data.index-D.data.index}return C||B(E,D)}},getTotalCount:function(){return this.getCount()},afterEdit:function(C,B){var A=this;if(A.needsLocalFilter()){A.doFilter(C)}A.callParent([C,B])},afterReject:function(A){var B=this;if(B.contains(A)){B.onUpdate(A,Ext.data.Model.REJECT,null);B.fireEvent("update",B,A,Ext.data.Model.REJECT,null)}},afterCommit:function(A,C){var B=this;if(!C){C=null}if(B.contains(A)){B.onUpdate(A,Ext.data.Model.COMMIT,C);B.fireEvent("update",B,A,Ext.data.Model.COMMIT,C)}},fireChangeEvent:function(A){return !!this.byIdMap[A.id]},updateRootVisible:function(B){var A=this.getRoot(),C;if(A){C=this.getData();if(B){C.insert(0,A)}else{C.remove(A)}}},updateTrackRemoved:function(A){this.callParent(arguments);this.removedNodes=this.removed;this.removed=null},onDestroyRecords:function(B,A,C){if(C){this.removedNodes.length=0}},updateProxy:function(B){var A;if(B){if(B.setIdParam){B.setIdParam(this.getNodeParam())}A=B.getReader();if(Ext.isEmpty(A.getRootProperty())){A.setRootProperty(this.getDefaultRootProperty())}}},setProxy:function(A){this.changingProxy=true;this.callParent([A]);this.changingProxy=false},updateModel:function(A){var B=A.prototype.isNode;Ext.data.NodeInterface.decorate(A);if(!B&&!this.changingProxy){this.getProxy().getReader().buildExtractors(true)}},onFilterEndUpdate:function(F){var E=this,D=F.length,A=E.getRoot(),H,C,G,B;if(!E.getRemoteFilter()){if(D){E.doFilter(A)}else{A.cascadeBy({after:function(I){I.set("visible",true,E._silentOptions)}})}if(D){G=[];H=A.childNodes;for(B=0,D=H.length;B<D;B++){C=H[B];if(C.get("visible")){G.push(C)}}}else{G=A.childNodes}E.onNodeFilter(A,G);A.fireEvent("filterchange",A,G);E.fireEvent("filterchange",E,F);E.suppressNextFilter=true;E.callParent([F]);E.suppressNextFilter=false}else{E.callParent([F])}},onNodeFilter:function(A,E){var C=this,D=C.getData(),B=[];if(C.getRootVisible()){if(E.length){B.push(A)}else{A.set("visible",false,C._silentOptions)}}C.handleNodeExpand(A,E,B);C.suspendEvents();D.splice(0,D.getCount(),B);C.resumeEvents();if(!C.suppressNextFilter){C.fireEvent("datachanged",C);C.fireEvent("refresh",C)}},onBeforeNodeExpand:function(B,J,K,F){var G=this,H,D,I,E,A,C;if(B.isLoaded()){C=[B.childNodes];if(F){C.push.apply(C,F)}Ext.callback(J,K||B,C)}else{if(B.isLoading()){G.on("load",function(){C=[B.childNodes];if(F){C.push.apply(C,F)}Ext.callback(J,K||B,C)},G,{single:true,priority:1001})}else{H=G.getProxy().getReader();D=B.getProxy();I=D?D.getReader():null;E=I&&I.initialConfig.rootProperty?I:H;A=E.getRoot(B.raw||B.data);if(A||(B.phantom&&!B.isRoot())){if(A){G.fillNode(B,E.extractData(A,{model:B.childType,recordCreator:G.recordCreator}))}C=[B.childNodes];if(F){C.push.apply(C,F)}Ext.callback(J,K||B,C)}else{G.read({node:B,onChildNodesAvailable:function(){delete G.lastOptions.onChildNodesAvailable;C=[B.childNodes];if(F){C.push.apply(C,F)}Ext.callback(J,K||B,C)}});G.flushLoad()}}}},onNodeExpand:function(D,B){var E=this,A=E.indexOf(D)+1,C=[];E.handleNodeExpand(D,B,C);if(!E.refreshCounter&&D.isRoot()&&!D.get("visible")){E.loadRecords(C)}else{E.insert(A,C)}},handleNodeExpand:function(E,B,D){var G=this,F=B?B.length:0,C,A;if(E!==this.getRoot()&&!G.isVisible(E)){return }if(F){for(C=0;C<F;C++){A=B[C];if(A.get("visible")){D.push(A);if(A.isExpanded()){if(A.isLoaded()){G.handleNodeExpand(A,A.childNodes,D)}else{A.set("expanded",false);A.expand()}}}}}},onNodeCollapse:function(D,A,G,C){var E=this,B=E.indexOf(D)+1,F;if(E.needsLocalFilter()){A=Ext.Array.filter(A,E.filterVisible)}if(A.length&&E.data.contains(A[0])){F=E.indexOfNextVisibleNode(D);E.removeAt(B,F-B)}Ext.callback(G,C)},indexOfNextVisibleNode:function(B){var A;while(B.parentNode){for(A=B.nextSibling;A&&!A.get("visible");A=A.nextSibling){}if(A){return this.indexOf(A)}B=B.parentNode}return this.getCount()},filterNew:function(A){return !A.get("root")&&this.callParent([A])},filterRejects:function(A){return !A.get("root")&&this.callParent([A])},getNewRecords:function(){return Ext.Array.filter(Ext.Object.getValues(this.byIdMap),this.filterNew,this)},getUpdatedRecords:function(){return Ext.Array.filter(Ext.Object.getValues(this.byIdMap),this.filterUpdated)},beforeNodeRemove:function(B,F){if(!Ext.isArray(F)){F=[F]}var E=this,A=F.length,D,C;for(D=0;!C&&D<A;D++){if(F[D].get("visible")){C=F[D]}}if(C){E.startRemoveIndex=E.indexOf(F[0]);E.lastRemoveIndexPlusOne=E.indexOfNextVisibleNode(F[F.length-1])}else{E.startRemoveIndex=-1;E.lastRemoveIndexPlusOne=0}},afterDrop:Ext.emptyFn,onNodeRemove:function(D,I,H){var G=this,E=G.removedNodes,F=I.length,A=G.startRemoveIndex,B=G.lastRemoveIndexPlusOne,C;G.suspendAutoSync();if(A!==-1){G.removeIsMove=H;G.removeAt(A,B-A);G.removeIsMove=false}for(C=0;C<F;C++){I[C].cascadeBy(function(J){G.unregisterNode(J);if(E&&!H){if(!J.phantom&&!J.erasing&&!G.loading){J.removedFrom=G.indexOf(J);E.push(J);G.needsSync=true}}})}G.resumeAutoSync()},onNodeAppend:function(B,C,A){this.onNodeInsert(B,C,A)},onNodeInsert:function(L,A,F){var I=this,C=A.raw||A.data,E=I.removedNodes,G,M,H,B,J,D,K;if(L&&I.needsLocalFilter()){I.doFilter(L)}I.beginUpdate();if(I.isVisible(A)){if(F===0||!A.previousSibling){G=L}else{for(M=A.previousSibling;M&&!M.get("visible");M=M.previousSibling){}while(M.isExpanded()&&M.lastChild){M=M.lastChild}G=M}I.insert(I.indexOf(G)+1,A);if(!A.isLeaf()&&A.isExpanded()){if(A.isLoaded()){I.onNodeExpand(A,A.childNodes)}else{if(!I.fillCount){A.set("expanded",false);A.expand()}}}}Ext.Array.remove(E,A);I.needsSync=I.needsSync||A.phantom||A.dirty;if(!A.isLeaf()&&!A.isLoaded()&&!I.lazyFill){H=I.getProxy().getReader();B=A.getProxy();J=B?B.getReader():null;D=J&&J.initialConfig.rootProperty?J:H;K=D.getRoot(C);if(K){I.fillNode(A,D.extractData(K,{model:A.childType,recordCreator:I.recordCreator}))}}I.endUpdate()},registerNode:function(F,A){var E=this,C,D,B;E.byIdMap[F.id]=F;if(A===true){C=F.childNodes;D=C.length;for(B=0;B<D;B++){E.registerNode(C[B],true)}}},unregisterNode:function(F,A){var E=this,C,D,B;delete E.byIdMap[F.id];if(A===true){C=F.childNodes;D=C.length;for(B=0;B<D;B++){E.unregisterNode(C[B],true)}}},onNodeSort:function(B,C){var A=this;A.suspendAutoSync();if((A.indexOf(B)!==-1&&B.isExpanded())||(B===A.getRoot()&&!A.getRootVisible())){Ext.suspendLayouts();A.onNodeCollapse(B,C);A.onNodeExpand(B,C);Ext.resumeLayouts(true)}A.resumeAutoSync(A.autoSync)},applyRoot:function(E){var B=this,D=B.getModel(),A=D.prototype.idProperty,C=B.getDefaultRootId();if(E&&!E.isNode){E=Ext.apply({text:B.getDefaultRootText(),root:true,isFirst:true,isLast:true,depth:0,index:0,parentId:null,allowDrag:false},E);if(C&&E[A]===undefined){E[A]=C}E=new D(E)}return E},updateRoot:function(F,B){var D=this,E,A=!B,C;D.byIdMap={};D.getTrackRemoved();D.suspendEvent("add","remove");if(B&&B.isModel){if(D.getRootVisible()){C=[B]}else{C=B.childNodes}D.beforeNodeRemove(null,C);B.set("root",false);D.onNodeRemove(null,C);B.fireEvent("remove",null,B,false);B.fireEvent("rootchange",null);B.clearListeners();B.store=B.treeStore=null}D.getData().clear();if(F){if(F.fireEventArgs("beforeappend",[null,F])===false){F=null}else{E=F.parentNode;if(E){if(!E.removeChild(F,false,false,E.getTreeStore()===D)){return }}else{if((E=F.getTreeStore())&&E!==D&&F===E.getRoot()){E.setRoot(null)}}F.store=F.treeStore=D;F.set("root",true);F.updateInfo(true,{isFirst:true,isLast:true,depth:0,index:0,parentId:null});D.registerNode(F,true);F.fireEvent("append",null,F,false);F.fireEvent("rootchange",F);D.onNodeAppend(null,F,0);F.phantom=true}}D.fireEvent("rootchange",F,B);if(F&&(D.getAutoLoad()||F.isExpanded())){if(F.isLoaded()){D.onNodeExpand(F,F.childNodes);D.fireEvent("datachanged",D);D.fireEvent("refresh",D)}else{F.data.expanded=false;F.expand(false,function(){D.fireEvent("datachanged",D);D.fireEvent("refresh",D)})}}else{if(!A){D.fireEvent("datachanged",D);D.fireEvent("refresh",D)}}D.resumeEvent("add","remove")},getNodeById:function(A){return this.byIdMap[A]||null},findNode:function(G,F,D,C,B){if(Ext.isEmpty(F,false)){return null}if(F===this.model.idProperty&&arguments.length<3){return this.byIdMap[F]}var E=Ext.String.createRegex(F,D,C,B),A=null;Ext.Object.eachValue(this.byIdMap,function(H){if(H&&E.test(H.get(G))){A=H;return false}});return A},load:function(A){var B=A&&A.node;if(!B&!(B=this.getRoot())){B=this.setRoot({expanded:true});return }if(B.isLoading()){return }return this.callParent([A])},flushLoad:function(){var F=this,I=F.pendingLoadOptions,A,G,H,D=F.getClearOnLoad(),E,B,C;F.clearLoadTask();if(!I){return }A=I.node||F.getRoot();E=A&&A.isRoot()&&A.isLoaded()&&D;G=I.callback;H=I.scope;I.params=I.params||{};if(A.data.expanded&&!E){A.data.loaded=false;if(D){A.data.expanded=false}I.callback=function(K,J,L){if(!D){A.collapse()}A.expand();Ext.callback(G,H,[K,J,L])}}I.id=A.getId();I=Ext.apply({filters:F.getFilters().items,sorters:F.getSorters().items,node:I.node||A,internalScope:F,internalCallback:F.onProxyLoad},I);F.lastOptions=Ext.apply({},I);I.isReload=E;B=F.createOperation("read",I);if(F.fireEvent("beforeload",F,B)!==false){F.loading=true;if(E){if(F.getClearRemovedOnLoad()){F.removedNodes.length=0}F.unregisterNode(A,true);A.childNodes.length=0;C=true}else{if(D){if(F.getTrackRemoved()&&F.getClearRemovedOnLoad()){F.clearRemoved(A)}A.removeAll(false)}}if(F.loading&&A){A.set("loading",true)}if(C){F.clearData(true);if(F.getRootVisible()){F.suspendEvents();F.add(A);F.resumeEvents()}}B.execute()}return F},onProxyLoad:function(C){var G=this,I=C.initialConfig,D=C.wasSuccessful(),B=C.getRecords(),A=I.node,F=I.isReload,H=C.getScope()||G,E=[B,C,D];if(G.destroyed){return }G.loading=false;A.set("loading",false);if(D){++G.loadCount;if(!G.getClearOnLoad()){B=G.cleanRecords(A,B)}if(G.getParentIdProperty()){B=G.treeify(A,B)}if(F){G.suspendEvent("add","update")}B=G.fillNode(A,B)}if(F){G.resumeEvent("add","update");G.callObservers("BeforePopulate");G.fireEvent("datachanged",G);G.fireEvent("refresh",G);G.callObservers("AfterPopulate")}else{Ext.callback(I.onChildNodesAvailable,H,E)}G.fireEvent("load",G,B,D,C,A)},clearRemoved:function(B){var I=this,E=I.removedNodes,A=B.getId(),D=E.length,C=D,L={},G=[],K={},H,F,J;if(B===I.getRoot()){I.removedNodes.length=0;return }for(;C--;){H=E[C];K[H.getId()]=H}for(C=D;C--;){H=E[C];F=H;while(F&&F.getId()!==A){J=F.get("parentId")||F.get("lastParentId");F=F.parentNode||I.getNodeById(J)||K[J]}if(F){L[H.getId()]=H}}for(C=0;C<D;C++){H=E[C];if(!L[H.getId()]){G.push(H)}}I.removedNodes=G},fillNode:function(C,A){var B=this,D=A?A.length:0;++B.bulkUpdate;if(D){B.setupNodes(A)}if(B.bulkUpdate===1){C.set("loaded",true)}else{C.data.loaded=true}if(A.length){C.appendChild(A,undefined,true)}--B.bulkUpdate;return A},setupNodes:function(C){var F=this,E=F.getSorters(),G=false,B=C.length,A=F.sortOnLoad&&B>1&&!F.getRemoteSort()&&F.getFolderSort()||E.length,J,H,D,I;if(F.needsLocalFilter()){I=F.getFilters().getFilterFn();C[0].set("visible",I(C[0]))}for(D=1;D<B;D++){J=C[D];H=C[D-1];if(I){J.set("visible",I(J))}G=J.data.index!==H.data.index}if(A){F.needsIndexSort=true;Ext.Array.sort(C,F.getSortFn());F.needsIndexSort=false}else{if(G){Ext.Array.sort(C,F.sortByIndex)}}},beginFill:function(){var A=this;if(!A.fillCount++){A.beginUpdate();A.suspendEvent("add","update");A.suspendAutoSync();A.fillArray=[]}},endFill:function(E,B){var F=this,G=F.fillArray,D,A,C;G.push(B);if(!--F.fillCount){F.resumeAutoSync();F.resumeEvent("add","update");for(D=0,A=G.length;D<A;D++){C=F.indexOf(G[D][0]);if(C!==-1){F.fireEvent("add",F,G[D],C)}}F.fillArray=null;F.endUpdate()}},sortByIndex:function(B,A){return B.data.index-A.data.index},onIdChanged:function(D,F,B){var E=D.childNodes,A=E&&E.length,C;this.callParent(arguments);delete this.byIdMap[F];this.byIdMap[B]=D;for(C=0;C<A;C++){E[C].set("parentId",B)}},treeify:function(H,E){var K=this,M=H.getId(),C=K.getParentIdProperty(),I=E.length,N=[],J={},F,D,G,L,A,B;for(F=0;F<I;F++){D=E[F];J[D.id]=D}for(F=0;F<I;F++){D=E[F];G=D.data[C];if(!(G||G===0)||G===M){N.push(D)}else{if(!J[G]){Ext.raise('Ext.data.TreeStore, Invalid parentId "'+G+'"')}L=J[G];L.$children=L.$children||[];L.$children.push(D)}}for(A in J){D=J[A];B=D.$children;if(B){delete D.$children;K.setupNodes(B);D.appendChild(B)}K.registerNode(D)}K.setupNodes(N);return N},cleanRecords:function(F,B){var E={},H=F.childNodes,D=0,A=H.length,C=[],G;for(;D<A;++D){E[H[D].getId()]=true}for(D=0,A=B.length;D<A;++D){G=B[D];if(!E[G.getId()]){C.push(G)}}return C},removeAll:function(){this.suspendEvents();this.setRoot(null);this.resumeEvents();this.callParent()},doSort:function(A){var B=this;if(B.getRemoteSort()){B.load()}else{B.tree.sort(A,true);B.fireEvent("datachanged",B);B.fireEvent("refresh",B)}B.fireEvent("sort",B,B.sorters.getRange())},filterVisible:function(A){return A.get("visible")},isVisible:function(C){var A=C.parentNode,D=C.data.visible,B=this.getRoot();while(D&&A){D=A.data.expanded&&A.data.visible;A=A.parentNode}return D&&!(C===B&&!this.getRootVisible())},commitChanges:function(){var A=this.removedNodes;if(A){A.length=0}this.callParent()},getRootNode:function(){return this.getRoot()},setRootNode:function(A){this.setRoot(A);return this.getRoot()},privates:{getRawRemovedRecords:function(){return this.removedNodes},recordCreator:function(A,B){return new B(A)},doFilter:function(B){var A=this.getRoot(),C=this.getFilters().getFilterFn();this.filterNodes(A,B,C)},filterNodes:function(B,E,F){var C=false,G=E.childNodes,A=G&&G.length,D;if(A){for(D=0;D<A;++D){this.filterNodes(B,G[D],F)}}C=E===B||F(E);E.set("visible",C,this._silentOptions);return C},needsLocalFilter:function(){return !this.getRemoteFilter()&&this.getFilters().length},onRemoteFilterSet:function(A,C){var B=this.getData();B.setFilters(null);if(A){A.on("endupdate",this.onFilterEndUpdate,this)}},onRemoteSortSet:function(B,C){var A=this.getData();A.setSorters(null);if(B){B.on("endupdate",this.onSorterEndUpdate,this)}}},deprecated:{5:{properties:{tree:null}}}})