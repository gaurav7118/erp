Ext.define("Ext.data.proxy.WebStorage",{extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.WebStorageProxy",requires:["Ext.data.identifier.Sequential"],config:{id:undefined},constructor:function(A){this.callParent(arguments);this.cache={};if(this.getStorageObject()===undefined){Ext.raise("Local Storage is not supported in this browser, please use another type of data proxy")}if(this.getId()===undefined){Ext.raise("No unique id was provided to the local storage proxy. See Ext.data.proxy.LocalStorage documentation for details")}this.initialize()},create:function(E){var I=this,D=E.getRecords(),C=D.length,A=I.getIds(),B,G,F,H;if(I.isHierarchical===undefined){I.isHierarchical=!!D[0].isNode;if(I.isHierarchical){I.getStorageObject().setItem(I.getTreeKey(),true)}}for(F=0;F<C;F++){G=D[F];if(G.phantom){G.phantom=false;H=G.identifier;if(H&&H.isUnique){B=G.getId()}else{B=I.getNextId()}}else{B=G.getId()}I.setRecord(G,B);G.commit();A.push(B)}I.setIds(A);E.setSuccessful(true)},read:function(H){var S=this,R,O=[],D=true,G=S.getModel(),E=0,Q=H.getRecordCreator(),F,A,P,K,J,B,L,C,T,I,N,M;if(S.isHierarchical){O=S.getTreeData()}else{L=S.getIds();C=L.length;I=H.getId();if(I){T=S.getRecord(I);if(T!==null){B=Q?Q(T,G):new G(T)}if(B){O.push(B)}else{D=false}}else{A=H.getSorters();F=H.getFilters();P=H.getLimit();R=[];for(N=0;N<C;N++){T=S.getRecord(L[N]);B=Q?Q(T,G):new G(T);R.push(B)}if(A){Ext.Array.sort(R,Ext.util.Sorter.createComparator(A))}for(N=H.getStart()||0;N<C;N++){B=R[N];J=true;if(F){for(M=0,K=F.length;M<K;M++){J=F[M].filter(B)}}if(J){O.push(B);E++}if(P&&E===P){break}}}}if(D){H.setResultSet(new Ext.data.ResultSet({records:O,total:O.length,loaded:true}));H.setSuccessful(true)}else{H.setException("Unable to load records")}},update:function(C){var B=C.getRecords(),F=B.length,E=this.getIds(),A,G,D;for(D=0;D<F;D++){A=B[D];this.setRecord(A);A.commit();G=A.getId();if(G!==undefined&&Ext.Array.indexOf(E,G)===-1){E.push(G)}}this.setIds(E);C.setSuccessful(true)},erase:function(D){var F=this,C=D.getRecords(),A=F.getIds(),G=A.length,I=[],H={},E=C.length,B;for(;E--;){Ext.apply(H,F.removeRecord(C[E]))}for(E=0;E<G;E++){B=A[E];if(!H[B]){I.push(B)}}F.setIds(I);D.setSuccessful(true)},getRecord:function(D){var B=this,A=B.cache,C=!A[D]?Ext.decode(B.getStorageObject().getItem(B.getRecordKey(D))):A[D];if(!C){return null}A[D]=C;C[B.getModel().prototype.idProperty]=D;return Ext.merge({},C)},setRecord:function(I,C){if(C){I.set("id",C,{commit:true})}else{C=I.getId()}var K=this,A=I.getData(),G={},H=K.getModel(),J=H.getFields(),D=J.length,F=0,L,B,E,M;for(;F<D;F++){L=J[F];B=L.name;if(L.persist){G[B]=A[B]}}delete G[H.prototype.idProperty];if(I.isNode&&I.get("depth")===1){delete G.parentId}E=K.getStorageObject();M=K.getRecordKey(C);K.cache[C]=G;E.removeItem(M);E.setItem(M,Ext.encode(G))},removeRecord:function(A){var D=this,F=A.getId(),B={},C,E;B[F]=A;D.getStorageObject().removeItem(D.getRecordKey(F));delete D.cache[F];if(A.childNodes){E=A.childNodes;for(C=E.length;C--;){Ext.apply(B,D.removeRecord(E[C]))}}return B},getRecordKey:function(A){if(A.isModel){A=A.getId()}return Ext.String.format("{0}-{1}",this.getId(),A)},getRecordCounterKey:function(){return Ext.String.format("{0}-counter",this.getId())},getTreeKey:function(){return Ext.String.format("{0}-tree",this.getId())},getIds:function(){var E=this,C=(E.getStorageObject().getItem(E.getId())||"").split(","),D=C.length,A=this.getIdField().isStringField,B;if(D===1&&C[0]===""){C=[]}else{for(B=0;B<D;B++){C[B]=A?C[B]:+C[B]}}return C},getIdField:function(){return this.getModel().prototype.idField},setIds:function(A){var B=this.getStorageObject(),C=A.join(","),D=this.getId();B.removeItem(D);if(!Ext.isEmpty(C)){B.setItem(D,C)}},getNextId:function(){var C=this,D=C.getStorageObject(),B=C.getRecordCounterKey(),A=C.getIdField().isStringField,E;E=C.idGenerator.generate();D.setItem(B,E);if(A){E=E+""}return E},getTreeData:function(){var L=this,A=L.getIds(),E=A.length,H=[],B={},M=[],I=0,G=L.getModel(),O=G.prototype.idProperty,F,K,N,J,D,C;for(;I<E;I++){C=A[I];K=L.getRecord(C);H.push(K);B[C]=K;if(!K.parentId){M.push(K)}}F=M.length;Ext.Array.sort(H,L.sortByParentId);for(I=F;I<E;I++){K=H[I];J=K.parentId;if(!N||N[O]!==J){N=B[J];N.children=D=[]}D.push(K)}for(I=E;I--;){K=H[I];if(!K.children&&!K.leaf){K.loaded=true}}for(I=F;I--;){K=M[I];M[I]=new G(K)}return M},sortByParentId:function(B,A){return(B.parentId||0)-(A.parentId||0)},initialize:function(){var B=this,A=B.getStorageObject(),C=+A.getItem(B.getRecordCounterKey()),D=B.getId();A.setItem(D,A.getItem(D)||"");if(A.getItem(B.getTreeKey())){B.isHierarchical=true}B.idGenerator=new Ext.data.identifier.Sequential({seed:C?C+1:1})},clear:function(){var D=this,E=D.getStorageObject(),C=D.getIds(),A=C.length,B;for(B=0;B<A;B++){E.removeItem(D.getRecordKey(C[B]))}E.removeItem(D.getRecordCounterKey());E.removeItem(D.getTreeKey());E.removeItem(D.getId());D.cache={}},getStorageObject:function(){Ext.raise("The getStorageObject function has not been defined in your Ext.data.proxy.WebStorage subclass")}})