Ext.define("Ext.data.request.Ajax",{extend:"Ext.data.request.Base",alias:"request.ajax",requires:["Ext.data.flash.BinaryXhr"],statics:{parseStatus:function(A){A=A==1223?204:A;var C=(A>=200&&A<300)||A==304,B=false;if(!C){switch(A){case 12002:case 12029:case 12030:case 12031:case 12152:case 13030:B=true;break}}return{success:C,isException:B}}},start:function(E){var C=this,B=C.options,A=C.requestOptions,D=C.isXdr,G,F;G=C.xhr=C.openRequest(B,A,C.async,C.username,C.password);if(!D){F=C.setupHeaders(G,B,A.data,A.params)}if(C.async){if(!D){G.onreadystatechange=Ext.Function.bind(C.onStateChange,C)}}if(D){C.processXdrRequest(C,G)}C.callParent([E]);G.send(E);if(!C.async){return C.onComplete()}return C},abort:function(B){var A=this,D=A.xhr;if(B||A.isLoading()){try{D.onreadystatechange=null}catch(C){D.onreadystatechange=Ext.emptyFn}D.abort();A.callParent([B]);A.onComplete();A.cleanup()}},cleanup:function(){this.xhr=null;delete this.xhr},isLoading:function(){var A=this,E=A.xhr,B=E&&E.readyState,D=Ext.data.flash&&Ext.data.flash.BinaryXhr;if(!E||A.aborted||A.timedout){return false}if(D&&E instanceof D){return B!==4}return B!==0&&B!==4},openRequest:function(C,A,D,G,B){var E=this,F=E.newRequest(C);if(G){F.open(A.method,A.url,D,G,B)}else{if(E.isXdr){F.open(A.method,A.url)}else{F.open(A.method,A.url,D)}}if(C.binary||E.binary){if(window.Uint8Array){F.responseType="arraybuffer"}else{if(F.overrideMimeType){F.overrideMimeType("text/plain; charset=x-user-defined")}else{if(!Ext.isIE){Ext.log.warn("Your browser does not support loading binary data using Ajax.")}}}}if(C.withCredentials||E.withCredentials){F.withCredentials=true}return F},newRequest:function(A){var B=this,C;if(A.binaryData){if(window.Uint8Array){C=B.getXhrInstance()}else{C=new Ext.data.flash.BinaryXhr()}}else{if(B.cors&&Ext.isIE9m){C=B.getXdrInstance();B.isXdr=true}else{C=B.getXhrInstance();B.isXdr=false}}return C},setupHeaders:function(M,N,E,D){var I=this,B=Ext.apply({},N.headers||{},I.defaultHeaders),L=I.defaultPostHeader,J=N.jsonData,A=N.xmlData,H="Content-Type",C=I.useDefaultXhrHeader,K,F;if(!B.hasOwnProperty(H)&&(E||D)){if(E){if(N.rawData){L="text/plain"}else{if(A&&Ext.isDefined(A)){L="text/xml"}else{if(J&&Ext.isDefined(J)){L="application/json"}}}}B[H]=L}if(C&&!B["X-Requested-With"]){B["X-Requested-With"]=I.defaultXhrHeader}if(B[H]===undefined||B[H]===null){delete B[H]}try{for(K in B){if(B.hasOwnProperty(K)){F=B[K];M.setRequestHeader(K,F)}}}catch(G){I.owner.fireEvent("exception",K,F)}return B},getXdrInstance:function(){var A;if(Ext.ieVersion>=8){A=new XDomainRequest()}else{Ext.raise({msg:"Your browser does not support CORS"})}return A},getXhrInstance:(function(){var B=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],C=0,A=B.length,E;for(;C<A;++C){try{E=B[C];E();break}catch(D){}}return E}()),processXdrRequest:function(B,C){var A=this;delete B.headers;B.contentType=B.options.contentType||A.defaultXdrContentType;C.onload=Ext.Function.bind(A.onStateChange,A,[true]);C.onerror=C.ontimeout=Ext.Function.bind(A.onStateChange,A,[false])},processXdrResponse:function(A,B){A.getAllResponseHeaders=function(){return[]};A.getResponseHeader=function(){return""};A.contentType=B.contentType||this.defaultXdrContentType},onStateChange:function(B){var C=this,D=C.xhr,A=Ext.GlobalEvents;if((D&&D.readyState==4)||C.isXdr){C.clearTimer();C.onComplete(B);C.cleanup();if(A.hasListeners.idle){A.fireEvent("idle")}}},onComplete:function(H){var E=this,A=E.owner,I=E.options,G=E.xhr,B={success:false,isException:false},J,F,C;if(!G||E.destroyed){return E.result=B}try{J=Ext.data.request.Ajax.parseStatus(G.status);if(J.success){J.success=G.readyState===4}}catch(D){J=B}F=E.success=E.isXdr?H:J.success;if(F){C=E.createResponse(G);A.fireEvent("requestcomplete",A,C,I);Ext.callback(I.success,I.scope,[C,I])}else{if(J.isException||E.aborted||E.timedout){C=E.createException(G)}else{C=E.createResponse(G)}A.fireEvent("requestexception",A,C,I);Ext.callback(I.failure,I.scope,[C,I])}E.result=C;Ext.callback(I.callback,I.scope,[I,F,C]);A.onRequestComplete(E);E.callParent([H]);return C},createResponse:function(I){var G=this,C=G.isXdr,B={},J=C?[]:I.getAllResponseHeaders().replace(/\r\n/g,"\n").split("\n"),E=J.length,K,F,H,D,A;while(E--){K=J[E];F=K.indexOf(":");if(F>=0){H=K.substr(0,F).toLowerCase();if(K.charAt(F+1)==" "){++F}B[H]=K.substr(F+1)}}D={request:G,requestId:G.id,status:I.status,statusText:I.statusText,getResponseHeader:function(L){return B[L.toLowerCase()]},getAllResponseHeaders:function(){return B}};if(C){G.processXdrResponse(D,I)}if(G.binary){D.responseBytes=G.getByteArray(I)}else{D.responseText=I.responseText;D.responseXML=I.responseXML}return D},destroy:function(){this.xhr=null;this.callParent()},privates:{getByteArray:function(H){var C=H.response,B=H.responseBody,I=Ext.data.flash&&Ext.data.flash.BinaryXhr,A,G,E,D;if(H instanceof I){A=H.responseBytes}else{if(window.Uint8Array){A=C?new Uint8Array(C):[]}else{if(Ext.isIE9p){try{A=new VBArray(B).toArray()}catch(F){A=[]}}else{if(Ext.isIE){if(!this.self.vbScriptInjected){this.injectVBScript()}getIEByteArray(H.responseBody,A=[])}else{A=[];G=H.responseText;E=G.length;for(D=0;D<E;D++){A.push(G.charCodeAt(D)&255)}}}}}return A},injectVBScript:function(){var A=document.createElement("script");A.type="text/vbscript";A.text=["Function getIEByteArray(byteArray, out)","Dim len, i","len = LenB(byteArray)","For i = 1 to len","out.push(AscB(MidB(byteArray, i, 1)))","Next","End Function"].join("\n");Ext.getHead().dom.appendChild(A);this.self.vbScriptInjected=true}}})