Ext.define("Ext.scroll.TouchScroller",{extend:"Ext.scroll.Scroller",alias:"scroller.touch",requires:["Ext.fx.easing.BoundMomentum","Ext.fx.easing.EaseOut","Ext.util.Translatable","Ext.scroll.Indicator","Ext.GlobalEvents"],isTouchScroller:true,config:{autoRefresh:true,bounceEasing:{duration:400},elementSize:undefined,indicators:true,fps:"auto",maxAbsoluteVelocity:6,momentumEasing:{momentum:{acceleration:30,friction:0.5},bounce:{acceleration:30,springTension:0.3},minVelocity:1},outOfBoundRestrictFactor:0.5,innerElement:null,size:undefined,slotSnapEasing:{duration:150},slotSnapOffset:{x:0,y:0},startMomentumResetTime:300,translatable:{translationMethod:"auto",useWrapper:false}},cls:Ext.baseCSSPrefix+"scroll-container",scrollerCls:Ext.baseCSSPrefix+"scroll-scroller",dragStartTime:0,dragEndTime:0,isDragging:false,isAnimating:false,isMouseEvent:{mousedown:1,mousemove:1,mouseup:1},listenerMap:{touchstart:"onTouchStart",touchmove:"onTouchMove",dragstart:"onDragStart",drag:"onDrag",dragend:"onDragEnd"},refreshCounter:0,constructor:function(A){var B=this,C="onEvent";B.elementListeners={touchstart:C,touchmove:C,dragstart:C,drag:C,dragend:C,scope:B};B.minPosition={x:0,y:0};B.startPosition={x:0,y:0};B.velocity={x:0,y:0};B.isAxisEnabledFlags={x:false,y:false};B.flickStartPosition={x:0,y:0};B.flickStartTime={x:0,y:0};B.lastDragPosition={x:0,y:0};B.dragDirection={x:0,y:0};B.callParent([A]);B.refreshAxes();B.scheduleRefresh={idle:B.doRefresh,scope:B,single:true,destroyable:true}},applyBounceEasing:function(B){var A=Ext.fx.easing.EaseOut;return{x:Ext.factory(B,A),y:Ext.factory(B,A)}},applyElementSize:function(B){var C=this.getElement(),D,A,E;if(!C){return null}D=C.dom;if(!D){return }if(B==null){A=D.clientWidth;E=D.clientHeight}else{A=B.x;E=B.y}return{x:A,y:E}},applyIndicators:function(F,C){var E=this,B,D,A,G;if(F){if(F===true){B=D={}}else{A=F.x;G=F.y;if(A||G){B=(A==null||A===true)?{}:A;D=(A==null||G===true)?{}:G}else{B=D=F}}if(C){if(B){C.x.setConfig(B)}else{C.x.destroy();C.x=null}if(D){C.y.setConfig(D)}else{C.y.destroy();C.y=null}F=C}else{F={x:null,y:null};if(B){F.x=new Ext.scroll.Indicator(Ext.applyIf({axis:"x",scroller:E},B))}if(D){F.y=new Ext.scroll.Indicator(Ext.applyIf({axis:"y",scroller:E},D))}}}else{if(C){if(C.x){C.x.destroy()}if(C.y){C.y.destroy()}C.x=C.y=null}}return F},applyMomentumEasing:function(B){var A=Ext.fx.easing.BoundMomentum;return{x:Ext.factory(B,A),y:Ext.factory(B,A)}},applyInnerElement:function(A){if(A&&!A.isElement){A=Ext.get(A)}if(this.isConfiguring&&!A){Ext.raise("Cannot create Ext.scroll.TouchScroller instance with null innerElement")}return A},applyMaxPosition:function(C,D){if(D&&C.x===D.x&&C.y===D.y){return }var A=this.getTranslatable(),B;if(A.isAnimating){B=A.activeEasingY;if(B&&B.getStartVelocity&&B.getStartVelocity()<0&&C.y<D.y){B.setMinMomentumValue(-C.y)}}return C},applyMaxUserPosition:function(B,A){if(A&&B.x===A.x&&B.y===A.y){return }return B},applySize:function(B){var C=this.getElement(),E,D,A,F;if(typeof B==="number"){A=B;F=B}else{if(B){A=B.x;F=B.y}}if(C&&(A==null||F==null)){E=C.dom;D=this.getInnerElement().dom;if(A==null){A=Math.max(D.scrollWidth,E.clientWidth)}if(F==null){F=Math.max(D.scrollHeight,E.clientHeight)}}return{x:A,y:F}},applySlotSnapOffset:function(A){if(typeof A==="number"){A={x:A,y:A}}return A},applySlotSnapSize:function(A){if(typeof A==="number"){A={x:A,y:A}}return A},applySlotSnapEasing:function(B){var A=Ext.fx.easing.EaseOut;return{x:Ext.factory(B,A),y:Ext.factory(B,A)}},applyTranslatable:function(B,A){return Ext.factory(B,Ext.util.Translatable,A)},destroy:function(){var C=this,B=C.getElement(),D=C.getInnerElement(),A=C.sizeMonitors;if(A){A.element.destroy();A.container.destroy()}if(B&&!B.destroyed){B.removeCls(C.cls)}if(D&&!D.destroyed){D.removeCls(C.scrollerCls)}if(C._isWrapped){if(!B.destroyed){C.unwrapContent()}D.destroy()}C.setElement(null);C.setInnerElement(null);C.setIndicators(null);Ext.destroy(C.getTranslatable());C.callParent()},refresh:function(A,B){var C=this;++C.refreshCounter;if(A){C.doRefresh(B)}else{if(!C.refreshScheduled){C.scheduleRefresh.args=[B];C.refreshScheduled=Ext.on(C.scheduleRefresh)}}},updateAutoRefresh:function(A){this.toggleResizeListeners(A)},updateBounceEasing:function(A){this.getTranslatable().setEasingX(A.x).setEasingY(A.y)},updateElementSize:function(){if(!this.isConfiguring){this.refreshAxes()}},updateDisabled:function(A){if(!this.isConfiguring){if(A){this.detachListeners()}else{this.attachListeners()}}},updateElement:function(C,B){var E=this,F=E.getInnerElement(),D,A;if(!F){F=C.dom.firstChild;if(!F||F.nodeType!==1||!Ext.fly(F).hasCls(E.scrollerCls)){F=E.wrapContent(C)}E.setInnerElement(F)}C.addCls(E.cls);if(E.isConfiguring){if(!E.getTranslatable().isScrollParent){C.dom.style.overflowX=C.dom.style.overflowY="";D=E.elementListeners;D.mousewheel="onMouseWheel";D.scroll={fn:"onElementScroll",delegated:false,scope:E}}}if(!E.getDisabled()){E.attachListeners()}if(!E.isConfiguring){A=E.getAutoRefresh();if(A!==false){E.toggleResizeListeners(A);if(A){E.refresh()}else{if(A===null){E.setElementSize(null)}}}}},updateFps:function(A){if(A!=="auto"){this.getTranslatable().setFps(A)}},updateMaxUserPosition:function(){this.snapToBoundary()},updateMinUserPosition:function(){this.snapToBoundary()},updateInnerElement:function(A){if(A){A.addCls(this.scrollerCls)}this.getTranslatable().setElement(A)},updateSize:function(A){if(!this.isConfiguring){if(Ext.supports.touchScroll===1){this.callParent([A])}this.refreshAxes()}},updateTranslatable:function(A){A.setElement(this.getInnerElement());if(!A.isScrollParent){A.on({animationframe:"onAnimationFrame",animationend:"onAnimationEnd",scope:this})}},updateX:function(){if(!this.isConfiguring){this.refreshAxes()}},updateY:function(){if(!this.isConfiguring){this.refreshAxes()}},privates:{attachListeners:function(){this.getElement().on(this.elementListeners)},constrainX:function(A){return Math.min(this.getMaxPosition().x,Math.max(A,0))},constrainY:function(A){return Math.min(this.getMaxPosition().y,Math.max(A,0))},convertEasingConfig:function(A){return A},detachListeners:function(){this.getElement().un(this.elementListeners)},doRefresh:function(B){var D=this,C,A;if(D.refreshScheduled){D.refreshScheduled=D.refreshScheduled.destroy()}if(D.refreshCounter&&D.getElement()){D.stopAnimation();D.getTranslatable().refresh();if(B){C=B.size;A=B.elementSize}D.setSize(C);D.setElementSize(A);D.fireEvent("refresh",D);D.refreshCounter=0}},doScrollTo:function(J,I,B,F){var H=this,G=H.isDragging,K=H.getTranslatable().isScrollParent,A=!H.isReflecting&&!K;if(H.destroyed||!H.getElement()){return H}F=F||H.isDragging;var L=H.getTranslatable(),C=H.position,M=false,E,D;if(!G||H.isAxisEnabled("x")){if(isNaN(J)||typeof J!=="number"){J=C.x}else{if(!F){J=H.constrainX(J)}if(C.x!==J){C.x=J;M=true}}E=H.convertX(-J)}if(!G||H.isAxisEnabled("y")){if(isNaN(I)||typeof I!=="number"){I=C.y}else{if(!F){I=H.constrainY(I)}if(C.y!==I){C.y=I;M=true}}D=-I}if(M){if(A){H.onScrollStart()}if(B){L.translateAnimated(E,D,B)}else{if(!K){H.onScroll()}L.translate(E,D);if(A){H.onScrollEnd()}}}else{if(B&&B.callback){B.callback()}}return H},getAnimationEasing:function(G,J){if(!this.isAxisEnabled(G)){return null}var L=this,F=L.position[G],D=L.getMinUserPosition()[G],I=L.getMaxUserPosition()[G],B=L.getMaxAbsoluteVelocity(),E=null,C=L.dragEndTime,H=J.flick.velocity[G],M=G==="x",A,K;if(F<D){E=D}else{if(F>I){E=I}}if(M){F=L.convertX(F);E=L.convertX(E)}if(E!==null){K=L.getBounceEasing()[G];K.setConfig({startTime:C,startValue:-F,endValue:-E});return K}if(H===0){return null}if(H<-B){H=-B}else{if(H>B){H=B}}K=L.getMomentumEasing()[G];A={startTime:C,startValue:-F,startVelocity:H*1.5,minMomentumValue:-I,maxMomentumValue:0};if(M){L.convertEasingConfig(A)}K.setConfig(A);return K},getSnapPosition:function(C){var D=this,H=D.getSlotSnapSize()[C],E=null,A,G,F,B;if(H!==0&&D.isAxisEnabled(C)){A=D.position[C];G=D.getSlotSnapOffset()[C];F=D.getMaxUserPosition()[C];B=Math.floor((A-G)%H);if(B!==0){if(A!==F){if(Math.abs(B)>H/2){E=Math.min(F,A+((B>0)?H-B:B-H))}else{E=A-B}}else{E=A-B}}}return E},hideIndicators:function(){var C=this,D=C.getIndicators(),A,B;if(D){if(C.isAxisEnabled("x")){A=D.x;if(A){A.hide()}}if(C.isAxisEnabled("y")){B=D.y;if(B){B.hide()}}}},isAxisEnabled:function(A){this.getX();this.getY();return this.isAxisEnabledFlags[A]},onAnimationEnd:function(){this.snapToBoundary();this.onScrollEnd()},onAnimationFrame:function(C,B,D){var A=this.position;A.x=this.convertX(-B);A.y=-D;this.onScroll()},onAxisDrag:function(D,P){if(P&&this.isAxisEnabled(D)){var Q=this,K=Q.flickStartPosition,R=Q.flickStartTime,I=Q.lastDragPosition,M=Q.dragDirection,A=Q.position[D],N=Q.getMinUserPosition()[D],O=Q.getMaxUserPosition()[D],G=Q.startPosition[D],J=I[D],L=G-P,H=M[D],F=Q.getOutOfBoundRestrictFactor(),B=Q.getStartMomentumResetTime(),C=Ext.Date.now(),E;if(L<N){L*=F}else{if(L>O){E=L-O;L=O+E*F}}if(L>J){M[D]=1}else{if(L<J){M[D]=-1}}if((H!==0&&(M[D]!==H))||(C-R[D])>B){K[D]=A;R[D]=C}I[D]=L;return true}},onDomScroll:function(){var B=this,C,A;if(B.getTranslatable().isScrollParent){C=B.getElement().dom;A=B.position;A.x=C.scrollLeft;A.y=C.scrollTop}B.callParent()},onDrag:function(C){var A=this,B=A.lastDragPosition;if(!A.isDragging){return }if(A.onAxisDrag("x",A.convertX(C.deltaX))|A.onAxisDrag("y",C.deltaY)){A.doScrollTo(B.x,B.y)}},onDragEnd:function(D){var C=this,B,A;if(!C.isDragging){return }C.dragEndTime=Ext.Date.now();C.onDrag(D);C.isDragging=false;B=C.getAnimationEasing("x",D);A=C.getAnimationEasing("y",D);if(B||A){C.getTranslatable().animate(B,A)}else{C.onScrollEnd()}},onDragStart:function(K){var L=this,O=L.getDirection(),F=K.absDeltaX,E=K.absDeltaY,J=L.getDirectionLock(),H=L.startPosition,D=L.flickStartPosition,I=L.flickStartTime,G=L.lastDragPosition,C=L.position,B=L.dragDirection,N=C.x,M=C.y,A=Ext.Date.now();if(J&&O!=="both"){if((O==="horizontal"&&F>E)||(O==="vertical"&&E>F)){K.stopPropagation()}else{return }}G.x=N;G.y=M;D.x=N;D.y=M;H.x=N;H.y=M;I.x=A;I.y=A;B.x=0;B.y=0;L.dragStartTime=A;L.isDragging=true;if(!L.isScrolling){L.onScrollStart()}},onElementResize:function(A,B){this.refresh(true,{elementSize:{x:B.contentWidth,y:B.contentHeight},size:this.getAutoRefresh()?null:this.getSize()})},onElementScroll:function(A,B){B.scrollTop=B.scrollLeft=0},onEvent:function(B){var A=this,C=B.browserEvent;if((!A.self.isTouching||A.isTouching)&&((!A.getTranslatable().isScrollParent)||(!A.isMouseEvent[C.type]&&C.pointerType!=="mouse"))&&(A.getY()||A.getX())){A[A.listenerMap[B.type]](B)}},onInnerElementResize:function(A,B){this.refresh(true,{size:{x:B.width,y:B.height}})},onMouseWheel:function(I){var J=this,L=I.getWheelDeltas(),D=-L.x,B=-L.y,F=J.position,E=J.getMaxUserPosition(),A=J.getMinUserPosition(),K=Math.max,C=Math.min,H=K(C(F.x+D,E.x),A.x),G=K(C(F.y+B,E.y),A.y);D=H-F.x;B=G-F.y;if(!D&&!B){return }I.stopEvent();J.onScrollStart();J.scrollBy(D,B);J.onScroll();J.onScrollEnd()},onPartnerScrollEnd:function(A,C){var B=this;if(!B.getTranslatable().isScrollParent){B.fireScrollEnd(A,C)}B.callParent([A,C]);B.isScrolling=false;B.hideIndicators()},onPartnerScrollStart:function(A,C){var B=this;B.isScrolling=true;if(!B.getTranslatable().isScrollParent){B.fireScrollStart(A,C)}B.showIndicators()},onScroll:function(){var E=this,C=E.position,B=C.x,G=C.y,F=E.getIndicators(),A,D;if(F){if(E.isAxisEnabled("x")){A=F.x;if(A){A.setValue(B)}}if(E.isAxisEnabled("y")){D=F.y;if(D){D.setValue(G)}}}E.fireScroll(B,G)},onScrollEnd:function(){var B=this,A=B.position;if(B.isScrolling&&!B.isTouching&&!B.snapToSlot()){B.hideIndicators();B.isScrolling=Ext.isScrolling=false;B.fireScrollEnd(A.x,A.y)}},onScrollStart:function(){var B=this,A=B.position;if(!B.isScrolling){B.showIndicators();B.isScrolling=Ext.isScrolling=true;B.fireScrollStart(A.x,A.y)}},onTouchEnd:function(){var A=this;A.isTouching=A.self.isTouching=false;if(!A.isDragging&&A.snapToSlot()){A.onScrollStart()}},onTouchMove:function(A){A.preventDefault()},onTouchStart:function(){var A=this;A.isTouching=A.self.isTouching=true;Ext.getDoc().on({touchend:"onTouchEnd",scope:A,single:true});A.stopAnimation()},refreshAxes:function(){var E=this,C=E.isAxisEnabledFlags,K=E.getSize(),J=E.getElementSize(),I=E.getIndicators(),B,A,H,G,D,F;if(!K||!J){return }B=Math.max(0,K.x-J.x);A=Math.max(0,K.y-J.y);H=E.getX();G=E.getY();E.setMaxPosition({x:B,y:A});if(H===true||H==="auto"){C.x=!!B}else{if(H===false){C.x=false;D=I&&I.x;if(D){D.hide()}}else{if(H==="scroll"){C.x=true}}}if(G===true||G==="auto"){C.y=!!A}else{if(G===false){C.y=false;F=I&&I.y;if(F){F.hide()}}else{if(G==="scroll"){C.y=true}}}E.setMaxUserPosition({x:C.x?B:0,y:C.y?A:0});if(Ext.supports.touchScroll===1){E.initXStyle();E.initYStyle()}},showIndicators:function(){var C=this,D=C.getIndicators(),A,B;if(D){if(C.isAxisEnabled("x")){A=D.x;if(A){A.show()}}if(C.isAxisEnabled("y")){B=D.y;if(B){B.show()}}}},snapToBoundary:function(){var H=this,G=H.getPosition();if(H.isConfiguring||!(G.x||G.y)){return }var C=H.getMinUserPosition(),F=H.getMaxUserPosition(),E=C.x,D=C.y,B=F.x,A=F.y,J=Math.round(G.x),I=Math.round(G.y);if(J<E){J=E}else{if(J>B){J=B}}if(I<D){I=D}else{if(I>A){I=A}}H.doScrollTo(J,I)},snapToSlot:function(){var A=this,C=A.getSnapPosition("x"),B=A.getSnapPosition("y"),D=A.getSlotSnapEasing();if(C!==null||B!==null){A.doScrollTo(C,B,{easingX:D.x,easingY:D.y});return true}return false},stopAnimation:function(){this.getTranslatable().stopAnimation()},toggleResizeListeners:function(A){var C=this,B=C.getElement(),F,E,D;if(B){D=C.getInnerElement();if(A){F=E="on"}else{if(A===null){F="on";E="un"}else{F=E="un"}}B[F]("resize","onElementResize",C);D[E]("resize","onInnerElementResize",C)}},unwrapContent:function(){var A=this.getInnerElement().dom,B=this.getElement().dom,C;while((C=A.firstChild)){B.insertBefore(C,A)}},wrapContent:function(A){var B=document.createElement("div"),C=A.dom,D;while(D=C.lastChild){B.insertBefore(D,B.firstChild)}C.appendChild(B);this.setInnerElement(B);this._isWrapped=true;return this.getInnerElement()}}})