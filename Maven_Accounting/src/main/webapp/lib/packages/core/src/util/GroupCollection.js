Ext.define("Ext.util.GroupCollection",{extend:"Ext.util.Collection",requires:["Ext.util.Group","Ext.util.SorterCollection","Ext.util.FilterCollection"],isGroupCollection:true,config:{grouper:null,itemRoot:null},observerPriority:-100,onCollectionAdd:function(B,A){this.addItemsToGroups(B,A.items)},onCollectionBeforeItemChange:function(B,A){this.changeDetails=A},onCollectionBeginUpdate:function(){this.beginUpdate()},onCollectionEndUpdate:function(){this.endUpdate()},onCollectionItemChange:function(C,A){var B=A.item;if(!A.indexChanged){this.syncItemGrouping(C,B,C.getKey(B),A.oldKey,A.oldIndex)}this.changeDetails=null},onCollectionRefresh:function(A){this.removeAll();this.addItemsToGroups(A,A.items)},onCollectionRemove:function(A,B){var G=this,J=G.changeDetails,F,H,I,E,C,D,K;if(J){K=J.item;I=G.findGroupForItem(K);F=[];if(I){F.push({group:I,items:[K]})}}else{F=G.groupItems(A,B.items,false)}for(E=0,C=F.length;E<C;++E){I=(H=F[E]).group;if(I){I.remove(H.items);if(!I.length){(D||(D=[])).push(I)}}}if(D){G.remove(D)}},onCollectionSort:function(E){var D=this,G=E.getSorters(false),A,C,B,F;if(G){A=D.items;C=D.length;for(B=0;B<C;++B){F=A[B];if(F.getSorters()!==G){F.setSorters(G)}}}},onCollectionUpdateKey:function(D,B){var A=B.index,C=B.item;if(!B.indexChanged){A=D.indexOf(C);this.syncItemGrouping(D,C,B.newKey,B.oldKey,A)}},addItemsToGroups:function(B,A){this.groupItems(B,A,true)},groupItems:function(B,J,D){var K=this,A={},H=[],C=B.getGrouper(),M=K.itemGroupKeys,L,N,P,G,O,E,I,F;for(G=0,I=J.length;G<I;++G){P=C.getGroupString(O=J[G]);E=B.getKey(O);if(D){(M||(K.itemGroupKeys=M={}))[E]=P}else{if(M){delete M[E]}}if(!(L=A[P])){if(!(N=K.getByKey(P))&&D){(F||(F=[])).push(N=K.createGroup(B,P))}H.push(A[P]=L={group:N,items:[]})}L.items.push(O)}for(G=0,I=H.length;G<I;++G){L=H[G];L.group.add(L.items)}if(F){K.add(F)}return H},syncItemGrouping:function(A,O,F,I,B){var M=this,J=M.itemGroupKeys||(M.itemGroupKeys={}),C=A.getGrouper(),P=C.getGroupString(O),G=0,L=-1,K,N,E,H,D;if(I){H=J[I];delete J[I]}else{H=J[F]}J[F]=P;if(!(N=M.get(P))){N=M.createGroup(A,P);K=[N]}if(N.get(F)!==O){if(N.getCount()>0&&A.getSorters().getCount()===0){D=A.indexOf(N.items[0]);if(B<D){L=0}else{L=B-D}}if(L===-1){N.add(O)}else{N.insert(L,O)}}else{N.itemChanged(O)}if(P!==H&&(H===0||H)){E=M.get(H);if(E){E.remove(O);if(!E.length){G=[E]}}}if(K){M.splice(0,G,K)}else{if(G){M.splice(0,G)}}},createGroup:function(B,A){var C=new Ext.util.Group({groupKey:A,rootProperty:this.getItemRoot(),sorters:B.getSorters()});return C},getKey:function(A){return A.getGroupKey()},createSortFn:function(){var C=this,A=C.getGrouper(),B=C.getSorters().getSortFn();if(!A){return B}return function(D,E){return A.sort(D.items[0],E.items[0])||B(D,E)}},updateGrouper:function(A){var B=this;B.grouped=!!(A&&B.$groupable.getAutoGroup());B.onSorterChange();B.onEndUpdateSorters(B.getSorters())},destroy:function(){this.$groupable=null;this.callParent()},privates:{findGroupForItem:function(D){var B=this.items,A=B.length,C,E;for(C=0;C<A;++C){E=B[C];if(E.contains(D)){return E}}}}})