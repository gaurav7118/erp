describe("Ext.data.proxy.Ajax",function(){var B;function A(C){C=C||{};C=Ext.applyIf(C,{url:"/foo"});B=new Ext.data.proxy.Ajax(C)}afterEach(function(){Ext.data.Model.schema.clear();Ext.undefine("spec.Company");B=null});describe("instantiation",function(){beforeEach(function(){A()});it("should extend Ext.data.proxy.Server",function(){expect(B.superclass).toBe(Ext.data.proxy.Server.prototype)});it("should have correct actionMethods",function(){expect(B.getActionMethods()).toEqual({create:"POST",read:"GET",update:"POST",destroy:"POST"})})});describe("parameters",function(){var D,C;beforeEach(function(){spyOn(Ext.Ajax,"request").andCallFake(function(E){D=E});C=new Ext.data.operation.Read()});afterEach(function(){D=C=null});describe("binary",function(){it("should default to binary false",function(){A();B.read(C);expect(D.binary).toBe(false)});it("should pass binary when set on the proxy",function(){A({binary:true});B.read(C);expect(D.binary).toBe(true)})});describe("headers",function(){it("should default to no headers",function(){A();B.read(C);expect(D.headers).toBeUndefined()});it("should pass headers",function(){A({headers:{"Content-Type":"text/plain"}});B.read(C);expect(D.headers).toEqual({"Content-Type":"text/plain"})})});describe("timeout",function(){it("should use the default timeout",function(){A();B.read(C);expect(D.timeout).toBe(B.getTimeout())});it("should use a passed timeout",function(){A({timeout:1000});B.read(C);expect(D.timeout).toBe(1000)})});describe("useDefaultXhrHeader",function(){it("should default to true",function(){A();B.read(C);expect(D.useDefaultXhrHeader).toBe(true)});it("should pass along useDefaultXhrHeader",function(){A({useDefaultXhrHeader:true});B.read(C);expect(D.useDefaultXhrHeader).toBe(true)})});describe("withCredentials",function(){it("should default to false",function(){A();B.read(C);expect(D.withCredentials).toBe(false)});it("should should pass the username/password",function(){A({withCredentials:true,username:"foo",password:"bar"});B.read(C);expect(D.withCredentials).toBe(true);expect(D.username).toBe("foo");expect(D.password).toBe("bar")})});describe("paramsAsJson",function(){it("should always send as params when using get",function(){B=new Ext.data.proxy.Ajax({url:"fake",paramsAsJson:true});C.setParams({id:1});B.read(C);expect(D.params.id).toBe(1);expect(D.jsonData).toBeUndefined()});it("should send as params when paramsAsJson is false",function(){B=new Ext.data.proxy.Ajax({url:"fake",paramsAsJson:false});C=new Ext.data.operation.Create();C.setParams({id:1});B.create(C);expect(D.params.id).toBe(1);expect(D.jsonData).toBeUndefined()});it("should send as jsonData with non-get action and paramsAsJson: true",function(){B=new Ext.data.proxy.Ajax({url:"fake",paramsAsJson:true});C=new Ext.data.operation.Create();C.setParams({id:1});B.create(C);expect(D.jsonData).toEqual({id:1});expect(D.params).toBeUndefined()});it("should not overwrite existing jsonData, but merge them",function(){B=new Ext.data.proxy.Ajax({url:"fake",paramsAsJson:true,writer:{type:"json",writeRecordId:false}});var E=Ext.define(null,{extend:"Ext.data.Model",fields:["name"]});C=new Ext.data.operation.Create({records:[new E({name:"X"})]});C.setParams({foo:1});B.create(C);expect(D.jsonData).toEqual({name:"X",foo:1})})})});describe("request result",function(){var D,E;function C(F,H,G){Ext.Ajax.mockComplete({status:F||200,statusText:H||"",responseText:Ext.isDefined(G)?G:'{"success": true, "data": []}'})}beforeEach(function(){Ext.define("spec.AjaxModel",{extend:"Ext.data.Model",fields:["id"]});MockAjaxManager.addMethods();D=new Ext.data.operation.Read();A({model:spec.AjaxModel,reader:{type:"json",rootProperty:"data",successProperty:"success"}})});afterEach(function(){E=D=null;MockAjaxManager.removeMethods();Ext.undefine("spec.AjaxModel")});it("should return the null result set if status 204 is returned",function(){E=B.read(D);spyOn(B,"afterRequest");C(204,"No Content","");expect(D.getResultSet()).toBe(Ext.data.reader.Reader.prototype.nullResultSet)});describe("successful request",function(){it("should call afterRequest with the request & the success status",function(){E=B.read(D);spyOn(B,"afterRequest");C(200);expect(B.afterRequest).toHaveBeenCalledWith(E,true)});describe("reader success",function(){it("should process the operation",function(){B.read(D);spyOn(D,"process");C(200);expect(D.process).toHaveBeenCalled()});it("should not fire the exception event",function(){var F=jasmine.createSpy();B.on("exception",F);B.read(D);C(200);expect(F).not.toHaveBeenCalled()})});describe("reader failure",function(){it("should process the operation",function(){spyOn(D,"process");B.read(D);C(200,"",'{"success": false}');expect(D.process).toHaveBeenCalled()});it("should fire the exception event",function(){var G=jasmine.createSpy();B.on("exception",G);B.read(D);C(200,"",'{"success": false}');var F=G.mostRecentCall.args;expect(F[0]).toBe(B);expect(F[1].responseText).toBe('{"success": false}');expect(F[2]).toBe(D)})})});describe("failed request",function(){it("should call afterRequest with the request & the success status",function(){E=B.read(D);spyOn(B,"afterRequest");C(500);expect(B.afterRequest).toHaveBeenCalledWith(E,false)});describe("server error",function(){beforeEach(function(){B.read(D)});it("should set an exception on the operation",function(){C(500,"failStatus");expect(D.wasSuccessful()).toBe(false);expect(D.getError()).toEqual({status:500,statusText:"failStatus",response:jasmine.any(Object)})});it("should fire the exception event and pass the proxy, response & operation",function(){var G=jasmine.createSpy();B.on("exception",G);C(500,"","someResponse");var F=G.mostRecentCall.args;expect(F[0]).toBe(B);expect(F[1].responseText).toBe("someResponse");expect(F[2]).toBe(D)})});describe("timeout",function(){it("should set an exception on the operation",function(){B.setTimeout(1);E=B.read(D);waitsFor(function(){return D.isComplete()},"Operation never completed");runs(function(){expect(D.wasSuccessful()).toBe(false);expect(D.getError()).toEqual({status:0,statusText:"communication failure",response:jasmine.any(Object)})})});it("should fire the exception event and pass the proxy, response & operation",function(){var F=jasmine.createSpy();B.on("exception",F);B.setTimeout(1);E=B.read(D);waitsFor(function(){return D.isComplete()},"Operation never completed");runs(function(){var G=F.mostRecentCall.args;expect(G[0]).toBe(B);expect(G[1].statusText).toBe("communication failure");expect(G[2]).toBe(D)})})})})});describe("getMethod",function(){var C;beforeEach(function(){A();C=new Ext.data.Request({url:"/",action:"read"})});it("should return the HTTP method name for a given request",function(){expect(B.getMethod(C)).toBe("GET")});it("should return a the default action method if the actionMethods property is overridden",function(){B.setActionMethods({update:"PUT"});expect(B.getMethod(C)).toBe("GET")});it("should return a value when actionMethods is undefined/null",function(){B.setActionMethods(undefined);expect(B.getMethod(C)).toBe("GET")})})})