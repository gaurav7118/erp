describe("Ext.direct.RemotingProvider",function(){var C=Ext.direct.RemotingProvider,E,B={actions:{"TestAction":[{len:1,name:"echo"},{len:1,name:"directFail"},{name:"directForm",formHandler:true},{len:1,name:"directMetaNamed",metadata:{params:[],strict:false}},{len:1,name:"directMetaOrdered",metadata:{len:2}},{name:"directMetaFormNamed",formHandler:true,metadata:{params:[],strict:false}},{name:"directMetaFormOrdered",formHandler:true,metadata:{len:2}}],"TestAction.Foo":[{len:0,name:"foo"}],"TestAction.Foo.Bar":[{len:0,name:"bar"}],"TestAction.Foo.Bar.Baz":[{len:0,name:"baz"}],"TestAction.Foo.Qux":[{len:0,name:"qux"}]},namespace:"Direct.foo.bar",type:"remoting",url:"/router",id:"foo"},A={echo:function(F){return F},directFail:function(F){return{type:"exception"}},directForm:function(F){return{success:true,data:F}},directMetaNamed:function(G,F){return{data:G,metadata:F}},directMetaOrdered:function(G,F){return{data:G,metadata:F}},directMetaFormNamed:function(G,F){return{success:true,data:G,metadata:F}},directMetaFormOrdered:function(G,F){return{success:true,data:G,metadata:F}},foo:function(){return"foo"},bar:function(){return"bar"},baz:function(){return"baz"},qux:function(){return"qux"}};function D(K){var L=K.callback,H=K.scope,U=K.transaction,I=K.form!==undefined,O=K.isUpload,M={},X,V,T,J,M,Q,N,R,F,P,G,S;if(I){X=K.params;V=X.extTID;T=X.extAction;J=X.extMethod;S=X.extMetadata;Ext.fly(K.form).select("input").each(function(Z,a,Y){this[Z.dom.name]=Z.dom.value},M);M=[M]}else{X=K.jsonData;V=X.tid;T=X.action;J=X.method;M=X.data||[];S=X.metadata}Q=A[J];if(/^directMeta/.test(J)){M.push(S)}if(K.timeout===666){F={type:"exception",tid:V,message:"Can't connect to the server"};N=false}else{try{R=Q.apply({},M);F={type:"rpc",tid:V,action:T,method:J,result:R}}catch(W){F={type:"exception",tid:V,message:W.toString(),where:"internal"}}N=true}P={responseText:Ext.encode(F)};G={transaction:U};Ext.callback(L,H,[G,N,P],1)}beforeEach(function(){E=new C(B)});afterEach(function(){if(E){E.destroy()}Ext.direct.Manager.clearAllMethods();E=null;try{delete window.Direct}catch(F){window.Direct=undefined}});describe("handles namespaces:",function(){var F;it("creates namespace for itself if passed a string",function(){expect(Direct.foo.bar).toBeDefined()});it("doesn't create nested objects until it's connected",function(){expect(Direct.foo.bar).toEqual({})});describe("creates nested namespaces after it's connected:",function(){beforeEach(function(){E.connect();F=Direct.foo.bar});it("creates TestAction",function(){expect(F.TestAction).toBeDefined()});it("creates TestAction.Foo",function(){expect(F.TestAction.Foo).toBeDefined()});it("creates TestAction.Foo.Bar",function(){expect(F.TestAction.Foo.Bar).toBeDefined()});it("creates TestAction.Foo.Bar.Baz",function(){expect(F.TestAction.Foo.Bar.Baz).toBeDefined()});it("creates TestAction.Foo.Qux",function(){expect(F.TestAction.Foo.Qux).toBeDefined()})});describe("handles nested namespaces the old way:",function(){beforeEach(function(){E.disableNestedActions=true;E.connect();F=Direct.foo.bar});it("creates TestAction",function(){expect(F.TestAction).toBeDefined()});it("creates TestAction.Foo",function(){expect(F["TestAction.Foo"]).toBeDefined();expect(F.TestAction.Foo).not.toBeDefined()});it("creates TestAction.Foo.Bar",function(){expect(F["TestAction.Foo.Bar"]).toBeDefined()});it("creates TestAction.Foo.Bar.Baz",function(){expect(F["TestAction.Foo.Bar.Baz"]).toBeDefined()});it("creates TestAction.Foo.Qux",function(){expect(F["TestAction.Foo.Qux"]).toBeDefined()})})});describe("handles remoting methods:",function(){var G;function F(H){expect(Ext.isFunction(H)).toBeTruthy()}beforeEach(function(){E.connect();G=Direct.foo.bar});it("has Foo.foo",function(){F(G.TestAction.Foo.foo)});it("has Foo.Bar.bar",function(){F(G.TestAction.Foo.Bar.bar)});it("has Foo.Bar.Baz.baz",function(){F(G.TestAction.Foo.Bar.Baz.baz)});it("has Foo.Qux.qux",function(){F(G.TestAction.Foo.Qux.qux)})});describe("runs remoting methods:",function(){var M,I,R,P;function J(S,T){this.echo=T.status}function Q(S,T){if(T.status){this.echo=S}}function H(T,S){this.echo=S.result}function L(S,U,V,T){if(V){this.echo=S;this.options=T}}function G(){return false}function K(){return Ext.isDefined(this.echo)}function F(){return !!P.callCount}function O(S,U,T){S=S||K;U=U||"callback never fired";T=T!=null?T:100;waitsFor(S,U,T)}function N(S){runs(function(){expect(this.echo).toEqual(S)})}beforeEach(function(){I=undefined;R=undefined;spyOn(Ext.Ajax,"request").andCallFake(D);E.connect();M=Direct.foo.bar;P=jasmine.createSpy("event handler")});afterEach(function(){P=undefined});describe("handles call mechanics",function(){describe("call batching",function(){afterEach(function(){if(E.callTask){E.callTask.cancel()}Ext.direct.Manager.transactions.clear()});it("should batch calls within specified enableBuffer timeout",function(){var T,S;runs(function(){Ext.Ajax.request.andCallFake(function(U){T=U});S=Ext.direct.Transaction.TRANSACTION_ID;M.TestAction.echo("foo",Ext.emptyFn);M.TestAction.echo("bar",Ext.emptyFn)});waitsFor(function(){return !!T},"options never modified",20);runs(function(){expect(T.jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+1,data:["foo"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["bar"]}])})});it("should run calls with specified timeout w/o batching",function(){var T=[],S;runs(function(){Ext.Ajax.request.andCallFake(function(U){T.push(U)});E.enableBuffer=200;S=Ext.direct.Transaction.TRANSACTION_ID;M.TestAction.echo("baz",Ext.emptyFn);M.TestAction.echo("qux",Ext.emptyFn,this,{timeout:1})});waitsFor(function(){return !!T},"options never modified",20);runs(function(){expect(T.length).toBe(1);expect(T[0].jsonData).toEqual({action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["qux"]})})});it("should run calls instantly with disableBatching",function(){var T=[],S;runs(function(){Ext.Ajax.request.andCallFake(function(U){T.push(U)});E.enableBuffer=200;S=Ext.direct.Transaction.TRANSACTION_ID;M.TestAction.echo("baz",Ext.emptyFn);M.TestAction.echo.$directCfg.method.disableBatching=true;M.TestAction.echo("qux",Ext.emptyFn)});waitsFor(function(){return !!T},"options never modified",20);runs(function(){expect(T.length).toBe(1);expect(T[0].jsonData).toEqual({action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["qux"]})})});it("should run calls instantly with enableBuffer = false",function(){var T,S;Ext.Ajax.request.andCallFake(function(U){R=U});E.enableBuffer=false;S=Ext.direct.Transaction.TRANSACTION_ID;M.TestAction.echo("fred",Ext.emptyFn);expect(R.jsonData).toEqual({action:"TestAction",method:"echo",type:"rpc",tid:S+1,data:["fred"]})});describe("bufferLimit",function(){var T,S;beforeEach(function(){T=[];Ext.Ajax.request.andCallFake(function(U){T.push(U)});E.enableBuffer=200;E.bufferLimit=3;S=Ext.direct.Transaction.TRANSACTION_ID});it("should batch calls up to bufferLimit",function(){runs(function(){M.TestAction.echo("fee",Ext.emptyFn);M.TestAction.echo("fie",Ext.emptyFn);M.TestAction.echo("foe",Ext.emptyFn);M.TestAction.echo("foo",Ext.emptyFn)});waitsFor(function(){return !!T.length},"options never modified",20);runs(function(){expect(T.length).toBe(1);expect(T[0].jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+1,data:["fee"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["fie"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+3,data:["foe"]}])})});it("should make 2 batched requests for 6 calls",function(){runs(function(){M.TestAction.echo("frobbe",Ext.emptyFn);M.TestAction.echo("throbbe",Ext.emptyFn);M.TestAction.echo("gurgle",Ext.emptyFn);M.TestAction.echo("bonzo",Ext.emptyFn);M.TestAction.echo("mymse",Ext.emptyFn);M.TestAction.echo("splurge",Ext.emptyFn)});waitsFor(function(){return !!T.length},"options never modified",20);runs(function(){expect(T.length).toBe(2);expect(T[0].jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+1,data:["frobbe"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["throbbe"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+3,data:["gurgle"]}]);expect(T[1].jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+4,data:["bonzo"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+5,data:["mymse"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+6,data:["splurge"]}])})});it("should make 3 batched requests for 7 calls",function(){runs(function(){M.TestAction.echo("Grumpy",Ext.emptyFn);M.TestAction.echo("Sleepy",Ext.emptyFn);M.TestAction.echo("Dopey",Ext.emptyFn);M.TestAction.echo("Bashful",Ext.emptyFn);M.TestAction.echo("Sneezy",Ext.emptyFn);M.TestAction.echo("Happy",Ext.emptyFn);M.TestAction.echo("Doc",Ext.emptyFn)});waitsFor(function(){return T.length===3},"3 Ajax requests",300);runs(function(){expect(T.length).toBe(3);expect(T[0].jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+1,data:["Grumpy"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+2,data:["Sleepy"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+3,data:["Dopey"]}]);expect(T[1].jsonData).toEqual([{action:"TestAction",method:"echo",type:"rpc",tid:S+4,data:["Bashful"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+5,data:["Sneezy"]},{action:"TestAction",method:"echo",type:"rpc",tid:S+6,data:["Happy"]}]);expect(T[2].jsonData).toEqual({action:"TestAction",method:"echo",type:"rpc",tid:S+7,data:["Doc"]})})})})});describe("call related events",function(){it("fires 'beforecall' event",function(){runs(function(){E.on("beforecall",P);M.TestAction.echo("fred",Ext.emptyFn)});waitsFor(F,"event handler never fired",20);runs(function(){expect(P).toHaveBeenCalled()});waits(35)});it("fires 'call' event",function(){runs(function(){E.on("call",P);M.TestAction.echo("plugh",Ext.emptyFn)});waitsFor(F,"event handler never fired",20);runs(function(){expect(P).toHaveBeenCalled()});waits(35)});it("cancels request when 'beforecall' handler returns false",function(){runs(function(){P.andCallFake(G);E.on("beforecall",P);M.TestAction.echo("mymse",Ext.emptyFn)});waitsFor(F,"event handler never fired",200);waits(20);runs(function(){expect(R).toBeUndefined()});waits(35)})})});describe("with connection failed",function(){it("retries failed transactions",function(){var S=Ext.direct.Transaction.prototype;runs(function(){spyOn(S,"retry").andCallThrough();M.TestAction.echo("foo",Ext.emptyFn,this,{timeout:666})});waitsFor(function(){return S.retry.callCount===1},"transaction.retry() never called",200);runs(function(){expect(S.retry).toHaveBeenCalled()})});it("fires exception when retry count is exceeded",function(){runs(function(){E.on("data",P);M.TestAction.echo("bar",Ext.emptyFn,this,{timeout:666})});waitsFor(F,"event handler never fired",200);runs(function(){expect(P).toHaveBeenCalled()})});describe("handles callback:",function(){it("fires 'beforecallback' event",function(){runs(function(){E.on("beforecallback",P);M.TestAction.echo("baz",Ext.emptyFn,this,{timeout:666})});waitsFor(F,"event handler never fired",200);runs(function(){expect(P).toHaveBeenCalled()})});it("cancels callback when 'beforecallback' handler returns false",function(){var S=jasmine.createSpy("callback");runs(function(){P.andCallFake(G);E.on("beforecallback",P);M.TestAction.echo("qux",S,this,{timeout:666})});waitsFor(F,"event handler never fired",200);waits(20);runs(function(){expect(P).toHaveBeenCalled();expect(S).not.toHaveBeenCalled()})});it("fires callback when retry count is exceeded",function(){runs(function(){M.TestAction.echo("plugh",J,this,{timeout:666})});waitsFor(K,"callback never fired",200);runs(function(){expect(this.echo).toBe(false)})})})});describe("successfully connected:",function(){it("fires 'data' event",function(){runs(function(){E.on("data",P);M.TestAction.echo("foo",Q,this)});O();runs(function(){expect(P).toHaveBeenCalled()})});describe("handles callback:",function(){it("fires 'beforecallback' event",function(){runs(function(){E.on("beforecallback",P);M.TestAction.echo("foo",Q,this)});waitsFor(K,"event handler never fired",100);runs(function(){expect(P).toHaveBeenCalled()})});it("cancels callback when 'beforecallback' handler returns false",function(){var S=jasmine.createSpy("callback");runs(function(){P.andCallFake(G);E.on("beforecallback",P);M.TestAction.echo("bar",S,this)});waitsFor(F,"event handler never fired",100);waits(20);runs(function(){expect(P).toHaveBeenCalled();expect(S).not.toHaveBeenCalled()})});it("runs w/o additional options",function(){runs(function(){M.TestAction.echo("foo",Q,this)});O();N("foo")});it("runs w/ additional options",function(){runs(function(){M.TestAction.echo("bar",L,this,{victory:"Huzzah!"})});O();runs(function(){expect(this.echo).toEqual("bar");expect(this.options).toBeDefined();expect(this.options.victory).toEqual("Huzzah!")})});it("runs in nested namespaces",function(){runs(function(){M.TestAction.Foo.foo(Q,this)});O();N("foo")});it("runs in deeply nested namespaces",function(){runs(function(){M.TestAction.Foo.Bar.bar(Q,this)});O();N("bar")});it("runs in really truly deeply nested namespaces",function(){runs(function(){M.TestAction.Foo.Bar.Baz.baz(Q,this)});O();N("baz")})});describe("metadata",function(){it("will pass named metadata",function(){runs(function(){M.TestAction.directMetaNamed("foo",Q,this,{metadata:{bleh:"blah"}})});O();N({data:"foo",metadata:{bleh:"blah"}})});it("will pass ordered metadata",function(){runs(function(){M.TestAction.directMetaOrdered("bar",Q,this,{metadata:["blerg","blam","frob"]})});O();N({data:"bar",metadata:["blerg","blam"]})})})});(Ext.toolkit==="classic"?describe:xdescribe)("form calls:",function(){var S;function T(U){U=Ext.apply({xtype:"form",renderTo:document.body,width:300,height:200,layout:"form",api:{submit:"TestAction.directForm"},items:[{xtype:"hiddenfield",name:"hidden_foo",value:"hide the sacred foo from infoodels!"},{xtype:"textfield",name:"overt_foo",value:"behold the false, deceitful overt foo"}]},U);S=Ext.widget(U)}beforeEach(function(){T()});afterEach(function(){if(S){S.destroy()}});describe("submit",function(){it("should pass field values to direct fn",function(){runs(function(){S.submit({success:H,scope:this})});waitsFor(K,"callback that never fired",2000);runs(function(){expect(this.echo).toEqual({success:true,data:{hidden_foo:"hide the sacred foo from infoodels!",overt_foo:"behold the false, deceitful overt foo"}})})});it("should pass extra params to direct fn",function(){runs(function(){S.submit({params:{simple_foo:"barf!"},success:H,scope:this})});waitsFor(K,"callback that never fired",2000);runs(function(){expect(this.echo).toEqual({success:true,data:{hidden_foo:"hide the sacred foo from infoodels!",overt_foo:"behold the false, deceitful overt foo",simple_foo:"barf!"}})})});it("should pass form baseParams to direct fn",function(){runs(function(){S.getForm().baseParams={MEGA_FOO:"ALL YOUR FOO ARE BELONG TO US!"};S.submit({success:H,scope:this})});waitsFor(K,"callback that never fired",2000);runs(function(){expect(this.echo).toEqual({success:true,data:{hidden_foo:"hide the sacred foo from infoodels!",overt_foo:"behold the false, deceitful overt foo",MEGA_FOO:"ALL YOUR FOO ARE BELONG TO US!"}})})});it("should pass named metadata",function(){runs(function(){S.getForm().api.submit="TestAction.directMetaFormNamed";S.getForm().metadata={foo:"bargh!"};S.submit({success:H,scope:this})});waitsFor(K,"callback that never fired",2000);runs(function(){expect(this.echo).toEqual({success:true,data:{hidden_foo:"hide the sacred foo from infoodels!",overt_foo:"behold the false, deceitful overt foo"},metadata:'{"foo":"bargh!"}'})})});it("should pass ordered metadata",function(){runs(function(){S.getForm().api.submit="TestAction.directMetaFormOrdered";S.getForm().metadata=["bram","blam","qux?"];S.submit({success:H,scope:this})});waitsFor(K,"callback that never fired",2000);runs(function(){expect(this.echo).toEqual({success:true,data:{hidden_foo:"hide the sacred foo from infoodels!",overt_foo:"behold the false, deceitful overt foo"},metadata:'["bram","blam"]'})})})})})})})