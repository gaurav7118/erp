Ext.define("Ext.ux.BoxReorderer",{requires:["Ext.dd.DD"],mixins:{observable:"Ext.util.Observable"},itemSelector:".x-box-item",animate:100,constructor:function(){this.mixins.observable.constructor.apply(this,arguments)},init:function(A){var B=this;B.container=A;B.animatePolicy={};B.animatePolicy[A.getLayout().names.x]=true;B.container.on({scope:B,boxready:B.onBoxReady,beforedestroy:B.onContainerDestroy})},onContainerDestroy:function(){var A=this.dd;if(A){A.unreg();this.dd=null}},onBoxReady:function(){var C=this,B=C.container.getLayout(),D=B.names,A;A=C.dd=new Ext.dd.DD(B.innerCt,C.container.id+"-reorderer");Ext.apply(A,{animate:C.animate,reorderer:C,container:C.container,getDragCmp:C.getDragCmp,clickValidator:Ext.Function.createInterceptor(A.clickValidator,C.clickValidator,C,false),onMouseDown:C.onMouseDown,startDrag:C.startDrag,onDrag:C.onDrag,endDrag:C.endDrag,getNewIndex:C.getNewIndex,doSwap:C.doSwap,findReorderable:C.findReorderable});A.dim=D.width;A.startAttr=D.beforeX;A.endAttr=D.afterX},getDragCmp:function(A){return this.container.getChildByElement(A.getTarget(this.itemSelector,10))},clickValidator:function(B){var A=this.getDragCmp(B);return !!(A&&A.reorderable!==false)},onMouseDown:function(F){var E=this,A=E.container,D,B,C;E.dragCmp=E.getDragCmp(F);if(E.dragCmp){B=E.dragCmp.getEl();E.startIndex=E.curIndex=A.items.indexOf(E.dragCmp);C=B.getBox();E.lastPos=C[E.startAttr];D=A.el.getBox();if(E.dim==="width"){E.minX=D.left;E.maxX=D.right-C.width;E.minY=E.maxY=C.top;E.deltaX=F.getX()-C.left}else{E.minY=D.top;E.maxY=D.bottom-C.height;E.minX=E.maxX=C.left;E.deltaY=F.getY()-C.top}E.constrainY=E.constrainX=true}},startDrag:function(){var B=this,A=B.dragCmp;if(A){A.setPosition=Ext.emptyFn;A.animate=false;if(B.animate){B.container.getLayout().animatePolicy=B.reorderer.animatePolicy}B.dragElId=A.getEl().id;B.reorderer.fireEvent("StartDrag",B,B.container,A,B.curIndex);A.suspendEvents();A.disabled=true;A.el.setStyle("zIndex",100)}else{B.dragElId=null}},findReorderable:function(C){var D=this,A=D.container.items,B;if(A.getAt(C).reorderable===false){B=A.getAt(C);if(C>D.startIndex){while(B&&B.reorderable===false){C++;B=A.getAt(C)}}else{while(B&&B.reorderable===false){C--;B=A.getAt(C)}}}C=Math.min(Math.max(C,0),A.getCount()-1);if(A.getAt(C).reorderable===false){return -1}return C},doSwap:function(D){var F=this,B=F.container.items,A=F.container,E=F.container._isLayoutRoot,H,C,G;D=F.findReorderable(D);if(D===-1){return }F.reorderer.fireEvent("ChangeIndex",F,A,F.dragCmp,F.startIndex,D);H=B.getAt(F.curIndex);C=B.getAt(D);B.remove(H);G=Math.min(Math.max(D,0),B.getCount()-1);B.insert(G,H);B.remove(C);B.insert(F.curIndex,C);A._isLayoutRoot=true;A.updateLayout();A._isLayoutRoot=E;F.curIndex=D},onDrag:function(C){var B=this,A;A=B.getNewIndex(C.getPoint());if((A!==undefined)){B.reorderer.fireEvent("Drag",B,B.container,B.dragCmp,B.startIndex,B.curIndex);B.doSwap(A)}},endDrag:function(D){if(D){D.stopEvent()}var C=this,B=C.container.getLayout(),A;if(C.dragCmp){delete C.dragElId;delete C.dragCmp.setPosition;C.dragCmp.animate=true;C.dragCmp.lastBox[B.names.x]=C.dragCmp.getPosition(true)[B.names.widthIndex];C.container._isLayoutRoot=true;C.container.updateLayout();C.container._isLayoutRoot=undefined;A=Ext.fx.Manager.getFxQueue(C.dragCmp.el.id)[0];if(A){A.on({afteranimate:C.reorderer.afterBoxReflow,scope:C})}else{Ext.Function.defer(C.reorderer.afterBoxReflow,1,C)}if(C.animate){delete B.animatePolicy}C.reorderer.fireEvent("drop",C,C.container,C.dragCmp,C.startIndex,C.curIndex)}},afterBoxReflow:function(){var A=this;A.dragCmp.el.setStyle("zIndex","");A.dragCmp.disabled=false;A.dragCmp.resumeEvents()},getNewIndex:function(H){var G=this,A=G.getDragEl(),B=Ext.fly(A).getBox(),K,F,J,D=0,C=G.container.items.items,E=C.length,I=G.lastPos;G.lastPos=B[G.startAttr];for(;D<E;D++){K=C[D].getEl();if(K.is(G.reorderer.itemSelector)){F=K.getBox();J=F[G.startAttr]+(F[G.dim]>>1);if(D<G.curIndex){if((B[G.startAttr]<I)&&(B[G.startAttr]<(J-5))){return D}}else{if(D>G.curIndex){if((B[G.startAttr]>I)&&(B[G.endAttr]>(J+5))){return D}}}}}}})