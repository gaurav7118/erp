Ext.define("Ext.ux.LiveSearchGridPanel",{extend:"Ext.grid.Panel",requires:["Ext.toolbar.TextItem","Ext.form.field.Checkbox","Ext.form.field.Text","Ext.ux.statusbar.StatusBar"],searchValue:null,matches:[],currentIndex:null,searchRegExp:null,caseSensitive:false,regExpMode:false,matchCls:"x-livesearch-match",defaultStatusText:"Nothing Found",initComponent:function(){var A=this;A.tbar=["Search",{xtype:"textfield",name:"searchField",hideLabel:true,width:200,listeners:{change:{fn:A.onTextFieldChange,scope:this,buffer:500}}},{xtype:"button",text:"&lt;",tooltip:"Find Previous Row",handler:A.onPreviousClick,scope:A},{xtype:"button",text:"&gt;",tooltip:"Find Next Row",handler:A.onNextClick,scope:A},"-",{xtype:"checkbox",hideLabel:true,margin:"0 0 0 4px",handler:A.regExpToggle,scope:A},"Regular expression",{xtype:"checkbox",hideLabel:true,margin:"0 0 0 4px",handler:A.caseSensitiveToggle,scope:A},"Case sensitive"];A.bbar=new Ext.ux.StatusBar({defaultText:A.defaultStatusText,name:"searchStatusBar"});A.callParent(arguments)},afterRender:function(){var A=this;A.callParent(arguments);A.textField=A.down("textfield[name=searchField]");A.statusBar=A.down("statusbar[name=searchStatusBar]");A.view.on("cellkeydown",A.focusTextField,A)},focusTextField:function(B,H,C,A,E,G,F,D){if(F.getKey()===F.S){F.preventDefault();this.textField.focus()}},tagsRe:/<[^>]*>/gm,tagsProtect:"\x0f",getSearchValue:function(){var B=this,C=B.textField.getValue();if(C===""){return null}if(!B.regExpMode){C=Ext.String.escapeRegex(C)}else{try{new RegExp(C)}catch(A){B.statusBar.setStatus({text:A.message,iconCls:"x-status-error"});return null}if(C==="^"||C==="$"){return null}}return C},onTextFieldChange:function(){var F=this,E=0,B=F.view,A=B.cellSelector,C=B.innerSelector,D=F.visibleColumnManager.getColumns();B.refresh();F.statusBar.setStatus({text:F.defaultStatusText,iconCls:""});F.searchValue=F.getSearchValue();F.matches=[];F.currentIndex=null;if(F.searchValue!==null){F.searchRegExp=new RegExp(F.getSearchValue(),"g"+(F.caseSensitive?"":"i"));F.store.each(function(H,G){var I=B.getNode(H);if(I){Ext.Array.forEach(D,function(L){var J=Ext.fly(I).down(L.getCellInnerSelector(),true),N,M,K;if(J){N=J.innerHTML.match(F.tagsRe);M=J.innerHTML.replace(F.tagsRe,F.tagsProtect);M=M.replace(F.searchRegExp,function(O){++E;if(!K){F.matches.push({record:H,column:L});K=true}return'<span class="'+F.matchCls+'">'+O+"</span>"},F);Ext.each(N,function(O){M=M.replace(F.tagsProtect,O)});J.innerHTML=M}})}},F);if(E){F.currentIndex=0;F.gotoCurrent();F.statusBar.setStatus({text:Ext.String.format("{0} match{1} found.",E,E===1?"es":""),iconCls:"x-status-valid"})}}if(F.currentIndex===null){F.getSelectionModel().deselectAll();F.textField.focus()}},onPreviousClick:function(){var C=this,D=C.matches,B=D.length,A=C.currentIndex;if(B){C.currentIndex=A===0?B-1:A-1;C.gotoCurrent()}},onNextClick:function(){var C=this,D=C.matches,B=D.length,A=C.currentIndex;if(B){C.currentIndex=A===B-1?0:A+1;C.gotoCurrent()}},caseSensitiveToggle:function(B,A){this.caseSensitive=A;this.onTextFieldChange()},regExpToggle:function(B,A){this.regExpMode=A;this.onTextFieldChange()},privates:{gotoCurrent:function(){var A=this.matches[this.currentIndex];this.getNavigationModel().setPosition(A.record,A.column);this.getSelectionModel().select(A.record)}}})