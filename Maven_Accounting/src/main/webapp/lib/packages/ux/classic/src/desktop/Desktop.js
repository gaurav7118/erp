Ext.define("Ext.ux.desktop.Desktop",{extend:"Ext.panel.Panel",alias:"widget.desktop",uses:["Ext.util.MixedCollection","Ext.menu.Menu","Ext.view.View","Ext.window.Window","Ext.ux.desktop.TaskBar","Ext.ux.desktop.Wallpaper"],activeWindowCls:"ux-desktop-active-win",inactiveWindowCls:"ux-desktop-inactive-win",lastActiveWindow:null,border:false,html:"&#160;",layout:"fit",xTickSize:1,yTickSize:1,app:null,shortcuts:null,shortcutItemSelector:"div.ux-desktop-shortcut",shortcutTpl:['<tpl for=".">','<div class="ux-desktop-shortcut" id="{name}-shortcut">','<div class="ux-desktop-shortcut-icon {iconCls}">','<img src="',Ext.BLANK_IMAGE_URL,'" title="{name}">',"</div>",'<span class="ux-desktop-shortcut-text">{name}</span>',"</div>","</tpl>",'<div class="x-clear"></div>'],taskbarConfig:null,windowMenu:null,initComponent:function(){var B=this;B.windowMenu=new Ext.menu.Menu(B.createWindowMenu());B.bbar=B.taskbar=new Ext.ux.desktop.TaskBar(B.taskbarConfig);B.taskbar.windowMenu=B.windowMenu;B.windows=new Ext.util.MixedCollection();B.contextMenu=new Ext.menu.Menu(B.createDesktopMenu());B.items=[{xtype:"wallpaper",id:B.id+"_wallpaper"},B.createDataView()];B.callParent();B.shortcutsView=B.items.getAt(1);B.shortcutsView.on("itemclick",B.onShortcutItemClick,B);var A=B.wallpaper;B.wallpaper=B.items.getAt(0);if(A){B.setWallpaper(A,B.wallpaperStretch)}},afterRender:function(){var A=this;A.callParent();A.el.on("contextmenu",A.onDesktopMenu,A)},createDataView:function(){var A=this;return{xtype:"dataview",overItemCls:"x-view-over",trackOver:true,itemSelector:A.shortcutItemSelector,store:A.shortcuts,style:{position:"absolute"},x:0,y:0,tpl:new Ext.XTemplate(A.shortcutTpl)}},createDesktopMenu:function(){var B=this,A={items:B.contextMenuItems||[]};if(A.items.length){A.items.push("-")}A.items.push({text:"Tile",handler:B.tileWindows,scope:B,minWindows:1},{text:"Cascade",handler:B.cascadeWindows,scope:B,minWindows:1});return A},createWindowMenu:function(){var A=this;return{defaultAlign:"br-tr",items:[{text:"Restore",handler:A.onWindowMenuRestore,scope:A},{text:"Minimize",handler:A.onWindowMenuMinimize,scope:A},{text:"Maximize",handler:A.onWindowMenuMaximize,scope:A},"-",{text:"Close",handler:A.onWindowMenuClose,scope:A}],listeners:{beforeshow:A.onWindowMenuBeforeShow,hide:A.onWindowMenuHide,scope:A}}},onDesktopMenu:function(B){var A=this,C=A.contextMenu;B.stopEvent();if(!C.rendered){C.on("beforeshow",A.onDesktopMenuBeforeShow,A)}C.showAt(B.getXY());C.doConstrain()},onDesktopMenuBeforeShow:function(C){var B=this,A=B.windows.getCount();C.items.each(function(E){var D=E.minWindows||0;E.setDisabled(A<D)})},onShortcutItemClick:function(E,A){var C=this,B=C.app.getModule(A.data.module),D=B&&B.createWindow();if(D){C.restoreWindow(D)}},onWindowClose:function(B){var A=this;A.windows.remove(B);A.taskbar.removeTaskButton(B.taskButton);A.updateActiveWindow()},onWindowMenuBeforeShow:function(C){var A=C.items.items,B=C.theWin;A[0].setDisabled(B.maximized!==true&&B.hidden!==true);A[1].setDisabled(B.minimized===true);A[2].setDisabled(B.maximized===true||B.hidden===true)},onWindowMenuClose:function(){var A=this,B=A.windowMenu.theWin;B.close()},onWindowMenuHide:function(A){Ext.defer(function(){A.theWin=null},1)},onWindowMenuMaximize:function(){var A=this,B=A.windowMenu.theWin;B.maximize();B.toFront()},onWindowMenuMinimize:function(){var A=this,B=A.windowMenu.theWin;B.minimize()},onWindowMenuRestore:function(){var A=this,B=A.windowMenu.theWin;A.restoreWindow(B)},getWallpaper:function(){return this.wallpaper.wallpaper},setTickSize:function(B,C){var E=this,A=E.xTickSize=B,D=E.yTickSize=(arguments.length>1)?C:A;E.windows.each(function(G){var F=G.dd,H=G.resizer;F.xTickSize=A;F.yTickSize=D;H.widthIncrement=A;H.heightIncrement=D})},setWallpaper:function(B,A){this.wallpaper.setWallpaper(B,A);return this},cascadeWindows:function(){var A=0,C=0,B=this.getDesktopZIndexManager();B.eachBottomUp(function(D){if(D.isWindow&&D.isVisible()&&!D.maximized){D.setPosition(A,C);A+=20;C+=20}})},createWindow:function(C,B){var D=this,E,A=Ext.applyIf(C||{},{stateful:false,isWindow:true,constrainHeader:true,minimizable:true,maximizable:true});B=B||Ext.window.Window;E=D.add(new B(A));D.windows.add(E);E.taskButton=D.taskbar.addTaskButton(E);E.animateTarget=E.taskButton.el;E.on({activate:D.updateActiveWindow,beforeshow:D.updateActiveWindow,deactivate:D.updateActiveWindow,minimize:D.minimizeWindow,destroy:D.onWindowClose,scope:D});E.on({boxready:function(){E.dd.xTickSize=D.xTickSize;E.dd.yTickSize=D.yTickSize;if(E.resizer){E.resizer.widthIncrement=D.xTickSize;E.resizer.heightIncrement=D.yTickSize}},single:true});E.doClose=function(){E.doClose=Ext.emptyFn;E.el.disableShadow();E.el.fadeOut({listeners:{afteranimate:function(){E.destroy()}}})};return E},getActiveWindow:function(){var B=null,A=this.getDesktopZIndexManager();if(A){A.eachTopDown(function(C){if(C.isWindow&&!C.hidden){B=C;return false}return true})}return B},getDesktopZIndexManager:function(){var A=this.windows;return(A.getCount()&&A.getAt(0).zIndexManager)||null},getWindow:function(A){return this.windows.get(A)},minimizeWindow:function(A){A.minimized=true;A.hide()},restoreWindow:function(A){if(A.isVisible()){A.restore();A.toFront()}else{A.show()}return A},tileWindows:function(){var B=this,E=B.body.getWidth(true);var A=B.xTickSize,D=B.yTickSize,C=D;B.windows.each(function(G){if(G.isVisible()&&!G.maximized){var F=G.el.getWidth();if(A>B.xTickSize&&A+F>E){A=B.xTickSize;D=C}G.setPosition(A,D);A+=F+B.xTickSize;C=Math.max(C,D+G.el.getHeight()+B.yTickSize)}})},updateActiveWindow:function(){var B=this,C=B.getActiveWindow(),A=B.lastActiveWindow;if(A&&A.destroyed){B.lastActiveWindow=null;return }if(C===A){return }if(A){if(A.el.dom){A.addCls(B.inactiveWindowCls);A.removeCls(B.activeWindowCls)}A.active=false}B.lastActiveWindow=C;if(C){C.addCls(B.activeWindowCls);C.removeCls(B.inactiveWindowCls);C.minimized=false;C.active=true}B.taskbar.setActiveButton(C&&C.taskButton)}})