Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.FieldContainer",mixins:["Ext.util.StoreHolder","Ext.form.field.Field"],alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselectfield","widget.multiselect"],requires:["Ext.panel.Panel","Ext.view.BoundList","Ext.layout.container.Fit"],uses:["Ext.view.DragZone","Ext.view.DropZone"],layout:"anchor",ddReorder:false,appendOnly:false,displayField:"text",allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) required",delimiter:",",dragText:"{0} Item{1}",ignoreSelectChange:0,pageSize:10,initComponent:function(){var A=this;A.items=A.setupItems();A.bindStore(A.store,true);if(A.store.autoCreated){A.valueField=A.displayField="field1";if(!A.store.expanded){A.displayField="field2"}}if(!Ext.isDefined(A.valueField)){A.valueField=A.displayField}A.callParent();A.initField()},setupItems:function(){var A=this;A.boundList=new Ext.view.BoundList(Ext.apply({anchor:"none 100%",border:1,multiSelect:true,store:A.store,displayField:A.displayField,disabled:A.disabled,tabIndex:0,navigationModel:{type:"default"}},A.listConfig));A.boundList.getNavigationModel().addKeyBindings({pageUp:A.onKeyPageUp,pageDown:A.onKeyPageDown,scope:A});A.boundList.getSelectionModel().on("selectionchange",A.onSelectChange,A);A.boundList.pickerField=A;if(!A.title){return A.boundList}A.boundList.border=false;return{xtype:"panel",isAriaRegion:false,border:true,anchor:"none 100%",layout:"anchor",title:A.title,tbar:A.tbar,items:A.boundList}},onSelectChange:function(A,B){if(!this.ignoreSelectChange){this.setValue(B)}},getSelected:function(){return this.boundList.getSelectionModel().getSelection()},isEqual:function(E,D){var B=Ext.Array.from,C=0,A;E=B(E);D=B(D);A=E.length;if(A!==D.length){return false}for(;C<A;C++){if(D[C]!==E[C]){return false}}return true},afterRender:function(){var D=this,C=D.boundList,B,A;D.callParent();if(D.selectOnRender){B=D.getRecordsForValue(D.value);if(B.length){++D.ignoreSelectChange;D.boundList.getSelectionModel().select(B);--D.ignoreSelectChange}delete D.toSelect}if(D.ddReorder&&!D.dragGroup&&!D.dropGroup){D.dragGroup=D.dropGroup="MultiselectDD-"+Ext.id()}if(D.draggable||D.dragGroup){D.dragZone=Ext.create("Ext.view.DragZone",{view:D.boundList,ddGroup:D.dragGroup,dragText:D.dragText})}if(D.droppable||D.dropGroup){D.dropZone=Ext.create("Ext.view.DropZone",{view:D.boundList,ddGroup:D.dropGroup,handleNodeDrop:function(K,J,E){var F=this.view,H=F.getStore(),G=K.records,I;K.view.store.remove(G);I=H.indexOf(J);if(E==="after"){I++}H.insert(I,G);F.getSelectionModel().select(G);D.fireEvent("drop",D,G)}})}A=D.down("panel");if(A&&C){C.ariaEl.dom.setAttribute("aria-labelledby",A.header.id+"-title-textEl")}},onKeyPageUp:function(G){var F=this,B=F.pageSize,C=F.boundList,A=C.getNavigationModel(),D,E;D=A.recordIndex;E=D>B?D-B:0;A.setPosition(E,G)},onKeyPageDown:function(H){var G=this,B=G.pageSize,C=G.boundList,A=C.getNavigationModel(),F,D,E;F=C.getStore().getCount();D=A.recordIndex;E=D<(F-B)?D+B:F-1;A.setPosition(E,H)},isValid:function(){var B=this,A=B.disabled,C=B.forceValidation||!A;return C?B.validateValue(B.value):A},validateValue:function(B){var A=this,D=A.getErrors(B),C=Ext.isEmpty(D);if(!A.preventMark){if(C){A.clearInvalid()}else{A.markInvalid(D)}}return C},markInvalid:function(C){var B=this,A=B.getActiveError();B.setActiveErrors(Ext.Array.from(C));if(A!==B.getActiveError()){B.updateLayout()}},clearInvalid:function(){var B=this,A=B.hasActiveError();B.unsetActiveError();if(A){B.updateLayout()}},getSubmitData:function(){var A=this,B=null,C;if(!A.disabled&&A.submitValue&&!A.isFileUpload()){C=A.getSubmitValue();if(C!==null){B={};B[A.getName()]=C}}return B},getSubmitValue:function(){var B=this,A=B.delimiter,C=B.getValue();return Ext.isString(A)?C.join(A):C},getValue:function(){return this.value||[]},getRecordsForValue:function(G){var F=this,A=[],H=F.store.getRange(),J=F.valueField,D=0,I=H.length,B,C,E;for(E=G.length;D<E;++D){for(C=0;C<I;++C){B=H[C];if(B.get(J)==G[D]){A.push(B)}}}return A},setupValue:function(G){var B=this.delimiter,D=this.valueField,E=0,C,A,F;if(Ext.isDefined(G)){if(B&&Ext.isString(G)){G=G.split(B)}else{if(!Ext.isArray(G)){G=[G]}}for(A=G.length;E<A;++E){F=G[E];if(F&&F.isModel){G[E]=F.get(D)}}C=Ext.Array.unique(G)}else{C=[]}return C},setValue:function(D){var C=this,B=C.boundList.getSelectionModel(),A=C.store;if(!A.getCount()){A.on({load:Ext.Function.bind(C.setValue,C,[D]),single:true});return }D=C.setupValue(D);C.mixins.field.setValue.call(C,D);if(C.rendered){++C.ignoreSelectChange;B.deselectAll();if(D.length){B.select(C.getRecordsForValue(D))}--C.ignoreSelectChange}else{C.selectOnRender=true}},clearValue:function(){this.setValue([])},onEnable:function(){var A=this.boundList;this.callParent();if(A){A.enable()}},onDisable:function(){var A=this.boundList;this.callParent();if(A){A.disable()}},getErrors:function(B){var A=this,C=Ext.String.format,E=[],D;B=Ext.Array.from(B||A.getValue());D=B.length;if(!A.allowBlank&&D<1){E.push(A.blankText)}if(D<A.minSelections){E.push(C(A.minSelectionsText,A.minSelections))}if(D>A.maxSelections){E.push(C(A.maxSelectionsText,A.maxSelections))}return E},onDestroy:function(){var A=this;A.bindStore(null);Ext.destroy(A.dragZone,A.dropZone,A.keyNav);A.callParent()},onBindStore:function(A){var B=this.boundList;if(B){B.bindStore(A)}}})